<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 6.4.4" />
    <title>esbmtk.utility_functions API documentation</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2264%22%20height%3D%2264%22%20viewBox%3D%2244.5%202.5%2015%2015%22%3E%3Cpath%20d%3D%22M49.351%2021.041c-.233-.721-.546-2.408-.772-4.076-.042-.09-.067-.187-.046-.288-.166-1.347-.277-2.625-.241-3.351-1.378-1.008-2.271-2.586-2.271-4.362%200-.976.272-1.935.788-2.774.057-.094.122-.18.184-.268-.033-.167-.052-.339-.052-.516%200-1.477%201.202-2.679%202.679-2.679.791%200%201.496.352%201.987.9a6.3%206.3%200%200%201%201.001.029c.492-.564%201.207-.929%202.012-.929%201.477%200%202.679%201.202%202.679%202.679a2.65%202.65%200%200%201-.269%201.148c.383.747.595%201.572.595%202.41%200%202.311-1.507%204.29-3.635%205.107.037.699.147%202.27.423%203.294l.137.461c.156%202.136-4.612%205.166-5.199%203.215zm.127-4.919a4.78%204.78%200%200%200%20.775-.584c-.172-.115-.505-.254-.88-.378zm.331%202.302l.828-.502c-.202-.143-.576-.328-.984-.49zm.45%202.157l.701-.403c-.214-.115-.536-.249-.891-.376l.19.779zM49.13%204.141c0%20.152.123.276.276.276s.275-.124.275-.276-.123-.276-.276-.276-.275.124-.275.276zm.735-.389a1.15%201.15%200%200%201%20.314.783%201.16%201.16%200%200%201-1.162%201.162c-.457%200-.842-.27-1.032-.653-.026.117-.042.238-.042.362a1.68%201.68%200%200%200%201.679%201.679%201.68%201.68%200%200%200%201.679-1.679c0-.843-.626-1.535-1.436-1.654zm3.076%201.654a1.68%201.68%200%200%200%201.679%201.679%201.68%201.68%200%200%200%201.679-1.679c0-.037-.009-.072-.011-.109-.21.3-.541.508-.935.508a1.16%201.16%200%200%201-1.162-1.162%201.14%201.14%200%200%201%20.474-.912c-.015%200-.03-.005-.045-.005-.926.001-1.679.754-1.679%201.68zm1.861-1.265c0%20.152.123.276.276.276s.275-.124.275-.276-.123-.276-.276-.276-.275.124-.275.276zm1.823%204.823c0-.52-.103-1.035-.288-1.52-.466.394-1.06.64-1.717.64-1.144%200-2.116-.725-2.499-1.738-.383%201.012-1.355%201.738-2.499%201.738-.867%200-1.631-.421-2.121-1.062-.307.605-.478%201.267-.478%201.942%200%202.486%202.153%204.51%204.801%204.51s4.801-2.023%204.801-4.51zm-3.032%209.156l-.146-.492c-.276-1.02-.395-2.457-.444-3.268a6.11%206.11%200%200%201-1.18.115%206.01%206.01%200%200%201-2.536-.562l.006.175c.802.215%201.848.612%202.021%201.25.079.295-.021.601-.274.837l-.598.501c.667.304%201.243.698%201.311%201.179.02.144.022.507-.393.787l-.564.365c1.285.521%201.361.96%201.381%201.126.018.142.011.496-.427.746l-.854.489c.064-1.19%201.985-2.585%202.697-3.248zM49.34%209.925c0-.667%201-.667%201%200%200%20.653.818%201.205%201.787%201.205s1.787-.552%201.787-1.205c0-.667%201-.667%201%200%200%201.216-1.25%202.205-2.787%202.205s-2.787-.989-2.787-2.205zm-.887-7.633c-.093.077-.205.114-.317.114a.5.5%200%200%201-.318-.886L49.183.397a.5.5%200%200%201%20.703.068.5.5%200%200%201-.069.703zm7.661-.065c-.086%200-.173-.022-.253-.068l-1.523-.893c-.575-.337-.069-1.2.506-.863l1.523.892a.5.5%200%200%201%20.179.685c-.094.158-.261.247-.432.247z%22%20fill%3D%22%233bb300%22/%3E%3C/svg%3E"/>


<style type="text/css">/*! * Bootstrap Reboot v5.0.0-beta1 (https://getbootstrap.com/) * Copyright 2011-2020 The Bootstrap Authors * Copyright 2011-2020 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}[tabindex="-1"]:focus:not(:focus-visible){outline:0!important}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus{outline:dotted 1px;outline:-webkit-focus-ring-color auto 5px}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
<style type="text/css">/*! pygments syntax highlighting */pre{line-height:125%;}td.linenos pre{color:#000000; background-color:#f0f0f0; padding-left:5px; padding-right:5px;}span.linenos{color:#000000; background-color:#f0f0f0; padding-left:5px; padding-right:5px;}td.linenos pre.special{color:#000000; background-color:#ffffc0; padding-left:5px; padding-right:5px;}span.linenos.special{color:#000000; background-color:#ffffc0; padding-left:5px; padding-right:5px;}.pdoc .hll{background-color:#ffffcc}.pdoc{background:#f8f8f8;}.pdoc .c{color:#408080; font-style:italic}.pdoc .err{border:1px solid #FF0000}.pdoc .k{color:#008000; font-weight:bold}.pdoc .o{color:#666666}.pdoc .ch{color:#408080; font-style:italic}.pdoc .cm{color:#408080; font-style:italic}.pdoc .cp{color:#BC7A00}.pdoc .cpf{color:#408080; font-style:italic}.pdoc .c1{color:#408080; font-style:italic}.pdoc .cs{color:#408080; font-style:italic}.pdoc .gd{color:#A00000}.pdoc .ge{font-style:italic}.pdoc .gr{color:#FF0000}.pdoc .gh{color:#000080; font-weight:bold}.pdoc .gi{color:#00A000}.pdoc .go{color:#888888}.pdoc .gp{color:#000080; font-weight:bold}.pdoc .gs{font-weight:bold}.pdoc .gu{color:#800080; font-weight:bold}.pdoc .gt{color:#0044DD}.pdoc .kc{color:#008000; font-weight:bold}.pdoc .kd{color:#008000; font-weight:bold}.pdoc .kn{color:#008000; font-weight:bold}.pdoc .kp{color:#008000}.pdoc .kr{color:#008000; font-weight:bold}.pdoc .kt{color:#B00040}.pdoc .m{color:#666666}.pdoc .s{color:#BA2121}.pdoc .na{color:#7D9029}.pdoc .nb{color:#008000}.pdoc .nc{color:#0000FF; font-weight:bold}.pdoc .no{color:#880000}.pdoc .nd{color:#AA22FF}.pdoc .ni{color:#999999; font-weight:bold}.pdoc .ne{color:#D2413A; font-weight:bold}.pdoc .nf{color:#0000FF}.pdoc .nl{color:#A0A000}.pdoc .nn{color:#0000FF; font-weight:bold}.pdoc .nt{color:#008000; font-weight:bold}.pdoc .nv{color:#19177C}.pdoc .ow{color:#AA22FF; font-weight:bold}.pdoc .w{color:#bbbbbb}.pdoc .mb{color:#666666}.pdoc .mf{color:#666666}.pdoc .mh{color:#666666}.pdoc .mi{color:#666666}.pdoc .mo{color:#666666}.pdoc .sa{color:#BA2121}.pdoc .sb{color:#BA2121}.pdoc .sc{color:#BA2121}.pdoc .dl{color:#BA2121}.pdoc .sd{color:#BA2121; font-style:italic}.pdoc .s2{color:#BA2121}.pdoc .se{color:#BB6622; font-weight:bold}.pdoc .sh{color:#BA2121}.pdoc .si{color:#BB6688; font-weight:bold}.pdoc .sx{color:#008000}.pdoc .sr{color:#BB6688}.pdoc .s1{color:#BA2121}.pdoc .ss{color:#19177C}.pdoc .bp{color:#008000}.pdoc .fm{color:#0000FF}.pdoc .vc{color:#19177C}.pdoc .vg{color:#19177C}.pdoc .vi{color:#19177C}.pdoc .vm{color:#19177C}.pdoc .il{color:#666666}</style>
<style type="text/css">/*! pdoc */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f7f7f7;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}body{background-color:var(--pdoc-background);}html, body{width:100%;height:100%;}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main{padding:2rem 3vw;}.git-button{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}#navtoggle{display:none;}}#togglestate{display:none;}nav.pdoc{--pad:1.75rem;--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc li{display:block;margin:0;padding:.2rem 0 .2rem var(--indent);transition:all 100ms;}nav.pdoc > div > ul > li{padding-left:0;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}html, main{scroll-behavior:smooth;}.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3, .pdoc h4{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{background-color:var(--code);border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.pdoc details{--shift:-40px;text-align:right;margin-top:var(--shift);margin-bottom:calc(0px - var(--shift));clear:both;filter:opacity(1);}.pdoc details:not([open]){height:0;overflow:visible;}.pdoc details > summary{font-size:.75rem;cursor:pointer;color:var(--muted);border-width:0;padding:0 .7em;display:inline-block;display:inline list-item;user-select:none;}.pdoc details > summary:focus{outline:0;}.pdoc details > div{margin-top:calc(0px - var(--shift) / 2);text-align:left;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc > section:first-of-type > .docstring{margin-bottom:3rem;}.pdoc .docstring pre{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc .headerlink{position:absolute;width:0;margin-left:-1.5rem;line-height:1.4rem;font-size:1.5rem;font-weight:normal;transition:all 100ms ease-in-out;opacity:0;}.pdoc .attr > .headerlink{margin-left:-2.5rem;}.pdoc *:hover > .headerlink,.pdoc *:target > .attr > .headerlink{opacity:1;}.pdoc .attr{color:var(--text);margin:1rem 0 .5rem;padding:.4rem 5rem .4rem 1rem;background-color:var(--accent);}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{white-space:pre-wrap;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}</style>
</head>
<body>        <nav class="pdoc">
            <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
            <input id="togglestate" type="checkbox">
            <div>
                        <a class="pdoc-button module-list-button" href="../esbmtk.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                            &nbsp;esbmtk</a>




                    <h2>API Documentation</h2>
                        <ul class="memberlist">
            <li>
                    <a class="function" href="#get_imass">get_imass</a>
            </li>
            <li>
                    <a class="function" href="#get_frac">get_frac</a>
            </li>
            <li>
                    <a class="function" href="#get_flux_data">get_flux_data</a>
            </li>
            <li>
                    <a class="function" href="#get_delta">get_delta</a>
            </li>
            <li>
                    <a class="function" href="#add_to">add_to</a>
            </li>
            <li>
                    <a class="function" href="#get_plot_layout">get_plot_layout</a>
            </li>
            <li>
                    <a class="function" href="#plot_geometry">plot_geometry</a>
            </li>
            <li>
                    <a class="function" href="#list_fluxes">list_fluxes</a>
            </li>
            <li>
                    <a class="function" href="#show_data">show_data</a>
            </li>
            <li>
                    <a class="function" href="#set_y_limits">set_y_limits</a>
            </li>
            <li>
                    <a class="function" href="#get_ptype">get_ptype</a>
            </li>
            <li>
                    <a class="function" href="#plot_object_data">plot_object_data</a>
            </li>
            <li>
                    <a class="function" href="#is_name_in_list">is_name_in_list</a>
            </li>
            <li>
                    <a class="function" href="#get_object_from_list">get_object_from_list</a>
            </li>
            <li>
                    <a class="function" href="#sort_by_type">sort_by_type</a>
            </li>
            <li>
                    <a class="function" href="#split_key">split_key</a>
            </li>
            <li>
                    <a class="function" href="#make_dict">make_dict</a>
            </li>
            <li>
                    <a class="function" href="#get_typed_list">get_typed_list</a>
            </li>
            <li>
                    <a class="function" href="#create_reservoirs">create_reservoirs</a>
            </li>
            <li>
                    <a class="function" href="#build_concentration_dicts">build_concentration_dicts</a>
            </li>
            <li>
                    <a class="function" href="#calc_volumes">calc_volumes</a>
            </li>
            <li>
                    <a class="function" href="#get_longest_dict_entry">get_longest_dict_entry</a>
            </li>
            <li>
                    <a class="function" href="#convert_to_lists">convert_to_lists</a>
            </li>
            <li>
                    <a class="function" href="#get_sub_key">get_sub_key</a>
            </li>
            <li>
                    <a class="function" href="#expand_dict">expand_dict</a>
            </li>
            <li>
                    <a class="function" href="#create_bulk_connections">create_bulk_connections</a>
            </li>
            <li>
                    <a class="function" href="#create_connection">create_connection</a>
            </li>
            <li>
                    <a class="function" href="#update_or_create">update_or_create</a>
            </li>
            <li>
                    <a class="function" href="#execute">execute</a>
            </li>
            <li>
                    <a class="function" href="#execute_h">execute_h</a>
            </li>
            <li>
                    <a class="function" href="#execute_n">execute_n</a>
            </li>
            <li>
                    <a class="function" href="#execute_e">execute_e</a>
            </li>
            <li>
                    <a class="function" href="#foo">foo</a>
            </li>
            <li>
                    <a class="function" href="#update_fluxes">update_fluxes</a>
            </li>
            <li>
                    <a class="function" href="#sum_p">sum_p</a>
            </li>
            <li>
                    <a class="function" href="#summarize_fluxes">summarize_fluxes</a>
            </li>
            <li>
                    <a class="function" href="#build_vr_list">build_vr_list</a>
            </li>
            <li>
                    <a class="function" href="#build_flux_lists">build_flux_lists</a>
            </li>
            <li>
                    <a class="function" href="#build_flux_lists_all">build_flux_lists_all</a>
            </li>
            <li>
                    <a class="function" href="#build_process_list">build_process_list</a>
            </li>
            <li>
                    <a class="function" href="#get_string_between_brackets">get_string_between_brackets</a>
            </li>
            <li>
                    <a class="function" href="#map_units">map_units</a>
            </li>
    </ul>


                    <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev">
                        built with <span class="visually-hidden">pdoc</span><img
                            alt="pdoc logo"
                            src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
                    </a>
            </div>
        </nav>
    <main class="pdoc">
            <section>
                    <h1 class="modulename">
<a href="./../esbmtk.html">esbmtk</a>.utility_functions    </h1>

                        <div class="docstring"><p>esbmtk: A general purpose Earth Science box model toolkit
Copyright (C), 2020 Ulrich G. Wortmann</p>

<p>This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.</p>

<p>This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.</p>

<p>You should have received a copy of the GNU General Public License
along with this program.  If not, see <a href="https://www.gnu.org/licenses/">https://www.gnu.org/licenses/</a>.</p>
</div>

                        <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     esbmtk: A general purpose Earth Science box model toolkit</span>
<span class="sd">     Copyright (C), 2020 Ulrich G. Wortmann</span>

<span class="sd">     This program is free software: you can redistribute it and/or modify</span>
<span class="sd">     it under the terms of the GNU General Public License as published by</span>
<span class="sd">     the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">     (at your option) any later version.</span>

<span class="sd">     This program is distributed in the hope that it will be useful,</span>
<span class="sd">     but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="sd">     GNU General Public License for more details.</span>

<span class="sd">     You should have received a copy of the GNU General Public License</span>
<span class="sd">     along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># from pint import UnitRegistry</span>
<span class="kn">from</span> <span class="nn">numbers</span> <span class="kn">import</span> <span class="n">Number</span>
<span class="kn">from</span> <span class="nn">nptyping</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">array</span><span class="p">,</span> <span class="n">set_printoptions</span><span class="p">,</span> <span class="n">arange</span><span class="p">,</span> <span class="n">zeros</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="n">mean</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span><span class="p">,</span> <span class="n">copy</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">process_time</span>
<span class="kn">import</span> <span class="nn">numba</span>
<span class="kn">from</span> <span class="nn">numba.core</span> <span class="kn">import</span> <span class="n">types</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">njit</span><span class="p">,</span> <span class="n">prange</span>
<span class="kn">from</span> <span class="nn">numba.typed</span> <span class="kn">import</span> <span class="n">List</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">mpmath</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">builtins</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<span class="c1"># @njit()</span>
<span class="k">def</span> <span class="nf">get_imass</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the isotope masses from bulk mass and delta value.</span>
<span class="sd">    Arguments are m = mass, d= delta value, r = abundance ratio </span>
<span class="sd">    species</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">l</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1000.0</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">d</span> <span class="o">+</span> <span class="mf">1000.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span> <span class="o">+</span> <span class="mf">1000.0</span><span class="p">)</span>
    <span class="n">h</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">m</span> <span class="o">-</span> <span class="n">l</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">]</span>

<span class="c1"># @njit()</span>
<span class="k">def</span> <span class="nf">get_frac</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Calculate the effect of the istope fractionation factor alpha on</span>
<span class="sd">    the ratio between the light and heavy isotope.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">li</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="n">l</span> <span class="o">*</span> <span class="n">m</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">l</span> <span class="o">-</span> <span class="n">a</span> <span class="o">*</span> <span class="n">m</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span>
    <span class="n">hi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">m</span> <span class="o">-</span> <span class="n">li</span>  <span class="c1"># get the new heavy isotope value</span>
    <span class="k">return</span> <span class="n">li</span><span class="p">,</span> <span class="n">hi</span>

<span class="c1"># @njit()</span>
<span class="k">def</span> <span class="nf">get_flux_data</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Calculate the isotope masses from bulk mass and delta value.</span>
<span class="sd">    Arguments are m = mass, d= delta value, r = abundance ratio </span>
<span class="sd">    species. Unlike get_mass, this function returns the full array</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">l</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1000.0</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">d</span> <span class="o">+</span> <span class="mf">1000.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span> <span class="o">+</span> <span class="mf">1000.0</span><span class="p">)</span>
    <span class="n">h</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">m</span> <span class="o">-</span> <span class="n">l</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">m</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">d</span><span class="p">])</span>

<span class="c1"># @njit()</span>
<span class="k">def</span> <span class="nf">get_delta</span><span class="p">(</span><span class="n">l</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="p">[</span><span class="n">Float64</span><span class="p">]],</span> <span class="n">h</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="p">[</span><span class="n">Float64</span><span class="p">]],</span>
              <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="p">[</span><span class="n">Float64</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Calculate the delta from the mass of light and heavy isotope</span>
<span class="sd">     Arguments are l and h which are the masses of the light and</span>
<span class="sd">     heavy isotopes respectively, r = abundance ratio of the</span>
<span class="sd">     respective element. Note that this equation can result in a</span>
<span class="sd">     siginificant loss of precision (on the order of 1E-13). I</span>
<span class="sd">     therefore round the results to numbers largers 1E12 (otherwise a</span>
<span class="sd">     delta of zero may no longer be zero)</span>

<span class="sd">   &quot;&quot;&quot;</span>
    <span class="c1"># d = 1000 * (h / l - r) / r</span>
    <span class="n">d</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1E3</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span>
    <span class="k">return</span> <span class="n">d</span>

<span class="k">def</span> <span class="nf">add_to</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      add element e to list l, but check if the entry already exist. If so, throw</span>
<span class="sd">      exception. Otherwise add</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">e</span> <span class="ow">in</span> <span class="n">l</span><span class="p">):</span>  <span class="c1"># if not present, append element</span>
        <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_plot_layout</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simple function which selects a row, column layout based on the number of</span>
<span class="sd">    objects to display.  The expected argument is a reservoir object which</span>
<span class="sd">    contains the list of fluxes in the reservoir</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">noo</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># the reservoir is the fisrt object</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>  <span class="c1"># count numbert of fluxes</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">plot</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
            <span class="n">noo</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">ldf</span><span class="p">:</span>  <span class="c1"># count number of data fields</span>
        <span class="n">noo</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># noo = len(obj.lof) + 1  # number of objects in this reservoir</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">noo</span><span class="si">}</span><span class="s2"> subplots for </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> required&quot;</span><span class="p">)</span>

    <span class="n">size</span><span class="p">,</span> <span class="n">geo</span> <span class="o">=</span> <span class="n">plot_geometry</span><span class="p">(</span><span class="n">noo</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">size</span><span class="p">,</span> <span class="n">geo</span>


<span class="k">def</span> <span class="nf">plot_geometry</span><span class="p">(</span><span class="n">noo</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Define plot geometry based on number of objects to plot&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">noo</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># one row, one column</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># size in inches</span>
    <span class="k">elif</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">noo</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># two rows, one column</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>  <span class="c1"># size in inches</span>
    <span class="k">elif</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="n">noo</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># two rows, two columns</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>  <span class="c1"># size in inches</span>
    <span class="k">elif</span> <span class="mi">4</span> <span class="o">&lt;</span> <span class="n">noo</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># two rows, three columns</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>  <span class="c1"># size in inches</span>
    <span class="k">elif</span> <span class="mi">6</span> <span class="o">&lt;</span> <span class="n">noo</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># two rows, three columns</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>  <span class="c1"># size in inches</span>
    <span class="k">elif</span> <span class="mi">9</span> <span class="o">&lt;</span> <span class="n">noo</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">:</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># two rows, three columns</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">]</span>  <span class="c1"># size in inches</span>
    <span class="k">elif</span> <span class="mi">12</span> <span class="o">&lt;</span> <span class="n">noo</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">:</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># two rows, three columns</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">]</span>  <span class="c1"># size in inches</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;plot geometry for more than 15 fluxes is not yet defined&quot;</span>
            <span class="s2">&quot;Consider calling flux.plot individually on each flux in the reservoir&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">size</span><span class="p">,</span> <span class="n">geo</span>

<span class="k">def</span> <span class="nf">list_fluxes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Echo all fluxes in the reservoir to the screen</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">List of fluxes in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span> <span class="c1"># show the processes</span>
                  <span class="n">direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">n</span><span class="p">]</span>
                  <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">t1</span> <span class="o">=</span> <span class="s2">&quot;From:&quot;</span>
                        <span class="n">t2</span> <span class="o">=</span> <span class="s2">&quot;Outflux from&quot;</span>
                  <span class="k">else</span><span class="p">:</span>
                        <span class="n">t1</span> <span class="o">=</span> <span class="s2">&quot;To  :&quot;</span>   
                        <span class="n">t2</span> <span class="o">=</span> <span class="s2">&quot;Influx to&quot;</span>

                  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> </span><span class="si">{</span><span class="n">t2</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> via </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                  
                  <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span>
                        <span class="n">p</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
                  <span class="n">f</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="c1"># print out the flux data</span>

<span class="k">def</span> <span class="nf">show_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Print the 3 lines of the data starting with index</span>

<span class="sd">    Optional arguments:</span>
<span class="sd">    </span>
<span class="sd">    index :int = 0 starting index</span>
<span class="sd">    indent :int = 0 indentation </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">off</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>

    <span class="k">if</span> <span class="s2">&quot;index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">ind</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="s2">&quot; &quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ind</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># show the first 4 entries</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">3</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}{</span><span class="n">ind</span><span class="si">}</span><span class="s2">i = </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, Mass = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">, delta = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

<span class="k">def</span> <span class="nf">set_y_limits</span><span class="p">(</span><span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Prevent the display or arbitrarily small differences&quot;&quot;&quot;</span>
    <span class="n">lower</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">upper</span><span class="p">:</span> <span class="nb">float</span>

    <span class="n">bottom</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">top</span> <span class="o">-</span> <span class="n">bottom</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">obj</span><span class="o">.</span><span class="n">display_precision</span><span class="p">:</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">bottom</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">display_precision</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_ptype</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set plot type variable based on ptype or isotope keyword</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Flux</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">Signal</span><span class="p">,</span> <span class="n">DataField</span><span class="p">,</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Sink</span>

    <span class="n">ptype</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">Reservoir</span><span class="p">,</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Sink</span><span class="p">,</span> <span class="n">Flux</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="s2">&quot;ptype&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ptype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ptype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;iso&quot;</span><span class="p">:</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ptype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;concentration&quot;</span><span class="p">:</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ptype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;mass_only&quot;</span><span class="p">:</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">return</span> <span class="n">ptype</span>


<span class="k">def</span> <span class="nf">plot_object_data</span><span class="p">(</span><span class="n">geo</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;collection of commands which will plotqand annotate a reservoir or flux</span>
<span class="sd">    object into an existing plot window.</span>

<span class="sd">    geo: geometry info</span>
<span class="sd">    fn: figure number in plot</span>
<span class="sd">    obj: the object to plot</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>
    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Flux</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">Signal</span><span class="p">,</span> <span class="n">DataField</span><span class="p">,</span> <span class="n">Source</span>

    <span class="c1"># geo = list with rows and cols</span>
    <span class="c1"># fn  = figure number</span>
    <span class="c1"># yl  = array with y values for the left side</span>
    <span class="c1"># yr  = array with y values for the right side</span>
    <span class="c1"># obj = object handle, i.e., reservoir or flux</span>

    <span class="n">first_axis</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">second_axis</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">rows</span> <span class="o">=</span> <span class="n">geo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">geo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># species = obj.sp</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">mo</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">time</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">offset</span>

    <span class="c1"># convert data from model units to display units (i.e. the same</span>
    <span class="c1"># units the input data was defined).</span>
    <span class="c1"># time units are the same regardless of object</span>
    <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">d_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

    <span class="c1"># we do not map isotope values</span>
    <span class="n">yr</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">d</span>

    <span class="c1"># get plot type</span>
    <span class="n">ptype</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">get_ptype</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="c1"># remap concentration &amp; flux values</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Flux</span><span class="p">):</span>
        <span class="n">yl</span> <span class="o">=</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">plt_units</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">legend_left</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">plt_units</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">]&quot;</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">Reservoir</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">display_as</span> <span class="o">==</span> <span class="s2">&quot;mass&quot;</span><span class="p">:</span>
            <span class="n">yl</span> <span class="o">=</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">m_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">plt_units</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">legend_left</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">plt_units</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">]&quot;</span>

        <span class="k">elif</span> <span class="n">obj</span><span class="o">.</span><span class="n">plot_transform_c</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">plot_transform_c</span><span class="p">):</span>
                <span class="c1"># yl = (obj.m * model.m_unit).to(obj.plt_units).magnitude</span>
                <span class="n">yl</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">plot_transform_c</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
                <span class="n">y_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">legend_left</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;plot_transform_c must be function&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">yl</span> <span class="o">=</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">c</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">c_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">plt_units</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">legend_left</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">plt_units</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">]&quot;</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Signal</span><span class="p">):</span>
        <span class="c1"># use the same units as the associated flux</span>
        <span class="n">yl</span> <span class="o">=</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">plt_units</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">plt_units</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">]&quot;</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">DataField</span><span class="p">):</span>
        <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">d_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">yl</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">y1_data</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">y1_label</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">y2_data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># sources, sinks, external data should not show up here</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># decide what to plot</span>
    <span class="k">if</span> <span class="n">ptype</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">first_axis</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">second_axis</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">ptype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">first_axis</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">second_axis</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">ptype</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">first_axis</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">second_axis</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># start subplot</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>

    <span class="c1"># set color index</span>
    <span class="n">cn</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">cn</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">first_axis</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">DataField</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">y1_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">y1_data</span><span class="p">):</span>  <span class="c1"># loop over datafield list</span>
                    <span class="n">yl</span> <span class="o">=</span> <span class="n">d</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">y1_legend</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">ln1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">yl</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                    <span class="n">cn</span> <span class="o">=</span> <span class="n">cn</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">cn</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">time_label</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">d_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>
                <span class="c1"># remove unnecessary frame species</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">set_y_limits</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">ln1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">yl</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">y_label</span><span class="p">)</span>
            <span class="n">cn</span> <span class="o">=</span> <span class="n">cn</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">cn</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">time_label</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">d_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>
            <span class="c1"># remove unnecessary frame species</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">set_y_limits</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">second_axis</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">DataField</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">y2_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">common_y_scale</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">y2_data</span><span class="p">):</span>  <span class="c1"># loop over datafield list</span>
                        <span class="n">yl</span> <span class="o">=</span> <span class="n">d</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">y2_legend</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">ln1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">yl</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                        <span class="n">cn</span> <span class="o">=</span> <span class="n">cn</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="n">col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">cn</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">set_y_limits</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
                        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                        <span class="n">second_axis</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>  <span class="c1"># create a second y-axis</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">y2_data</span><span class="p">):</span>  <span class="c1"># loop over datafield list</span>
                        <span class="n">yl</span> <span class="o">=</span> <span class="n">d</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">y2_legend</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">ln1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">yl</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                        <span class="n">cn</span> <span class="o">=</span> <span class="n">cn</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="n">col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">cn</span><span class="si">}</span><span class="s2">&quot;</span>

                    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">ld</span><span class="p">)</span>  <span class="c1"># species object delta label</span>
                    <span class="n">set_y_limits</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
                    <span class="c1"># remove unneeded frame</span>
                    <span class="n">ax2</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">second_axis</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Signal</span><span class="p">):</span>
            <span class="c1"># use the same units as the associated flux</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>  <span class="c1"># create a second y-axis</span>
            <span class="c1"># plof right y-scale data</span>
            <span class="n">ln2</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">legend_right</span>
            <span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ld</span><span class="p">)</span>  <span class="c1"># species object delta label</span>
            <span class="n">set_y_limits</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># remove unnecessary frame speciess</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>  <span class="c1"># create a second y-axis</span>
            <span class="c1"># plof right y-scale data</span>
            <span class="n">ln2</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">yr</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">legend_right</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">ld</span><span class="p">)</span>  <span class="c1"># species object delta label</span>
            <span class="n">set_y_limits</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># remove unnecessary frame speciess</span>

    <span class="c1"># adjust display properties for title and legend</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">Reservoir</span><span class="p">)):</span>
        <span class="c1"># ax1.set_title(obj.pt)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.titlepad&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">14</span>  <span class="c1"># offset title upwards</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;legend.facecolor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0.8&quot;</span>  <span class="c1"># show a gray background</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;legend.edgecolor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0.8&quot;</span>  <span class="c1"># make frame the same color</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;legend.framealpha&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.4</span>  <span class="c1"># set transparency</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">led</span><span class="p">:</span>  <span class="c1"># loop over external data objects if present</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># if string, something is off</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No time axis in external data object </span><span class="si">{d.name}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;y&quot;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>  <span class="c1"># mass or concentration data is present</span>
            <span class="n">cn</span> <span class="o">=</span> <span class="n">cn</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">cn</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">leg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">lm</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">legend</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">ln3</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">d</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">leg</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;z&quot;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="ow">and</span> <span class="n">second_axis</span><span class="p">:</span>  <span class="c1"># isotope data is present</span>
            <span class="n">cn</span> <span class="o">=</span> <span class="n">cn</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">cn</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">leg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">legend</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">ln3</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">leg</span><span class="p">)</span>

    <span class="c1"># collect all labels and print them in one legend</span>
    <span class="k">if</span> <span class="n">first_axis</span><span class="p">:</span>
        <span class="n">handler1</span><span class="p">,</span> <span class="n">label1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">second_axis</span><span class="p">:</span>
        <span class="n">handler2</span><span class="p">,</span> <span class="n">label2</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">first_axis</span> <span class="ow">and</span> <span class="n">second_axis</span><span class="p">:</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handler1</span> <span class="o">+</span> <span class="n">handler2</span><span class="p">,</span> <span class="n">label1</span> <span class="o">+</span> <span class="n">label2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    <span class="c1"># elif first_axis:</span>
    <span class="c1">#    legend = ax1.legend(handler1 + label1, loc=0).set_zorder(6)</span>
    <span class="c1"># elif second_axis:</span>
    <span class="c1">#   legend = ax2.legend(handler2 + label2, loc=0).set_zorder(6)</span>

    <span class="c1"># Matplotlib will show arbitrarily small differences which can be confusing</span>
    <span class="c1"># yl_min = min(yl)</span>
    <span class="c1"># yl_max = max(yl)</span>
    <span class="c1"># if (yl_max - yl_min) &lt; 0.1:</span>

<span class="k">def</span> <span class="nf">is_name_in_list</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test if an object name is part of the object list&quot;&quot;&quot;</span>

    <span class="n">r</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">full_name</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">r</span>


<span class="k">def</span> <span class="nf">get_object_from_list</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">any</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Match a name to a list of objects. Return the object&quot;&quot;&quot;</span>

    <span class="n">match</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">full_name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">o</span>
            <span class="n">match</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">r</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Object = </span><span class="si">{</span><span class="n">o</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> has no matching flux </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">sort_by_type</span><span class="p">(</span><span class="n">l</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;divide a list by type into new lists. This function will return a</span>
<span class="sd">    list and it is up to the calling code to unpack the list</span>

<span class="sd">    l is list with various object types</span>
<span class="sd">    t is a list which contains the object types used for sorting</span>
<span class="sd">    m is a string for the error function</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#from numbers import Number</span>

    <span class="n">lc</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">rl</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">ot</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>  <span class="c1"># loop over object types</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>  <span class="c1"># loop over list elements</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ot</span><span class="p">):</span>
                <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>  <span class="c1"># add to temporary list</span>
                <span class="n">lc</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>  <span class="c1"># remove this element</span>

        <span class="n">rl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>  <span class="c1"># save the temporary list to rl</span>

    <span class="c1"># at this point, all elements of lc should have been processed</span>
    <span class="c1"># if not, lc contains element which are of a different type</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rl</span>

<span class="k">def</span> <span class="nf">split_key</span><span class="p">(</span><span class="n">k</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;split the string k with letter 2, and test if optional</span>
<span class="sd">    id string is present</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;2&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sinkandid</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Name must follow &#39;Source2Sink&#39; format&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;@&quot;</span> <span class="ow">in</span> <span class="n">sinkandid</span><span class="p">:</span>
        <span class="n">sink</span> <span class="o">=</span> <span class="n">sinkandid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cid</span> <span class="o">=</span> <span class="n">sinkandid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sink</span> <span class="o">=</span> <span class="n">sinkandid</span>
        <span class="n">cid</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">sink</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">dmo</span><span class="p">[</span><span class="n">sink</span><span class="p">]</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">dmo</span><span class="p">[</span><span class="n">source</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="n">cid</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">make_dict</span><span class="p">(</span><span class="n">keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Create a dictionary from a list and value, or from</span>
<span class="sd">    two lists</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
            <span class="n">d</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;len values =</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="si">}</span><span class="s2">, len keys =</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;values = </span><span class="si">{</span><span class="n">values</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;key = </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;key and value list must be of equal length&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">values</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
        <span class="n">d</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">d</span>

<span class="k">def</span> <span class="nf">get_typed_list</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>

    <span class="n">tl</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">tl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tl</span>

<span class="k">def</span> <span class="nf">create_reservoirs</span><span class="p">(</span><span class="n">bn</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">ic</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="n">cs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;boxes are defined by area and depth interval here we use an ordered</span>
<span class="sd">    dictionary to define the box geometries. The next column is temperature</span>
<span class="sd">    in deg C, followed by pressure in bar</span>
<span class="sd">    the geometry is [upper depth datum, lower depth datum, area percentage]</span>

<span class="sd">    bn = dictionary with box parameters</span>
<span class="sd">    bn: dict = {  # name: [[geometry], T, P]</span>
<span class="sd">                 &quot;sb&quot;: {&quot;g&quot;: [0, 200, 0.9], &quot;T&quot;: 20, &quot;P&quot;: 5},</span>
<span class="sd">                 &quot;ib&quot;: {&quot;g&quot;: [200, 1200, 1], &quot;T&quot;: 10, &quot;P&quot;: 100},</span>
<span class="sd">                }</span>

<span class="sd">    ic = dictionary with species default values. This is used to et up</span>
<span class="sd">         initial conditions. Here we use shortcut and use the same conditions</span>
<span class="sd">         in each box. If you need box specific initial conditions</span>
<span class="sd">         use the output of build_concentration_dicts as starting point</span>


<span class="sd">    ic: dict = { # species: concentration, Isotopes</span>
<span class="sd">                   PO4: [Q_(&quot;2.1 * umol/liter&quot;), False],</span>
<span class="sd">                   DIC: [Q_(&quot;2.1 mmol/liter&quot;), False],</span>
<span class="sd">                   ALK: [Q_(&quot;2.43 mmol/liter&quot;), False],</span>
<span class="sd">               }</span>

<span class="sd">    M: Model object handle</span>

<span class="sd">    cs: add virtual reservoir for the carbonate system. Defaults to False</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">SeawaterConstants</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">build_concentration_dicts</span>
    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span><span class="p">,</span> <span class="n">carbonate_system</span><span class="p">,</span> <span class="n">Q_</span>

    <span class="c1"># parse for sources and sinks, create these and remove them from the list</span>

    <span class="c1"># setup the remaining boxes</span>
    <span class="c1"># icd: dict = build_concentration_dicts(ic, bn)</span>

    <span class="c1"># loop over reservoir names</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">bn</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="s2">&quot;ty&quot;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>  <span class="c1"># type is given</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;ty&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Source&quot;</span><span class="p">:</span>
                <span class="n">SourceGroup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;sp&quot;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;ty&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Sink&quot;</span><span class="p">:</span>
                <span class="n">SinkGroup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;sp&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;ty&#39; must be either Source or Sink&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># create reservoirs</span>
            <span class="n">icd</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">build_concentration_dicts</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="n">swc</span> <span class="o">=</span> <span class="n">SeawaterConstants</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;SW_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">model</span><span class="o">=</span><span class="n">M</span><span class="p">,</span>
                <span class="n">temperature</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">],</span>
                <span class="n">pressure</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;P&quot;</span><span class="p">],</span>
            <span class="p">)</span>

            <span class="n">rg</span> <span class="o">=</span> <span class="n">ReservoirGroup</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                <span class="n">geometry</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;g&quot;</span><span class="p">],</span>
                <span class="n">concentration</span><span class="o">=</span><span class="n">icd</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">isotopes</span><span class="o">=</span><span class="n">icd</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">delta</span><span class="o">=</span><span class="n">icd</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">cs</span><span class="p">:</span>
                <span class="n">volume</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rg</span><span class="o">.</span><span class="n">lor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">volume</span><span class="si">}</span><span class="s2"> l&quot;</span><span class="p">)</span>
                <span class="n">carbonate_system</span><span class="p">(</span>
                    <span class="n">Q_</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">swc</span><span class="o">.</span><span class="n">ca</span><span class="si">}</span><span class="s2"> mol/l&quot;</span><span class="p">),</span>
                    <span class="n">Q_</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">swc</span><span class="o">.</span><span class="n">hplus</span><span class="si">}</span><span class="s2"> mol/l&quot;</span><span class="p">),</span>
                    <span class="n">volume</span><span class="p">,</span>
                    <span class="n">swc</span><span class="p">,</span>
                    <span class="n">rg</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="k">return</span> <span class="n">icd</span>


<span class="k">def</span> <span class="nf">build_concentration_dicts</span><span class="p">(</span><span class="n">cd</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">bg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Build a dict which can be used by create_reservoirs</span>

<span class="sd">    bg : dict where the box_names are dict keys.</span>
<span class="sd">    cd: dictionary with the following format:</span>
<span class="sd">        cd = {</span>
<span class="sd">             # species: [concentration, isotopes]</span>
<span class="sd">             PO4: [Q_(&quot;2.1 * umol/liter&quot;), False],</span>
<span class="sd">             DIC: [Q_(&quot;2.1 mmol/liter&quot;), False],</span>
<span class="sd">            }</span>

<span class="sd">    This function returns a new dict in the following format</span>

<span class="sd">    #  box_names: [concentrations, isotopes]</span>
<span class="sd">    d= {&quot;bn&quot;: [{PO4: .., DIC: ..},{PO4:False, DIC:False}]}</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">box_names</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">box_names</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">bg</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">box_names</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="n">bg</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;This should never happen&quot;</span><span class="p">)</span>

    <span class="n">icd</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="n">td1</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># temp dictionary</span>
    <span class="n">td2</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># temp dictionary</span>
    <span class="n">td3</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># temp dictionary</span>

    <span class="c1"># create the dicts for concentration and isotopes</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">td1</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>
        <span class="n">td2</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]})</span>
        <span class="n">td3</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]})</span>

    <span class="c1"># box_names: list = bg.keys()</span>
    <span class="k">for</span> <span class="n">bn</span> <span class="ow">in</span> <span class="n">box_names</span><span class="p">:</span>  <span class="c1"># loop over box names</span>
        <span class="n">icd</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">bn</span><span class="p">:</span> <span class="p">[</span><span class="n">td1</span><span class="p">,</span> <span class="n">td2</span><span class="p">,</span> <span class="n">td3</span><span class="p">]})</span>

    <span class="k">return</span> <span class="n">icd</span>


<span class="k">def</span> <span class="nf">calc_volumes</span><span class="p">(</span><span class="n">bg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="n">h</span><span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate volume contained in a given depth interval</span>
<span class="sd">    bg is an ordered dictionary in the following format</span>

<span class="sd">    bg=  {</span>
<span class="sd">          &quot;hb&quot;: (0.1, 0, 200),</span>
<span class="sd">          &quot;sb&quot;: (0.9, 0, 200),</span>
<span class="sd">         }</span>

<span class="sd">    where the key must be a valid box name, the first entry of the list denoted</span>
<span class="sd">    the areal extent in percent, the second number is upper depth limit, and last</span>
<span class="sd">    number is the lower depth limit.</span>

<span class="sd">    M must be a model handle</span>
<span class="sd">    h is the hypsometry handle</span>

<span class="sd">    The function returns a list with the corresponding volumes</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># from esbmtk import hypsometry</span>

    <span class="n">v</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of volumes</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">bg</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">volume</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">v</span>

<span class="k">def</span> <span class="nf">get_longest_dict_entry</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Get length of each item in the connection dict&quot;&quot;&quot;</span>
    <span class="n">l_length</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># length of  longest list</span>
    <span class="n">p_length</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># length of single parameter</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">l_length</span><span class="p">:</span>
                <span class="n">l_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_length</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">l_length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p_length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">case</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Only lists present</span>
    <span class="k">if</span> <span class="n">l_length</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p_length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">case</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1">#  Only parameters present</span>
    <span class="k">if</span> <span class="n">l_length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p_length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">case</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1">#  Lists and parameters present</span>

    <span class="k">return</span> <span class="n">case</span><span class="p">,</span> <span class="n">l_length</span>


<span class="k">def</span> <span class="nf">convert_to_lists</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;expand mixed dict entries (i.e. list and single value) such</span>
<span class="sd">    that they are all lists of equal length</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cd</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
                <span class="n">p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>

    <span class="k">return</span> <span class="n">d</span>


<span class="k">def</span> <span class="nf">get_sub_key</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;take a dict which has where the value is a list, and return the</span>
<span class="sd">    key with the n-th value of that list</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">rd</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">rd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">rd</span>


<span class="k">def</span> <span class="nf">expand_dict</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">mt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1:1&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;Determine dict structure</span>

<span class="sd">    in case we have mutiple connections with mutiple species, the</span>
<span class="sd">    default action is to map connections to species (t = &#39;1:1&#39;). If</span>
<span class="sd">    you rather want to create mutiple connections (one for each</span>
<span class="sd">    species) in each connection set t = &#39;1:N&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># loop over dict entries</span>
    <span class="c1"># ck = connection key</span>
    <span class="c1"># cd = connection dict</span>

    <span class="n">r</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># the dict we will return</span>

    <span class="k">for</span> <span class="n">ck</span><span class="p">,</span> <span class="n">cd</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># loop over connections</span>

        <span class="n">rd</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># temp dict</span>
        <span class="n">nd</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># temp dict</span>
        <span class="n">case</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="n">get_longest_dict_entry</span><span class="p">(</span><span class="n">cd</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ck</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="c1"># assume 1:1 mapping between tuple and connection parameters</span>
            <span class="k">if</span> <span class="n">mt</span> <span class="o">==</span> <span class="s2">&quot;1:1&quot;</span><span class="p">:</span>

                <span class="c1"># prep dictionaries</span>
                <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">nd</span> <span class="o">=</span> <span class="n">cd</span>
                    <span class="c1"># print(&quot;case 0&quot;)</span>
                <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># only parameters present. Expand for each tuple entry</span>
                    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ck</span><span class="p">)</span>
                    <span class="n">nd</span> <span class="o">=</span> <span class="n">convert_to_lists</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
                    <span class="c1"># print(&quot;case 1&quot;)</span>
                <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># mixed list present, Expand list</span>
                    <span class="c1"># print(f&quot;case 2, length = {length}&quot;)</span>
                    <span class="n">nd</span> <span class="o">=</span> <span class="n">convert_to_lists</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
                    <span class="c1"># print(nd)</span>

                <span class="c1"># for each connection group in the tuple</span>
                <span class="k">if</span> <span class="n">length</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ck</span><span class="p">):</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;The number of connection properties (</span><span class="si">{</span><span class="n">length</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;does not match the number of connection groups (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ck</span><span class="p">)</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;did you intend to do a 1:N mapping?&quot;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

                <span class="c1"># map property dicts to connection group names</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ck</span><span class="p">:</span>
                    <span class="n">rd</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_sub_key</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="k">elif</span> <span class="n">mt</span> <span class="o">==</span> <span class="s2">&quot;1:N&quot;</span><span class="p">:</span>  <span class="c1"># apply each species to each connection</span>
                <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">nd</span> <span class="o">=</span> <span class="n">cd</span>
                <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># only parameters present. Expand for each tuple entry</span>
                    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ck</span><span class="p">)</span>
                    <span class="n">nd</span> <span class="o">=</span> <span class="n">convert_to_lists</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># mixed list present, Expand list</span>
                    <span class="n">nd</span> <span class="o">=</span> <span class="n">convert_to_lists</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ck</span><span class="p">:</span>  <span class="c1"># apply the entire nd dict to all connections</span>
                    <span class="n">rd</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">nd</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mt</span><span class="si">}</span><span class="s2"> is not defined. must be &#39;1:1&#39; or &#39;1:N&#39;&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># only lists present, case 3</span>
                <span class="n">nd</span> <span class="o">=</span> <span class="n">cd</span>
            <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># only parameters present</span>
                <span class="n">nd</span> <span class="o">=</span> <span class="n">cd</span>
            <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># list and parameters present case 4</span>
                <span class="n">nd</span> <span class="o">=</span> <span class="n">convert_to_lists</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
            <span class="n">rd</span><span class="p">[</span><span class="n">ck</span><span class="p">]</span> <span class="o">=</span> <span class="n">nd</span>

        <span class="c1"># update the overall dict and move to the next entry</span>
        <span class="n">r</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rd</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">r</span>


<span class="k">def</span> <span class="nf">create_bulk_connections</span><span class="p">(</span><span class="n">ct</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="n">mt</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="s2">&quot;1:1&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Create connections from a dictionary. The dict can have the following keys</span>
<span class="sd">    following format:</span>

<span class="sd">    mt = mapping type. See below for explanation</span>

<span class="sd">    # na: names, tuple or str. If lists, all list elements share the same properties</span>
<span class="sd">    # sp: species list or species</span>
<span class="sd">    # ty: type, str</span>
<span class="sd">    # ra: rate, Quantity</span>
<span class="sd">    # sc: scale, Number</span>
<span class="sd">    # re: reference, optional</span>
<span class="sd">    # al: alpha, optional</span>
<span class="sd">    # de: delta, optional</span>
<span class="sd">    # mx: True, optional defaults to False. If set, it will create forward</span>
<span class="sd">          and backward fluxes (i.e. mixing)</span>

<span class="sd">    There are 6 different cases how to specify connections</span>

<span class="sd">    Case 1 One connection, one set of parameters</span>
<span class="sd">           ct1 = {&quot;sb2hb&quot;: {&quot;ty&quot;: &quot;scale&quot;, &#39;ra&#39;....}}</span>

<span class="sd">    Case 2 One connection, one set of instructions, one subset with mutiple parameters</span>
<span class="sd">           This will be expanded to create connections for each species</span>
<span class="sd">           ct2 = {&quot;sb2hb&quot;: {&quot;ty&quot;: &quot;scale&quot;, &quot;sp&quot;: [&quot;a&quot;, &quot;b&quot;]}}</span>

<span class="sd">    Case 3 One connection complete set of mutiple characters. Similar to case 2, but now</span>
<span class="sd">           all parameters are given explicitly</span>
<span class="sd">           ct3 = {&quot;sb2hb&quot;: {&quot;ty&quot;: [&quot;scale&quot;, &quot;scale&quot;], &quot;sp&quot;: [&quot;a&quot;, &quot;b&quot;]}}</span>

<span class="sd">    Case 4 Mutiple connections, one set of parameters. This will create</span>
<span class="sd">           identical connection for &quot;sb2hb&quot; and  &quot;ib2db&quot;</span>
<span class="sd">           ct4 = {(&quot;sb2hb&quot;, &quot;ib2db&quot;): {&quot;ty&quot;: &quot;scale&quot;, &#39;ra&#39;: ...}}</span>

<span class="sd">    Case 5 Mutiple connections, one subset of mutiple set of parameters. This wil</span>
<span class="sd">          create a connection for species &#39;a&#39; in sb2hb and with species &#39;b&#39; in ib2db</span>
<span class="sd">           ct5 = {(&quot;sb2hb&quot;, &quot;ib2db&quot;): {&quot;ty&quot;: &quot;scale&quot;, &quot;sp&quot;: [&quot;a&quot;, &quot;b&quot;]}}</span>

<span class="sd">    Case 6 Mutiple connections, complete set of parameters of mutiple parameters</span>
<span class="sd">           Same as case 5, but now all parameters are specified explicitly</span>
<span class="sd">           ct6 = {(&quot;sb2hb&quot;, &quot;ib2db&quot;): {&quot;ty&quot;: [&quot;scale&quot;, &quot;scale&quot;], &quot;sp&quot;: [&quot;a&quot;, &quot;b&quot;]}}</span>


<span class="sd">    The default interpretation for cases 5 and 6 is that each list</span>
<span class="sd">    entry corresponds to connection. However, sometimes we want to</span>
<span class="sd">    create mutiple connections for multiple entries. In this case</span>
<span class="sd">    provide the mt=&#39;1:N&#39; parameter which will create a connection for</span>
<span class="sd">    each species in each connection group. See the below example.</span>

<span class="sd">    It is easy to shoot yourself in the foot. It is best to try the above first with</span>
<span class="sd">    some simple examples, e.g.,</span>

<span class="sd">    from esbmtk import expand_dict</span>
<span class="sd">    ct2 = {&quot;sb2hb&quot;: {&quot;ty&quot;: &quot;scale&quot;, &quot;sp&quot;: [&quot;a&quot;, &quot;b&quot;]}}</span>
<span class="sd">    print(expand_dict(ct2))</span>

<span class="sd">    The below example specifies 3 connection groups which share the rate, and connection type.</span>
<span class="sd">    However, the default mapping is 1:1 so this will fail. You need to explicitly set</span>
<span class="sd">    mt=&quot;1:N&quot;</span>
<span class="sd">    Each connection group comprises the species named in the species list, so this will create</span>
<span class="sd">    a total of 3 x 2 = 6 connections</span>

<span class="sd">    from esbmtk import expand_dict, Q_</span>

<span class="sd">    sl: list = [&#39;PO4&#39;, &#39;DIC&#39;]  # get species list</span>
<span class="sd">    ct = {  # thermohaline circulation</span>
<span class="sd">            # Apply to all boxes in the tuple</span>
<span class="sd">         (&quot;hb2db@thc&quot;, &quot;db2ib@thc&quot;, &quot;ib2hb@thc&quot;): {</span>
<span class="sd">          &quot;ty&quot;: &quot;scale_with_concentration&quot;,</span>
<span class="sd">          &quot;sp&quot;: sl,  # species list</span>
<span class="sd">          &quot;ra&quot;: Q_(&#39;20*Sv&#39;),</span>
<span class="sd">         }</span>

<span class="sd">    create_bulk_connections(ct, M, mt=&quot;1:N&quot;)</span>

<span class="sd">    will create a connection for each species in each connectiongroup and all of these connections</span>
<span class="sd">    share the same properties</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">create_connection</span><span class="p">,</span> <span class="n">expand_dict</span>

    <span class="c1"># expand dictionary into a well formed dict where each connection</span>
    <span class="c1"># has a fully formed entry</span>
    <span class="n">c_ct</span> <span class="o">=</span> <span class="n">expand_dict</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">mt</span><span class="o">=</span><span class="n">mt</span><span class="p">)</span>

    <span class="c1"># loop over dict entries and create the respective connections</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">c_ct</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="c1"># loop over names in tuple</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                <span class="n">create_connection</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">create_connection</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">connection</span><span class="si">}</span><span class="s2"> must be string or tuple&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ct</span>


<span class="k">def</span> <span class="nf">create_connection</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;called by create_bulk_connections in order to create a connection</span>
<span class="sd">    group It is assumed that all rates are in liter/year or mol per</span>
<span class="sd">    year. This may not be what you want or need.</span>

<span class="sd">    You need to provide a connection key e.g., sb2db@mix which will be</span>
<span class="sd">    interpreted as mixing a connection between sb and db and thus</span>
<span class="sd">    create connections in both directions</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="n">Q_</span>

    <span class="c1"># get the reservoir handles by splitting the key</span>
    <span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="n">cid</span> <span class="o">=</span> <span class="n">split_key</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>

    <span class="c1"># create default connections parameters and replace with values in</span>
    <span class="c1"># the parameter dict if present.</span>
    <span class="n">los</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;sp&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;sp&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;sp&quot;</span><span class="p">]]</span>
    <span class="n">typ</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;ty&quot;</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;ty&quot;</span><span class="p">]</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;sc&quot;</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;sc&quot;</span><span class="p">]</span>
    <span class="n">rate</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="s2">&quot;0 mol/a&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;ra&quot;</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span>
    <span class="n">ref</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;re&quot;</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;re&quot;</span><span class="p">]</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;al&quot;</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;al&quot;</span><span class="p">]</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;de&quot;</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;de&quot;</span><span class="p">]</span>
    <span class="n">mix</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;mx&quot;</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;mx&quot;</span><span class="p">]</span>
    <span class="n">cid</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cid</span><span class="si">}</span><span class="s2">_f&quot;</span> <span class="k">if</span> <span class="n">mix</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cid</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">Q_</span><span class="p">):</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;l/a&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

    <span class="c1"># if name in M.dmo: # group already exist in this case we nee to update the</span>
    <span class="c1"># connection group</span>

    <span class="c1"># Case one, no mixing, test if exist, otherwise create</span>
    <span class="c1"># Case 2, mixing: test if forward connection exists, if not create</span>
    <span class="c1">#                  test if backwards connection exists, or create</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">mix</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;C_</span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">2</span><span class="si">{</span><span class="n">sink</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">update_or_create</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="n">los</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">M</span>
        <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># this is a connection with mixing</span>
        <span class="c1"># create forward connection</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;C_</span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">2</span><span class="si">{</span><span class="n">sink</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">update_or_create</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="n">los</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">M</span>
        <span class="p">)</span>

        <span class="c1"># create backwards connection</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;C_</span><span class="si">{</span><span class="n">sink</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">2</span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">cid</span> <span class="o">=</span> <span class="n">cid</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_f&quot;</span><span class="p">,</span> <span class="s2">&quot;_b&quot;</span><span class="p">)</span>
        <span class="n">update_or_create</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">los</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">M</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">update_or_create</span><span class="p">(</span>
    <span class="n">name</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="n">los</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">M</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create or update connection&quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">ConnectionGroup</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">M</span><span class="o">.</span><span class="n">dmo</span><span class="p">:</span>  <span class="c1"># update connection</span>
        <span class="n">cg</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">dmo</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">cg</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
            <span class="n">sink</span><span class="o">=</span><span class="n">sink</span><span class="p">,</span>
            <span class="n">ctype</span><span class="o">=</span><span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">typ</span><span class="p">),</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">scale</span><span class="p">),</span>  <span class="c1"># get rate from dictionary</span>
            <span class="n">rate</span><span class="o">=</span><span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">rate</span><span class="p">),</span>
            <span class="n">ref</span><span class="o">=</span><span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">ref</span><span class="p">),</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">alpha</span><span class="p">),</span>
            <span class="n">delta</span><span class="o">=</span><span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">delta</span><span class="p">),</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">cid</span><span class="p">,</span>  <span class="c1"># get id from dictionary</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># create connection</span>
        <span class="n">cg</span> <span class="o">=</span> <span class="n">ConnectionGroup</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
            <span class="n">sink</span><span class="o">=</span><span class="n">sink</span><span class="p">,</span>
            <span class="n">ctype</span><span class="o">=</span><span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">typ</span><span class="p">),</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">scale</span><span class="p">),</span>  <span class="c1"># get rate from dictionary</span>
            <span class="n">rate</span><span class="o">=</span><span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">rate</span><span class="p">),</span>
            <span class="n">ref</span><span class="o">=</span><span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">ref</span><span class="p">),</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">alpha</span><span class="p">),</span>
            <span class="n">delta</span><span class="o">=</span><span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">delta</span><span class="p">),</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">cid</span><span class="p">,</span>  <span class="c1"># get id from dictionary</span>
        <span class="p">)</span>

<span class="k">def</span> <span class="nf">execute</span><span class="p">(</span>
    <span class="n">new</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float64</span><span class="p">],</span>
    <span class="n">time</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float64</span><span class="p">],</span>
    <span class="n">lor</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">lpc_f</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">lpc_r</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;This is the original object oriented solver&quot;&quot;&quot;</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># some processes refer to the previous time step</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># loop over the time vector except the first</span>
        <span class="c1"># we first need to calculate all fluxes</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">lor</span><span class="p">:</span>  <span class="c1"># loop over all reservoirs</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span>  <span class="c1"># loop over reservoir processes</span>
                <span class="n">p</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>  <span class="c1"># update fluxes</span>

        <span class="c1"># update all process based fluxes. This can be done in a global lpc list</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">lpc_f</span><span class="p">:</span>
            <span class="n">p</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># and then update all reservoirs</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">lor</span><span class="p">:</span>  <span class="c1"># loop over all reservoirs</span>
            <span class="n">flux_list</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span>

            <span class="n">new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flux_list</span><span class="p">:</span>  <span class="c1"># do sum of fluxes in this reservoir</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
                <span class="n">new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">direction</span>  <span class="c1"># current flux and direction</span>
                <span class="n">new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">direction</span>  <span class="c1"># current flux and direction</span>
                <span class="c1">#new[2] = new[2] + f.h[i] * direction  # current flux and direction</span>

            <span class="c1"># print(f&quot;fsum = {new[0]:.2e}&quot;)</span>
            <span class="c1"># new = array([ms, ls, hs])</span>
            <span class="n">new</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># new[3] = delta will be set by the setitem method in the reserevoir</span>
            <span class="c1"># ditto for the concentration</span>
            <span class="n">new</span> <span class="o">=</span> <span class="n">new</span> <span class="o">*</span> <span class="n">r</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span>  <span class="c1"># get flux / timestep</span>
            <span class="c1">#print(f&quot;{i} new = {new}, dt = {r.mo.dt}&quot;)</span>
            <span class="n">new</span> <span class="o">=</span> <span class="n">new</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># add to data from last time step</span>
            <span class="n">new</span> <span class="o">=</span> <span class="n">new</span> <span class="o">*</span> <span class="p">(</span><span class="n">new</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># set negative values to zero</span>
            <span class="c1"># print(f&quot;updating {r.full_name} from {r.m[i]:.2e}&quot;)</span>
            <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>  <span class="c1"># update reservoir data</span>
            <span class="c1"># print(f&quot;to  {r.m[i]:.2e}\n&quot;)</span>

        <span class="c1"># update reservoirs which do not depend on fluxes but on</span>
        <span class="c1"># functions</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">lpc_r</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">act_on</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">execute_h</span><span class="p">(</span>
    <span class="n">new</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float64</span><span class="p">],</span>
    <span class="n">time</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float64</span><span class="p">],</span>
    <span class="n">lor</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">lpc_f</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">lpc_r</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;Moved this code into a separate function to enable numba optimization&quot;&quot;&quot;</span>

    <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># processes refer to the previous time step -&gt; start at 1</span>
    <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">lor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span>
    <span class="n">ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">lor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span>
    <span class="n">ratio</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">build_flux_lists_all</span><span class="p">(</span><span class="n">lor</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># loop over the time vector except the first</span>
        <span class="c1"># we first need to calculate all fluxes</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">lor</span><span class="p">:</span>  <span class="c1"># loop over all reservoirs</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span>  <span class="c1"># loop over reservoir processes</span>
                <span class="n">p</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>  <span class="c1"># update fluxes</span>

        <span class="c1"># update all process based fluxes. This can be done in a global lpc list</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">lpc_f</span><span class="p">:</span>
            <span class="n">p</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">summarize_fluxes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>

        <span class="c1"># update reservoirs which do not depend on fluxes but on</span>
        <span class="c1"># functions</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">lpc_r</span><span class="p">:</span>
            <span class="n">p</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># next time step</span>


<span class="k">def</span> <span class="nf">execute_n</span><span class="p">(</span>
    <span class="n">new</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float64</span><span class="p">],</span>
    <span class="n">time</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float64</span><span class="p">],</span>
    <span class="n">lor</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">lpc_f</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">lpc_r</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;Moved this code into a separate function to enable numba optimization&quot;&quot;&quot;</span>
    <span class="c1"># config.THREADING_LAYER = &quot;threadsafe&quot;</span>
    <span class="c1"># numba.set_num_threads(2)</span>

    <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># processes refer to the previous time step -&gt; start at 1</span>
    <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">lor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span>
    <span class="n">ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">lor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span>
    <span class="n">ratio</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">fn_vr</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">a5</span><span class="p">,</span> <span class="n">a6</span><span class="p">,</span> <span class="n">a7</span> <span class="o">=</span> <span class="n">build_vr_list</span><span class="p">(</span><span class="n">lpc_r</span><span class="p">)</span>
    <span class="n">fn</span><span class="p">,</span> <span class="n">rd</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">pc</span> <span class="o">=</span> <span class="n">build_process_list</span><span class="p">(</span><span class="n">lor</span><span class="p">)</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">build_flux_lists_all</span><span class="p">(</span><span class="n">lor</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># loop over the time vector except the first</span>
        <span class="c1"># update_fluxes for each reservoir</span>
        <span class="n">update_fluxes</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">rd</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

        <span class="c1"># update all process based fluxes. This can be done in a global lpc list</span>
        <span class="c1"># for p in lpc_f:</span>
        <span class="c1">#    p(i)</span>

        <span class="c1"># calculate the resulting reservoir concentrations</span>
        <span class="n">summarize_fluxes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>

        <span class="c1"># update reservoirs which do not depend on fluxes but on</span>
        <span class="c1"># functions</span>
        <span class="c1"># calc_v_reservoir_data()</span>
        <span class="n">update_virtual_reservoirs</span><span class="p">(</span><span class="n">fn_vr</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">a5</span><span class="p">,</span> <span class="n">a6</span><span class="p">,</span> <span class="n">a7</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># next time step</span>


<span class="k">def</span> <span class="nf">execute_e</span><span class="p">(</span>
    <span class="n">new</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float64</span><span class="p">],</span>
    <span class="n">time_array</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float64</span><span class="p">],</span>
    <span class="n">lor</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">lpc_f</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">lpc_r</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;Moved this code into a separate function to enable numba optimization&quot;&quot;&quot;</span>
    <span class="c1"># numba.config.THREADING_LAYER = &quot;threadsafe&quot;</span>
    <span class="c1">#numba.set_num_threads(2)</span>

    <span class="c1"># this has nothing todo with self.time below!</span>
    <span class="n">start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">process_time</span><span class="p">()</span>
    <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">lor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span>
    <span class="n">fn_vr</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a7</span> <span class="o">=</span> <span class="n">build_vr_list</span><span class="p">(</span><span class="n">lpc_r</span><span class="p">)</span>
    <span class="n">fn</span><span class="p">,</span> <span class="n">rd</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">pc</span> <span class="o">=</span> <span class="n">build_process_list</span><span class="p">(</span><span class="n">lor</span><span class="p">)</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">build_flux_lists_all</span><span class="p">(</span><span class="n">lor</span><span class="p">)</span>

    <span class="n">duration</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">process_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Setup time </span><span class="si">{</span><span class="n">duration</span><span class="si">}</span><span class="s2"> cpu seconds</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting solver&quot;</span><span class="p">)</span>

    <span class="n">wts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">process_time</span><span class="p">()</span>
    <span class="n">foo</span><span class="p">(</span><span class="n">fn_vr</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a7</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">rd</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">time_array</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dt</span><span class="p">)</span>

    <span class="n">duration</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">process_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
    <span class="n">wcd</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">wts</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Total solver time </span><span class="si">{</span><span class="n">duration</span><span class="si">}</span><span class="s2"> cpu seconds, wt = </span><span class="si">{</span><span class="n">wcd</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="nd">@njit</span><span class="p">(</span><span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">fn_vr</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a7</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">rd</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">maxt</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">maxt</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">f_list</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">function</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f_list</span><span class="p">):</span>
                <span class="n">fn</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">u</span><span class="p">](</span><span class="n">rd</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">u</span><span class="p">],</span> <span class="n">fd</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">u</span><span class="p">],</span> <span class="n">pc</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">u</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>

        <span class="c1"># calculate the resulting reservoir concentrations</span>
        <span class="c1"># summarize_fluxes(a, b, c, d, e, i, dt)</span>
        <span class="n">r_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="c1"># loop over reservoirs</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r_steps</span><span class="p">):</span>
            <span class="c1"># for j, r in enumerate(b):  # this will catch the list for each reservoir</span>

            <span class="c1"># sum fluxes in each reservoir</span>
            <span class="n">mass</span> <span class="o">=</span> <span class="n">li</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">f_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">f_steps</span><span class="p">):</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">u</span><span class="p">]</span>
                <span class="c1"># for u, f in enumerate(r):  # this should catch each flux per reservoir</span>
                <span class="n">mass</span> <span class="o">+=</span> <span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">u</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">direction</span>  <span class="c1"># mass</span>
                <span class="n">li</span> <span class="o">+=</span> <span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">u</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">direction</span>  <span class="c1"># li</span>

            <span class="c1"># update masses</span>
            <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">mass</span> <span class="o">*</span> <span class="n">dt</span>  <span class="c1"># mass</span>
            <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">li</span> <span class="o">*</span> <span class="n">dt</span>  <span class="c1"># li</span>
            <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># hi</span>
            <span class="c1"># update delta</span>
            <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e3</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">e</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">/</span> <span class="n">e</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="c1"># update concentrations</span>
            <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">4</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">d</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

        <span class="c1"># # update reservoirs which do not depend on fluxes but on</span>
        <span class="c1"># # functions</span>
        <span class="c1"># # calc_v_reservoir_data()</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fn_vr</span><span class="p">):</span>
            <span class="n">a7</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">a7</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">a7</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">a7</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">a7</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">4</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn_vr</span><span class="p">[</span><span class="n">j</span><span class="p">](</span>
                <span class="n">i</span><span class="p">,</span> <span class="n">a1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">a2</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">a3</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># next time step</span>


<span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">update_fluxes</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">rd</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loop over all processes and update fluxes&quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">f_list</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">function</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f_list</span><span class="p">):</span>
            <span class="n">fn</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">u</span><span class="p">](</span><span class="n">rd</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">u</span><span class="p">],</span> <span class="n">fd</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">u</span><span class="p">],</span> <span class="n">pc</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">u</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>


<span class="nd">@njit</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">sum_p</span><span class="p">(</span><span class="n">r_list</span><span class="p">,</span> <span class="n">f_list</span><span class="p">,</span> <span class="n">dir_list</span><span class="p">,</span> <span class="n">v_list</span><span class="p">,</span> <span class="n">r0_list</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>

    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">sum_lists</span><span class="p">(</span><span class="n">r_list</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">f_list</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">dir_list</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">v_list</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">r0_list</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">i</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>

<span class="nd">@njit</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">summarize_fluxes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sum fluxes in reservoirs with isostopes&quot;&quot;&quot;</span>
    
    <span class="n">r_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="c1"># loop over reservoirs</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r_steps</span><span class="p">):</span>
        <span class="c1"># for j, r in enumerate(b):  # this will catch the list for each reservoir</span>

        <span class="c1"># sum fluxes in each reservoir</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="n">li</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">f_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">f_steps</span><span class="p">):</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">u</span><span class="p">]</span>
            <span class="c1"># for u, f in enumerate(r):  # this should catch each flux per reservoir</span>
            <span class="n">mass</span> <span class="o">+=</span> <span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">u</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">direction</span>  <span class="c1"># mass</span>
            <span class="n">li</span> <span class="o">+=</span> <span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">u</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">direction</span>  <span class="c1"># li</span>

        <span class="c1"># update masses</span>
        <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">mass</span> <span class="o">*</span> <span class="n">dt</span>  <span class="c1"># mass</span>
        <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">li</span> <span class="o">*</span> <span class="n">dt</span>  <span class="c1"># li</span>
        <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># hi</span>
        <span class="c1"># update delta</span>
        <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mf">1e3</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">e</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">/</span> <span class="n">e</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># update concentrations</span>
        <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">4</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">d</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

<span class="c1"># GenericFunction(</span>
<span class="c1">#      name = &#39;db_VH_generic_function&#39;,</span>
<span class="c1">#      function = &lt;function calc_H at 0x7f8bc474c160&gt;,</span>
<span class="c1">#      a1 = VCA,</span>
<span class="c1">#      a2 = DIC,</span>
<span class="c1">#      a3 = SW_db,</span>
<span class="c1">#      a4 = 0,</span>
<span class="c1">#      a5 = 0,</span>
<span class="c1">#      a6 = 0,</span>
<span class="c1">#      act_on = VH,</span>
<span class="c1">#      full_name = &#39;db_VH_generic_function&#39;,</span>
<span class="c1">#  )]</span>

<span class="c1"># a1 to a6 should probably be lists so they can contain any type of data</span>


<span class="k">def</span> <span class="nf">build_vr_list</span><span class="p">(</span><span class="n">lor</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Build lists which contain all function references for</span>
<span class="sd">    virtual reservoirs as well aas their input values</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fn</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>  <span class="c1"># List() # list of functions</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>  <span class="c1"># reservoir data</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>  <span class="c1"># flux data  flux.m flux.l, flux.h, flux.d</span>
    <span class="n">a3</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>  <span class="c1"># list of constants</span>
    <span class="n">a7</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>

    <span class="n">fn</span> <span class="o">=</span> <span class="n">numba</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">empty_list</span><span class="p">(</span>
        <span class="n">types</span><span class="o">.</span><span class="n">UniTuple</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="mi">5</span><span class="p">)(</span>
            <span class="n">types</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>  <span class="c1"># i</span>
            <span class="n">types</span><span class="o">.</span><span class="n">float64</span><span class="p">[::</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># a1</span>
            <span class="n">types</span><span class="o">.</span><span class="n">float64</span><span class="p">[::</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># a2</span>
            <span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="c1"># a3</span>
        <span class="p">)</span><span class="o">.</span><span class="n">as_type</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">lor</span><span class="p">:</span>  <span class="c1"># loop over reservoir processes</span>

        <span class="n">func_name</span><span class="p">,</span> <span class="n">a1d</span><span class="p">,</span> <span class="n">a2d</span><span class="p">,</span> <span class="n">a3d</span><span class="p">,</span> <span class="n">a7d</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get_process_args</span><span class="p">()</span>
        <span class="c1">#print(f&quot;fname = {func_name}&quot;)</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func_name</span><span class="p">)</span>
        <span class="n">a1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a1d</span><span class="p">)</span>
        <span class="n">a2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a2d</span><span class="p">)</span>
        <span class="n">a3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a3d</span><span class="p">)</span>
        <span class="n">a7</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">List</span><span class="p">(</span><span class="n">a7d</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">fn</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a7</span>

<span class="k">def</span> <span class="nf">build_flux_lists</span><span class="p">(</span><span class="n">lor</span><span class="p">,</span> <span class="n">iso</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;flux_list :list [] contains all fluxes as</span>
<span class="sd">    [f.m, f.l, f.h, f.d], where each sublist relates to one reservoir</span>

<span class="sd">    i.e. per reservoir we have list [f1, f2, f3], where f1 = [m, l, h, d]</span>
<span class="sd">    and m = np.array()</span>

<span class="sd">    iso = False/True</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">r_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
    <span class="n">v_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
    <span class="n">r0_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>

    <span class="n">f_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
    <span class="n">dir_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
    <span class="n">rd_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
    <span class="n">fd_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">lor</span><span class="p">:</span>  <span class="c1"># loop over all reservoirs</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">==</span> <span class="n">iso</span><span class="p">:</span>
            <span class="n">rd_list</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">c</span><span class="p">])</span>

            <span class="n">r_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rd_list</span><span class="p">)</span>
            <span class="n">v_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">volume</span><span class="p">))</span>
            <span class="n">r0_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">))</span>

            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># add fluxes for each reservoir entry</span>
            <span class="n">tf</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>  <span class="c1"># temp list for flux data</span>
            <span class="n">td</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>  <span class="c1"># temp list for direction data</span>

            <span class="c1"># loop over all fluxes</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
                <span class="n">fd_list</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">d</span><span class="p">])</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fd_list</span><span class="p">)</span>
                <span class="n">td</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">lodir</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="n">f_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="p">)</span>
            <span class="n">dir_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">td</span><span class="p">)</span>

    <span class="c1"># v_list = tuple(v_list)</span>
    <span class="c1"># r0_list = tuple(r0_list)</span>
    <span class="c1"># dir_list = tuple(dir_list)</span>

    <span class="k">return</span> <span class="n">r_list</span><span class="p">,</span> <span class="n">f_list</span><span class="p">,</span> <span class="n">dir_list</span><span class="p">,</span> <span class="n">v_list</span><span class="p">,</span> <span class="n">r0_list</span>


<span class="k">def</span> <span class="nf">build_flux_lists_all</span><span class="p">(</span><span class="n">lor</span><span class="p">,</span> <span class="n">iso</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;flux_list :list [] contains all fluxes as</span>
<span class="sd">    [f.m, f.l, f.h, f.d], where each sublist relates to one reservoir</span>

<span class="sd">    i.e. per reservoir we have list [f1, f2, f3], where f1 = [m, l, h, d]</span>
<span class="sd">    and m = np.array()</span>

<span class="sd">    iso = False/True</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">r_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
    <span class="n">v_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
    <span class="n">r0_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>

    <span class="n">f_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
    <span class="n">dir_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
    <span class="n">rd_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
    <span class="n">fd_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">lor</span><span class="p">:</span>  <span class="c1"># loop over all reservoirs</span>
        <span class="n">rd_list</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">c</span><span class="p">])</span>

        <span class="n">r_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rd_list</span><span class="p">)</span>
        <span class="n">v_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">volume</span><span class="p">))</span>
        <span class="n">r0_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">))</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># add fluxes for each reservoir entry</span>
        <span class="n">tf</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>  <span class="c1"># temp list for flux data</span>
        <span class="n">td</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>  <span class="c1"># temp list for direction data</span>

        <span class="c1"># loop over all fluxes</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
            <span class="n">fd_list</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">d</span><span class="p">])</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fd_list</span><span class="p">)</span>
            <span class="n">td</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">lodir</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">f_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="p">)</span>
        <span class="n">dir_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">td</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">r_list</span><span class="p">,</span> <span class="n">f_list</span><span class="p">,</span> <span class="n">dir_list</span><span class="p">,</span> <span class="n">v_list</span><span class="p">,</span> <span class="n">r0_list</span>

<span class="k">def</span> <span class="nf">build_process_list</span><span class="p">(</span><span class="n">lor</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">numba.typed</span> <span class="kn">import</span> <span class="n">List</span>
    <span class="kn">import</span> <span class="nn">numba</span>
    <span class="kn">from</span> <span class="nn">numba.core</span> <span class="kn">import</span> <span class="n">types</span>

    <span class="n">fn</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>  <span class="c1"># List() # list of functions</span>
    <span class="n">rd</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>  <span class="c1"># reservoir data</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>  <span class="c1"># flux data  flux.m flux.l, flux.h, flux.d</span>
    <span class="n">pc</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>  <span class="c1"># list of constants</span>

    <span class="c1"># func_name : function reference</span>
    <span class="c1"># res_data :list = reservoir data (m,l,d,c)</span>
    <span class="c1"># flux_data :list = flux data (m,l,h,d)</span>
    <span class="c1"># proc_const : list = any constants, must be float</span>

    <span class="n">f_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">d_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Building Process List&quot;</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">lor</span><span class="p">:</span>  <span class="c1"># loop over reservoirs</span>

        <span class="c1"># note that types.List is differenfr from Types.ListType. Also</span>
        <span class="c1"># note that [::1]  declares C-style arrays see</span>
        <span class="c1"># https://numba.discourse.group/t/list-mistaken-as-list-when-creating-list-of-function-references/677/3</span>
        <span class="n">tfn</span> <span class="o">=</span> <span class="n">numba</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">empty_list</span><span class="p">(</span>
            <span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">void</span><span class="p">)(</span>  <span class="c1"># return value</span>
                <span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">float64</span><span class="p">[::</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">float64</span><span class="p">[::</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> 
                <span class="n">types</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>  <span class="c1"># parameter 4</span>
            <span class="p">)</span><span class="o">.</span><span class="n">as_type</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="n">trd</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
        <span class="n">tfd</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
        <span class="n">tpc</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span>  <span class="c1"># loop over reservoir processes</span>

            
            <span class="n">start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">process_time</span><span class="p">()</span>
            <span class="n">func_name</span><span class="p">,</span> <span class="n">res_data</span><span class="p">,</span> <span class="n">flux_data</span><span class="p">,</span> <span class="n">proc_const</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get_process_args</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">duration</span> <span class="o">=</span>  <span class="n">process_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
            <span class="n">f_time</span> <span class="o">=</span> <span class="n">f_time</span> <span class="o">+</span>  <span class="n">duration</span>
            
            <span class="n">start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">process_time</span><span class="p">()</span>
            <span class="n">tfn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func_name</span><span class="p">)</span>
            <span class="n">trd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res_data</span><span class="p">)</span>
            <span class="n">tfd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux_data</span><span class="p">)</span>
            <span class="n">tpc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proc_const</span><span class="p">)</span>
            <span class="n">duration</span> <span class="o">=</span>  <span class="n">process_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
            <span class="n">d_time</span> <span class="o">=</span> <span class="n">d_time</span> <span class="o">+</span>  <span class="n">duration</span>

        <span class="n">fn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tfn</span><span class="p">)</span>
        <span class="n">rd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trd</span><span class="p">)</span>
        <span class="n">fd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tfd</span><span class="p">)</span>
        <span class="n">pc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tpc</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;f_time = </span><span class="si">{</span><span class="n">f_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;d_time = </span><span class="si">{</span><span class="n">d_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fn</span><span class="p">,</span> <span class="n">rd</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">pc</span>

<span class="k">def</span> <span class="nf">get_string_between_brackets</span><span class="p">(</span><span class="n">s</span> <span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Parse string and extract substring between square brackets</span>

<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">s</span> <span class="o">=</span>  <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column header </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2"> must include units in square brackets&quot;</span><span class="p">)</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column header </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2"> must include units in square brackets&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">map_units</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; parse v to see if it is a string. if yes, map to quantity. </span>
<span class="sd">        parse v to see if it is a quantity, if yes, map to model units</span>
<span class="sd">        and extract magnitude, assign mangitude to return value</span>
<span class="sd">        if not, assign value to return value</span>
<span class="sd">        </span>
<span class="sd">        v : a keyword value number/string/quantity</span>
<span class="sd">        args: one or more quantities (units) see the Model class (e.g., f_unit)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">Q_</span>

    <span class="n">m</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">match</span> <span class="p">:</span><span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># test if string, map to quantity if yes</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="c1"># test if we find a matching dimension, map if true</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Q_</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">dimensionality</span> <span class="o">==</span> <span class="n">q</span><span class="o">.</span><span class="n">dimensionality</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
                <span class="n">match</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2"> is none of </span><span class="si">{</span><span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># no quantity, so it should be a number</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;m is </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="si">}</span><span class="s2">, must be float, v=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">. Something is fishy&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">m</span>
</pre></div>

        </details>

            </section>
                <section id="get_imass">
                            <div class="attr function"><a class="headerlink" href="#get_imass">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_imass</span><span class="signature">(m: float, d: float, r: float) -&gt; [&lt;class &#39;float&#39;&gt;, &lt;class &#39;float&#39;&gt;]</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_imass</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the isotope masses from bulk mass and delta value.</span>
<span class="sd">    Arguments are m = mass, d= delta value, r = abundance ratio </span>
<span class="sd">    species</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">l</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1000.0</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">d</span> <span class="o">+</span> <span class="mf">1000.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span> <span class="o">+</span> <span class="mf">1000.0</span><span class="p">)</span>
    <span class="n">h</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">m</span> <span class="o">-</span> <span class="n">l</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">]</span>
</pre></div>

        </details>

            <div class="docstring"><p>Calculate the isotope masses from bulk mass and delta value.
Arguments are m = mass, d= delta value, r = abundance ratio 
species</p>
</div>


                </section>
                <section id="get_frac">
                            <div class="attr function"><a class="headerlink" href="#get_frac">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_frac</span><span class="signature">(m: float, l: float, a: float) -&gt; [&lt;class &#39;float&#39;&gt;, &lt;class &#39;float&#39;&gt;]</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_frac</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Calculate the effect of the istope fractionation factor alpha on</span>
<span class="sd">    the ratio between the light and heavy isotope.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">li</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="n">l</span> <span class="o">*</span> <span class="n">m</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">l</span> <span class="o">-</span> <span class="n">a</span> <span class="o">*</span> <span class="n">m</span> <span class="o">-</span> <span class="n">l</span><span class="p">)</span>
    <span class="n">hi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">m</span> <span class="o">-</span> <span class="n">li</span>  <span class="c1"># get the new heavy isotope value</span>
    <span class="k">return</span> <span class="n">li</span><span class="p">,</span> <span class="n">hi</span>
</pre></div>

        </details>

            <div class="docstring"><p>Calculate the effect of the istope fractionation factor alpha on
the ratio between the light and heavy isotope.</p>
</div>


                </section>
                <section id="get_flux_data">
                            <div class="attr function"><a class="headerlink" href="#get_flux_data">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_flux_data</span><span class="signature">(
    m: float,
    d: float,
    r: float
) -&gt; [NDArray[(typing.Any, ...), typing.Any], &lt;class &#39;float&#39;&gt;]</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_flux_data</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Calculate the isotope masses from bulk mass and delta value.</span>
<span class="sd">    Arguments are m = mass, d= delta value, r = abundance ratio </span>
<span class="sd">    species. Unlike get_mass, this function returns the full array</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">l</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1000.0</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">d</span> <span class="o">+</span> <span class="mf">1000.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span> <span class="o">+</span> <span class="mf">1000.0</span><span class="p">)</span>
    <span class="n">h</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">m</span> <span class="o">-</span> <span class="n">l</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">m</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">d</span><span class="p">])</span>
</pre></div>

        </details>

            <div class="docstring"><p>Calculate the isotope masses from bulk mass and delta value.
Arguments are m = mass, d= delta value, r = abundance ratio 
species. Unlike get_mass, this function returns the full array</p>
</div>


                </section>
                <section id="get_delta">
                            <div class="attr function"><a class="headerlink" href="#get_delta">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_delta</span><span class="signature">(
    l: [NDArray[(typing.Any, ...), typing.Any], [Float[64]]],
    h: [NDArray[(typing.Any, ...), typing.Any], [Float[64]]],
    r: float
) -&gt; [NDArray[(typing.Any, ...), typing.Any], [Float[64]]]</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_delta</span><span class="p">(</span><span class="n">l</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="p">[</span><span class="n">Float64</span><span class="p">]],</span> <span class="n">h</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="p">[</span><span class="n">Float64</span><span class="p">]],</span>
              <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="p">[</span><span class="n">Float64</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Calculate the delta from the mass of light and heavy isotope</span>
<span class="sd">     Arguments are l and h which are the masses of the light and</span>
<span class="sd">     heavy isotopes respectively, r = abundance ratio of the</span>
<span class="sd">     respective element. Note that this equation can result in a</span>
<span class="sd">     siginificant loss of precision (on the order of 1E-13). I</span>
<span class="sd">     therefore round the results to numbers largers 1E12 (otherwise a</span>
<span class="sd">     delta of zero may no longer be zero)</span>

<span class="sd">   &quot;&quot;&quot;</span>
    <span class="c1"># d = 1000 * (h / l - r) / r</span>
    <span class="n">d</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1E3</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span>
    <span class="k">return</span> <span class="n">d</span>
</pre></div>

        </details>

            <div class="docstring"><p>Calculate the delta from the mass of light and heavy isotope
Arguments are l and h which are the masses of the light and
heavy isotopes respectively, r = abundance ratio of the
respective element. Note that this equation can result in a
siginificant loss of precision (on the order of 1E-13). I
therefore round the results to numbers largers 1E12 (otherwise a
delta of zero may no longer be zero)</p>
</div>


                </section>
                <section id="add_to">
                            <div class="attr function"><a class="headerlink" href="#add_to">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">add_to</span><span class="signature">(l, e)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">add_to</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      add element e to list l, but check if the entry already exist. If so, throw</span>
<span class="sd">      exception. Otherwise add</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">e</span> <span class="ow">in</span> <span class="n">l</span><span class="p">):</span>  <span class="c1"># if not present, append element</span>
        <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>add element e to list l, but check if the entry already exist. If so, throw
exception. Otherwise add</p>
</div>


                </section>
                <section id="get_plot_layout">
                            <div class="attr function"><a class="headerlink" href="#get_plot_layout">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_plot_layout</span><span class="signature">(obj)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_plot_layout</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simple function which selects a row, column layout based on the number of</span>
<span class="sd">    objects to display.  The expected argument is a reservoir object which</span>
<span class="sd">    contains the list of fluxes in the reservoir</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">noo</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># the reservoir is the fisrt object</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>  <span class="c1"># count numbert of fluxes</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">plot</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
            <span class="n">noo</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">ldf</span><span class="p">:</span>  <span class="c1"># count number of data fields</span>
        <span class="n">noo</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># noo = len(obj.lof) + 1  # number of objects in this reservoir</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">noo</span><span class="si">}</span><span class="s2"> subplots for </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> required&quot;</span><span class="p">)</span>

    <span class="n">size</span><span class="p">,</span> <span class="n">geo</span> <span class="o">=</span> <span class="n">plot_geometry</span><span class="p">(</span><span class="n">noo</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">size</span><span class="p">,</span> <span class="n">geo</span>
</pre></div>

        </details>

            <div class="docstring"><p>Simple function which selects a row, column layout based on the number of
objects to display.  The expected argument is a reservoir object which
contains the list of fluxes in the reservoir</p>
</div>


                </section>
                <section id="plot_geometry">
                            <div class="attr function"><a class="headerlink" href="#plot_geometry">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">plot_geometry</span><span class="signature">(noo: int) -&gt; ()</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">plot_geometry</span><span class="p">(</span><span class="n">noo</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Define plot geometry based on number of objects to plot&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">noo</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># one row, one column</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># size in inches</span>
    <span class="k">elif</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">noo</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># two rows, one column</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>  <span class="c1"># size in inches</span>
    <span class="k">elif</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="n">noo</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># two rows, two columns</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>  <span class="c1"># size in inches</span>
    <span class="k">elif</span> <span class="mi">4</span> <span class="o">&lt;</span> <span class="n">noo</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># two rows, three columns</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>  <span class="c1"># size in inches</span>
    <span class="k">elif</span> <span class="mi">6</span> <span class="o">&lt;</span> <span class="n">noo</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># two rows, three columns</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>  <span class="c1"># size in inches</span>
    <span class="k">elif</span> <span class="mi">9</span> <span class="o">&lt;</span> <span class="n">noo</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">:</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># two rows, three columns</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">]</span>  <span class="c1"># size in inches</span>
    <span class="k">elif</span> <span class="mi">12</span> <span class="o">&lt;</span> <span class="n">noo</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">:</span>
        <span class="n">geo</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># two rows, three columns</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">]</span>  <span class="c1"># size in inches</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;plot geometry for more than 15 fluxes is not yet defined&quot;</span>
            <span class="s2">&quot;Consider calling flux.plot individually on each flux in the reservoir&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">size</span><span class="p">,</span> <span class="n">geo</span>
</pre></div>

        </details>

            <div class="docstring"><p>Define plot geometry based on number of objects to plot</p>
</div>


                </section>
                <section id="list_fluxes">
                            <div class="attr function"><a class="headerlink" href="#list_fluxes">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">list_fluxes</span><span class="signature">(self, name, i) -&gt; None</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">list_fluxes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Echo all fluxes in the reservoir to the screen</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">List of fluxes in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span> <span class="c1"># show the processes</span>
                  <span class="n">direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">n</span><span class="p">]</span>
                  <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">t1</span> <span class="o">=</span> <span class="s2">&quot;From:&quot;</span>
                        <span class="n">t2</span> <span class="o">=</span> <span class="s2">&quot;Outflux from&quot;</span>
                  <span class="k">else</span><span class="p">:</span>
                        <span class="n">t1</span> <span class="o">=</span> <span class="s2">&quot;To  :&quot;</span>   
                        <span class="n">t2</span> <span class="o">=</span> <span class="s2">&quot;Influx to&quot;</span>

                  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> </span><span class="si">{</span><span class="n">t2</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> via </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                  
                  <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span>
                        <span class="n">p</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
                  <span class="n">f</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="c1"># print out the flux data</span>
</pre></div>

        </details>

            <div class="docstring"><p>Echo all fluxes in the reservoir to the screen</p>
</div>


                </section>
                <section id="show_data">
                            <div class="attr function"><a class="headerlink" href="#show_data">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">show_data</span><span class="signature">(self, **kwargs) -&gt; None</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">show_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Print the 3 lines of the data starting with index</span>

<span class="sd">    Optional arguments:</span>
<span class="sd">    </span>
<span class="sd">    index :int = 0 starting index</span>
<span class="sd">    indent :int = 0 indentation </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">off</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>

    <span class="k">if</span> <span class="s2">&quot;index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">ind</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="s2">&quot; &quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ind</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># show the first 4 entries</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">3</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}{</span><span class="n">ind</span><span class="si">}</span><span class="s2">i = </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, Mass = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">, delta = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Print the 3 lines of the data starting with index</p>

<p>Optional arguments:</p>

<p>index :int = 0 starting index
indent :int = 0 indentation</p>
</div>


                </section>
                <section id="set_y_limits">
                            <div class="attr function"><a class="headerlink" href="#set_y_limits">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">set_y_limits</span><span class="signature">(ax: matplotlib.axes._axes.Axes, obj: &lt;built-in function any&gt;) -&gt; None</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">set_y_limits</span><span class="p">(</span><span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Prevent the display or arbitrarily small differences&quot;&quot;&quot;</span>
    <span class="n">lower</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">upper</span><span class="p">:</span> <span class="nb">float</span>

    <span class="n">bottom</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">top</span> <span class="o">-</span> <span class="n">bottom</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">obj</span><span class="o">.</span><span class="n">display_precision</span><span class="p">:</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">bottom</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">display_precision</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Prevent the display or arbitrarily small differences</p>
</div>


                </section>
                <section id="get_ptype">
                            <div class="attr function"><a class="headerlink" href="#get_ptype">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_ptype</span><span class="signature">(obj, **kwargs: dict) -&gt; int</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_ptype</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set plot type variable based on ptype or isotope keyword</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Flux</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">Signal</span><span class="p">,</span> <span class="n">DataField</span><span class="p">,</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Sink</span>

    <span class="n">ptype</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">Reservoir</span><span class="p">,</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Sink</span><span class="p">,</span> <span class="n">Flux</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="s2">&quot;ptype&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ptype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ptype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;iso&quot;</span><span class="p">:</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ptype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;concentration&quot;</span><span class="p">:</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ptype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;mass_only&quot;</span><span class="p">:</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">return</span> <span class="n">ptype</span>
</pre></div>

        </details>

            <div class="docstring"><p>Set plot type variable based on ptype or isotope keyword</p>
</div>


                </section>
                <section id="plot_object_data">
                            <div class="attr function"><a class="headerlink" href="#plot_object_data">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">plot_object_data</span><span class="signature">(geo: list, fn: int, obj: &lt;built-in function any&gt;) -&gt; None</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">plot_object_data</span><span class="p">(</span><span class="n">geo</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;collection of commands which will plotqand annotate a reservoir or flux</span>
<span class="sd">    object into an existing plot window.</span>

<span class="sd">    geo: geometry info</span>
<span class="sd">    fn: figure number in plot</span>
<span class="sd">    obj: the object to plot</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>
    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Flux</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">Signal</span><span class="p">,</span> <span class="n">DataField</span><span class="p">,</span> <span class="n">Source</span>

    <span class="c1"># geo = list with rows and cols</span>
    <span class="c1"># fn  = figure number</span>
    <span class="c1"># yl  = array with y values for the left side</span>
    <span class="c1"># yr  = array with y values for the right side</span>
    <span class="c1"># obj = object handle, i.e., reservoir or flux</span>

    <span class="n">first_axis</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">second_axis</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">rows</span> <span class="o">=</span> <span class="n">geo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">geo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># species = obj.sp</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">mo</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">time</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">offset</span>

    <span class="c1"># convert data from model units to display units (i.e. the same</span>
    <span class="c1"># units the input data was defined).</span>
    <span class="c1"># time units are the same regardless of object</span>
    <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">d_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

    <span class="c1"># we do not map isotope values</span>
    <span class="n">yr</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">d</span>

    <span class="c1"># get plot type</span>
    <span class="n">ptype</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">get_ptype</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="c1"># remap concentration &amp; flux values</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Flux</span><span class="p">):</span>
        <span class="n">yl</span> <span class="o">=</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">plt_units</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">legend_left</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">plt_units</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">]&quot;</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">Reservoir</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">display_as</span> <span class="o">==</span> <span class="s2">&quot;mass&quot;</span><span class="p">:</span>
            <span class="n">yl</span> <span class="o">=</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">m_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">plt_units</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">legend_left</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">plt_units</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">]&quot;</span>

        <span class="k">elif</span> <span class="n">obj</span><span class="o">.</span><span class="n">plot_transform_c</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">plot_transform_c</span><span class="p">):</span>
                <span class="c1"># yl = (obj.m * model.m_unit).to(obj.plt_units).magnitude</span>
                <span class="n">yl</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">plot_transform_c</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
                <span class="n">y_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">legend_left</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;plot_transform_c must be function&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">yl</span> <span class="o">=</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">c</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">c_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">plt_units</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">legend_left</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">plt_units</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">]&quot;</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Signal</span><span class="p">):</span>
        <span class="c1"># use the same units as the associated flux</span>
        <span class="n">yl</span> <span class="o">=</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">plt_units</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">plt_units</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">]&quot;</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">DataField</span><span class="p">):</span>
        <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">d_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">yl</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">y1_data</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">y1_label</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">y2_data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># sources, sinks, external data should not show up here</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># decide what to plot</span>
    <span class="k">if</span> <span class="n">ptype</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">first_axis</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">second_axis</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">ptype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">first_axis</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">second_axis</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">ptype</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">first_axis</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">second_axis</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># start subplot</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>

    <span class="c1"># set color index</span>
    <span class="n">cn</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">cn</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">first_axis</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">DataField</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">y1_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">y1_data</span><span class="p">):</span>  <span class="c1"># loop over datafield list</span>
                    <span class="n">yl</span> <span class="o">=</span> <span class="n">d</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">y1_legend</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">ln1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">yl</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                    <span class="n">cn</span> <span class="o">=</span> <span class="n">cn</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">cn</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">time_label</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">d_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>
                <span class="c1"># remove unnecessary frame species</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">set_y_limits</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">ln1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">yl</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">y_label</span><span class="p">)</span>
            <span class="n">cn</span> <span class="o">=</span> <span class="n">cn</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">cn</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">time_label</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">d_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>
            <span class="c1"># remove unnecessary frame species</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">set_y_limits</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">second_axis</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">DataField</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">y2_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">common_y_scale</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">y2_data</span><span class="p">):</span>  <span class="c1"># loop over datafield list</span>
                        <span class="n">yl</span> <span class="o">=</span> <span class="n">d</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">y2_legend</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">ln1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">yl</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                        <span class="n">cn</span> <span class="o">=</span> <span class="n">cn</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="n">col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">cn</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">set_y_limits</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
                        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                        <span class="n">second_axis</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>  <span class="c1"># create a second y-axis</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">y2_data</span><span class="p">):</span>  <span class="c1"># loop over datafield list</span>
                        <span class="n">yl</span> <span class="o">=</span> <span class="n">d</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">y2_legend</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">ln1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">yl</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                        <span class="n">cn</span> <span class="o">=</span> <span class="n">cn</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="n">col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">cn</span><span class="si">}</span><span class="s2">&quot;</span>

                    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">ld</span><span class="p">)</span>  <span class="c1"># species object delta label</span>
                    <span class="n">set_y_limits</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
                    <span class="c1"># remove unneeded frame</span>
                    <span class="n">ax2</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">second_axis</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Signal</span><span class="p">):</span>
            <span class="c1"># use the same units as the associated flux</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>  <span class="c1"># create a second y-axis</span>
            <span class="c1"># plof right y-scale data</span>
            <span class="n">ln2</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">legend_right</span>
            <span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ld</span><span class="p">)</span>  <span class="c1"># species object delta label</span>
            <span class="n">set_y_limits</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># remove unnecessary frame speciess</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>  <span class="c1"># create a second y-axis</span>
            <span class="c1"># plof right y-scale data</span>
            <span class="n">ln2</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">yr</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">legend_right</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">ld</span><span class="p">)</span>  <span class="c1"># species object delta label</span>
            <span class="n">set_y_limits</span><span class="p">(</span><span class="n">ax2</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># remove unnecessary frame speciess</span>

    <span class="c1"># adjust display properties for title and legend</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">Reservoir</span><span class="p">)):</span>
        <span class="c1"># ax1.set_title(obj.pt)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.titlepad&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">14</span>  <span class="c1"># offset title upwards</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;legend.facecolor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0.8&quot;</span>  <span class="c1"># show a gray background</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;legend.edgecolor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0.8&quot;</span>  <span class="c1"># make frame the same color</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;legend.framealpha&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.4</span>  <span class="c1"># set transparency</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">led</span><span class="p">:</span>  <span class="c1"># loop over external data objects if present</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># if string, something is off</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No time axis in external data object </span><span class="si">{d.name}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;y&quot;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>  <span class="c1"># mass or concentration data is present</span>
            <span class="n">cn</span> <span class="o">=</span> <span class="n">cn</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">cn</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">leg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">lm</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">legend</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">ln3</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">d</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">leg</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;z&quot;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="ow">and</span> <span class="n">second_axis</span><span class="p">:</span>  <span class="c1"># isotope data is present</span>
            <span class="n">cn</span> <span class="o">=</span> <span class="n">cn</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">cn</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">leg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">legend</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">ln3</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">leg</span><span class="p">)</span>

    <span class="c1"># collect all labels and print them in one legend</span>
    <span class="k">if</span> <span class="n">first_axis</span><span class="p">:</span>
        <span class="n">handler1</span><span class="p">,</span> <span class="n">label1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">second_axis</span><span class="p">:</span>
        <span class="n">handler2</span><span class="p">,</span> <span class="n">label2</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">first_axis</span> <span class="ow">and</span> <span class="n">second_axis</span><span class="p">:</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handler1</span> <span class="o">+</span> <span class="n">handler2</span><span class="p">,</span> <span class="n">label1</span> <span class="o">+</span> <span class="n">label2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>collection of commands which will plotqand annotate a reservoir or flux
object into an existing plot window.</p>

<p>geo: geometry info
fn: figure number in plot
obj: the object to plot</p>
</div>


                </section>
                <section id="is_name_in_list">
                            <div class="attr function"><a class="headerlink" href="#is_name_in_list">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">is_name_in_list</span><span class="signature">(n: str, l: list) -&gt; bool</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">is_name_in_list</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Test if an object name is part of the object list&quot;&quot;&quot;</span>

    <span class="n">r</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">full_name</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">r</span>
</pre></div>

        </details>

            <div class="docstring"><p>Test if an object name is part of the object list</p>
</div>


                </section>
                <section id="get_object_from_list">
                            <div class="attr function"><a class="headerlink" href="#get_object_from_list">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_object_from_list</span><span class="signature">(name: str, l: list) -&gt; &lt;built-in function any&gt;</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_object_from_list</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">any</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Match a name to a list of objects. Return the object&quot;&quot;&quot;</span>

    <span class="n">match</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">full_name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">o</span>
            <span class="n">match</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">r</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Object = </span><span class="si">{</span><span class="n">o</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> has no matching flux </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Match a name to a list of objects. Return the object</p>
</div>


                </section>
                <section id="sort_by_type">
                            <div class="attr function"><a class="headerlink" href="#sort_by_type">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">sort_by_type</span><span class="signature">(l: list, t: list, m: str) -&gt; list</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">sort_by_type</span><span class="p">(</span><span class="n">l</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;divide a list by type into new lists. This function will return a</span>
<span class="sd">    list and it is up to the calling code to unpack the list</span>

<span class="sd">    l is list with various object types</span>
<span class="sd">    t is a list which contains the object types used for sorting</span>
<span class="sd">    m is a string for the error function</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#from numbers import Number</span>

    <span class="n">lc</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">rl</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">ot</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>  <span class="c1"># loop over object types</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>  <span class="c1"># loop over list elements</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ot</span><span class="p">):</span>
                <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>  <span class="c1"># add to temporary list</span>
                <span class="n">lc</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>  <span class="c1"># remove this element</span>

        <span class="n">rl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>  <span class="c1"># save the temporary list to rl</span>

    <span class="c1"># at this point, all elements of lc should have been processed</span>
    <span class="c1"># if not, lc contains element which are of a different type</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rl</span>
</pre></div>

        </details>

            <div class="docstring"><p>divide a list by type into new lists. This function will return a
list and it is up to the calling code to unpack the list</p>

<p>l is list with various object types
t is a list which contains the object types used for sorting
m is a string for the error function</p>
</div>


                </section>
                <section id="split_key">
                            <div class="attr function"><a class="headerlink" href="#split_key">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">split_key</span><span class="signature">(
    k: str,
    M: &lt;built-in function any&gt;
) -&gt; Union[&lt;built-in function any&gt;, str]</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">split_key</span><span class="p">(</span><span class="n">k</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;split the string k with letter 2, and test if optional</span>
<span class="sd">    id string is present</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;2&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sinkandid</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Name must follow &#39;Source2Sink&#39; format&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;@&quot;</span> <span class="ow">in</span> <span class="n">sinkandid</span><span class="p">:</span>
        <span class="n">sink</span> <span class="o">=</span> <span class="n">sinkandid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cid</span> <span class="o">=</span> <span class="n">sinkandid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sink</span> <span class="o">=</span> <span class="n">sinkandid</span>
        <span class="n">cid</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">sink</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">dmo</span><span class="p">[</span><span class="n">sink</span><span class="p">]</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">dmo</span><span class="p">[</span><span class="n">source</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="n">cid</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>split the string k with letter 2, and test if optional
id string is present</p>
</div>


                </section>
                <section id="make_dict">
                            <div class="attr function"><a class="headerlink" href="#make_dict">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">make_dict</span><span class="signature">(keys: list, values: list) -&gt; dict</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">make_dict</span><span class="p">(</span><span class="n">keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Create a dictionary from a list and value, or from</span>
<span class="sd">    two lists</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
            <span class="n">d</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;len values =</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="si">}</span><span class="s2">, len keys =</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;values = </span><span class="si">{</span><span class="n">values</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;key = </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;key and value list must be of equal length&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">values</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
        <span class="n">d</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">d</span>
</pre></div>

        </details>

            <div class="docstring"><p>Create a dictionary from a list and value, or from
two lists</p>
</div>


                </section>
                <section id="get_typed_list">
                            <div class="attr function"><a class="headerlink" href="#get_typed_list">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_typed_list</span><span class="signature">(data: list) -&gt; list</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_typed_list</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>

    <span class="n">tl</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">tl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tl</span>
</pre></div>

        </details>

    

                </section>
                <section id="create_reservoirs">
                            <div class="attr function"><a class="headerlink" href="#create_reservoirs">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">create_reservoirs</span><span class="signature">(
    bn: dict,
    ic: dict,
    M: &lt;built-in function any&gt;,
    cs: bool = False
) -&gt; dict</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">create_reservoirs</span><span class="p">(</span><span class="n">bn</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">ic</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="n">cs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;boxes are defined by area and depth interval here we use an ordered</span>
<span class="sd">    dictionary to define the box geometries. The next column is temperature</span>
<span class="sd">    in deg C, followed by pressure in bar</span>
<span class="sd">    the geometry is [upper depth datum, lower depth datum, area percentage]</span>

<span class="sd">    bn = dictionary with box parameters</span>
<span class="sd">    bn: dict = {  # name: [[geometry], T, P]</span>
<span class="sd">                 &quot;sb&quot;: {&quot;g&quot;: [0, 200, 0.9], &quot;T&quot;: 20, &quot;P&quot;: 5},</span>
<span class="sd">                 &quot;ib&quot;: {&quot;g&quot;: [200, 1200, 1], &quot;T&quot;: 10, &quot;P&quot;: 100},</span>
<span class="sd">                }</span>

<span class="sd">    ic = dictionary with species default values. This is used to et up</span>
<span class="sd">         initial conditions. Here we use shortcut and use the same conditions</span>
<span class="sd">         in each box. If you need box specific initial conditions</span>
<span class="sd">         use the output of build_concentration_dicts as starting point</span>


<span class="sd">    ic: dict = { # species: concentration, Isotopes</span>
<span class="sd">                   PO4: [Q_(&quot;2.1 * umol/liter&quot;), False],</span>
<span class="sd">                   DIC: [Q_(&quot;2.1 mmol/liter&quot;), False],</span>
<span class="sd">                   ALK: [Q_(&quot;2.43 mmol/liter&quot;), False],</span>
<span class="sd">               }</span>

<span class="sd">    M: Model object handle</span>

<span class="sd">    cs: add virtual reservoir for the carbonate system. Defaults to False</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">SeawaterConstants</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">build_concentration_dicts</span>
    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span><span class="p">,</span> <span class="n">carbonate_system</span><span class="p">,</span> <span class="n">Q_</span>

    <span class="c1"># parse for sources and sinks, create these and remove them from the list</span>

    <span class="c1"># setup the remaining boxes</span>
    <span class="c1"># icd: dict = build_concentration_dicts(ic, bn)</span>

    <span class="c1"># loop over reservoir names</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">bn</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="s2">&quot;ty&quot;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>  <span class="c1"># type is given</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;ty&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Source&quot;</span><span class="p">:</span>
                <span class="n">SourceGroup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;sp&quot;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;ty&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Sink&quot;</span><span class="p">:</span>
                <span class="n">SinkGroup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;sp&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;ty&#39; must be either Source or Sink&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># create reservoirs</span>
            <span class="n">icd</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">build_concentration_dicts</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="n">swc</span> <span class="o">=</span> <span class="n">SeawaterConstants</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;SW_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">model</span><span class="o">=</span><span class="n">M</span><span class="p">,</span>
                <span class="n">temperature</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">],</span>
                <span class="n">pressure</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;P&quot;</span><span class="p">],</span>
            <span class="p">)</span>

            <span class="n">rg</span> <span class="o">=</span> <span class="n">ReservoirGroup</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
                <span class="n">geometry</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;g&quot;</span><span class="p">],</span>
                <span class="n">concentration</span><span class="o">=</span><span class="n">icd</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">isotopes</span><span class="o">=</span><span class="n">icd</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">delta</span><span class="o">=</span><span class="n">icd</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">cs</span><span class="p">:</span>
                <span class="n">volume</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rg</span><span class="o">.</span><span class="n">lor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">volume</span><span class="si">}</span><span class="s2"> l&quot;</span><span class="p">)</span>
                <span class="n">carbonate_system</span><span class="p">(</span>
                    <span class="n">Q_</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">swc</span><span class="o">.</span><span class="n">ca</span><span class="si">}</span><span class="s2"> mol/l&quot;</span><span class="p">),</span>
                    <span class="n">Q_</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">swc</span><span class="o">.</span><span class="n">hplus</span><span class="si">}</span><span class="s2"> mol/l&quot;</span><span class="p">),</span>
                    <span class="n">volume</span><span class="p">,</span>
                    <span class="n">swc</span><span class="p">,</span>
                    <span class="n">rg</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="k">return</span> <span class="n">icd</span>
</pre></div>

        </details>

            <div class="docstring"><p>boxes are defined by area and depth interval here we use an ordered
dictionary to define the box geometries. The next column is temperature
in deg C, followed by pressure in bar
the geometry is [upper depth datum, lower depth datum, area percentage]</p>

<p>bn = dictionary with box parameters
bn: dict = {  # name: [[geometry], T, P]
             "sb": {"g": [0, 200, 0.9], "T": 20, "P": 5},
             "ib": {"g": [200, 1200, 1], "T": 10, "P": 100},
            }</p>

<p>ic = dictionary with species default values. This is used to et up
     initial conditions. Here we use shortcut and use the same conditions
     in each box. If you need box specific initial conditions
     use the output of build_concentration_dicts as starting point</p>

<p>ic: dict = { # species: concentration, Isotopes
               PO4: [Q_("2.1 * umol/liter"), False],
               DIC: [Q_("2.1 mmol/liter"), False],
               ALK: [Q_("2.43 mmol/liter"), False],
           }</p>

<p>M: Model object handle</p>

<p>cs: add virtual reservoir for the carbonate system. Defaults to False</p>
</div>


                </section>
                <section id="build_concentration_dicts">
                            <div class="attr function"><a class="headerlink" href="#build_concentration_dicts">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">build_concentration_dicts</span><span class="signature">(cd: dict, bg: dict) -&gt; dict</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">build_concentration_dicts</span><span class="p">(</span><span class="n">cd</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">bg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Build a dict which can be used by create_reservoirs</span>

<span class="sd">    bg : dict where the box_names are dict keys.</span>
<span class="sd">    cd: dictionary with the following format:</span>
<span class="sd">        cd = {</span>
<span class="sd">             # species: [concentration, isotopes]</span>
<span class="sd">             PO4: [Q_(&quot;2.1 * umol/liter&quot;), False],</span>
<span class="sd">             DIC: [Q_(&quot;2.1 mmol/liter&quot;), False],</span>
<span class="sd">            }</span>

<span class="sd">    This function returns a new dict in the following format</span>

<span class="sd">    #  box_names: [concentrations, isotopes]</span>
<span class="sd">    d= {&quot;bn&quot;: [{PO4: .., DIC: ..},{PO4:False, DIC:False}]}</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">box_names</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">box_names</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">bg</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">box_names</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="n">bg</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;This should never happen&quot;</span><span class="p">)</span>

    <span class="n">icd</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="n">td1</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># temp dictionary</span>
    <span class="n">td2</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># temp dictionary</span>
    <span class="n">td3</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># temp dictionary</span>

    <span class="c1"># create the dicts for concentration and isotopes</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">td1</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>
        <span class="n">td2</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]})</span>
        <span class="n">td3</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]})</span>

    <span class="c1"># box_names: list = bg.keys()</span>
    <span class="k">for</span> <span class="n">bn</span> <span class="ow">in</span> <span class="n">box_names</span><span class="p">:</span>  <span class="c1"># loop over box names</span>
        <span class="n">icd</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">bn</span><span class="p">:</span> <span class="p">[</span><span class="n">td1</span><span class="p">,</span> <span class="n">td2</span><span class="p">,</span> <span class="n">td3</span><span class="p">]})</span>

    <span class="k">return</span> <span class="n">icd</span>
</pre></div>

        </details>

            <div class="docstring"><p>Build a dict which can be used by create_reservoirs</p>

<p>bg : dict where the box_names are dict keys.
cd: dictionary with the following format:
    cd = {
         # species: [concentration, isotopes]
         PO4: [Q_("2.1 * umol/liter"), False],
         DIC: [Q_("2.1 mmol/liter"), False],
        }</p>

<p>This function returns a new dict in the following format</p>

<h1 id="box_names-concentrations-isotopes">box_names: [concentrations, isotopes]</h1>

<p>d= {"bn": [{PO4: .., DIC: ..},{PO4:False, DIC:False}]}</p>
</div>


                </section>
                <section id="calc_volumes">
                            <div class="attr function"><a class="headerlink" href="#calc_volumes">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">calc_volumes</span><span class="signature">(
    bg: dict,
    M: &lt;built-in function any&gt;,
    h: &lt;built-in function any&gt;
) -&gt; list</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">calc_volumes</span><span class="p">(</span><span class="n">bg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="n">h</span><span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculate volume contained in a given depth interval</span>
<span class="sd">    bg is an ordered dictionary in the following format</span>

<span class="sd">    bg=  {</span>
<span class="sd">          &quot;hb&quot;: (0.1, 0, 200),</span>
<span class="sd">          &quot;sb&quot;: (0.9, 0, 200),</span>
<span class="sd">         }</span>

<span class="sd">    where the key must be a valid box name, the first entry of the list denoted</span>
<span class="sd">    the areal extent in percent, the second number is upper depth limit, and last</span>
<span class="sd">    number is the lower depth limit.</span>

<span class="sd">    M must be a model handle</span>
<span class="sd">    h is the hypsometry handle</span>

<span class="sd">    The function returns a list with the corresponding volumes</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># from esbmtk import hypsometry</span>

    <span class="n">v</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of volumes</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">bg</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">volume</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">v</span>
</pre></div>

        </details>

            <div class="docstring"><p>Calculate volume contained in a given depth interval
bg is an ordered dictionary in the following format</p>

<p>bg=  {
      "hb": (0.1, 0, 200),
      "sb": (0.9, 0, 200),
     }</p>

<p>where the key must be a valid box name, the first entry of the list denoted
the areal extent in percent, the second number is upper depth limit, and last
number is the lower depth limit.</p>

<p>M must be a model handle
h is the hypsometry handle</p>

<p>The function returns a list with the corresponding volumes</p>
</div>


                </section>
                <section id="get_longest_dict_entry">
                            <div class="attr function"><a class="headerlink" href="#get_longest_dict_entry">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_longest_dict_entry</span><span class="signature">(d: dict) -&gt; int</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_longest_dict_entry</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Get length of each item in the connection dict&quot;&quot;&quot;</span>
    <span class="n">l_length</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># length of  longest list</span>
    <span class="n">p_length</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># length of single parameter</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">l_length</span><span class="p">:</span>
                <span class="n">l_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_length</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">l_length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p_length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">case</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Only lists present</span>
    <span class="k">if</span> <span class="n">l_length</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p_length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">case</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1">#  Only parameters present</span>
    <span class="k">if</span> <span class="n">l_length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p_length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">case</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1">#  Lists and parameters present</span>

    <span class="k">return</span> <span class="n">case</span><span class="p">,</span> <span class="n">l_length</span>
</pre></div>

        </details>

            <div class="docstring"><p>Get length of each item in the connection dict</p>
</div>


                </section>
                <section id="convert_to_lists">
                            <div class="attr function"><a class="headerlink" href="#convert_to_lists">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">convert_to_lists</span><span class="signature">(d: dict, l: int) -&gt; dict</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">convert_to_lists</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;expand mixed dict entries (i.e. list and single value) such</span>
<span class="sd">    that they are all lists of equal length</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cd</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
                <span class="n">p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>

    <span class="k">return</span> <span class="n">d</span>
</pre></div>

        </details>

            <div class="docstring"><p>expand mixed dict entries (i.e. list and single value) such
that they are all lists of equal length</p>
</div>


                </section>
                <section id="get_sub_key">
                            <div class="attr function"><a class="headerlink" href="#get_sub_key">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_sub_key</span><span class="signature">(d: dict, i: int) -&gt; dict</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_sub_key</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;take a dict which has where the value is a list, and return the</span>
<span class="sd">    key with the n-th value of that list</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">rd</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">rd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">rd</span>
</pre></div>

        </details>

            <div class="docstring"><p>take a dict which has where the value is a list, and return the
key with the n-th value of that list</p>
</div>


                </section>
                <section id="expand_dict">
                            <div class="attr function"><a class="headerlink" href="#expand_dict">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">expand_dict</span><span class="signature">(d: dict, mt: str = &#39;1:1&#39;) -&gt; int</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">expand_dict</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">mt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1:1&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;Determine dict structure</span>

<span class="sd">    in case we have mutiple connections with mutiple species, the</span>
<span class="sd">    default action is to map connections to species (t = &#39;1:1&#39;). If</span>
<span class="sd">    you rather want to create mutiple connections (one for each</span>
<span class="sd">    species) in each connection set t = &#39;1:N&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># loop over dict entries</span>
    <span class="c1"># ck = connection key</span>
    <span class="c1"># cd = connection dict</span>

    <span class="n">r</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># the dict we will return</span>

    <span class="k">for</span> <span class="n">ck</span><span class="p">,</span> <span class="n">cd</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># loop over connections</span>

        <span class="n">rd</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># temp dict</span>
        <span class="n">nd</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># temp dict</span>
        <span class="n">case</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="n">get_longest_dict_entry</span><span class="p">(</span><span class="n">cd</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ck</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="c1"># assume 1:1 mapping between tuple and connection parameters</span>
            <span class="k">if</span> <span class="n">mt</span> <span class="o">==</span> <span class="s2">&quot;1:1&quot;</span><span class="p">:</span>

                <span class="c1"># prep dictionaries</span>
                <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">nd</span> <span class="o">=</span> <span class="n">cd</span>
                    <span class="c1"># print(&quot;case 0&quot;)</span>
                <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># only parameters present. Expand for each tuple entry</span>
                    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ck</span><span class="p">)</span>
                    <span class="n">nd</span> <span class="o">=</span> <span class="n">convert_to_lists</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
                    <span class="c1"># print(&quot;case 1&quot;)</span>
                <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># mixed list present, Expand list</span>
                    <span class="c1"># print(f&quot;case 2, length = {length}&quot;)</span>
                    <span class="n">nd</span> <span class="o">=</span> <span class="n">convert_to_lists</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
                    <span class="c1"># print(nd)</span>

                <span class="c1"># for each connection group in the tuple</span>
                <span class="k">if</span> <span class="n">length</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ck</span><span class="p">):</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;The number of connection properties (</span><span class="si">{</span><span class="n">length</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;does not match the number of connection groups (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ck</span><span class="p">)</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;did you intend to do a 1:N mapping?&quot;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

                <span class="c1"># map property dicts to connection group names</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ck</span><span class="p">:</span>
                    <span class="n">rd</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_sub_key</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="k">elif</span> <span class="n">mt</span> <span class="o">==</span> <span class="s2">&quot;1:N&quot;</span><span class="p">:</span>  <span class="c1"># apply each species to each connection</span>
                <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">nd</span> <span class="o">=</span> <span class="n">cd</span>
                <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># only parameters present. Expand for each tuple entry</span>
                    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ck</span><span class="p">)</span>
                    <span class="n">nd</span> <span class="o">=</span> <span class="n">convert_to_lists</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># mixed list present, Expand list</span>
                    <span class="n">nd</span> <span class="o">=</span> <span class="n">convert_to_lists</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ck</span><span class="p">:</span>  <span class="c1"># apply the entire nd dict to all connections</span>
                    <span class="n">rd</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">nd</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mt</span><span class="si">}</span><span class="s2"> is not defined. must be &#39;1:1&#39; or &#39;1:N&#39;&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># only lists present, case 3</span>
                <span class="n">nd</span> <span class="o">=</span> <span class="n">cd</span>
            <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># only parameters present</span>
                <span class="n">nd</span> <span class="o">=</span> <span class="n">cd</span>
            <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># list and parameters present case 4</span>
                <span class="n">nd</span> <span class="o">=</span> <span class="n">convert_to_lists</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
            <span class="n">rd</span><span class="p">[</span><span class="n">ck</span><span class="p">]</span> <span class="o">=</span> <span class="n">nd</span>

        <span class="c1"># update the overall dict and move to the next entry</span>
        <span class="n">r</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rd</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">r</span>
</pre></div>

        </details>

            <div class="docstring"><p>Determine dict structure</p>

<p>in case we have mutiple connections with mutiple species, the
default action is to map connections to species (t = '1:1'). If
you rather want to create mutiple connections (one for each
species) in each connection set t = '1:N'</p>
</div>


                </section>
                <section id="create_bulk_connections">
                            <div class="attr function"><a class="headerlink" href="#create_bulk_connections">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">create_bulk_connections</span><span class="signature">(ct: dict, M: &lt;built-in function any&gt;, mt: int = &#39;1:1&#39;) -&gt; None</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">create_bulk_connections</span><span class="p">(</span><span class="n">ct</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="n">mt</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="s2">&quot;1:1&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Create connections from a dictionary. The dict can have the following keys</span>
<span class="sd">    following format:</span>

<span class="sd">    mt = mapping type. See below for explanation</span>

<span class="sd">    # na: names, tuple or str. If lists, all list elements share the same properties</span>
<span class="sd">    # sp: species list or species</span>
<span class="sd">    # ty: type, str</span>
<span class="sd">    # ra: rate, Quantity</span>
<span class="sd">    # sc: scale, Number</span>
<span class="sd">    # re: reference, optional</span>
<span class="sd">    # al: alpha, optional</span>
<span class="sd">    # de: delta, optional</span>
<span class="sd">    # mx: True, optional defaults to False. If set, it will create forward</span>
<span class="sd">          and backward fluxes (i.e. mixing)</span>

<span class="sd">    There are 6 different cases how to specify connections</span>

<span class="sd">    Case 1 One connection, one set of parameters</span>
<span class="sd">           ct1 = {&quot;sb2hb&quot;: {&quot;ty&quot;: &quot;scale&quot;, &#39;ra&#39;....}}</span>

<span class="sd">    Case 2 One connection, one set of instructions, one subset with mutiple parameters</span>
<span class="sd">           This will be expanded to create connections for each species</span>
<span class="sd">           ct2 = {&quot;sb2hb&quot;: {&quot;ty&quot;: &quot;scale&quot;, &quot;sp&quot;: [&quot;a&quot;, &quot;b&quot;]}}</span>

<span class="sd">    Case 3 One connection complete set of mutiple characters. Similar to case 2, but now</span>
<span class="sd">           all parameters are given explicitly</span>
<span class="sd">           ct3 = {&quot;sb2hb&quot;: {&quot;ty&quot;: [&quot;scale&quot;, &quot;scale&quot;], &quot;sp&quot;: [&quot;a&quot;, &quot;b&quot;]}}</span>

<span class="sd">    Case 4 Mutiple connections, one set of parameters. This will create</span>
<span class="sd">           identical connection for &quot;sb2hb&quot; and  &quot;ib2db&quot;</span>
<span class="sd">           ct4 = {(&quot;sb2hb&quot;, &quot;ib2db&quot;): {&quot;ty&quot;: &quot;scale&quot;, &#39;ra&#39;: ...}}</span>

<span class="sd">    Case 5 Mutiple connections, one subset of mutiple set of parameters. This wil</span>
<span class="sd">          create a connection for species &#39;a&#39; in sb2hb and with species &#39;b&#39; in ib2db</span>
<span class="sd">           ct5 = {(&quot;sb2hb&quot;, &quot;ib2db&quot;): {&quot;ty&quot;: &quot;scale&quot;, &quot;sp&quot;: [&quot;a&quot;, &quot;b&quot;]}}</span>

<span class="sd">    Case 6 Mutiple connections, complete set of parameters of mutiple parameters</span>
<span class="sd">           Same as case 5, but now all parameters are specified explicitly</span>
<span class="sd">           ct6 = {(&quot;sb2hb&quot;, &quot;ib2db&quot;): {&quot;ty&quot;: [&quot;scale&quot;, &quot;scale&quot;], &quot;sp&quot;: [&quot;a&quot;, &quot;b&quot;]}}</span>


<span class="sd">    The default interpretation for cases 5 and 6 is that each list</span>
<span class="sd">    entry corresponds to connection. However, sometimes we want to</span>
<span class="sd">    create mutiple connections for multiple entries. In this case</span>
<span class="sd">    provide the mt=&#39;1:N&#39; parameter which will create a connection for</span>
<span class="sd">    each species in each connection group. See the below example.</span>

<span class="sd">    It is easy to shoot yourself in the foot. It is best to try the above first with</span>
<span class="sd">    some simple examples, e.g.,</span>

<span class="sd">    from esbmtk import expand_dict</span>
<span class="sd">    ct2 = {&quot;sb2hb&quot;: {&quot;ty&quot;: &quot;scale&quot;, &quot;sp&quot;: [&quot;a&quot;, &quot;b&quot;]}}</span>
<span class="sd">    print(expand_dict(ct2))</span>

<span class="sd">    The below example specifies 3 connection groups which share the rate, and connection type.</span>
<span class="sd">    However, the default mapping is 1:1 so this will fail. You need to explicitly set</span>
<span class="sd">    mt=&quot;1:N&quot;</span>
<span class="sd">    Each connection group comprises the species named in the species list, so this will create</span>
<span class="sd">    a total of 3 x 2 = 6 connections</span>

<span class="sd">    from esbmtk import expand_dict, Q_</span>

<span class="sd">    sl: list = [&#39;PO4&#39;, &#39;DIC&#39;]  # get species list</span>
<span class="sd">    ct = {  # thermohaline circulation</span>
<span class="sd">            # Apply to all boxes in the tuple</span>
<span class="sd">         (&quot;hb2db@thc&quot;, &quot;db2ib@thc&quot;, &quot;ib2hb@thc&quot;): {</span>
<span class="sd">          &quot;ty&quot;: &quot;scale_with_concentration&quot;,</span>
<span class="sd">          &quot;sp&quot;: sl,  # species list</span>
<span class="sd">          &quot;ra&quot;: Q_(&#39;20*Sv&#39;),</span>
<span class="sd">         }</span>

<span class="sd">    create_bulk_connections(ct, M, mt=&quot;1:N&quot;)</span>

<span class="sd">    will create a connection for each species in each connectiongroup and all of these connections</span>
<span class="sd">    share the same properties</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">create_connection</span><span class="p">,</span> <span class="n">expand_dict</span>

    <span class="c1"># expand dictionary into a well formed dict where each connection</span>
    <span class="c1"># has a fully formed entry</span>
    <span class="n">c_ct</span> <span class="o">=</span> <span class="n">expand_dict</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">mt</span><span class="o">=</span><span class="n">mt</span><span class="p">)</span>

    <span class="c1"># loop over dict entries and create the respective connections</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">c_ct</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="c1"># loop over names in tuple</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                <span class="n">create_connection</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">create_connection</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">connection</span><span class="si">}</span><span class="s2"> must be string or tuple&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ct</span>
</pre></div>

        </details>

            <div class="docstring"><p>Create connections from a dictionary. The dict can have the following keys
following format:</p>

<p>mt = mapping type. See below for explanation</p>

<h1 id="na-names-tuple-or-str-if-lists-all-list-elements-share-the-same-properties">na: names, tuple or str. If lists, all list elements share the same properties</h1>

<h1 id="sp-species-list-or-species">sp: species list or species</h1>

<h1 id="ty-type-str">ty: type, str</h1>

<h1 id="ra-rate-quantity">ra: rate, Quantity</h1>

<h1 id="sc-scale-number">sc: scale, Number</h1>

<h1 id="re-reference-optional">re: reference, optional</h1>

<h1 id="al-alpha-optional">al: alpha, optional</h1>

<h1 id="de-delta-optional">de: delta, optional</h1>

<h1 id="mx-true-optional-defaults-to-false-if-set-it-will-create-forward">mx: True, optional defaults to False. If set, it will create forward</h1>

<pre><code>  and backward fluxes (i.e. mixing)
</code></pre>

<p>There are 6 different cases how to specify connections</p>

<p>Case 1 One connection, one set of parameters
       ct1 = {"sb2hb": {"ty": "scale", 'ra'....}}</p>

<p>Case 2 One connection, one set of instructions, one subset with mutiple parameters
       This will be expanded to create connections for each species
       ct2 = {"sb2hb": {"ty": "scale", "sp": ["a", "b"]}}</p>

<p>Case 3 One connection complete set of mutiple characters. Similar to case 2, but now
       all parameters are given explicitly
       ct3 = {"sb2hb": {"ty": ["scale", "scale"], "sp": ["a", "b"]}}</p>

<p>Case 4 Mutiple connections, one set of parameters. This will create
       identical connection for "sb2hb" and  "ib2db"
       ct4 = {("sb2hb", "ib2db"): {"ty": "scale", 'ra': ...}}</p>

<p>Case 5 Mutiple connections, one subset of mutiple set of parameters. This wil
      create a connection for species 'a' in sb2hb and with species 'b' in ib2db
       ct5 = {("sb2hb", "ib2db"): {"ty": "scale", "sp": ["a", "b"]}}</p>

<p>Case 6 Mutiple connections, complete set of parameters of mutiple parameters
       Same as case 5, but now all parameters are specified explicitly
       ct6 = {("sb2hb", "ib2db"): {"ty": ["scale", "scale"], "sp": ["a", "b"]}}</p>

<p>The default interpretation for cases 5 and 6 is that each list
entry corresponds to connection. However, sometimes we want to
create mutiple connections for multiple entries. In this case
provide the mt='1:N' parameter which will create a connection for
each species in each connection group. See the below example.</p>

<p>It is easy to shoot yourself in the foot. It is best to try the above first with
some simple examples, e.g.,</p>

<p>from esbmtk import expand_dict
ct2 = {"sb2hb": {"ty": "scale", "sp": ["a", "b"]}}
print(expand_dict(ct2))</p>

<p>The below example specifies 3 connection groups which share the rate, and connection type.
However, the default mapping is 1:1 so this will fail. You need to explicitly set
mt="1:N"
Each connection group comprises the species named in the species list, so this will create
a total of 3 x 2 = 6 connections</p>

<p>from esbmtk import expand_dict, Q_</p>

<p>sl: list = ['PO4', 'DIC']  # get species list
ct = {  # thermohaline circulation
        # Apply to all boxes in the tuple
     ("hb2db@thc", "db2ib@thc", "ib2hb@thc"): {
      "ty": "scale_with_concentration",
      "sp": sl,  # species list
      "ra": Q_('20*Sv'),
     }</p>

<p>create_bulk_connections(ct, M, mt="1:N")</p>

<p>will create a connection for each species in each connectiongroup and all of these connections
share the same properties</p>
</div>


                </section>
                <section id="create_connection">
                            <div class="attr function"><a class="headerlink" href="#create_connection">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">create_connection</span><span class="signature">(n: str, p: dict, M: &lt;built-in function any&gt;) -&gt; None</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">create_connection</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;called by create_bulk_connections in order to create a connection</span>
<span class="sd">    group It is assumed that all rates are in liter/year or mol per</span>
<span class="sd">    year. This may not be what you want or need.</span>

<span class="sd">    You need to provide a connection key e.g., sb2db@mix which will be</span>
<span class="sd">    interpreted as mixing a connection between sb and db and thus</span>
<span class="sd">    create connections in both directions</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="n">Q_</span>

    <span class="c1"># get the reservoir handles by splitting the key</span>
    <span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="n">cid</span> <span class="o">=</span> <span class="n">split_key</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>

    <span class="c1"># create default connections parameters and replace with values in</span>
    <span class="c1"># the parameter dict if present.</span>
    <span class="n">los</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;sp&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;sp&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;sp&quot;</span><span class="p">]]</span>
    <span class="n">typ</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;ty&quot;</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;ty&quot;</span><span class="p">]</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;sc&quot;</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;sc&quot;</span><span class="p">]</span>
    <span class="n">rate</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="s2">&quot;0 mol/a&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;ra&quot;</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span>
    <span class="n">ref</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;re&quot;</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;re&quot;</span><span class="p">]</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;al&quot;</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;al&quot;</span><span class="p">]</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;de&quot;</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;de&quot;</span><span class="p">]</span>
    <span class="n">mix</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;mx&quot;</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;mx&quot;</span><span class="p">]</span>
    <span class="n">cid</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cid</span><span class="si">}</span><span class="s2">_f&quot;</span> <span class="k">if</span> <span class="n">mix</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cid</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">Q_</span><span class="p">):</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;l/a&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

    <span class="c1"># if name in M.dmo: # group already exist in this case we nee to update the</span>
    <span class="c1"># connection group</span>

    <span class="c1"># Case one, no mixing, test if exist, otherwise create</span>
    <span class="c1"># Case 2, mixing: test if forward connection exists, if not create</span>
    <span class="c1">#                  test if backwards connection exists, or create</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">mix</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;C_</span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">2</span><span class="si">{</span><span class="n">sink</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">update_or_create</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="n">los</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">M</span>
        <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># this is a connection with mixing</span>
        <span class="c1"># create forward connection</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;C_</span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">2</span><span class="si">{</span><span class="n">sink</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">update_or_create</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="n">los</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">M</span>
        <span class="p">)</span>

        <span class="c1"># create backwards connection</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;C_</span><span class="si">{</span><span class="n">sink</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">2</span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">cid</span> <span class="o">=</span> <span class="n">cid</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_f&quot;</span><span class="p">,</span> <span class="s2">&quot;_b&quot;</span><span class="p">)</span>
        <span class="n">update_or_create</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">los</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">M</span>
        <span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>called by create_bulk_connections in order to create a connection
group It is assumed that all rates are in liter/year or mol per
year. This may not be what you want or need.</p>

<p>You need to provide a connection key e.g., sb2db@mix which will be
interpreted as mixing a connection between sb and db and thus
create connections in both directions</p>
</div>


                </section>
                <section id="update_or_create">
                            <div class="attr function"><a class="headerlink" href="#update_or_create">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">update_or_create</span><span class="signature">(name, source, sink, los, typ, scale, rate, ref, alpha, delta, cid, M)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">update_or_create</span><span class="p">(</span>
    <span class="n">name</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="n">los</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">M</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create or update connection&quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">ConnectionGroup</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">M</span><span class="o">.</span><span class="n">dmo</span><span class="p">:</span>  <span class="c1"># update connection</span>
        <span class="n">cg</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">dmo</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">cg</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
            <span class="n">sink</span><span class="o">=</span><span class="n">sink</span><span class="p">,</span>
            <span class="n">ctype</span><span class="o">=</span><span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">typ</span><span class="p">),</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">scale</span><span class="p">),</span>  <span class="c1"># get rate from dictionary</span>
            <span class="n">rate</span><span class="o">=</span><span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">rate</span><span class="p">),</span>
            <span class="n">ref</span><span class="o">=</span><span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">ref</span><span class="p">),</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">alpha</span><span class="p">),</span>
            <span class="n">delta</span><span class="o">=</span><span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">delta</span><span class="p">),</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">cid</span><span class="p">,</span>  <span class="c1"># get id from dictionary</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># create connection</span>
        <span class="n">cg</span> <span class="o">=</span> <span class="n">ConnectionGroup</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
            <span class="n">sink</span><span class="o">=</span><span class="n">sink</span><span class="p">,</span>
            <span class="n">ctype</span><span class="o">=</span><span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">typ</span><span class="p">),</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">scale</span><span class="p">),</span>  <span class="c1"># get rate from dictionary</span>
            <span class="n">rate</span><span class="o">=</span><span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">rate</span><span class="p">),</span>
            <span class="n">ref</span><span class="o">=</span><span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">ref</span><span class="p">),</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">alpha</span><span class="p">),</span>
            <span class="n">delta</span><span class="o">=</span><span class="n">make_dict</span><span class="p">(</span><span class="n">los</span><span class="p">,</span> <span class="n">delta</span><span class="p">),</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">cid</span><span class="p">,</span>  <span class="c1"># get id from dictionary</span>
        <span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Create or update connection</p>
</div>


                </section>
                <section id="execute">
                            <div class="attr function"><a class="headerlink" href="#execute">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">execute</span><span class="signature">(
    new: [NDArray[(typing.Any, ...), typing.Any], Float[64]],
    time: [NDArray[(typing.Any, ...), typing.Any], Float[64]],
    lor: list,
    lpc_f: list,
    lpc_r: list
) -&gt; None</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">execute</span><span class="p">(</span>
    <span class="n">new</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float64</span><span class="p">],</span>
    <span class="n">time</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float64</span><span class="p">],</span>
    <span class="n">lor</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">lpc_f</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">lpc_r</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;This is the original object oriented solver&quot;&quot;&quot;</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># some processes refer to the previous time step</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># loop over the time vector except the first</span>
        <span class="c1"># we first need to calculate all fluxes</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">lor</span><span class="p">:</span>  <span class="c1"># loop over all reservoirs</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span>  <span class="c1"># loop over reservoir processes</span>
                <span class="n">p</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>  <span class="c1"># update fluxes</span>

        <span class="c1"># update all process based fluxes. This can be done in a global lpc list</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">lpc_f</span><span class="p">:</span>
            <span class="n">p</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># and then update all reservoirs</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">lor</span><span class="p">:</span>  <span class="c1"># loop over all reservoirs</span>
            <span class="n">flux_list</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span>

            <span class="n">new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flux_list</span><span class="p">:</span>  <span class="c1"># do sum of fluxes in this reservoir</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
                <span class="n">new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">direction</span>  <span class="c1"># current flux and direction</span>
                <span class="n">new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">direction</span>  <span class="c1"># current flux and direction</span>
                <span class="c1">#new[2] = new[2] + f.h[i] * direction  # current flux and direction</span>

            <span class="c1"># print(f&quot;fsum = {new[0]:.2e}&quot;)</span>
            <span class="c1"># new = array([ms, ls, hs])</span>
            <span class="n">new</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">new</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># new[3] = delta will be set by the setitem method in the reserevoir</span>
            <span class="c1"># ditto for the concentration</span>
            <span class="n">new</span> <span class="o">=</span> <span class="n">new</span> <span class="o">*</span> <span class="n">r</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span>  <span class="c1"># get flux / timestep</span>
            <span class="c1">#print(f&quot;{i} new = {new}, dt = {r.mo.dt}&quot;)</span>
            <span class="n">new</span> <span class="o">=</span> <span class="n">new</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># add to data from last time step</span>
            <span class="n">new</span> <span class="o">=</span> <span class="n">new</span> <span class="o">*</span> <span class="p">(</span><span class="n">new</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># set negative values to zero</span>
            <span class="c1"># print(f&quot;updating {r.full_name} from {r.m[i]:.2e}&quot;)</span>
            <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>  <span class="c1"># update reservoir data</span>
            <span class="c1"># print(f&quot;to  {r.m[i]:.2e}\n&quot;)</span>

        <span class="c1"># update reservoirs which do not depend on fluxes but on</span>
        <span class="c1"># functions</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">lpc_r</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">act_on</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>

        </details>

            <div class="docstring"><p>This is the original object oriented solver</p>
</div>


                </section>
                <section id="execute_h">
                            <div class="attr function"><a class="headerlink" href="#execute_h">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">execute_h</span><span class="signature">(
    new: [NDArray[(typing.Any, ...), typing.Any], Float[64]],
    time: [NDArray[(typing.Any, ...), typing.Any], Float[64]],
    lor: list,
    lpc_f: list,
    lpc_r: list
) -&gt; None</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">execute_h</span><span class="p">(</span>
    <span class="n">new</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float64</span><span class="p">],</span>
    <span class="n">time</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float64</span><span class="p">],</span>
    <span class="n">lor</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">lpc_f</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">lpc_r</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;Moved this code into a separate function to enable numba optimization&quot;&quot;&quot;</span>

    <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># processes refer to the previous time step -&gt; start at 1</span>
    <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">lor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span>
    <span class="n">ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">lor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span>
    <span class="n">ratio</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">build_flux_lists_all</span><span class="p">(</span><span class="n">lor</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># loop over the time vector except the first</span>
        <span class="c1"># we first need to calculate all fluxes</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">lor</span><span class="p">:</span>  <span class="c1"># loop over all reservoirs</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span>  <span class="c1"># loop over reservoir processes</span>
                <span class="n">p</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>  <span class="c1"># update fluxes</span>

        <span class="c1"># update all process based fluxes. This can be done in a global lpc list</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">lpc_f</span><span class="p">:</span>
            <span class="n">p</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">summarize_fluxes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>

        <span class="c1"># update reservoirs which do not depend on fluxes but on</span>
        <span class="c1"># functions</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">lpc_r</span><span class="p">:</span>
            <span class="n">p</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># next time step</span>
</pre></div>

        </details>

            <div class="docstring"><p>Moved this code into a separate function to enable numba optimization</p>
</div>


                </section>
                <section id="execute_n">
                            <div class="attr function"><a class="headerlink" href="#execute_n">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">execute_n</span><span class="signature">(
    new: [NDArray[(typing.Any, ...), typing.Any], Float[64]],
    time: [NDArray[(typing.Any, ...), typing.Any], Float[64]],
    lor: list,
    lpc_f: list,
    lpc_r: list
) -&gt; None</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">execute_n</span><span class="p">(</span>
    <span class="n">new</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float64</span><span class="p">],</span>
    <span class="n">time</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float64</span><span class="p">],</span>
    <span class="n">lor</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">lpc_f</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">lpc_r</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;Moved this code into a separate function to enable numba optimization&quot;&quot;&quot;</span>
    <span class="c1"># config.THREADING_LAYER = &quot;threadsafe&quot;</span>
    <span class="c1"># numba.set_num_threads(2)</span>

    <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># processes refer to the previous time step -&gt; start at 1</span>
    <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">lor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span>
    <span class="n">ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">lor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span>
    <span class="n">ratio</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">fn_vr</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">a5</span><span class="p">,</span> <span class="n">a6</span><span class="p">,</span> <span class="n">a7</span> <span class="o">=</span> <span class="n">build_vr_list</span><span class="p">(</span><span class="n">lpc_r</span><span class="p">)</span>
    <span class="n">fn</span><span class="p">,</span> <span class="n">rd</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">pc</span> <span class="o">=</span> <span class="n">build_process_list</span><span class="p">(</span><span class="n">lor</span><span class="p">)</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">build_flux_lists_all</span><span class="p">(</span><span class="n">lor</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># loop over the time vector except the first</span>
        <span class="c1"># update_fluxes for each reservoir</span>
        <span class="n">update_fluxes</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">rd</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

        <span class="c1"># update all process based fluxes. This can be done in a global lpc list</span>
        <span class="c1"># for p in lpc_f:</span>
        <span class="c1">#    p(i)</span>

        <span class="c1"># calculate the resulting reservoir concentrations</span>
        <span class="n">summarize_fluxes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>

        <span class="c1"># update reservoirs which do not depend on fluxes but on</span>
        <span class="c1"># functions</span>
        <span class="c1"># calc_v_reservoir_data()</span>
        <span class="n">update_virtual_reservoirs</span><span class="p">(</span><span class="n">fn_vr</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">a5</span><span class="p">,</span> <span class="n">a6</span><span class="p">,</span> <span class="n">a7</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># next time step</span>
</pre></div>

        </details>

            <div class="docstring"><p>Moved this code into a separate function to enable numba optimization</p>
</div>


                </section>
                <section id="execute_e">
                            <div class="attr function"><a class="headerlink" href="#execute_e">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">execute_e</span><span class="signature">(
    new: [NDArray[(typing.Any, ...), typing.Any], Float[64]],
    time_array: [NDArray[(typing.Any, ...), typing.Any], Float[64]],
    lor: list,
    lpc_f: list,
    lpc_r: list
) -&gt; None</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">execute_e</span><span class="p">(</span>
    <span class="n">new</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float64</span><span class="p">],</span>
    <span class="n">time_array</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float64</span><span class="p">],</span>
    <span class="n">lor</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">lpc_f</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">lpc_r</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;Moved this code into a separate function to enable numba optimization&quot;&quot;&quot;</span>
    <span class="c1"># numba.config.THREADING_LAYER = &quot;threadsafe&quot;</span>
    <span class="c1">#numba.set_num_threads(2)</span>

    <span class="c1"># this has nothing todo with self.time below!</span>
    <span class="n">start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">process_time</span><span class="p">()</span>
    <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">lor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span>
    <span class="n">fn_vr</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a7</span> <span class="o">=</span> <span class="n">build_vr_list</span><span class="p">(</span><span class="n">lpc_r</span><span class="p">)</span>
    <span class="n">fn</span><span class="p">,</span> <span class="n">rd</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">pc</span> <span class="o">=</span> <span class="n">build_process_list</span><span class="p">(</span><span class="n">lor</span><span class="p">)</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">build_flux_lists_all</span><span class="p">(</span><span class="n">lor</span><span class="p">)</span>

    <span class="n">duration</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">process_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Setup time </span><span class="si">{</span><span class="n">duration</span><span class="si">}</span><span class="s2"> cpu seconds</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting solver&quot;</span><span class="p">)</span>

    <span class="n">wts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">process_time</span><span class="p">()</span>
    <span class="n">foo</span><span class="p">(</span><span class="n">fn_vr</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a7</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">rd</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">time_array</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dt</span><span class="p">)</span>

    <span class="n">duration</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">process_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
    <span class="n">wcd</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">wts</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Total solver time </span><span class="si">{</span><span class="n">duration</span><span class="si">}</span><span class="s2"> cpu seconds, wt = </span><span class="si">{</span><span class="n">wcd</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Moved this code into a separate function to enable numba optimization</p>
</div>


                </section>
                <section id="foo">
                            <div class="attr function"><a class="headerlink" href="#foo">#&nbsp;&nbsp</a>

                <div class="decorator">@njit(parallel=False, fastmath=True)</div>

            <span class="def">def</span>
            <span class="name">foo</span><span class="signature">(fn_vr, a1, a2, a3, a7, fn, rd, fd, pc, a, b, c, d, e, maxt, dt)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="nd">@njit</span><span class="p">(</span><span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">fn_vr</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a7</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">rd</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">maxt</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">maxt</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">f_list</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">function</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f_list</span><span class="p">):</span>
                <span class="n">fn</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">u</span><span class="p">](</span><span class="n">rd</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">u</span><span class="p">],</span> <span class="n">fd</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">u</span><span class="p">],</span> <span class="n">pc</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">u</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>

        <span class="c1"># calculate the resulting reservoir concentrations</span>
        <span class="c1"># summarize_fluxes(a, b, c, d, e, i, dt)</span>
        <span class="n">r_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="c1"># loop over reservoirs</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r_steps</span><span class="p">):</span>
            <span class="c1"># for j, r in enumerate(b):  # this will catch the list for each reservoir</span>

            <span class="c1"># sum fluxes in each reservoir</span>
            <span class="n">mass</span> <span class="o">=</span> <span class="n">li</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">f_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">f_steps</span><span class="p">):</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">u</span><span class="p">]</span>
                <span class="c1"># for u, f in enumerate(r):  # this should catch each flux per reservoir</span>
                <span class="n">mass</span> <span class="o">+=</span> <span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">u</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">direction</span>  <span class="c1"># mass</span>
                <span class="n">li</span> <span class="o">+=</span> <span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">u</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">direction</span>  <span class="c1"># li</span>

            <span class="c1"># update masses</span>
            <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">mass</span> <span class="o">*</span> <span class="n">dt</span>  <span class="c1"># mass</span>
            <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">li</span> <span class="o">*</span> <span class="n">dt</span>  <span class="c1"># li</span>
            <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># hi</span>
            <span class="c1"># update delta</span>
            <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e3</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">e</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">/</span> <span class="n">e</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="c1"># update concentrations</span>
            <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">4</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">d</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

        <span class="c1"># # update reservoirs which do not depend on fluxes but on</span>
        <span class="c1"># # functions</span>
        <span class="c1"># # calc_v_reservoir_data()</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fn_vr</span><span class="p">):</span>
            <span class="n">a7</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">a7</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">a7</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">a7</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">a7</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">4</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn_vr</span><span class="p">[</span><span class="n">j</span><span class="p">](</span>
                <span class="n">i</span><span class="p">,</span> <span class="n">a1</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">a2</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">a3</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># next time step</span>
</pre></div>

        </details>

    

                </section>
                <section id="update_fluxes">
                            <div class="attr function"><a class="headerlink" href="#update_fluxes">#&nbsp;&nbsp</a>

                <div class="decorator">@njit</div>

            <span class="def">def</span>
            <span class="name">update_fluxes</span><span class="signature">(fn, rd, fd, pc, i)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="nd">@njit</span>
<span class="k">def</span> <span class="nf">update_fluxes</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">rd</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loop over all processes and update fluxes&quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">f_list</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">function</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f_list</span><span class="p">):</span>
            <span class="n">fn</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">u</span><span class="p">](</span><span class="n">rd</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">u</span><span class="p">],</span> <span class="n">fd</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">u</span><span class="p">],</span> <span class="n">pc</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">u</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Loop over all processes and update fluxes</p>
</div>


                </section>
                <section id="sum_p">
                            <div class="attr function"><a class="headerlink" href="#sum_p">#&nbsp;&nbsp</a>

                <div class="decorator">@njit()</div>

            <span class="def">def</span>
            <span class="name">sum_p</span><span class="signature">(r_list, f_list, dir_list, v_list, r0_list, i, dt)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="nd">@njit</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">sum_p</span><span class="p">(</span><span class="n">r_list</span><span class="p">,</span> <span class="n">f_list</span><span class="p">,</span> <span class="n">dir_list</span><span class="p">,</span> <span class="n">v_list</span><span class="p">,</span> <span class="n">r0_list</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>

    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">sum_lists</span><span class="p">(</span><span class="n">r_list</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">f_list</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">dir_list</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">v_list</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">r0_list</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">i</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
</pre></div>

        </details>

    

                </section>
                <section id="summarize_fluxes">
                            <div class="attr function"><a class="headerlink" href="#summarize_fluxes">#&nbsp;&nbsp</a>

                <div class="decorator">@njit()</div>

            <span class="def">def</span>
            <span class="name">summarize_fluxes</span><span class="signature">(a, b, c, d, e, i, dt)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="nd">@njit</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">summarize_fluxes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sum fluxes in reservoirs with isostopes&quot;&quot;&quot;</span>
    
    <span class="n">r_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="c1"># loop over reservoirs</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r_steps</span><span class="p">):</span>
        <span class="c1"># for j, r in enumerate(b):  # this will catch the list for each reservoir</span>

        <span class="c1"># sum fluxes in each reservoir</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="n">li</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">f_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">f_steps</span><span class="p">):</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">u</span><span class="p">]</span>
            <span class="c1"># for u, f in enumerate(r):  # this should catch each flux per reservoir</span>
            <span class="n">mass</span> <span class="o">+=</span> <span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">u</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">direction</span>  <span class="c1"># mass</span>
            <span class="n">li</span> <span class="o">+=</span> <span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">u</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">direction</span>  <span class="c1"># li</span>

        <span class="c1"># update masses</span>
        <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">mass</span> <span class="o">*</span> <span class="n">dt</span>  <span class="c1"># mass</span>
        <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">li</span> <span class="o">*</span> <span class="n">dt</span>  <span class="c1"># li</span>
        <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># hi</span>
        <span class="c1"># update delta</span>
        <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mf">1e3</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">e</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">/</span> <span class="n">e</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># update concentrations</span>
        <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">4</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">d</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</pre></div>

        </details>

            <div class="docstring"><p>Sum fluxes in reservoirs with isostopes</p>
</div>


                </section>
                <section id="build_vr_list">
                            <div class="attr function"><a class="headerlink" href="#build_vr_list">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">build_vr_list</span><span class="signature">(lor: list) -&gt; tuple</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">build_vr_list</span><span class="p">(</span><span class="n">lor</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Build lists which contain all function references for</span>
<span class="sd">    virtual reservoirs as well aas their input values</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fn</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>  <span class="c1"># List() # list of functions</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>  <span class="c1"># reservoir data</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>  <span class="c1"># flux data  flux.m flux.l, flux.h, flux.d</span>
    <span class="n">a3</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>  <span class="c1"># list of constants</span>
    <span class="n">a7</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>

    <span class="n">fn</span> <span class="o">=</span> <span class="n">numba</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">empty_list</span><span class="p">(</span>
        <span class="n">types</span><span class="o">.</span><span class="n">UniTuple</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="mi">5</span><span class="p">)(</span>
            <span class="n">types</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>  <span class="c1"># i</span>
            <span class="n">types</span><span class="o">.</span><span class="n">float64</span><span class="p">[::</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># a1</span>
            <span class="n">types</span><span class="o">.</span><span class="n">float64</span><span class="p">[::</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># a2</span>
            <span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="c1"># a3</span>
        <span class="p">)</span><span class="o">.</span><span class="n">as_type</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">lor</span><span class="p">:</span>  <span class="c1"># loop over reservoir processes</span>

        <span class="n">func_name</span><span class="p">,</span> <span class="n">a1d</span><span class="p">,</span> <span class="n">a2d</span><span class="p">,</span> <span class="n">a3d</span><span class="p">,</span> <span class="n">a7d</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get_process_args</span><span class="p">()</span>
        <span class="c1">#print(f&quot;fname = {func_name}&quot;)</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func_name</span><span class="p">)</span>
        <span class="n">a1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a1d</span><span class="p">)</span>
        <span class="n">a2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a2d</span><span class="p">)</span>
        <span class="n">a3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a3d</span><span class="p">)</span>
        <span class="n">a7</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">List</span><span class="p">(</span><span class="n">a7d</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">fn</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a7</span>
</pre></div>

        </details>

            <div class="docstring"><p>Build lists which contain all function references for
virtual reservoirs as well aas their input values</p>
</div>


                </section>
                <section id="build_flux_lists">
                            <div class="attr function"><a class="headerlink" href="#build_flux_lists">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">build_flux_lists</span><span class="signature">(lor, iso: bool = False) -&gt; tuple</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">build_flux_lists</span><span class="p">(</span><span class="n">lor</span><span class="p">,</span> <span class="n">iso</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;flux_list :list [] contains all fluxes as</span>
<span class="sd">    [f.m, f.l, f.h, f.d], where each sublist relates to one reservoir</span>

<span class="sd">    i.e. per reservoir we have list [f1, f2, f3], where f1 = [m, l, h, d]</span>
<span class="sd">    and m = np.array()</span>

<span class="sd">    iso = False/True</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">r_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
    <span class="n">v_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
    <span class="n">r0_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>

    <span class="n">f_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
    <span class="n">dir_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
    <span class="n">rd_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
    <span class="n">fd_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">lor</span><span class="p">:</span>  <span class="c1"># loop over all reservoirs</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">==</span> <span class="n">iso</span><span class="p">:</span>
            <span class="n">rd_list</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">c</span><span class="p">])</span>

            <span class="n">r_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rd_list</span><span class="p">)</span>
            <span class="n">v_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">volume</span><span class="p">))</span>
            <span class="n">r0_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">))</span>

            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># add fluxes for each reservoir entry</span>
            <span class="n">tf</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>  <span class="c1"># temp list for flux data</span>
            <span class="n">td</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>  <span class="c1"># temp list for direction data</span>

            <span class="c1"># loop over all fluxes</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
                <span class="n">fd_list</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">d</span><span class="p">])</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fd_list</span><span class="p">)</span>
                <span class="n">td</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">lodir</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="n">f_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="p">)</span>
            <span class="n">dir_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">td</span><span class="p">)</span>

    <span class="c1"># v_list = tuple(v_list)</span>
    <span class="c1"># r0_list = tuple(r0_list)</span>
    <span class="c1"># dir_list = tuple(dir_list)</span>

    <span class="k">return</span> <span class="n">r_list</span><span class="p">,</span> <span class="n">f_list</span><span class="p">,</span> <span class="n">dir_list</span><span class="p">,</span> <span class="n">v_list</span><span class="p">,</span> <span class="n">r0_list</span>
</pre></div>

        </details>

            <div class="docstring"><p>flux_list :list [] contains all fluxes as
[f.m, f.l, f.h, f.d], where each sublist relates to one reservoir</p>

<p>i.e. per reservoir we have list [f1, f2, f3], where f1 = [m, l, h, d]
and m = np.array()</p>

<p>iso = False/True</p>
</div>


                </section>
                <section id="build_flux_lists_all">
                            <div class="attr function"><a class="headerlink" href="#build_flux_lists_all">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">build_flux_lists_all</span><span class="signature">(lor, iso: bool = False) -&gt; tuple</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">build_flux_lists_all</span><span class="p">(</span><span class="n">lor</span><span class="p">,</span> <span class="n">iso</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;flux_list :list [] contains all fluxes as</span>
<span class="sd">    [f.m, f.l, f.h, f.d], where each sublist relates to one reservoir</span>

<span class="sd">    i.e. per reservoir we have list [f1, f2, f3], where f1 = [m, l, h, d]</span>
<span class="sd">    and m = np.array()</span>

<span class="sd">    iso = False/True</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">r_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
    <span class="n">v_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
    <span class="n">r0_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>

    <span class="n">f_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
    <span class="n">dir_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
    <span class="n">rd_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
    <span class="n">fd_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">lor</span><span class="p">:</span>  <span class="c1"># loop over all reservoirs</span>
        <span class="n">rd_list</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">c</span><span class="p">])</span>

        <span class="n">r_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rd_list</span><span class="p">)</span>
        <span class="n">v_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">volume</span><span class="p">))</span>
        <span class="n">r0_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">))</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># add fluxes for each reservoir entry</span>
        <span class="n">tf</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>  <span class="c1"># temp list for flux data</span>
        <span class="n">td</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>  <span class="c1"># temp list for direction data</span>

        <span class="c1"># loop over all fluxes</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
            <span class="n">fd_list</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">d</span><span class="p">])</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fd_list</span><span class="p">)</span>
            <span class="n">td</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">lodir</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">f_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="p">)</span>
        <span class="n">dir_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">td</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">r_list</span><span class="p">,</span> <span class="n">f_list</span><span class="p">,</span> <span class="n">dir_list</span><span class="p">,</span> <span class="n">v_list</span><span class="p">,</span> <span class="n">r0_list</span>
</pre></div>

        </details>

            <div class="docstring"><p>flux_list :list [] contains all fluxes as
[f.m, f.l, f.h, f.d], where each sublist relates to one reservoir</p>

<p>i.e. per reservoir we have list [f1, f2, f3], where f1 = [m, l, h, d]
and m = np.array()</p>

<p>iso = False/True</p>
</div>


                </section>
                <section id="build_process_list">
                            <div class="attr function"><a class="headerlink" href="#build_process_list">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">build_process_list</span><span class="signature">(lor: list) -&gt; tuple</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">build_process_list</span><span class="p">(</span><span class="n">lor</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">numba.typed</span> <span class="kn">import</span> <span class="n">List</span>
    <span class="kn">import</span> <span class="nn">numba</span>
    <span class="kn">from</span> <span class="nn">numba.core</span> <span class="kn">import</span> <span class="n">types</span>

    <span class="n">fn</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>  <span class="c1"># List() # list of functions</span>
    <span class="n">rd</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>  <span class="c1"># reservoir data</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>  <span class="c1"># flux data  flux.m flux.l, flux.h, flux.d</span>
    <span class="n">pc</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>  <span class="c1"># list of constants</span>

    <span class="c1"># func_name : function reference</span>
    <span class="c1"># res_data :list = reservoir data (m,l,d,c)</span>
    <span class="c1"># flux_data :list = flux data (m,l,h,d)</span>
    <span class="c1"># proc_const : list = any constants, must be float</span>

    <span class="n">f_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">d_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Building Process List&quot;</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">lor</span><span class="p">:</span>  <span class="c1"># loop over reservoirs</span>

        <span class="c1"># note that types.List is differenfr from Types.ListType. Also</span>
        <span class="c1"># note that [::1]  declares C-style arrays see</span>
        <span class="c1"># https://numba.discourse.group/t/list-mistaken-as-list-when-creating-list-of-function-references/677/3</span>
        <span class="n">tfn</span> <span class="o">=</span> <span class="n">numba</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">empty_list</span><span class="p">(</span>
            <span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">void</span><span class="p">)(</span>  <span class="c1"># return value</span>
                <span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">float64</span><span class="p">[::</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">float64</span><span class="p">[::</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> 
                <span class="n">types</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>  <span class="c1"># parameter 4</span>
            <span class="p">)</span><span class="o">.</span><span class="n">as_type</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="n">trd</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
        <span class="n">tfd</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
        <span class="n">tpc</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span>  <span class="c1"># loop over reservoir processes</span>

            
            <span class="n">start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">process_time</span><span class="p">()</span>
            <span class="n">func_name</span><span class="p">,</span> <span class="n">res_data</span><span class="p">,</span> <span class="n">flux_data</span><span class="p">,</span> <span class="n">proc_const</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get_process_args</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">duration</span> <span class="o">=</span>  <span class="n">process_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
            <span class="n">f_time</span> <span class="o">=</span> <span class="n">f_time</span> <span class="o">+</span>  <span class="n">duration</span>
            
            <span class="n">start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">process_time</span><span class="p">()</span>
            <span class="n">tfn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func_name</span><span class="p">)</span>
            <span class="n">trd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res_data</span><span class="p">)</span>
            <span class="n">tfd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux_data</span><span class="p">)</span>
            <span class="n">tpc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proc_const</span><span class="p">)</span>
            <span class="n">duration</span> <span class="o">=</span>  <span class="n">process_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
            <span class="n">d_time</span> <span class="o">=</span> <span class="n">d_time</span> <span class="o">+</span>  <span class="n">duration</span>

        <span class="n">fn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tfn</span><span class="p">)</span>
        <span class="n">rd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trd</span><span class="p">)</span>
        <span class="n">fd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tfd</span><span class="p">)</span>
        <span class="n">pc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tpc</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;f_time = </span><span class="si">{</span><span class="n">f_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;d_time = </span><span class="si">{</span><span class="n">d_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fn</span><span class="p">,</span> <span class="n">rd</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">pc</span>
</pre></div>

        </details>

    

                </section>
                <section id="get_string_between_brackets">
                            <div class="attr function"><a class="headerlink" href="#get_string_between_brackets">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_string_between_brackets</span><span class="signature">(s: str) -&gt; str</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get_string_between_brackets</span><span class="p">(</span><span class="n">s</span> <span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Parse string and extract substring between square brackets</span>

<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">s</span> <span class="o">=</span>  <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column header </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2"> must include units in square brackets&quot;</span><span class="p">)</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column header </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2"> must include units in square brackets&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

        </details>

            <div class="docstring"><p>Parse string and extract substring between square brackets</p>
</div>


                </section>
                <section id="map_units">
                            <div class="attr function"><a class="headerlink" href="#map_units">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">map_units</span><span class="signature">(v: &lt;built-in function any&gt;, *args) -&gt; float</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">map_units</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; parse v to see if it is a string. if yes, map to quantity. </span>
<span class="sd">        parse v to see if it is a quantity, if yes, map to model units</span>
<span class="sd">        and extract magnitude, assign mangitude to return value</span>
<span class="sd">        if not, assign value to return value</span>
<span class="sd">        </span>
<span class="sd">        v : a keyword value number/string/quantity</span>
<span class="sd">        args: one or more quantities (units) see the Model class (e.g., f_unit)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">Q_</span>

    <span class="n">m</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">match</span> <span class="p">:</span><span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># test if string, map to quantity if yes</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="c1"># test if we find a matching dimension, map if true</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Q_</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">dimensionality</span> <span class="o">==</span> <span class="n">q</span><span class="o">.</span><span class="n">dimensionality</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
                <span class="n">match</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2"> is none of </span><span class="si">{</span><span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># no quantity, so it should be a number</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;m is </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="si">}</span><span class="s2">, must be float, v=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">. Something is fishy&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">m</span>
</pre></div>

        </details>

            <div class="docstring"><p>parse v to see if it is a string. if yes, map to quantity. 
parse v to see if it is a quantity, if yes, map to model units
and extract magnitude, assign mangitude to return value
if not, assign value to return value</p>

<p>v : a keyword value number/string/quantity
args: one or more quantities (units) see the Model class (e.g., f_unit)</p>
</div>


                </section>
    </main>
</body>
</html>