<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 6.4.4" />
    <title>esbmtk.esbmtk API documentation</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2264%22%20height%3D%2264%22%20viewBox%3D%2244.5%202.5%2015%2015%22%3E%3Cpath%20d%3D%22M49.351%2021.041c-.233-.721-.546-2.408-.772-4.076-.042-.09-.067-.187-.046-.288-.166-1.347-.277-2.625-.241-3.351-1.378-1.008-2.271-2.586-2.271-4.362%200-.976.272-1.935.788-2.774.057-.094.122-.18.184-.268-.033-.167-.052-.339-.052-.516%200-1.477%201.202-2.679%202.679-2.679.791%200%201.496.352%201.987.9a6.3%206.3%200%200%201%201.001.029c.492-.564%201.207-.929%202.012-.929%201.477%200%202.679%201.202%202.679%202.679a2.65%202.65%200%200%201-.269%201.148c.383.747.595%201.572.595%202.41%200%202.311-1.507%204.29-3.635%205.107.037.699.147%202.27.423%203.294l.137.461c.156%202.136-4.612%205.166-5.199%203.215zm.127-4.919a4.78%204.78%200%200%200%20.775-.584c-.172-.115-.505-.254-.88-.378zm.331%202.302l.828-.502c-.202-.143-.576-.328-.984-.49zm.45%202.157l.701-.403c-.214-.115-.536-.249-.891-.376l.19.779zM49.13%204.141c0%20.152.123.276.276.276s.275-.124.275-.276-.123-.276-.276-.276-.275.124-.275.276zm.735-.389a1.15%201.15%200%200%201%20.314.783%201.16%201.16%200%200%201-1.162%201.162c-.457%200-.842-.27-1.032-.653-.026.117-.042.238-.042.362a1.68%201.68%200%200%200%201.679%201.679%201.68%201.68%200%200%200%201.679-1.679c0-.843-.626-1.535-1.436-1.654zm3.076%201.654a1.68%201.68%200%200%200%201.679%201.679%201.68%201.68%200%200%200%201.679-1.679c0-.037-.009-.072-.011-.109-.21.3-.541.508-.935.508a1.16%201.16%200%200%201-1.162-1.162%201.14%201.14%200%200%201%20.474-.912c-.015%200-.03-.005-.045-.005-.926.001-1.679.754-1.679%201.68zm1.861-1.265c0%20.152.123.276.276.276s.275-.124.275-.276-.123-.276-.276-.276-.275.124-.275.276zm1.823%204.823c0-.52-.103-1.035-.288-1.52-.466.394-1.06.64-1.717.64-1.144%200-2.116-.725-2.499-1.738-.383%201.012-1.355%201.738-2.499%201.738-.867%200-1.631-.421-2.121-1.062-.307.605-.478%201.267-.478%201.942%200%202.486%202.153%204.51%204.801%204.51s4.801-2.023%204.801-4.51zm-3.032%209.156l-.146-.492c-.276-1.02-.395-2.457-.444-3.268a6.11%206.11%200%200%201-1.18.115%206.01%206.01%200%200%201-2.536-.562l.006.175c.802.215%201.848.612%202.021%201.25.079.295-.021.601-.274.837l-.598.501c.667.304%201.243.698%201.311%201.179.02.144.022.507-.393.787l-.564.365c1.285.521%201.361.96%201.381%201.126.018.142.011.496-.427.746l-.854.489c.064-1.19%201.985-2.585%202.697-3.248zM49.34%209.925c0-.667%201-.667%201%200%200%20.653.818%201.205%201.787%201.205s1.787-.552%201.787-1.205c0-.667%201-.667%201%200%200%201.216-1.25%202.205-2.787%202.205s-2.787-.989-2.787-2.205zm-.887-7.633c-.093.077-.205.114-.317.114a.5.5%200%200%201-.318-.886L49.183.397a.5.5%200%200%201%20.703.068.5.5%200%200%201-.069.703zm7.661-.065c-.086%200-.173-.022-.253-.068l-1.523-.893c-.575-.337-.069-1.2.506-.863l1.523.892a.5.5%200%200%201%20.179.685c-.094.158-.261.247-.432.247z%22%20fill%3D%22%233bb300%22/%3E%3C/svg%3E"/>


<style type="text/css">/*! * Bootstrap Reboot v5.0.0-beta1 (https://getbootstrap.com/) * Copyright 2011-2020 The Bootstrap Authors * Copyright 2011-2020 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}[tabindex="-1"]:focus:not(:focus-visible){outline:0!important}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus{outline:dotted 1px;outline:-webkit-focus-ring-color auto 5px}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
<style type="text/css">/*! pygments syntax highlighting */pre{line-height:125%;}td.linenos pre{color:#000000; background-color:#f0f0f0; padding-left:5px; padding-right:5px;}span.linenos{color:#000000; background-color:#f0f0f0; padding-left:5px; padding-right:5px;}td.linenos pre.special{color:#000000; background-color:#ffffc0; padding-left:5px; padding-right:5px;}span.linenos.special{color:#000000; background-color:#ffffc0; padding-left:5px; padding-right:5px;}.pdoc .hll{background-color:#ffffcc}.pdoc{background:#f8f8f8;}.pdoc .c{color:#408080; font-style:italic}.pdoc .err{border:1px solid #FF0000}.pdoc .k{color:#008000; font-weight:bold}.pdoc .o{color:#666666}.pdoc .ch{color:#408080; font-style:italic}.pdoc .cm{color:#408080; font-style:italic}.pdoc .cp{color:#BC7A00}.pdoc .cpf{color:#408080; font-style:italic}.pdoc .c1{color:#408080; font-style:italic}.pdoc .cs{color:#408080; font-style:italic}.pdoc .gd{color:#A00000}.pdoc .ge{font-style:italic}.pdoc .gr{color:#FF0000}.pdoc .gh{color:#000080; font-weight:bold}.pdoc .gi{color:#00A000}.pdoc .go{color:#888888}.pdoc .gp{color:#000080; font-weight:bold}.pdoc .gs{font-weight:bold}.pdoc .gu{color:#800080; font-weight:bold}.pdoc .gt{color:#0044DD}.pdoc .kc{color:#008000; font-weight:bold}.pdoc .kd{color:#008000; font-weight:bold}.pdoc .kn{color:#008000; font-weight:bold}.pdoc .kp{color:#008000}.pdoc .kr{color:#008000; font-weight:bold}.pdoc .kt{color:#B00040}.pdoc .m{color:#666666}.pdoc .s{color:#BA2121}.pdoc .na{color:#7D9029}.pdoc .nb{color:#008000}.pdoc .nc{color:#0000FF; font-weight:bold}.pdoc .no{color:#880000}.pdoc .nd{color:#AA22FF}.pdoc .ni{color:#999999; font-weight:bold}.pdoc .ne{color:#D2413A; font-weight:bold}.pdoc .nf{color:#0000FF}.pdoc .nl{color:#A0A000}.pdoc .nn{color:#0000FF; font-weight:bold}.pdoc .nt{color:#008000; font-weight:bold}.pdoc .nv{color:#19177C}.pdoc .ow{color:#AA22FF; font-weight:bold}.pdoc .w{color:#bbbbbb}.pdoc .mb{color:#666666}.pdoc .mf{color:#666666}.pdoc .mh{color:#666666}.pdoc .mi{color:#666666}.pdoc .mo{color:#666666}.pdoc .sa{color:#BA2121}.pdoc .sb{color:#BA2121}.pdoc .sc{color:#BA2121}.pdoc .dl{color:#BA2121}.pdoc .sd{color:#BA2121; font-style:italic}.pdoc .s2{color:#BA2121}.pdoc .se{color:#BB6622; font-weight:bold}.pdoc .sh{color:#BA2121}.pdoc .si{color:#BB6688; font-weight:bold}.pdoc .sx{color:#008000}.pdoc .sr{color:#BB6688}.pdoc .s1{color:#BA2121}.pdoc .ss{color:#19177C}.pdoc .bp{color:#008000}.pdoc .fm{color:#0000FF}.pdoc .vc{color:#19177C}.pdoc .vg{color:#19177C}.pdoc .vi{color:#19177C}.pdoc .vm{color:#19177C}.pdoc .il{color:#666666}</style>
<style type="text/css">/*! pdoc */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f7f7f7;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}body{background-color:var(--pdoc-background);}html, body{width:100%;height:100%;}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main{padding:2rem 3vw;}.git-button{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}#navtoggle{display:none;}}#togglestate{display:none;}nav.pdoc{--pad:1.75rem;--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc li{display:block;margin:0;padding:.2rem 0 .2rem var(--indent);transition:all 100ms;}nav.pdoc > div > ul > li{padding-left:0;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}html, main{scroll-behavior:smooth;}.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3, .pdoc h4{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{background-color:var(--code);border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.pdoc details{--shift:-40px;text-align:right;margin-top:var(--shift);margin-bottom:calc(0px - var(--shift));clear:both;filter:opacity(1);}.pdoc details:not([open]){height:0;overflow:visible;}.pdoc details > summary{font-size:.75rem;cursor:pointer;color:var(--muted);border-width:0;padding:0 .7em;display:inline-block;display:inline list-item;user-select:none;}.pdoc details > summary:focus{outline:0;}.pdoc details > div{margin-top:calc(0px - var(--shift) / 2);text-align:left;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc > section:first-of-type > .docstring{margin-bottom:3rem;}.pdoc .docstring pre{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc .headerlink{position:absolute;width:0;margin-left:-1.5rem;line-height:1.4rem;font-size:1.5rem;font-weight:normal;transition:all 100ms ease-in-out;opacity:0;}.pdoc .attr > .headerlink{margin-left:-2.5rem;}.pdoc *:hover > .headerlink,.pdoc *:target > .attr > .headerlink{opacity:1;}.pdoc .attr{color:var(--text);margin:1rem 0 .5rem;padding:.4rem 5rem .4rem 1rem;background-color:var(--accent);}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{white-space:pre-wrap;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}</style>
</head>
<body>        <nav class="pdoc">
            <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
            <input id="togglestate" type="checkbox">
            <div>
                        <a class="pdoc-button module-list-button" href="../esbmtk.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                            &nbsp;esbmtk</a>




                    <h2>API Documentation</h2>
                        <ul class="memberlist">
            <li>
                    <a class="class" href="#esbmtkBase">esbmtkBase</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#esbmtkBase.__init__">esbmtkBase</a>
                        </li>
                        <li>
                                <a class="function" href="#esbmtkBase.info">info</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Model">Model</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Model.__init__">Model</a>
                        </li>
                        <li>
                                <a class="variable" href="#Model.lkk">lkk</a>
                        </li>
                        <li>
                                <a class="variable" href="#Model.lrk">lrk</a>
                        </li>
                        <li>
                                <a class="variable" href="#Model.lod">lod</a>
                        </li>
                        <li>
                                <a class="variable" href="#Model.dmo">dmo</a>
                        </li>
                        <li>
                                <a class="variable" href="#Model.lor">lor</a>
                        </li>
                        <li>
                                <a class="variable" href="#Model.loc">loc</a>
                        </li>
                        <li>
                                <a class="variable" href="#Model.lel">lel</a>
                        </li>
                        <li>
                                <a class="variable" href="#Model.lsp">lsp</a>
                        </li>
                        <li>
                                <a class="variable" href="#Model.lop">lop</a>
                        </li>
                        <li>
                                <a class="variable" href="#Model.lpc_f">lpc_f</a>
                        </li>
                        <li>
                                <a class="variable" href="#Model.lpc_r">lpc_r</a>
                        </li>
                        <li>
                                <a class="variable" href="#Model.lvr">lvr</a>
                        </li>
                        <li>
                                <a class="variable" href="#Model.olkk">olkk</a>
                        </li>
                        <li>
                                <a class="variable" href="#Model.lto">lto</a>
                        </li>
                        <li>
                                <a class="variable" href="#Model.ldf">ldf</a>
                        </li>
                        <li>
                                <a class="variable" href="#Model.los">los</a>
                        </li>
                        <li>
                                <a class="variable" href="#Model.plot_style">plot_style</a>
                        </li>
                        <li>
                                <a class="function" href="#Model.info">info</a>
                        </li>
                        <li>
                                <a class="function" href="#Model.save_state">save_state</a>
                        </li>
                        <li>
                                <a class="function" href="#Model.save_data">save_data</a>
                        </li>
                        <li>
                                <a class="function" href="#Model.read_state">read_state</a>
                        </li>
                        <li>
                                <a class="function" href="#Model.plot_data">plot_data</a>
                        </li>
                        <li>
                                <a class="function" href="#Model.plot">plot</a>
                        </li>
                        <li>
                                <a class="function" href="#Model.plot_reservoirs">plot_reservoirs</a>
                        </li>
                        <li>
                                <a class="function" href="#Model.run">run</a>
                        </li>
                        <li>
                                <a class="function" href="#Model.list_species">list_species</a>
                        </li>
                        <li>
                                <a class="function" href="#Model.flux_summary">flux_summary</a>
                        </li>
                        <li>
                                <a class="function" href="#Model.connection_summary">connection_summary</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Element">Element</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Element.__init__">Element</a>
                        </li>
                        <li>
                                <a class="variable" href="#Element.lrk">lrk</a>
                        </li>
                        <li>
                                <a class="variable" href="#Element.n">n</a>
                        </li>
                        <li>
                                <a class="variable" href="#Element.mo">mo</a>
                        </li>
                        <li>
                                <a class="variable" href="#Element.mu">mu</a>
                        </li>
                        <li>
                                <a class="variable" href="#Element.ln">ln</a>
                        </li>
                        <li>
                                <a class="variable" href="#Element.hn">hn</a>
                        </li>
                        <li>
                                <a class="variable" href="#Element.dn">dn</a>
                        </li>
                        <li>
                                <a class="variable" href="#Element.ds">ds</a>
                        </li>
                        <li>
                                <a class="variable" href="#Element.lsp">lsp</a>
                        </li>
                        <li>
                                <a class="function" href="#Element.list_species">list_species</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Species">Species</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Species.__init__">Species</a>
                        </li>
                        <li>
                                <a class="variable" href="#Species.lkk">lkk</a>
                        </li>
                        <li>
                                <a class="variable" href="#Species.r">r</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Reservoir">Reservoir</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Reservoir.__init__">Reservoir</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.lkk">lkk</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.lrk">lrk</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.lod">lod</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.n">n</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.sp">sp</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.mo">mo</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.rvalue">rvalue</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.volume">volume</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.v">v</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.mu">mu</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.lof">lof</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.led">led</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.lio">lio</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.lop">lop</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.loe">loe</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.doe">doe</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.loc">loc</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.ldf">ldf</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.lpc">lpc</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.m">m</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.l">l</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.h">h</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.lm">lm</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.ld">ld</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.xl">xl</a>
                        </li>
                        <li>
                                <a class="function" href="#Reservoir.info">info</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.c">c</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.d">d</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.lodir">lodir</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ReservoirGroup">ReservoirGroup</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ReservoirGroup.__init__">ReservoirGroup</a>
                        </li>
                        <li>
                                <a class="variable" href="#ReservoirGroup.lkk">lkk</a>
                        </li>
                        <li>
                                <a class="variable" href="#ReservoirGroup.lrk">lrk</a>
                        </li>
                        <li>
                                <a class="variable" href="#ReservoirGroup.lod">lod</a>
                        </li>
                        <li>
                                <a class="variable" href="#ReservoirGroup.cd">cd</a>
                        </li>
                        <li>
                                <a class="variable" href="#ReservoirGroup.lor">lor</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Flux">Flux</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Flux.__init__">Flux</a>
                        </li>
                        <li>
                                <a class="variable" href="#Flux.lkk">lkk</a>
                        </li>
                        <li>
                                <a class="variable" href="#Flux.lrk">lrk</a>
                        </li>
                        <li>
                                <a class="variable" href="#Flux.lod">lod</a>
                        </li>
                        <li>
                                <a class="variable" href="#Flux.n">n</a>
                        </li>
                        <li>
                                <a class="variable" href="#Flux.sp">sp</a>
                        </li>
                        <li>
                                <a class="variable" href="#Flux.mo">mo</a>
                        </li>
                        <li>
                                <a class="variable" href="#Flux.model">model</a>
                        </li>
                        <li>
                                <a class="variable" href="#Flux.rvalue">rvalue</a>
                        </li>
                        <li>
                                <a class="variable" href="#Flux.mu">mu</a>
                        </li>
                        <li>
                                <a class="variable" href="#Flux.m">m</a>
                        </li>
                        <li>
                                <a class="variable" href="#Flux.l">l</a>
                        </li>
                        <li>
                                <a class="variable" href="#Flux.h">h</a>
                        </li>
                        <li>
                                <a class="variable" href="#Flux.d">d</a>
                        </li>
                        <li>
                                <a class="variable" href="#Flux.lm">lm</a>
                        </li>
                        <li>
                                <a class="variable" href="#Flux.ld">ld</a>
                        </li>
                        <li>
                                <a class="variable" href="#Flux.legend_left">legend_left</a>
                        </li>
                        <li>
                                <a class="variable" href="#Flux.legend_right">legend_right</a>
                        </li>
                        <li>
                                <a class="variable" href="#Flux.xl">xl</a>
                        </li>
                        <li>
                                <a class="variable" href="#Flux.lop">lop</a>
                        </li>
                        <li>
                                <a class="variable" href="#Flux.lpc">lpc</a>
                        </li>
                        <li>
                                <a class="variable" href="#Flux.led">led</a>
                        </li>
                        <li>
                                <a class="variable" href="#Flux.source">source</a>
                        </li>
                        <li>
                                <a class="variable" href="#Flux.sink">sink</a>
                        </li>
                        <li>
                                <a class="function" href="#Flux.info">info</a>
                        </li>
                        <li>
                                <a class="function" href="#Flux.plot">plot</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#SourceSink">SourceSink</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SourceSink.__init__">SourceSink</a>
                        </li>
                        <li>
                                <a class="variable" href="#SourceSink.lkk">lkk</a>
                        </li>
                        <li>
                                <a class="variable" href="#SourceSink.lrk">lrk</a>
                        </li>
                        <li>
                                <a class="variable" href="#SourceSink.lod">lod</a>
                        </li>
                        <li>
                                <a class="variable" href="#SourceSink.loc">loc</a>
                        </li>
                        <li>
                                <a class="variable" href="#SourceSink.lio">lio</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Sink">Sink</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#Source">Source</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#SourceSinkGroup">SourceSinkGroup</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SourceSinkGroup.__init__">SourceSinkGroup</a>
                        </li>
                        <li>
                                <a class="variable" href="#SourceSinkGroup.lkk">lkk</a>
                        </li>
                        <li>
                                <a class="variable" href="#SourceSinkGroup.lrk">lrk</a>
                        </li>
                        <li>
                                <a class="variable" href="#SourceSinkGroup.lod">lod</a>
                        </li>
                        <li>
                                <a class="variable" href="#SourceSinkGroup.loc">loc</a>
                        </li>
                        <li>
                                <a class="variable" href="#SourceSinkGroup.lor">lor</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#SinkGroup">SinkGroup</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#SourceGroup">SourceGroup</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#Signal">Signal</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Signal.__init__">Signal</a>
                        </li>
                        <li>
                                <a class="variable" href="#Signal.lkk">lkk</a>
                        </li>
                        <li>
                                <a class="variable" href="#Signal.lrk">lrk</a>
                        </li>
                        <li>
                                <a class="variable" href="#Signal.lod">lod</a>
                        </li>
                        <li>
                                <a class="variable" href="#Signal.los">los</a>
                        </li>
                        <li>
                                <a class="variable" href="#Signal.st">st</a>
                        </li>
                        <li>
                                <a class="variable" href="#Signal.l">l</a>
                        </li>
                        <li>
                                <a class="variable" href="#Signal.n">n</a>
                        </li>
                        <li>
                                <a class="variable" href="#Signal.sp">sp</a>
                        </li>
                        <li>
                                <a class="variable" href="#Signal.mo">mo</a>
                        </li>
                        <li>
                                <a class="variable" href="#Signal.ty">ty</a>
                        </li>
                        <li>
                                <a class="variable" href="#Signal.sh">sh</a>
                        </li>
                        <li>
                                <a class="variable" href="#Signal.d">d</a>
                        </li>
                        <li>
                                <a class="variable" href="#Signal.kwd">kwd</a>
                        </li>
                        <li>
                                <a class="variable" href="#Signal.led">led</a>
                        </li>
                        <li>
                                <a class="function" href="#Signal.repeat">repeat</a>
                        </li>
                        <li>
                                <a class="function" href="#Signal.plot">plot</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#DataField">DataField</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#DataField.__init__">DataField</a>
                        </li>
                        <li>
                                <a class="variable" href="#DataField.lkk">lkk</a>
                        </li>
                        <li>
                                <a class="variable" href="#DataField.lrk">lrk</a>
                        </li>
                        <li>
                                <a class="variable" href="#DataField.lod">lod</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#VirtualReservoir">VirtualReservoir</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#VirtualReservoir.update">update</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ExternalData">ExternalData</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ExternalData.__init__">ExternalData</a>
                        </li>
                        <li>
                                <a class="variable" href="#ExternalData.lkk">lkk</a>
                        </li>
                        <li>
                                <a class="variable" href="#ExternalData.lrk">lrk</a>
                        </li>
                        <li>
                                <a class="variable" href="#ExternalData.lod">lod</a>
                        </li>
                        <li>
                                <a class="variable" href="#ExternalData.n">n</a>
                        </li>
                        <li>
                                <a class="variable" href="#ExternalData.fn">fn</a>
                        </li>
                        <li>
                                <a class="variable" href="#ExternalData.mo">mo</a>
                        </li>
                        <li>
                                <a class="variable" href="#ExternalData.df">df</a>
                        </li>
                        <li>
                                <a class="variable" href="#ExternalData.x">x</a>
                        </li>
                        <li>
                                <a class="function" href="#ExternalData.plot">plot</a>
                        </li>
                </ul>

            </li>
    </ul>


                    <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev">
                        built with <span class="visually-hidden">pdoc</span><img
                            alt="pdoc logo"
                            src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
                    </a>
            </div>
        </nav>
    <main class="pdoc">
            <section>
                    <h1 class="modulename">
<a href="./../esbmtk.html">esbmtk</a>.esbmtk    </h1>

                        <div class="docstring"><p>esbmtk: A general purpose Earth Science box model toolkit
Copyright (C), 2020 Ulrich G. Wortmann</p>

<p>This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.</p>

<p>This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.</p>

<p>You should have received a copy of the GNU General Public License
along with this program.  If not, see <a href="https://www.gnu.org/licenses/">https://www.gnu.org/licenses/</a>.</p>
</div>

                        <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     esbmtk: A general purpose Earth Science box model toolkit</span>
<span class="sd">     Copyright (C), 2020 Ulrich G. Wortmann</span>

<span class="sd">     This program is free software: you can redistribute it and/or modify</span>
<span class="sd">     it under the terms of the GNU General Public License as published by</span>
<span class="sd">     the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">     (at your option) any later version.</span>

<span class="sd">     This program is distributed in the hope that it will be useful,</span>
<span class="sd">     but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="sd">     GNU General Public License for more details.</span>

<span class="sd">     You should have received a copy of the GNU General Public License</span>
<span class="sd">     along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">numbers</span> <span class="kn">import</span> <span class="n">Number</span>
<span class="kn">from</span> <span class="nn">nptyping</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">array</span><span class="p">,</span> <span class="n">set_printoptions</span><span class="p">,</span> <span class="n">arange</span><span class="p">,</span> <span class="n">zeros</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="n">mean</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span><span class="p">,</span> <span class="n">copy</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">process_time</span>
<span class="kn">from</span> <span class="nn">numba.typed</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">import</span> <span class="nn">numba</span>
<span class="kn">from</span> <span class="nn">numba.core</span> <span class="kn">import</span> <span class="n">types</span> <span class="k">as</span> <span class="n">nbt</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">builtins</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">.utility_functions</span> <span class="kn">import</span> <span class="n">get_imass</span><span class="p">,</span> <span class="n">get_delta</span><span class="p">,</span> <span class="n">get_plot_layout</span>
<span class="kn">from</span> <span class="nn">.utility_functions</span> <span class="kn">import</span> <span class="n">plot_object_data</span><span class="p">,</span> <span class="n">show_data</span><span class="p">,</span> <span class="n">plot_geometry</span>
<span class="kn">from</span> <span class="nn">.utility_functions</span> <span class="kn">import</span> <span class="n">get_string_between_brackets</span><span class="p">,</span> <span class="n">execute</span><span class="p">,</span> <span class="n">execute_h</span><span class="p">,</span> <span class="n">execute_n</span><span class="p">,</span> <span class="n">execute_e</span>
<span class="c1"># from .sealevel import get_box_geometry_parameters</span>

<span class="k">class</span> <span class="nc">esbmtkBase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The esbmtk base class template. This class handles keyword</span>
<span class="sd">    arguments, name registration and other common tasks</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="s2">&quot;__dict__&quot;</span>

    <span class="c1"># from typing import Dict</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">__global_defaults__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initial variables which should be present in every object</span>
<span class="sd">        Note that this is executed before we register the kwargs as instance</span>
<span class="sd">        variables</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lmo</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ldo</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;full_name&quot;</span><span class="p">,</span> <span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;groupname&quot;</span><span class="p">,</span> <span class="s2">&quot;ctype&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldo</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;set </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> self.kwargs[</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">] to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__validateandregister__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate the user provided input key-value pairs. For this we need</span>
<span class="sd">        kwargs = dictionary with the user provided key-value pairs</span>
<span class="sd">        self.lkk = dictionary with allowed keys and type</span>
<span class="sd">        self.lrk = list of mandatory keywords</span>
<span class="sd">        self.lod = dictionary of default values for keys</span>

<span class="sd">        and register the instance variables and the instance in the global name space</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># validate input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__validateinput__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># add global key-value pairs which should be present in each object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__global_defaults__</span><span class="p">()</span>

        <span class="c1"># register all key/value pairs as instance variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__registerkeys__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__register_name__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register object name in global name space, and test if</span>
<span class="sd">        name is unique</span>

<span class="sd">        There are two possible cases: This is a regular object, which will be registered</span>
<span class="sd">        in the global namespace (self.register is not set).</span>

<span class="sd">        Case B) This object should be registered in the local namespace of a group. In which case</span>
<span class="sd">        self.register should be set to the group object.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># we use this to suppress the echo during object creation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

        <span class="c1"># if self register is set, it points to the group object which contains</span>
        <span class="c1"># this sub object.</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;self.register = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>  <span class="c1"># Register in global namespace</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Registering </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> in global namespace as type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>  <span class="c1"># Cannot register model with itself</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">builtins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lmo</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is a duplicate name. Please fix&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">builtins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lmo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dmo</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="p">})</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># register in group namespace</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="n">Element</span><span class="p">)):</span>  <span class="c1"># Model only exist in the global NS</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">builtins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># not a model, and part of group</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Registering </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> namespace&quot;</span>
                <span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">full_name</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                    <span class="n">fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span> <span class="o">=</span> <span class="n">fn</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">lmo</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> is a duplicate name. Please fix&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">lmo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>
                <span class="c1"># setattr(builtins, self.name, self)</span>
                <span class="c1"># self.mo.dmo.update({self.name: self})</span>

        <span class="c1"># add fullname to kwargs so it shows up in __repr__</span>
        <span class="c1"># its a dirty hack though</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provided_kwargs</span><span class="p">[</span><span class="s2">&quot;full_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__validateinput__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate the user provided input key-value pairs. For this we need</span>
<span class="sd">        kwargs = dictionary with the user provided key-value pairs</span>
<span class="sd">        self.lkk = dictionary with allowed keys and type</span>
<span class="sd">        self.lrk = list of mandatory keywords</span>
<span class="sd">        self.lod = dictionary of default values for keys</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>  <span class="c1"># store the kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provided_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># preserve a copy</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;lkk&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;lrk&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;lod&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;drn&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drn</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># check that mandatory keys are present</span>
        <span class="c1"># and that all keys are allowed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__checkkeys__</span><span class="p">()</span>

        <span class="c1"># initialize missing parameters</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__addmissingdefaults__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># check if key values are of correct type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__checktypes__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__checktypes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">av</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">],</span> <span class="n">pv</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;this method will use the the dict key in the user provided</span>
<span class="sd">        key value data (pv) to look up the allowed data type for this key in av</span>

<span class="sd">        av = dictinory with the allowed input keys and their type</span>
<span class="sd">        pv = dictionary with the user provided key-value data</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">k</span><span class="p">:</span> <span class="nb">any</span>
        <span class="n">v</span><span class="p">:</span> <span class="nb">any</span>

        <span class="c1"># provide more meaningful error messages</span>

        <span class="c1"># loop over provided keywords</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pv</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># check av if provided value v is of correct type</span>
            <span class="k">if</span> <span class="n">av</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">any</span><span class="p">:</span>
                <span class="c1"># print(f&quot;key = {k}, value  = {v}&quot;)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">av</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>

                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2"> is the wrong type for &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39;, should be &#39;</span><span class="si">{</span><span class="n">av</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__initerrormessages__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Init the list of known error messages&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bem</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Number&quot;</span><span class="p">:</span> <span class="s2">&quot;a number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Model&quot;</span><span class="p">:</span> <span class="s2">&quot;a model handle (i.e. the name without quotation marks)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Element&quot;</span><span class="p">:</span> <span class="s2">&quot;an element handle (i.e. the name without quotation marks)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Species&quot;</span><span class="p">:</span> <span class="s2">&quot;a species handle (i.e. the name without quotation marks)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Flux&quot;</span><span class="p">:</span> <span class="s2">&quot;a flux handle (i.e. the name without quotation marks)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Reservoir&quot;</span><span class="p">:</span> <span class="s2">&quot;a reservoir handle (i.e. the name without quotation marks)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Signal&quot;</span><span class="p">:</span> <span class="s2">&quot;a signal handle (i.e. the name without quotation marks)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Process&quot;</span><span class="p">:</span> <span class="s2">&quot;a process handle (i.e. the name without quotation marks)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Unit&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;File&quot;</span><span class="p">:</span> <span class="s2">&quot;a filename inb the local directory&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Legend&quot;</span><span class="p">:</span> <span class="s2">&quot; a string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Source&quot;</span><span class="p">:</span> <span class="s2">&quot; a string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Sink&quot;</span><span class="p">:</span> <span class="s2">&quot; a string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Ref&quot;</span><span class="p">:</span> <span class="s2">&quot; a Flux reference&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Alpha&quot;</span><span class="p">:</span> <span class="s2">&quot; a Number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Delta&quot;</span><span class="p">:</span> <span class="s2">&quot; a Number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Scale&quot;</span><span class="p">:</span> <span class="s2">&quot; a Number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Ratio&quot;</span><span class="p">:</span> <span class="s2">&quot; a Number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="s2">&quot;a number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;a model handle (i.e. the name without quotation marks)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;element&quot;</span><span class="p">:</span> <span class="s2">&quot;an element handle (i.e. the name without quotation marks)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="s2">&quot;a species handle (i.e. the name without quotation marks)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;flux&quot;</span><span class="p">:</span> <span class="s2">&quot;a flux handle (i.e. the name without quotation marks)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;reservoir&quot;</span><span class="p">:</span> <span class="s2">&quot;a reservoir handle (i.e. the name without quotation marks)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;signal&quot;</span><span class="p">:</span> <span class="s2">&quot;a signal handle (i.e. the name without quotation marks)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Process&quot;</span><span class="p">:</span> <span class="s2">&quot;a process handle (i.e. the name without quotation marks)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="s2">&quot;a filename inb the local directory&quot;</span><span class="p">,</span>
            <span class="s2">&quot;legend&quot;</span><span class="p">:</span> <span class="s2">&quot; a string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot; a string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sink&quot;</span><span class="p">:</span> <span class="s2">&quot; a string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ref&quot;</span><span class="p">:</span> <span class="s2">&quot; a Flux reference&quot;</span><span class="p">,</span>
            <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="s2">&quot; a Number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="s2">&quot; a Number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="s2">&quot;a Number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ratio&quot;</span><span class="p">:</span> <span class="s2">&quot;a Number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="s2">&quot;a Number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pl&quot;</span><span class="p">:</span> <span class="s2">&quot; a list with one or more process handles&quot;</span><span class="p">,</span>
            <span class="s2">&quot;react_with&quot;</span><span class="p">:</span> <span class="s2">&quot;a Flux handle&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;External Data Object&quot;</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="s2">&quot;esbmtk object&quot;</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">:</span> <span class="s2">&quot;a string with quotation marks&quot;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__registerkeys__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;register the kwargs key/value pairs as instance variables</span>
<span class="sd">        and complain about unknown keywords&quot;&quot;&quot;</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">any</span>  <span class="c1"># dict keys</span>
        <span class="n">v</span><span class="p">:</span> <span class="nb">any</span>  <span class="c1"># dict values</span>

        <span class="c1"># need list of replacement values</span>
        <span class="c1"># &quot;alpha&quot; : _alpha</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># check wheather the variable name needs to be replaced</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">drn</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drn</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__checkkeys__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; check if the mandatory keys are present&quot;&quot;&quot;</span>

        <span class="n">k</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">v</span><span class="p">:</span> <span class="nb">any</span>
        <span class="c1"># test if the required keywords are given</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span>  <span class="c1"># loop over required keywords</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  <span class="c1"># If keyword is a list</span>
                <span class="n">s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># loop over allowed substitutions</span>
                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>  <span class="c1"># test how many matches are in this list</span>
                    <span class="k">if</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># if more than one match</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;You need to specify exactly one from this list: </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c1"># keyword is not a list</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You need to specify a value for </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">tl</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># get a list of all known keywords</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">tl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="c1"># test if we know all keys</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> is not a valid keyword. </span><span class="se">\n</span><span class="s2"> Try any of </span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">tl</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__addmissingdefaults__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lod</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        test if the keys in lod exist in kwargs, otherwise add them with the default values</span>
<span class="sd">        in lod</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">lod</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                    <span class="n">new</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">})</span>

        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">kwargs</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Print the basic parameters for this class when called via the print method&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Q_</span>

        <span class="n">m</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># suppress output during object initialization</span>
        <span class="n">tdiff</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_time</span>

        <span class="c1"># do not echo input unless explicitly requestted</span>

        <span class="n">m</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">provided_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">({</span><span class="n">k</span><span class="p">},</span> <span class="n">esbmtkBase</span><span class="p">):</span>
                <span class="c1"># check if this is not another esbmtk object</span>
                <span class="k">if</span> <span class="s2">&quot;esbmtk&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)):</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="c1"># if this is a string</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> = &#39;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&#39;,</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="c1"># if this is a quantity</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Q_</span><span class="p">):</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> = &#39;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&#39;,</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="c1"># if this is a list</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> = &#39;</span><span class="si">{</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;,</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="c1"># all other cases</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>

        <span class="k">if</span> <span class="n">log</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tdiff</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">return</span> <span class="n">m</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print the basic parameters for this class when called via the print method</span>
<span class="sd">        Optional arguments</span>

<span class="sd">        indent :int = 0 printing offset</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Q_</span>

        <span class="n">m</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">off</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>

        <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">ind</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="s2">&quot; &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ind</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">m</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">provided_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">({</span><span class="n">k</span><span class="p">},</span> <span class="n">esbmtkBase</span><span class="p">):</span>
                <span class="c1"># check if this is not another esbmtk object</span>
                <span class="k">if</span> <span class="s2">&quot;esbmtk&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)):</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;name&quot;</span><span class="p">):</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="n">off</span><span class="si">}{</span><span class="n">k</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Q_</span><span class="p">):</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="n">off</span><span class="si">}{</span><span class="n">k</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">elif</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="n">off</span><span class="si">}{</span><span class="n">k</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">m</span>

    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This is needed for sorting with sorted()&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">n</span>

    <span class="k">def</span> <span class="fm">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This is needed for sorting with sorted()&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">n</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show an overview of the object properties.</span>
<span class="sd">        Optional arguments are</span>

<span class="sd">        indent :int = 0 indentation</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>

        <span class="c1"># print basic data bout this object</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__aux_inits__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Aux initialization code. Not normally used&quot;&quot;&quot;</span>

        <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class is used to specify a new model</span>

<span class="sd">    Example:</span>

<span class="sd">          esbmtkModel(name   =  &quot;Test_Model&quot;,</span>
<span class="sd">                      start    = &quot;0 yrs&quot;,    # optional: start time</span>
<span class="sd">                      stop     = &quot;1000 yrs&quot;, # end time</span>
<span class="sd">                      timestep = &quot;2 yrs&quot;,    # as a string &quot;2 yrs&quot;</span>
<span class="sd">                      offset = &quot;0 yrs&quot;,    # optional: time offset for plot</span>
<span class="sd">                      mass_unit = &quot;mol/l&quot;,   #required</span>
<span class="sd">                      volume_unit = &quot;mol/l&quot;, #required</span>
<span class="sd">                      time_label = optional, defaults to &quot;Time&quot;</span>
<span class="sd">                      display_precision = optional, defaults to 0.01,</span>
<span class="sd">                      m_type = &quot;mass_only/both&quot;</span>
<span class="sd">                      plot_style = &#39;default&#39;, optional defaults to &#39;default&#39;</span>
<span class="sd">                      )</span>

<span class="sd">    ref_time:  will offset the time axis by the specified</span>
<span class="sd">                 amount, when plotting the data, .i.e., the model time runs from to</span>
<span class="sd">                 100, but you want to plot data as if where from 2000 to 2100, you would</span>
<span class="sd">                 specify a value of 2000. This is for display purposes only, and does not affect</span>
<span class="sd">                 the model. Care must be taken that any external data references the model</span>
<span class="sd">                 time domain, and not the display time.</span>

<span class="sd">    display precision: affects the on-screen display of data. It is</span>
<span class="sd">                       also cutoff for the graphicak output. I.e., the interval f the y-axis will not be</span>
<span class="sd">                       smaller than the display_precision.</span>

<span class="sd">    m_type: enables or disables isotope calculation for the entire model.</span>
<span class="sd">            The default value  is &quot;Not set&quot; in this case isotopes will only be calculated for</span>
<span class="sd">            reservoirs which set the isotope keyword. &#39;mass_only&#39; &#39;both&#39; will override</span>
<span class="sd">            the reservoir settings</span>


<span class="sd">    All of the above keyword values are available as variables with</span>
<span class="sd">    Model_Name.keyword</span>

<span class="sd">    The user facing methods of the model class are</span>
<span class="sd">       - Model_Name.info()</span>
<span class="sd">       - Model_Name.save_data()</span>
<span class="sd">       - Model_Name.plot_data()</span>
<span class="sd">       - Model_Name.plot_reservoirs() takes an optional filename as argument</span>
<span class="sd">       - Model_Name.plot([sb.DIC, sb.TA]) plot any object in the list</span>
<span class="sd">       - Model_Name.save_state() Save the model state</span>
<span class="sd">       - Model_name.read_state() Initialize with a previous model state</span>
<span class="sd">       - Model_Name.run(), there are 2 optional arguments here, solver=&quot;hybrid&quot;</span>
<span class="sd">         and solver = &quot;numba&quot;. Both involve a 3 to 5 second overhead. The hybrid</span>
<span class="sd">         solver is compatible with all connection types, and about 3 times faster</span>
<span class="sd">         than the  regular solver. The numba solver is about 10 faster, but currently</span>
<span class="sd">         only supports a limited set of connection types.</span>
<span class="sd">       - Model_Name.list_species()</span>
<span class="sd">       - Model_name.flux_summary()</span>
<span class="sd">       - Model_Name.connection_summary()</span>

<span class="sd">    User facing variable are Model_Name.time which contains the time</span>
<span class="sd">    axis.</span>

<span class="sd">    Optional, you can provide the element keyword which will setup a</span>
<span class="sd">    default set of Species for Carbon and Sulfur. In this case, there</span>
<span class="sd">    is no need to define elements or species. The argument to this</span>
<span class="sd">    keyword are either &quot;Carbon&quot;, or &quot;Sulfur&quot; or both as a list</span>
<span class="sd">    [&quot;Carbon&quot;, &quot;Sulfur&quot;].</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="s2">&quot;lor&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Init Sequence&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;stop&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;timestep&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;element&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span>
            <span class="s2">&quot;mass_unit&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;volume_unit&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;time_label&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="s2">&quot;m_type&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;plot_style&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;stop&quot;</span><span class="p">,</span> <span class="s2">&quot;timestep&quot;</span><span class="p">,</span> <span class="s2">&quot;mass_unit&quot;</span><span class="p">,</span> <span class="s2">&quot;volume_unit&quot;</span><span class="p">]</span>

        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="s2">&quot;0 years&quot;</span><span class="p">,</span>
            <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="s2">&quot;0 years&quot;</span><span class="p">,</span>
            <span class="s2">&quot;time_label&quot;</span><span class="p">:</span> <span class="s2">&quot;Time&quot;</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
            <span class="s2">&quot;m_type&quot;</span><span class="p">:</span> <span class="s2">&quot;Not Set&quot;</span><span class="p">,</span>
            <span class="s2">&quot;plot_style&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bem</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;timesetp&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;element&quot;</span><span class="p">:</span> <span class="s2">&quot;element name or list of names&quot;</span><span class="p">,</span>
                <span class="s2">&quot;mass_unit&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;volume_unit&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;time_label&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="s2">&quot;a number&quot;</span><span class="p">,</span>
                <span class="s2">&quot;m_type&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;plot_style&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># empty list which will hold all reservoir references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dmo</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dict of all model objects. useful for name lookups</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># empty list which will hold all connector references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># set with connection handles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lel</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list which will hold all element references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lsp</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list which will hold all species references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list flux processe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpc_f</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of external functions affecting fluxes</span>
        <span class="c1"># list of external functions affecting virtual reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpc_r</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of virtual reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># optional keywords for use in the connector class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">olkk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of objects which require a delayed initialize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lto</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of datafield objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ldf</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of signals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Parse the strings which contain unit information and convert</span>
        <span class="c1"># into model base units For this we setup 3 variables which define</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l_unit</span> <span class="o">=</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span>  <span class="c1"># the length unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># the time unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># display time units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_unit</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># the mass unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume_unit</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># the volume unit</span>
        <span class="c1"># the concentration unit (mass/volume)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_unit</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_unit</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span>  <span class="c1"># the flux unit (mass/time)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_unit</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span>  <span class="c1"># flux as volume/time</span>
        <span class="c1"># this is now defined in __init__.py</span>
        <span class="c1"># ureg.define(&#39;Sverdrup = 1e6 * meter **3 / second = Sv = Sverdrups&#39;)</span>

        <span class="c1"># legacy variable names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tu</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bu</span><span class="p">)</span>  <span class="c1"># needs to be a string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_style</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_style</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xl</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Time [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bu</span><span class="si">}</span><span class="s2">]&quot;</span>  <span class="c1"># time axis label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># initialize the hypsometry class</span>
        <span class="n">hypsometry</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;hyp&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># set_printoptions(precision=self.display_precision)</span>

        <span class="k">if</span> <span class="s2">&quot;element&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">element_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">element_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">]]</span>

            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">element_list</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">e</span> <span class="o">==</span> <span class="s2">&quot;Carbon&quot;</span><span class="p">:</span>
                    <span class="n">carbon</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">e</span> <span class="o">==</span> <span class="s2">&quot;Sulfur&quot;</span><span class="p">:</span>
                    <span class="n">sulfur</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">e</span> <span class="o">==</span> <span class="s2">&quot;Hydrogen&quot;</span><span class="p">:</span>
                    <span class="n">hydrogen</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">e</span> <span class="o">==</span> <span class="s2">&quot;Phosphor&quot;</span><span class="p">:</span>
                    <span class="n">phosphor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">e</span> <span class="o">==</span> <span class="s2">&quot;Oxygen&quot;</span><span class="p">:</span>
                    <span class="n">oxygen</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">e</span> <span class="o">==</span> <span class="s2">&quot;Nitrogen&quot;</span><span class="p">:</span>
                    <span class="n">nitrogen</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">e</span> <span class="o">==</span> <span class="s2">&quot;Boron&quot;</span><span class="p">:</span>
                    <span class="n">boron</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> not implemented yet&quot;</span><span class="p">)</span>

        <span class="n">warranty</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ESBMTK  Copyright (C) 2020  Ulrich G.Wortmann</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;This program comes with ABSOLUTELY NO WARRANTY</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;For details see the LICENSE file</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;This is free software, and you are welcome to redistribute it</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;under certain conditions; See the LICENSE file for details.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">warranty</span><span class="p">)</span>

        <span class="c1"># start a log file</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">handlers</span><span class="p">[:]:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

        <span class="n">fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.log&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">fn</span><span class="p">,</span> <span class="n">filemode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show an overview of the object properties.</span>
<span class="sd">        Optional arguments are</span>
<span class="sd">        index  :int = 0 this will show data at the given index</span>
<span class="sd">        indent :int = 0 indentation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">off</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>
        <span class="k">if</span> <span class="s2">&quot;index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>

        <span class="c1"># print basic data bout this object</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># list elements</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Currently defined elements and their species:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lel</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}</span><span class="s2"> Defined Species:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">lsp</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}{</span><span class="n">off</span><span class="si">}{</span><span class="n">ind</span><span class="si">}{</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Save model state. Similar to save data, but only saves the last 10</span>
<span class="sd">        time-steps</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
        <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">stride</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;state_&quot;</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__write_data__</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">stride</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Save the model results to a CSV file. Each reservoir will have</span>
<span class="sd">        their own CSV file</span>

<span class="sd">        Optional arguments:</span>
<span class="sd">        stride = int  # every nth element</span>
<span class="sd">        start = int   # start index</span>
<span class="sd">        stop = int    # end index</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> must be an integer number&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> must be an integer number&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;stride&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">stride</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;stride&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stride</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="s2">&quot;start&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="s2">&quot;stop&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;stop&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># Save reservoir and flux data</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__write_data__</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">stride</span><span class="p">)</span>

        <span class="c1"># save data fields</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldf</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__write_data__</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">stride</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This will initialize the model with the result of a previous model</span>
<span class="sd">        run.  For this to work, you will need issue a</span>
<span class="sd">        Model.save_state() command at then end of a model run. This</span>
<span class="sd">        will create the necessary data files to initialize a</span>
<span class="sd">        subsequent model run.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__read_state__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">plot_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loop over all reservoirs and either plot the data into a</span>
<span class="sd">        window, or save it to a pdf</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__plot__</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># create the plot windows</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot all objects specified in list)</span>

<span class="sd">        M.plot([sb.PO4, sb.DIC],fn=test.pdf)</span>

<span class="sd">        fn is optional</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;fn&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;fn&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">.pdf&quot;</span>

        <span class="n">noo</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="n">size</span><span class="p">,</span> <span class="n">geo</span> <span class="o">=</span> <span class="n">plot_geometry</span><span class="p">(</span><span class="n">noo</span><span class="p">)</span>  <span class="c1"># adjust layout</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_style</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Initialize a plot window</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> Reservoirs&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
            <span class="n">plot_object_data</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># create the plot windows</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.88</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_reservoirs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot only Reservoir data</span>

<span class="sd">        you can further specify a different name for the plot</span>
<span class="sd">        fn = &quot;foo.pdf&quot;</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># get number of plot objects</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># get number of signals</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">plot</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># get number of reservoirs</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">plot</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># get number of virtual reservoirs</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">plot</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">noo</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ldf</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span>
        <span class="n">size</span><span class="p">,</span> <span class="n">geo</span> <span class="o">=</span> <span class="n">plot_geometry</span><span class="p">(</span><span class="n">noo</span><span class="p">)</span>  <span class="c1"># adjust layout</span>

        <span class="k">if</span> <span class="s2">&quot;fn&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;fn&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">_Reservoirs.pdf&quot;</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_style</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Initialize a plot window</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> Reservoirs&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">:</span>  <span class="c1"># signals</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">plot</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
                <span class="n">plot_object_data</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>  <span class="c1"># reservoirs</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">plot</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
                <span class="n">plot_object_data</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span>  <span class="c1"># virtual reservoirs</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">plot</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
                <span class="n">plot_object_data</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldf</span><span class="p">:</span>  <span class="c1"># datafields</span>
            <span class="n">plot_object_data</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># create the plot windows</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.88</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Loop over the time vector, and for each time step, calculate the</span>
<span class="sd">        fluxes for each reservoir</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># this has nothing todo with self.time below!</span>
        <span class="n">wts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">process_time</span><span class="p">()</span>
        <span class="n">new</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">]</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

        <span class="c1"># put direction dictionary into a list</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>  <span class="c1"># loop over reservoirs</span>
            <span class="n">r</span><span class="o">.</span><span class="n">lodir</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>  <span class="c1"># loop over fluxes</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
                <span class="n">r</span><span class="o">.</span><span class="n">lodir</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="c1"># take care of objects which require a delayed init</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lto</span><span class="p">:</span>
            <span class="n">o</span><span class="o">.</span><span class="n">__delayed_init__</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;solver&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="s2">&quot;python&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s2">&quot;numba&quot;</span><span class="p">:</span>
            <span class="n">execute_e</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpc_f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpc_r</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">solver</span> <span class="o">==</span> <span class="s2">&quot;hybrid&quot;</span><span class="p">:</span>
            <span class="n">execute_h</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpc_f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpc_r</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">execute</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpc_f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpc_r</span><span class="p">)</span>
        <span class="c1"># self.execute(new, self.time, self.lor, self.lpc_f, self.lpc_r)</span>

        <span class="n">duration</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">process_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">wcd</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">wts</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Execution took </span><span class="si">{</span><span class="n">duration</span><span class="si">}</span><span class="s2"> cpu seconds, wt = </span><span class="si">{</span><span class="n">wcd</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># flag that the model has executed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">__step_process__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;For debugging. Provide reservoir and step number,&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span>  <span class="c1"># loop over reservoir processes</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>  <span class="c1"># update fluxes</span>

    <span class="k">def</span> <span class="nf">__step_update_reservoir__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;For debugging. Provide reservoir and step number,&quot;&quot;&quot;</span>
        <span class="n">flux_list</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span>
        <span class="c1"># new = sum_fluxes(flux_list,r,i) # integrate all fluxes in self.lof</span>

        <span class="n">ms</span> <span class="o">=</span> <span class="n">ls</span> <span class="o">=</span> <span class="n">hs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flux_list</span><span class="p">:</span>  <span class="c1"># do sum of fluxes in this reservoir</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
            <span class="n">ms</span> <span class="o">=</span> <span class="n">ms</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">direction</span>  <span class="c1"># current flux and direction</span>
            <span class="n">ls</span> <span class="o">=</span> <span class="n">ls</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">direction</span>  <span class="c1"># current flux and direction</span>
            <span class="n">hs</span> <span class="o">=</span> <span class="n">hs</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">direction</span>  <span class="c1"># current flux and direction</span>

        <span class="n">new</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">ms</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">hs</span><span class="p">])</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">new</span> <span class="o">*</span> <span class="n">r</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span>  <span class="c1"># get flux / timestep</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">new</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># add to data from last time step</span>
        <span class="c1"># new = new * (new &gt; 0)  # set negative values to zero</span>
        <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>  <span class="c1"># update reservoir data</span>

    <span class="k">def</span> <span class="nf">list_species</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List all  defined species.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lel</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">e</span><span class="o">.</span><span class="n">list_species</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">flux_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show a summary of all model fluxes</span>

<span class="sd">        Optional parameters:</span>

<span class="sd">        index :int = i &gt; 1 and i &lt; number of timesteps -1</span>
<span class="sd">        filter_by :str = filter on flux name or part of flux name</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;index&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span>

        <span class="k">if</span> <span class="s2">&quot;filter_by&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">fby</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;filter_by&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fby</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;filter&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;use filter_by instead of filter&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> --- Flux Summary -- filtered by </span><span class="si">{</span><span class="n">fby</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fby</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="p">:</span>  <span class="c1"># and f.m[i] &gt; 0:</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;    - </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">direction</span> <span class="o">*</span> <span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> d = </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    - </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">direction</span> <span class="o">*</span> <span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">connection_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show a summary of all connections</span>

<span class="sd">        Optional parameters:</span>

<span class="sd">        filter_by :str = filter on flux name or part of flux name</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;filter_by&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">fby</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;filter_by&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fby</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;filter&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;use filter_by instead of filter&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> --- Connection Summary -- filtered by </span><span class="si">{</span><span class="n">fby</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;       append info() to the connection name to see more details&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fby</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">full_name</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Element</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Each model, can have one or more elements.  This class sets</span>
<span class="sd">    element specific properties</span>

<span class="sd">    Example::</span>

<span class="sd">            Element(name      = &quot;S &quot;           # the element name</span>
<span class="sd">                    model     = Test_model     # the model handle</span>
<span class="sd">                    mass_unit =  &quot;mol&quot;,        # base mass unit</span>
<span class="sd">                    li_label  =  &quot;$^{32$S&quot;,    # Label of light isotope</span>
<span class="sd">                    hi_label  =  &quot;$^{34}S&quot;,    # Label of heavy isotope</span>
<span class="sd">                    d_label   =  r&quot;$\delta^{34}$S&quot;,  # Label for delta value</span>
<span class="sd">                    d_scale   =  &quot;VCDT&quot;,       # Isotope scale</span>
<span class="sd">                    r         = 0.044162589,   # isotopic abundance ratio for element</span>
<span class="sd">                  )</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># set element properties</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Initialize all instance variables</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># provide a dict of known keywords and types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
            <span class="s2">&quot;mass_unit&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;li_label&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;hi_label&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;d_label&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;d_scale&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="n">Number</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;mass_unit&quot;</span><span class="p">]</span>
        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;li_label&#39;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s1">&#39;hi_label&#39;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s1">&#39;d_label&#39;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s1">&#39;d_scale&#39;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># legacy name aliases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># display name of species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>  <span class="c1"># model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_unit</span>  <span class="c1"># display name of mass unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ln</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">li_label</span>  <span class="c1"># display name of light isotope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hi_label</span>  <span class="c1"># display name of heavy isotope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_label</span>  <span class="c1"># display string for delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_scale</span>  <span class="c1"># display string for delta scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lsp</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of species for this element.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">list_species</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; List all species which are predefined for this element</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lsp</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Species</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Each model, can have one or more species.  This class sets species</span>
<span class="sd">specific properties</span>
<span class="sd">      </span>
<span class="sd">      Example::</span>
<span class="sd">        </span>
<span class="sd">            Species(name = &quot;SO4&quot;,</span>
<span class="sd">                    element = S,</span>
<span class="sd">)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

    <span class="c1"># set species properties</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Initialize all instance variables</span>
<span class="sd">            &quot;&quot;&quot;</span>

        <span class="c1"># provide a list of all known keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;element&quot;</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span>
            <span class="s1">&#39;display_as&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;m_weight&#39;</span><span class="p">:</span> <span class="n">Number</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;element&quot;</span><span class="p">]</span>

        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;display_as&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="s1">&#39;m_weight&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;display_as&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># legacy names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># display name of species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">mu</span>  <span class="c1"># display name of mass unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ln</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">ln</span>  <span class="c1"># display name of light isotope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">hn</span>  <span class="c1"># display name of heavy isotope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">dn</span>  <span class="c1"># display string for delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">ds</span>  <span class="c1"># display string for delta scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span>  <span class="c1"># ratio of isotope standard</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">n</span>  <span class="c1"># element name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span>  <span class="c1"># element handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dsa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span>  <span class="c1"># the display string.</span>

        <span class="c1">#self.mo.lsp.append(self)   # register self on the list of model objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">lsp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># register this species with the element</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Reservoir</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This object holds reservoir specific information.</span>

<span class="sd">          Example::</span>

<span class="sd">                  Reservoir(name = &quot;foo&quot;,      # Name of reservoir</span>
<span class="sd">                            species = S,          # Species handle</span>
<span class="sd">                            delta = 20,           # initial delta - optional (defaults  to 0)</span>
<span class="sd">                            mass/concentration = &quot;1 unit&quot;  # species concentration or mass</span>
<span class="sd">                            volume/geometry = &quot;1E5 l&quot;,      # reservoir volume (m^3)</span>
<span class="sd">                            plot = &quot;yes&quot;/&quot;no&quot;, defaults to yes</span>
<span class="sd">                            plot_transform_c = a function reference, optional (see below)</span>
<span class="sd">                            legend_left = str, optional, useful for plot transform</span>
<span class="sd">                            display_precision = number, optional, inherited from Model</span>
<span class="sd">                            register = optional, use to register with Reservoir Group</span>
<span class="sd">                            isotopes = True/False otherwise use Model.m_type</span>
<span class="sd">                            )</span>

<span class="sd">          You must either give mass or concentration.  The result will always be displayed</span>
<span class="sd">          as concentration though.</span>

<span class="sd">          You must provide either the volume or the geometry keyword. In the latter case</span>
<span class="sd">          provide a list where the first entry is the upper depth datum, the second entry is</span>
<span class="sd">          the lower depth datum, and the third entry is the area percentage. E.g., to specify</span>
<span class="sd">          the upper 200 meters of the entire ocean, you would write:</span>

<span class="sd">                 geometry=[0,-200,1]</span>

<span class="sd">          the corresponding ocean volume will then be calculated by the calc_volume method</span>
<span class="sd">          in this case the following instance variables will also be set:</span>

<span class="sd">                 self.volume in model units (usually liter)</span>
<span class="sd">                 self.are:a surface area in m^2 at the upper bounding surface</span>
<span class="sd">                 self.area_dz: area of seafloor which is intercepted by this box.</span>
<span class="sd">                 self.area_fraction: area of seafloor which is intercepted by this</span>
<span class="sd">                                    relative to the total ocean floor area</span>

<span class="sd">          Using a transform function</span>
<span class="sd">          ~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">          In some cases, it is useful to transform the reservoir</span>
<span class="sd">          concentration data before plotting it.  A good example is the H+</span>
<span class="sd">          concentration in water which is better displayed as pH.  We can</span>
<span class="sd">          do this by specifying a function to convert the reservoir</span>
<span class="sd">          concentration into pH units::</span>

<span class="sd">              def phc(c :float) -&gt; float:</span>
<span class="sd">                  # Calculate concentration as pH. c can be a number or numpy array</span>

<span class="sd">                  import numpy as np</span>

<span class="sd">                  pH :float = -np.log10(c)</span>
<span class="sd">                  return pH</span>

<span class="sd">          this function can then be added to a reservoir as::</span>

<span class="sd">          hplus.plot_transform_c = phc</span>

<span class="sd">          You can modify the left legend to suit the transform via the legend_left keyword</span>

<span class="sd">          Note, at present the plot_transform_c function will only take one</span>
<span class="sd">          argument, which always defaults to the reservoir</span>
<span class="sd">          concentration. The function must return a single argument which</span>
<span class="sd">          will be interpreted as the transformed reservoir concentration.</span>

<span class="sd">    Accesing Reservoir Data:</span>
<span class="sd">    ~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">    You can access the reservoir data as:</span>

<span class="sd">    - Name.m # mass</span>
<span class="sd">    - Name.d # delta</span>
<span class="sd">    - Name.c # concentration</span>

<span class="sd">    Useful methods include:</span>

<span class="sd">    - Name.write_data() # save data to file</span>
<span class="sd">    - Name.info()   # info Reservoir</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;lio&quot;</span><span class="p">,</span> <span class="s2">&quot;rvalue&quot;</span><span class="p">,</span> <span class="s2">&quot;lodir&quot;</span><span class="p">,</span> <span class="s2">&quot;lof&quot;</span><span class="p">,</span> <span class="s2">&quot;lpc&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize a reservoir.&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="n">Species</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Number</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">),</span>
            <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">),</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">),</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;plot_transform_c&quot;</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span>
            <span class="s2">&quot;legend_left&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;groupname&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="s2">&quot;a1&quot;</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span>
            <span class="s2">&quot;a2&quot;</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span>
            <span class="s2">&quot;a3&quot;</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span>
            <span class="s2">&quot;a4&quot;</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span>
            <span class="s2">&quot;a5&quot;</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span>
            <span class="s2">&quot;a6&quot;</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">,</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="s2">&quot;concentration&quot;</span><span class="p">],</span>
        <span class="p">]</span>

        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;plot_transform_c&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;legend_left&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;groupname&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Not Set&quot;</span><span class="p">,</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;a1&quot;</span><span class="p">:</span> <span class="n">numba</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">empty_list</span><span class="p">(</span><span class="n">nbt</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
            <span class="s2">&quot;a2&quot;</span><span class="p">:</span> <span class="n">numba</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">empty_list</span><span class="p">(</span><span class="n">nbt</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
            <span class="s2">&quot;a3&quot;</span><span class="p">:</span> <span class="n">numba</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">empty_list</span><span class="p">(</span><span class="n">nbt</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># validate and initialize instance variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bem</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="s2">&quot;a  string or quantity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="s2">&quot;a string or quantity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="s2">&quot;a string or quantity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;yes or no&quot;</span><span class="p">,</span>
                <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="s2">&quot;Group Object&quot;</span><span class="p">,</span>
                <span class="s2">&quot;legend_left&quot;</span><span class="p">:</span> <span class="s2">&quot;A string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="s2">&quot;A function&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># legacy names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># name of reservoir</span>
        <span class="c1"># if &quot;register&quot; in self.kwargs:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groupname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span>
        <span class="c1"># else:</span>
        <span class="c1">#   self.pt = self.name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">:</span> <span class="n">Species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>  <span class="c1"># species handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span>

        <span class="c1"># decide whether we use isotopes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_type</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_type</span> <span class="o">==</span> <span class="s2">&quot;mass_only&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">get_box_geometry_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            
        <span class="c1"># convert units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span> <span class="n">Number</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">v_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>  <span class="c1"># reservoir volume</span>
        <span class="c1"># This should probably be species specific?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">mass_unit</span>  <span class="c1"># massunit xxxx</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">units</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">:</span> <span class="n">Number</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">:</span> <span class="n">Number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>  <span class="c1"># caculate mass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span> <span class="o">=</span> <span class="s2">&quot;concentration&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_unit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">:</span> <span class="n">Number</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span> <span class="o">=</span> <span class="s2">&quot;mass&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You need to specify mass or concentration&quot;</span><span class="p">)</span>

        <span class="c1"># save the unit which was provided by the user for display purposes</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Flux</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># flux references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ExternalData</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># all external data references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lio</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># flux name:direction pairs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Process</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list holding all processe references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loe</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Element</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of elements in thiis reservoir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doe</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Species</span><span class="p">,</span> <span class="n">Flux</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># species flux pairs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># set of connection objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ldf</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">DataField</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of datafield objects</span>
        <span class="c1"># list of processes which calculate reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpc</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Process</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># initialize mass vector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># initialize concentration vector</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span>
            <span class="c1"># isotope mass</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_imass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
            <span class="c1"># delta of reservoir</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">get_delta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

        <span class="c1"># left y-axis label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">/l]&quot;</span>
        <span class="c1"># right y-axis label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ld</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">ds</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xl</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">xl</span>  <span class="c1"># set x-axis lable to model time</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dsa</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># leave as is</span>
            <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">ds</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># add this reservoir to the model</span>
        <span class="c1"># register instance name in global name space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>

        <span class="c1"># decide which setitem functions to use</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_with_isotopes__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_without_isotopes__</span>

        <span class="c1"># any auxilliary init - normally empty, but we use it here to extend the</span>
        <span class="c1"># reservoir class in virtual reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__aux_inits__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># setup a placeholder setitem function</span>
    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># what to do when called as a function ()</span>
        <span class="k">pass</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get flux data by index&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>

    <span class="k">def</span> <span class="nf">__set_with_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;write data by index&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="c1"># update concentration and delta next. This is computationally inefficient</span>
        <span class="c1"># but the next time step may depend on on both variables.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">get_delta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span>  <span class="c1"># update concentration</span>

    <span class="k">def</span> <span class="nf">__set_without_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;write data by index&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span>  <span class="c1"># update concentration</span>

    <span class="k">def</span> <span class="nf">__write_data__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stride</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;To be called by write_data and save_state&quot;&quot;&quot;</span>

        <span class="c1"># some short hands</span>
        <span class="n">sn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">n</span>  <span class="c1"># species name</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span>  <span class="c1"># species handle</span>
        <span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model handle</span>

        <span class="n">smu</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mo</span><span class="o">.</span><span class="n">m_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">mtu</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">fmu</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">cmu</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">sdn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">dn</span>  <span class="c1"># delta name</span>
        <span class="n">sds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">ds</span>  <span class="c1"># delta scale</span>
        <span class="n">rn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span>  <span class="c1"># reservoir name</span>
        <span class="n">mn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">n</span>  <span class="c1"># model name</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">mn</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2">.csv&quot;</span>  <span class="c1"># file name</span>

        <span class="c1"># build the dataframe</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>

        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2"> Time [</span><span class="si">{</span><span class="n">mtu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># time</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">smu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># mass</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sp</span><span class="o">.</span><span class="n">ln</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">smu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># light isotope</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sp</span><span class="o">.</span><span class="n">hn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">smu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># heavy isotope</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sdn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">sds</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># delta value</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">cmu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># concentration</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>  <span class="c1"># Assemble the headers and data for the reservoir fluxes</span>
            <span class="c1"># mass</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">fmu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>
            <span class="c1"># light isotope</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">sp</span><span class="o">.</span><span class="n">ln</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>
            <span class="c1"># heavy isotope</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">sp</span><span class="o">.</span><span class="n">hn</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>
            <span class="c1"># delta value</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sdn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">sds</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>

        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Write dataframe to file</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">__read_state__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;read data from csv-file into a dataframe</span>

<span class="sd">        The CSV file must have the following columns</span>

<span class="sd">        Model Time     t</span>
<span class="sd">        Reservoir_Name m</span>
<span class="sd">        Reservoir_Name l</span>
<span class="sd">        Reservoir_Name h</span>
<span class="sd">        Reservoir_Name d</span>
<span class="sd">        Reservoir_Name c</span>
<span class="sd">        Flux_name m</span>
<span class="sd">        Flux_name l etc etc.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.utility_functions</span> <span class="kn">import</span> <span class="n">is_name_in_list</span><span class="p">,</span> <span class="n">get_object_from_list</span>

        <span class="n">read</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">curr</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;state_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">.csv&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;reading state for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Flux </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2"> does not exist in Reservoir </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># get a set of all current fluxes</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
            <span class="n">curr</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Adding Flux </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> to list of fluxes to read&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span>

        <span class="c1"># the headers contain the object name for each data in the</span>
        <span class="c1"># reservoir or flux thus, we must reduce the list to unique</span>
        <span class="c1"># object names first. Note, we must preserve order</span>
        <span class="n">header_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header_list</span><span class="p">:</span>
                <span class="n">header_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="c1"># loop over all columns</span>
        <span class="n">col</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># we ignore the time column</span>
        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">header_list</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Looking for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># this finds the reservoir name</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;found reservoir data for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__assign__data__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="c1"># this loops over all fluxes in a reservoir</span>
            <span class="k">elif</span> <span class="n">is_name_in_list</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> is in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">.lof&quot;</span><span class="p">)</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">get_object_from_list</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;found object </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> adding flux data for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">read</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>
                <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__assign__data__</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to find Flux </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># test if we missed any fluxes</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">curr</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">read</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Warning: Did not find values for </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="se">\n</span><span class="s2"> in saved state&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__assign__data__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">res</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign the third last entry data to all values in flux or reservoir</span>

<span class="sd">        parameters: df = dataframe</span>
<span class="sd">                    col = column number</span>
<span class="sd">                    res = true if reservoir</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ovars</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">]</span>

        <span class="n">obj</span><span class="o">.</span><span class="n">m</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">l</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">h</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">d</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">4</span>

        <span class="k">if</span> <span class="n">res</span><span class="p">:</span>  <span class="c1"># if type is reservoir</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">c</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">col</span>

    <span class="k">def</span> <span class="nf">__plot__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot data from reservoirs and fluxes into a multiplot window&quot;&quot;&quot;</span>

        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span>
        <span class="n">species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="c1"># time = model.time + model.offset  # get the model time</span>
        <span class="c1"># xl = f&quot;Time [{model.bu}]&quot;</span>

        <span class="n">size</span><span class="p">,</span> <span class="n">geo</span> <span class="o">=</span> <span class="n">get_plot_layout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># adjust layout</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">.pdf&quot;</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># counter for the figure number</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">plot_style</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>  <span class="c1"># Initialize a plot window</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reservoir Name: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="c1"># plot reservoir data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
            <span class="n">plot_object_data</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

            <span class="c1"># plot the fluxes assoiated with this reservoir</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">):</span>  <span class="c1"># plot flux data</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">plot</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">plot_object_data</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ldf</span><span class="p">):</span>  <span class="c1"># plot data fields</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">plot_object_data</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">geo</span> <span class="o">!=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupname</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">, Reservoir: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># filename = f&quot;{self.groupname}_{self.n}.pdf&quot;</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Group: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">groupname</span><span class="si">}</span><span class="s2">, Reservoir: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span>
                    <span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.88</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving as </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__plot_reservoirs__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot only the  reservoirs data, and ignore the fluxes&quot;&quot;&quot;</span>

        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span>
        <span class="n">species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">time</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">offset</span>  <span class="c1"># get the model time</span>
        <span class="n">xl</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Time [</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">bu</span><span class="si">}</span><span class="s2">]&quot;</span>

        <span class="n">size</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">geo</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">.pdf&quot;</span>
        <span class="n">fn</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># counter for the figure number</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">plot_style</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>  <span class="c1"># Initialize a plot window</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="c1"># plt.legend()ot reservoir data</span>
        <span class="n">plot_object_data</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="c1"># fig.subplots_adjust(top=0.88)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show an overview of the object properties.</span>
<span class="sd">        Optional arguments are</span>
<span class="sd">        index  :int = 0 this will show data at the given index</span>
<span class="sd">        indent :int = 0 indentation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">off</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>
        <span class="k">if</span> <span class="s2">&quot;index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>

        <span class="c1"># print basic data bout this reservoir</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Data sample:&quot;</span><span class="p">)</span>
        <span class="n">show_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Connnections:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}{</span><span class="n">ind</span><span class="si">}{</span><span class="n">p</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Use the info method on any of the above connections&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;to see information on fluxes and processes&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ReservoirGroup</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class allows the creation of a group of reservoirs which share</span>
<span class="sd">    a common volume, and potentially connections. E.g., if we have two</span>
<span class="sd">    reservoir groups with the same reservoirs, and we connect them</span>
<span class="sd">    with a flux, this flux will apply to all reservoirs in this group.</span>

<span class="sd">    A typical examples might be ocean water which comprises several</span>
<span class="sd">    species.  A reservoir group like ShallowOcean will then contain</span>
<span class="sd">    sub-reservoirs like DIC in the form of ShallowOcean.DIC</span>

<span class="sd">    Example::</span>

<span class="sd">        ReservoirGroup(name = &quot;ShallowOcean&quot;,         # Name of reservoir group</span>
<span class="sd">                    volume/geometry = &quot;1E5 l&quot;,                # reservoir volume (m^3)</span>
<span class="sd">                    delta   = {DIC:0, ALK:0, PO4:0]  # dict of delta values</span>
<span class="sd">                    mass/concentration = {DIC:&quot;1 unit&quot;, ALK: &quot;1 unit&quot;}</span>
<span class="sd">                    plot = {DIC:&quot;yes&quot;, ALK:&quot;yes&quot;}  defaults to yes</span>
<span class="sd">                    isotopes = {DIC: True/False} see Reservoir class for details</span>
<span class="sd">               )</span>

<span class="sd">    Notes: - The subreservoirs are derived from the keys in the concentration or mass</span>
<span class="sd">             dictionary. Toward this end, the keys must be valid species handles and</span>
<span class="sd">             -- not species names -- !</span>

<span class="sd">    Connecting two reservoir groups requires that the names in both</span>
<span class="sd">    group match, or that you specify a dictionary which delineates the</span>
<span class="sd">    matching.</span>

<span class="sd">    Most parameters are passed on to the Reservoir class. See the reservoir class</span>
<span class="sd">    documentation for details</span>

<span class="sd">    If the geometry parameter is supplied, the following instance variables will be</span>
<span class="sd">    computed</span>

<span class="sd">                 self.volume: in model units (usually liter)</span>
<span class="sd">                 self.are:a surface area in m^2 at the upper bounding surface</span>
<span class="sd">                 self.area_dz: area of seafloor which is intercepted by this box.</span>
<span class="sd">                 self.area_fraction: area of seafloor which is intercepted by this</span>
<span class="sd">                                    relative to the total ocean floor area</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize a new reservoir group&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>
        <span class="kn">from</span> <span class="nn">.sealevel</span> <span class="kn">import</span> <span class="n">get_box_geometry_parameters</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">),</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">],</span>
        <span class="p">]</span>

        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="s2">&quot;concentration&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;concentration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">elif</span> <span class="s2">&quot;mass&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must provide either mass or concentration&quot;</span><span class="p">)</span>

        <span class="c1"># validate and initialize instance variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bem</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="s2">&quot;a  string or quantity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="s2">&quot;a string or quantity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="s2">&quot;a string or quantity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;yes or no&quot;</span><span class="p">,</span>
                <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="s2">&quot;dict Species: True/False&quot;</span><span class="p">,</span>
                <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="s2">&quot;list&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># legacy variable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span>

        <span class="c1"># geoemtry information</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">volume</span><span class="si">}</span><span class="s2"> m**3&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">v_unit</span><span class="p">)</span>
            
        <span class="n">get_box_geometry_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># register this group object in the global namespace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>

        <span class="c1"># dict with all default values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span>
                <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># now we loop trough all keys for this reservoir and see</span>
            <span class="c1"># if we find a corresponding item in the kwargs</span>
            <span class="k">for</span> <span class="n">kcd</span><span class="p">,</span> <span class="n">vcd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># kcd  = delta, plot, etc</span>
                <span class="k">if</span> <span class="n">kcd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>  <span class="c1"># found entry delta</span>
                    <span class="c1"># test if delta relates to any species</span>
                    <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="n">kcd</span><span class="p">]:</span>  <span class="c1"># {SO4: xxx}</span>
                        <span class="c1"># update the entry with the value provided in kwargs</span>
                        <span class="c1"># self.cd[&#39;SO4_name&#39;][&#39;delta&#39;] = self.kwargs[&#39;delta&#39;][SO4]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">kcd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="n">kcd</span><span class="p">][</span><span class="n">s</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of reservoirs in this group.</span>
        <span class="c1"># loop over all entries in species and create the respective reservoirs</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Species</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> needs to be a valid species name&quot;</span><span class="p">)</span>

            <span class="c1"># create reservoir without registering it in the global name space</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">Reservoir</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">species</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                <span class="n">delta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;delta&quot;</span><span class="p">],</span>
                <span class="n">mass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;mass&quot;</span><span class="p">],</span>
                <span class="n">concentration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;concentration&quot;</span><span class="p">],</span>
                <span class="n">volume</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="p">,</span>
                <span class="n">geometry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span>
                <span class="n">plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;plot&quot;</span><span class="p">],</span>
                <span class="n">groupname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">isotopes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;isotopes&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="c1"># register as part of this group</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Flux</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class which defines a flux object. Flux objects contain</span>
<span class="sd">    information which links them to an species, describe things like</span>
<span class="sd">    the mass and time unit, and store data of the total flux rate at</span>
<span class="sd">    any given time step. Similarly, they store the flux of the light</span>
<span class="sd">    and heavy isotope flux, as well as the delta of the flux. This</span>
<span class="sd">    is typically handled through the Connect object. If you set it up manually</span>

<span class="sd">    Flux = (name = &quot;Name&quot;</span>
<span class="sd">            species = species_handle,</span>
<span class="sd">            delta = any number,</span>
<span class="sd">            rate  = &quot;12 mol/s&quot; # must be a string</span>
<span class="sd">            display_precision = number, optional, inherited from Model</span>
<span class="sd">    )</span>

<span class="sd">     You can access the flux data as</span>
<span class="sd">    - Name.m # mass</span>
<span class="sd">    - Name.d # delta</span>
<span class="sd">    - Name.c # concentration</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;rvalue&quot;</span><span class="p">,</span> <span class="s2">&quot;lpc&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a flux. Arguments are the species name the flux rate</span>
<span class="sd">        (mol/year), the delta value and unit</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="n">Species</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">),</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;species&quot;</span><span class="p">,</span> <span class="s2">&quot;rate&quot;</span><span class="p">]</span>

        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># initialize instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bem</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span> <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># legacy names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># name of flux</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">:</span> <span class="n">Species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>  <span class="c1"># species name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="c1"># model units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">tu</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># and convert flux into model units</span>
        <span class="n">fluxrate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="n">fluxrate</span>
        <span class="p">)</span>  <span class="c1"># add the flux</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_imass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

        <span class="c1"># if self.delta == 0:</span>
        <span class="c1">#     self.d: [NDArray, Float[64]] = zeros(self.model.steps)</span>
        <span class="c1"># else:  # update delta</span>
        <span class="c1">#     self.d: [NDArray, Float[64]] = get_delta(self.l, self.h, self.sp.r)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">]&quot;</span>  <span class="c1"># left y-axis a label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ld</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">ds</span><span class="si">}</span><span class="s2">]&quot;</span>  <span class="c1"># right y-axis a label</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dsa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">ds</span><span class="si">}</span><span class="s2">]&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xl</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">xl</span>  <span class="c1"># se x-axis label equal to model time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Process</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of processes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpc</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of external functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ExternalData</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of ext data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Name of reservoir which acts as flux source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Name of reservoir which acts as flux sink</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>

        <span class="c1"># decide which setitem functions to use</span>
        <span class="c1"># decide whether we use isotopes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_type</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_type</span> <span class="o">==</span> <span class="s2">&quot;mass_only&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_with_isotopes__</span>
            <span class="c1"># self.__get_data__ = self.__get_with_isotopes__  </span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_without_isotopes__</span>
            <span class="c1">#self.__get_data__ = self.__get_without_isotopes__</span>

    <span class="c1"># setup a placeholder setitem function</span>
    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get data by index&quot;&quot;&quot;</span>
        <span class="c1">#return self.__get_data__(i)</span>
        <span class="k">return</span> <span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>

    <span class="c1"># def __get_with_isotopes__(self, i: int) -&gt; NDArray[np.float64]:</span>
    <span class="c1">#     &quot;&quot;&quot;Get data by index&quot;&quot;&quot;</span>

    <span class="c1">#     return array([self.m[i], self.l[i], self.h[i], self.d[i]])</span>

    <span class="c1"># def __get_without_isotopes__(self, i: int) -&gt; NDArray[np.float64]:</span>
    <span class="c1">#     &quot;&quot;&quot;Get data by index&quot;&quot;&quot;</span>

    <span class="c1">#     return array([self.m[i]])</span>

    <span class="k">def</span> <span class="nf">__set_with_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Write data by index&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="c1"># self.d[i] = get_delta(self.l[i], self.h[i], self.sp.r)  # update delta</span>

    <span class="k">def</span> <span class="nf">__set_without_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Write data by index&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># what to do when called as a function ()</span>
        <span class="k">pass</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;adding two fluxes works for the masses, but not for delta&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">l</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">h</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">get_delta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;adding two fluxes works for the masses, but not for delta&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">l</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">h</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">get_delta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show an overview of the object properties.</span>
<span class="sd">        Optional arguments are</span>
<span class="sd">        index  :int = 0 this will show data at the given index</span>
<span class="sd">        indent :int = 0 indentation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">off</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>
        <span class="k">if</span> <span class="s2">&quot;index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>

        <span class="c1"># print basic data bout this object</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Data sample:&quot;</span><span class="p">)</span>
        <span class="n">show_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Process(es) acting on this flux:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}{</span><span class="n">ind</span><span class="si">}{</span><span class="n">p</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Use help on the process name to get an explanation what this process does&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;e.g., help(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;e.g., help(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There are no processes for this flux&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot the flux data:&quot;&quot;&quot;</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># Set figure size in inches</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_dpi</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>  <span class="c1"># Set resolution in dots per inch</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">)</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>  <span class="c1"># get second y-axis</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">tu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>  <span class="c1">#</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">dn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">ds</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># remove unnecessary frame</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># remove unnecessary frame</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SourceSink</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a meta class to setup a Source/Sink objects. These are not</span>
<span class="sd">    actual reservoirs, but we stil need to have them as objects</span>
<span class="sd">    Example::</span>

<span class="sd">           Sink(name = &quot;Pyrite&quot;,</span>
<span class="sd">               species = SO4,</span>
<span class="sd">               display_precision = number, optional, inherited from Model</span>
<span class="sd">               delta = number or str. optional defaults to &quot;None&quot;</span>
<span class="sd">           )</span>

<span class="sd">    where the first argument is a string, and the second is a reservoir handle</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="n">Species</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Number</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;species&quot;</span><span class="p">]</span>

        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># set of connection objects</span>

        <span class="c1"># legacy names</span>
        <span class="c1"># if self.register != &quot;None&quot;:</span>
        <span class="c1">#    self.full_name = f&quot;{self.name}.{self.register.name}&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mu</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">bu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lio</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groupname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Sink</span><span class="p">(</span><span class="n">SourceSink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is just a wrapper to setup a Sink object</span>
<span class="sd">    Example::</span>

<span class="sd">           Sink(name = &quot;Pyrite&quot;,species =SO4)</span>

<span class="sd">    where the first argument is a string, and the second is a species handle</span>
<span class="sd">    &quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">Source</span><span class="p">(</span><span class="n">SourceSink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is just a wrapper to setup a Source object</span>
<span class="sd">    Example::</span>

<span class="sd">           Source(name = &quot;SO4_diffusion&quot;, species =&quot;SO4&quot;)</span>

<span class="sd">    where the first argument is a string, and the second is a species handle</span>
<span class="sd">    &quot;&quot;&quot;</span>

<span class="k">class</span> <span class="nc">SourceSinkGroup</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a meta class to setup  Source/Sink Groups. These are not</span>
<span class="sd">    actual reservoirs, but we stil need to have them as objects</span>
<span class="sd">    Example::</span>

<span class="sd">           Sink(name = &quot;Pyrite&quot;,</span>
<span class="sd">                species = [SO42, H2S],</span>
<span class="sd">                delta = {&quot;SO4&quot;: 10}</span>
<span class="sd">                )</span>

<span class="sd">    where the first argument is a string, and the second is a reservoir handle</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;species&quot;</span><span class="p">]</span>
        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">{}}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># legacy variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># set of connection objects</span>

        <span class="c1"># register this object in the global namespace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># get model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of sub reservoirs in this group</span>

        <span class="c1"># loop over species names and setup sub-objects</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Species</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> needs to be a valid species name&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">:</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>

            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;SourceGroup&quot;</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">Source</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">species</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                    <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;SinkGroup&quot;</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">Sink</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">species</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                    <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> is not a valid class type&quot;</span><span class="p">)</span>

            <span class="c1"># register in local namespace</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SinkGroup</span><span class="p">(</span><span class="n">SourceSinkGroup</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is just a wrapper to setup a Sink object</span>
<span class="sd">    Example::</span>

<span class="sd">           Sink(name = &quot;Pyrite&quot;,species =SO4)</span>

<span class="sd">    where the first argument is a string, and the second is a species handle</span>
<span class="sd">    &quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">SourceGroup</span><span class="p">(</span><span class="n">SourceSinkGroup</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is just a wrapper to setup a Source object</span>
<span class="sd">    Example::</span>

<span class="sd">           Sink(name = &quot;SO4_diffusion&quot;, species =&quot;SO4&quot;)</span>

<span class="sd">    where the first argument is a string, and the second is a species handle</span>
<span class="sd">    &quot;&quot;&quot;</span>

<span class="k">class</span> <span class="nc">Signal</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;We use a simple generator which will create a signal which is</span>
<span class="sd">    described by its startime (relative to the model time), it&#39;s</span>
<span class="sd">    size (as mass) and duration, or as duration and</span>
<span class="sd">    magnitude. Furthermore, we can presribe the signal shape</span>
<span class="sd">    (square, pyramid) and whether the signal will repeat. You</span>
<span class="sd">    can also specify whether the event will affect the delta value.</span>

<span class="sd">    The data in the signal class will simply be added to the data in</span>
<span class="sd">    a given flux. So this class cannot be used for scaling (can we</span>
<span class="sd">    add this functionality?)</span>

<span class="sd">    Example::</span>

<span class="sd">          Signal(name = &quot;Name&quot;,</span>
<span class="sd">                 species = Species handle,</span>
<span class="sd">                 start = &quot;0 yrs&quot;,     # optional</span>
<span class="sd">                 duration = &quot;0 yrs&quot;,  #</span>
<span class="sd">                 delta = 0,           # optional</span>
<span class="sd">                 stype = &quot;addition&quot;   # optional, currently the only type</span>
<span class="sd">                 shape = &quot;square&quot;     # square, pyramid</span>
<span class="sd">                 mass/magnitude/filename  # give one</span>
<span class="sd">                 offset = &#39;0 yrs&#39;,     #</span>
<span class="sd">                 scale = 1, optional,  #</span>
<span class="sd">                 reservoir = r-handle # optional, see below</span>
<span class="sd">                 source = s-handle optional, see below</span>
<span class="sd">                 display_precision = number, optional, inherited from Model</span>
<span class="sd">                )</span>

<span class="sd">    Signals are cumulative, i.e., complex signals ar created by</span>
<span class="sd">    adding one signal to another (i.e., Snew = S1 + S2)</span>

<span class="sd">    The optional scaling argument will only affect the y-column data of</span>
<span class="sd">    external data files</span>

<span class="sd">    Signals are registered with a flux during flux creation,</span>
<span class="sd">    i.e., they are passed on the process list when calling the</span>
<span class="sd">    connector object.</span>

<span class="sd">    if the filename argument is used, you can provide a filename which</span>
<span class="sd">    contains the data to be used in csv format. The data will be</span>
<span class="sd">    interpolated to the model domain, and added to the already existing data.</span>
<span class="sd">    The external data need to be in the following format</span>

<span class="sd">      Time, Rate, delta value</span>
<span class="sd">      0,     10,   12</span>

<span class="sd">      i.e., the first row needs to be a header line</span>

<span class="sd">    All time data in the csv file will be treated as realative time</span>
<span class="sd">    (i.e., the start time will be mapped to zero). Use the offset</span>
<span class="sd">    keyword to shift the external signal data in the time domain.</span>

<span class="sd">    Last but not least, you can provide an optional reservoir name. In</span>
<span class="sd">    this case, the signal will create a source as (signal_name_source)</span>
<span class="sd">    and the connection to the specified reservoir. If you build a</span>
<span class="sd">    complex signal do this as the last step. If you additionally</span>
<span class="sd">    provide a source name the connection will be made between the</span>
<span class="sd">    provided source (this can be useful if you use source groups).</span>


<span class="sd">    This class has the following methods</span>

<span class="sd">      Signal.repeat()</span>
<span class="sd">      Signal.plot()</span>
<span class="sd">      Signal.info()</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Parse and initialize variables&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>

        <span class="c1"># provide a list of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="n">Species</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;stype&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;magnitude&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;reservoir&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Reservoir</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Source</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;magnitude&quot;</span><span class="p">,</span> <span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">],</span>
        <span class="p">]</span>

        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="s2">&quot;0 yrs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;stype&quot;</span><span class="p">:</span> <span class="s2">&quot;addition&quot;</span><span class="p">,</span>
            <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="s2">&quot;external_data&quot;</span><span class="p">,</span>
            <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="s2">&quot;0 yrs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="s2">&quot;0 yrs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;reservoir&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bem</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;magnitude&quot;</span><span class="p">:</span> <span class="s2">&quot;Number&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="s2">&quot;Number&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># list of signals we are based on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Signal</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># convert units to model units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">st</span><span class="p">:</span> <span class="n">Number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="p">)</span>  <span class="c1"># start time</span>

        <span class="k">if</span> <span class="s2">&quot;mass&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="k">elif</span> <span class="s2">&quot;magnitude&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">magnitude</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="k">if</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="c1"># legacy name definitions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># the name of the this signal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">:</span> <span class="n">Species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>  <span class="c1"># the species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># the model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ty</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stype</span>  <span class="c1"># type of signal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sh</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># shape the event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span>  <span class="c1"># delta value offset during the event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwd</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span>  <span class="c1"># list of keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="c1"># initialize signal data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__init_signal_data__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_data&quot;</span>  <span class="c1"># update the name of the signal data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">legend_left</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">legend_right</span>
        <span class="c1"># update isotope values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">li</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">hi</span> <span class="o">=</span> <span class="n">get_imass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">los</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># register with model</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__apply_signal__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__apply_signal__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a source, and connect signal, source and reservoir&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Connect</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">Source</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_Source&quot;</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">)</span>

        <span class="n">Connect</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>  <span class="c1"># source of flux</span>
            <span class="n">sink</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="p">,</span>  <span class="c1"># target of flux</span>
            <span class="n">rate</span><span class="o">=</span><span class="s2">&quot;0 mol/yr&quot;</span><span class="p">,</span>  <span class="c1"># flux rate</span>
            <span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>  <span class="c1"># list of processes</span>
            <span class="n">plot</span><span class="o">=</span><span class="s2">&quot;no&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init_signal_data__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create an empty flux and apply the shape&quot;&quot;&quot;</span>
        <span class="c1"># create a dummy flux we can act up</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">:</span> <span class="n">Flux</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="s2">&quot;_data&quot;</span><span class="p">,</span>
            <span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">,</span>
            <span class="n">rate</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;0 </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">delta</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># since the flux is zero, the delta value will be undefined. So we set it explicitly</span>
        <span class="c1"># this will avoid having additions with Nan values.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">:]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># find nearest index for start, and end point</span>
        <span class="c1"># print(f&quot;Model time units = {self.species.mo.t_unit}&quot;)</span>
        <span class="c1"># print(f&quot;start_time = {self.st}, dt = {self.mo.dt}&quot;)</span>
        <span class="c1"># print(f&quot;duration = {self.duration}&quot;)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">si</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">st</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">))</span>  <span class="c1"># starting index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ei</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">si</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">))</span>  <span class="c1"># end index</span>
        <span class="c1"># print(f&quot;start index = {self.si}&quot;)</span>
        <span class="c1"># print(f&quot;end index = {self.ei}&quot;)</span>

        <span class="c1"># create slice of flux vector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">si</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ei</span><span class="p">])</span>
        <span class="c1"># create slice of delta vector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">si</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ei</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sh</span> <span class="o">==</span> <span class="s2">&quot;square&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__square__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">si</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ei</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sh</span> <span class="o">==</span> <span class="s2">&quot;pyramid&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__pyramid__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">si</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ei</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s2">&quot;filename&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>  <span class="c1"># use an external data set</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__int_ext_data__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">si</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ei</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;argument needs to be either square/pyramid, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;or an ExternalData object. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;shape = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sh</span><span class="si">}</span><span class="s2"> is not a valid Value&quot;</span>
            <span class="p">)</span>

        <span class="c1"># now add the signal into the flux slice</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">si</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ei</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">si</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ei</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span>

    <span class="k">def</span> <span class="nf">__square__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create Square Signal&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;mass&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span>  <span class="c1"># get the height of the square</span>

        <span class="k">elif</span> <span class="s2">&quot;magnitude&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must specify mass or magnitude of the signal&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">h</span>  <span class="c1"># add this to the section</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>  <span class="c1"># add the delta offset</span>

    <span class="k">def</span> <span class="nf">__pyramid__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create pyramid type Signal</span>

<span class="sd">        s = start index</span>
<span class="sd">        e = end index</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;mass&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span>  <span class="c1"># get the height of the pyramid</span>

        <span class="k">elif</span> <span class="s2">&quot;magnitude&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must specify mass or magnitude of the signal&quot;</span><span class="p">)</span>

        <span class="c1"># create pyramid</span>
        <span class="n">c</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">e</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># get the center index for the peak</span>
        <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">e</span> <span class="o">-</span> <span class="n">s</span><span class="p">])</span>  <span class="c1"># setup the x coordinates</span>
        <span class="n">y</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>  <span class="c1"># setup the y coordinates</span>
        <span class="n">d</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>  <span class="c1"># setup the d coordinates</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">e</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span>  <span class="c1"># setup the points at which to interpolate</span>
        <span class="n">h</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>  <span class="c1"># interpolate flux</span>
        <span class="n">dy</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>  <span class="c1"># interpolate delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span> <span class="o">+</span> <span class="n">h</span>  <span class="c1"># add this to the section</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span> <span class="o">+</span> <span class="n">dy</span>  <span class="c1"># ditto for delta</span>

    <span class="k">def</span> <span class="nf">__int_ext_data__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Interpolate External data as a signal. Unlike the other signals,</span>
<span class="sd">        thiw will replace the values in the flux with those read from the</span>
<span class="sd">        external data source. The external data need to be in the following format</span>

<span class="sd">        Time [units], Rate [units], delta value [units]</span>
<span class="sd">        0,     10,   12</span>

<span class="sd">        i.e., the first row needs to be a header line</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>  <span class="c1"># check if the file is actually there</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># read external dataset</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

        <span class="c1"># get unit information from each header</span>
        <span class="n">xh</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">yh</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># zh = df.iloc[0,2].split(&quot;[&quot;)[1].split(&quot;]&quot;)[0]</span>

        <span class="c1"># create the associated quantities</span>
        <span class="n">xq</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">xh</span><span class="p">)</span>
        <span class="n">yq</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">yh</span><span class="p">)</span>
        <span class="c1"># zq = Q_(zh)</span>

        <span class="c1"># add these to the data we are are reading</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">*</span> <span class="n">xq</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">*</span> <span class="n">yq</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="c1"># map into model units, and strip unit information</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

        <span class="c1"># the data can contain 1 to n data points (i.e., index</span>
        <span class="c1"># values[0,1,n]) each index value contains a time</span>
        <span class="c1"># coordinate. So the duration is x[-1] - X[0]. Duration/dt</span>
        <span class="c1"># gives us the steps, so we can setup a vector for</span>
        <span class="c1"># interpolation. Insertion off this vector depends on the time</span>
        <span class="c1"># offset defined by offset keyword which defines the</span>
        <span class="c1"># insertion indexes self.si self.ei</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">st</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># start time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">et</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># end times</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">et</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">st</span><span class="p">))</span>

        <span class="c1"># map the original time coordinate into model space</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># since everything has been mapped to dt, time equals index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">si</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>  <span class="c1"># starting index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ei</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">duration</span>  <span class="c1"># end index</span>

        <span class="c1"># create slice of flux vector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">si</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ei</span><span class="p">])</span>

        <span class="c1"># create slice of delta vector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">si</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ei</span><span class="p">])</span>

        <span class="c1"># setup the points at which to interpolate</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">duration</span><span class="p">)</span>

        <span class="n">h</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>  <span class="c1"># interpolate flux</span>
        <span class="n">dy</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>  <span class="c1"># interpolate delta</span>

        <span class="c1"># add this to the corresponding section off the flux</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span> <span class="o">+</span> <span class="n">h</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span> <span class="o">+</span> <span class="n">dy</span>  <span class="c1"># ditto for delta</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; allow the addition of two signals and return a new signal&quot;&quot;&quot;</span>

        <span class="n">ns</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># add the data of both fluxes</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">h</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span>

        <span class="p">[</span><span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_imass</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

        <span class="n">ns</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="s2">&quot;_and_&quot;</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">n</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;adding </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">, returning </span><span class="si">{</span><span class="n">ns</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="s2">&quot;_and_&quot;</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="s2">&quot;_data&quot;</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">st</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">st</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">st</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">l</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">sh</span> <span class="o">=</span> <span class="s2">&quot;compound&quot;</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">los</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">los</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ns</span>

    <span class="k">def</span> <span class="nf">repeat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This method creates a new signal by repeating an existing signal.</span>
<span class="sd">        Example::</span>

<span class="sd">        new_signal = signal.repeat(start,   # start time of signal slice to be repeated</span>
<span class="sd">                                   stop,    # end time of signal slice to be repeated</span>
<span class="sd">                                   offset,  # offset between repetitions</span>
<span class="sd">                                   times,   # number of time to repeat the slice</span>
<span class="sd">                              )</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ns</span><span class="p">:</span> <span class="n">Signal</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_repeated_</span><span class="si">{</span><span class="n">times</span><span class="si">}</span><span class="s2">_times&quot;</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_repeated_</span><span class="si">{</span><span class="n">times</span><span class="si">}</span><span class="s2">_times_data&quot;</span>
        <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>  <span class="c1"># convert from time to index</span>
        <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">stop</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">offset</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">start</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">stop</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">stop</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">offset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span> <span class="o">+</span> <span class="n">offset</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">times</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">times</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">ms</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">[</span>
            <span class="n">start</span><span class="p">:</span><span class="n">stop</span>
        <span class="p">]</span>  <span class="c1"># get the data slice we are using</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">ds</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>

        <span class="n">diff</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
            <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">ns</span><span class="o">.</span><span class="n">offset</span>
            <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">+</span> <span class="n">ns</span><span class="o">.</span><span class="n">offset</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">stop</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">):</span>  <span class="c1"># end index larger than data size</span>
                <span class="n">diff</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>  <span class="c1"># difference</span>
                <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">diff</span>  <span class="c1"># new end index</span>
                <span class="n">lds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">ds</span><span class="p">)</span> <span class="o">-</span> <span class="n">diff</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">ds</span><span class="p">)</span>

            <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span> <span class="o">+</span> <span class="n">ns</span><span class="o">.</span><span class="n">ms</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">lds</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span> <span class="o">+</span> <span class="n">ns</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">lds</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># and recalculate li and hi</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">h</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span>
        <span class="p">[</span><span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_imass</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ns</span>

    <span class="k">def</span> <span class="nf">__register_with_flux__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flux</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Register this signal with a flux. This should probably be done</span>
<span class="sd">        through a process!</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fo</span><span class="p">:</span> <span class="n">Flux</span> <span class="o">=</span> <span class="n">flux</span>  <span class="c1"># the flux handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">:</span> <span class="n">Species</span> <span class="o">=</span> <span class="n">flux</span><span class="o">.</span><span class="n">sp</span>  <span class="c1"># the species handle</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="n">flux</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># the model handle add this process to the</span>
        <span class="c1"># list of processes</span>
        <span class="n">flux</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;what to do when called as a function ()&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fo</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fo</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fo</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fo</span><span class="o">.</span><span class="n">d</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">fo</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">          Example::</span>

<span class="sd">              Signal.plot()</span>

<span class="sd">        Plot the signal</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">DataField</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DataField: Datafields can be used to plot data which is computed after</span>
<span class="sd">    the model finishes in the overview plot windows. Therefore, datafields will</span>
<span class="sd">    plot in the same window as the reservoir they are associated with.</span>
<span class="sd">    Datafields must share the same x-axis is the model, and can have up to two</span>
<span class="sd">    y axis.</span>

<span class="sd">    Example::</span>
<span class="sd">    </span>
<span class="sd">             DataField(name = &quot;Name&quot;</span>
<span class="sd">                       associated_with = reservoir_handle</span>
<span class="sd">                       y1_data = np.Ndarray</span>
<span class="sd">                       y1_label = Y-Axis label</span>
<span class="sd">                       y1_legend = Data legend</span>
<span class="sd">                       y2_data = np.Ndarray    # optional</span>
<span class="sd">                       y2_label = Y-Axis label # optional</span>
<span class="sd">                       y2_legend = Data legend # optional</span>
<span class="sd">                       common_y_scale = &quot;no&quot;,  #optional, default &quot;no&quot;</span>
<span class="sd">                       display_precision = number, optional, inherited from Model</span>
<span class="sd">                       )</span>

<span class="sd">    Note that Datafield data is not mapped to model units. Care must be taken</span>
<span class="sd">    that the data units match the model units.</span>

<span class="sd">    The instance provides the following data</span>

<span class="sd">    Name.x    = X-axis = model X-axis</span>
<span class="sd">    Name.y1_data</span>
<span class="sd">    Name.y1_label</span>
<span class="sd">    Name.y1_legend</span>

<span class="sd">    Similarly for y2</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Initialize this instance &quot;&quot;&quot;</span>

        <span class="c1"># dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;associated_with&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Reservoir</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">),</span>
            <span class="s2">&quot;y1_data&quot;</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
            <span class="s2">&quot;y1_label&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;y1_legend&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;y2_data&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">[</span><span class="nb">float</span><span class="p">]),</span>
            <span class="s2">&quot;y2_label&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;y2_legend&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;common_y_scale&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;associated_with&quot;</span><span class="p">,</span> <span class="s2">&quot;y1_data&quot;</span><span class="p">]</span>

        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;y1_label&quot;</span><span class="p">:</span> <span class="s2">&quot;Not Provided&quot;</span><span class="p">,</span>
            <span class="s2">&quot;y1_legend&quot;</span><span class="p">:</span> <span class="s2">&quot;Not Provided&quot;</span><span class="p">,</span>
            <span class="s2">&quot;y2_label&quot;</span><span class="p">:</span> <span class="s2">&quot;Not Provided&quot;</span><span class="p">,</span>
            <span class="s2">&quot;y2_legend&quot;</span><span class="p">:</span> <span class="s2">&quot;Not Provided&quot;</span><span class="p">,</span>
            <span class="s2">&quot;y2_data&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;common_y_scale&quot;</span><span class="p">:</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># provide a dictionary entry for a keyword specific error message</span>
        <span class="c1"># see esbmtkBase.__initerrormessages__()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bem</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;associated_with&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;y1_data&quot;</span><span class="p">:</span> <span class="s2">&quot;a numpy array&quot;</span><span class="p">,</span>
                <span class="s2">&quot;y1_label&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;y1_legend&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;y2_data&quot;</span><span class="p">:</span> <span class="s2">&quot;a numpy array&quot;</span><span class="p">,</span>
                <span class="s2">&quot;y2_label&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;y2_legend&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;common_y_scale&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># set legacy variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1_legend</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">associated_with</span><span class="o">.</span><span class="n">mo</span>
        <span class="k">if</span> <span class="s2">&quot;self.y2_data&quot;</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_legend</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ld</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_label</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># register with reservoir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">associated_with</span><span class="o">.</span><span class="n">ldf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># register with model. needed for print_reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">ldf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;---------------------------------------------------------------------------</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Warning, you are initializing a datafield before the model results are known</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;---------------------------------------------------------------------------&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__write_data__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stride</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;To be called by write_data and save_state&quot;&quot;&quot;</span>

        <span class="c1"># some short hands</span>
        <span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model handle</span>

        <span class="n">smu</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mo</span><span class="o">.</span><span class="n">m_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">mtu</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">fmu</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">cmu</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">rn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>  <span class="c1"># reservoir name</span>
        <span class="n">mn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">n</span>  <span class="c1"># model name</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">mn</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2">.csv&quot;</span>  <span class="c1"># file name</span>

        <span class="c1"># build the dataframe</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>

        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> Time [</span><span class="si">{</span><span class="n">mtu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># time</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1_data</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># y1 data</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># y2_data</span>

        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Write dataframe to file</span>
        <span class="k">return</span> <span class="n">df</span>

<span class="k">class</span> <span class="nc">VirtualReservoir</span><span class="p">(</span><span class="n">Reservoir</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;A virtual reservoir. Unlike regular reservoirs, the mass of a</span>
<span class="sd">   virtual reservoir depends entirely on the return value of a function.</span>

<span class="sd">   Example::</span>

<span class="sd">   VirtualReservoir(name=&quot;foo&quot;,</span>
<span class="sd">                   volume=&quot;10 liter&quot;,</span>
<span class="sd">                   concentration=&quot;1 mmol&quot;,</span>
<span class="sd">                   species=  ,</span>
<span class="sd">                   function=bar,</span>
<span class="sd">                   a1 to a3 =  to 3optional function arguments,</span>
<span class="sd">                   display_precision = number, optional, inherited from Model,</span>
<span class="sd">                   )</span>

<span class="sd">   the concentration argument will be used to initialize the reservoir and</span>
<span class="sd">   to determine the display units.</span>

<span class="sd">   The function definition follows the GenericFunction class.</span>
<span class="sd">   which takes a generic function and up to 6 optional</span>
<span class="sd">   function arguments, and will replace the mass value(s) of the</span>
<span class="sd">   given reservoirs with whatever the function calculates. This is</span>
<span class="sd">   particularly useful e.g., to calculate the pH of a given reservoir</span>
<span class="sd">   as function of e.g., Alkalinity and DIC.</span>
<span class="sd">   Parameters:</span>
<span class="sd">    - name = name of process,</span>
<span class="sd">    - act_on = name of a reservoir this process will act upon</span>
<span class="sd">    - function  = a function reference</span>
<span class="sd">    - a1 to a3 function arguments</span>

<span class="sd">   In order to be compatible with the numba solver, a1 and a2 must be</span>
<span class="sd">   an array of 1-D numpy.arrays i.e., [m, l, h, c]. The array can have</span>
<span class="sd">   any number of arrays though. a3 must be single array (or list)</span>
<span class="sd">   containing an arbitrary number if entries. All numbers in a1 to a3</span>
<span class="sd">   _must_ be of type float64.</span>

<span class="sd">   The function must return a list of numbers which correspond to the</span>
<span class="sd">   data which describe a reservoir i.e., mass, light isotope, heavy</span>
<span class="sd">   isotope, delta, and concentration</span>

<span class="sd">   In order to use this function we need first declare a function we plan to</span>
<span class="sd">   use with the generic function process. This function needs to follow this</span>
<span class="sd">   template::</span>

<span class="sd">       def my_func(i, a1, a2, a3) -&gt; tuple:</span>
<span class="sd">           #</span>
<span class="sd">           # i = index of the current timestep</span>
<span class="sd">           # a1 to a2 =  optional function parameter. These must be present,</span>
<span class="sd">           # even if your function will not use it</span>

<span class="sd">           # calc some stuff and return it as</span>

<span class="sd">           return [m, l, h, d, c] # where m= mass, and l &amp; h are the respective</span>
<span class="sd">                                  # isotopes. d denotes the delta value and</span>
<span class="sd">                                  # c the concentration</span>
<span class="sd">                                  # Use dummy value as necessary.</span>

<span class="sd">   This class provides an update method to resolve cases where e.g., two virtual</span>
<span class="sd">   reservoirs have a circular reference. See the documentation of update().</span>

<span class="sd">   &quot;&quot;&quot;</span>

   <span class="k">def</span> <span class="nf">__aux_inits__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
       <span class="sd">&quot;&quot;&quot;We us the regular init methods of the Reservoir Class, and extend it in this method&quot;&quot;&quot;</span>

       <span class="kn">from</span> <span class="nn">.processes</span> <span class="kn">import</span> <span class="n">GenericFunction</span>

       <span class="c1"># if self.register != &quot;None&quot;:</span>
       <span class="c1">#    self.full_name = f&quot;{self.full_name}.{self.name}&quot;</span>
       <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">_generic_function&quot;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
       <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;creating </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

       <span class="bp">self</span><span class="o">.</span><span class="n">gfh</span> <span class="o">=</span> <span class="n">GenericFunction</span><span class="p">(</span>
           <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
           <span class="n">function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">,</span>
           <span class="n">a1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="p">,</span>
           <span class="n">a2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a2</span><span class="p">,</span>
           <span class="n">a3</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a3</span><span class="p">,</span>
           <span class="n">act_on</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
       <span class="p">)</span>

       <span class="c1"># we only depend on the above function. so no need</span>
       <span class="c1"># to be in the reservoir list</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
       <span class="c1"># but lets keep track of  virtual reservoir in lvr.</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lvr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>



   <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
       <span class="sd">&quot;&quot;&quot;This method allows to update GenericFunction parameters after the</span>
<span class="sd">       VirtualReservoir has been initialized. This is most useful</span>
<span class="sd">       when parameters have to reference other virtual reservoirs</span>
<span class="sd">       which do not yet exist, e.g., when two virtual reservoirs have</span>
<span class="sd">       a circular reference.</span>

<span class="sd">       Example::</span>

<span class="sd">       VR.update(a1=new_parameter, a2=new_parameter)</span>

<span class="sd">       &quot;&quot;&quot;</span>

       <span class="n">allowed_keys</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;a1&quot;</span><span class="p">,</span> <span class="s2">&quot;a2&quot;</span><span class="p">,</span> <span class="s2">&quot;a3&quot;</span><span class="p">,</span> <span class="s2">&quot;a4&quot;</span><span class="p">,</span> <span class="s2">&quot;a5&quot;</span><span class="p">,</span> <span class="s2">&quot;a6&quot;</span><span class="p">,</span> <span class="s2">&quot;volume&quot;</span><span class="p">]</span>
       <span class="c1"># loop over provided kwargs</span>
       <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
           <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_keys</span><span class="p">:</span>
               <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;you can only change a1 to a6&quot;</span><span class="p">)</span>
           <span class="k">else</span><span class="p">:</span>
               <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="c1"># update self</span>
               <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gfh</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="c1"># update function</span>

<span class="k">class</span> <span class="nc">ExternalData</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Instances of this class hold external X/Y data which can be associated with</span>
<span class="sd">    a reservoir.</span>

<span class="sd">    Example::</span>

<span class="sd">           ExternalData(name       = &quot;Name&quot;</span>
<span class="sd">                        filename   = &quot;filename&quot;,</span>
<span class="sd">                        legend     = &quot;label&quot;,</span>
<span class="sd">                        offset     = &quot;0 yrs&quot;,</span>
<span class="sd">                        reservoir  = reservoir_handle,</span>
<span class="sd">                        scale      = scaling factor, optional</span>
<span class="sd">                        display_precision = number, optional, inherited from Model</span>
<span class="sd">                       )</span>

<span class="sd">    The data must exist as CSV file, where the first column contains</span>
<span class="sd">    the X-values, and the second column contains the Y-values.</span>

<span class="sd">    The x-values must be time and specify the time units in the header between square brackets</span>
<span class="sd">    They will be mapped into the model time units.</span>

<span class="sd">    The y-values can be any data, but the user must take care that they match the model units</span>
<span class="sd">    defined in the model instance. So your data file mujst look like this</span>

<span class="sd">    Time [years], Data [units], Data [units]</span>
<span class="sd">    1, 12</span>
<span class="sd">    2, 13</span>

<span class="sd">    By convention, the secon column should contaain the same type of</span>
<span class="sd">    data as the reservoir (i.e., a concentration), whereas the third</span>
<span class="sd">    column contain isotope delta values. Columns with no data should</span>
<span class="sd">    be left empty (and have no header!) The optional scale argumenty, will</span>
<span class="sd">    only affect the Y-col data, not the isotope data</span>

<span class="sd">    The column headers are only used for the time or concentration</span>
<span class="sd">    data conversion, and are ignored by the default plotting</span>
<span class="sd">    methods, but they are available as self.xh,yh</span>

<span class="sd">    The file must exist in the local working directory.</span>

<span class="sd">    Methods:</span>
<span class="sd">      - name.plot()</span>

<span class="sd">    Data:</span>
<span class="sd">      - name.x</span>
<span class="sd">      - name.y</span>
<span class="sd">      - name.df = dataframe as read from csv file</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>

        <span class="c1"># dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;legend&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;reservoir&quot;</span><span class="p">:</span> <span class="n">Reservoir</span><span class="p">,</span>
            <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="s2">&quot;legend&quot;</span><span class="p">,</span> <span class="s2">&quot;reservoir&quot;</span><span class="p">]</span>
        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="s2">&quot;0 yrs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># validate input and initialize instance variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># legacy names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># string =  name of this instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>  <span class="c1"># string = filename of data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">):</span>  <span class="c1"># check if the file is actually there</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">)</span>  <span class="c1"># read file</span>

        <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># test of we have 3 columns</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;CSV file must have 3 columns&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="n">xh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># get unit information from each header</span>
        <span class="n">xh</span> <span class="o">=</span> <span class="n">get_string_between_brackets</span><span class="p">(</span><span class="n">xh</span><span class="p">)</span>

        <span class="n">xq</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">xh</span><span class="p">)</span>
        <span class="c1"># add these to the data we are are reading</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">*</span> <span class="n">xq</span>
        <span class="c1"># map into model units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="c1"># map into model space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>

        <span class="c1"># check if y-data is present</span>
        <span class="n">yh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;Unnamed&quot;</span> <span class="ow">in</span> <span class="n">yh</span><span class="p">:</span>
            <span class="n">yh</span> <span class="o">=</span> <span class="n">get_string_between_brackets</span><span class="p">(</span><span class="n">yh</span><span class="p">)</span>
            <span class="n">yq</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">yh</span><span class="p">)</span>
            <span class="c1"># add these to the data we are are reading</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">*</span> <span class="n">yq</span>
            <span class="c1"># map into model units</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

        <span class="c1"># check if z-data is present</span>
        <span class="k">if</span> <span class="n">ncols</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">zh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="c1"># register with reservoir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__register__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register this dataset with a flux or reservoir. This will have the</span>
<span class="sd">        effect that the data will be printed together with the model</span>
<span class="sd">        results for this reservoir</span>

<span class="sd">        Example::</span>

<span class="sd">        ExternalData.register(Reservoir)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span>  <span class="c1"># reser handle we associate with</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">led</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__interpolate__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Interpolate the input data with a resolution of dt across the model</span>
<span class="sd">        domain The first and last data point must coincide with the</span>
<span class="sd">        model start and end time. In other words, this method will not</span>
<span class="sd">        patch data at the end points.</span>

<span class="sd">        This will replace the original values of name.x and name.y. However</span>
<span class="sd">        the original data remains accessible as name.df</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">xi</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">time</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">xi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">xi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Interpolation requires that the time domain&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;is equal or greater than the model domain&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;data t(0) = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, tmax = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;model t(0) = </span><span class="si">{</span><span class="n">xi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, tmax = </span><span class="si">{</span><span class="n">xi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">xi</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot the data and save a pdf</span>

<span class="sd">        Example::</span>

<span class="sd">                ExternalData.plot()</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>  <span class="c1">#</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">legend</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xh</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yh</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">.connections</span> <span class="kn">import</span> <span class="n">Connection</span><span class="p">,</span> <span class="n">ConnectionGroup</span>
<span class="kn">from</span> <span class="nn">.processes</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.species_definitions</span> <span class="kn">import</span> <span class="n">carbon</span><span class="p">,</span> <span class="n">sulfur</span><span class="p">,</span> <span class="n">hydrogen</span><span class="p">,</span> <span class="n">phosphor</span><span class="p">,</span> <span class="n">oxygen</span><span class="p">,</span> <span class="n">nitrogen</span><span class="p">,</span> <span class="n">boron</span>
<span class="kn">from</span> <span class="nn">.carbonate_chemistry</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.sealevel</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

        </details>

            </section>
                <section id="esbmtkBase">
                                <div class="attr class">
        <a class="headerlink" href="#esbmtkBase">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">esbmtkBase</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">esbmtkBase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The esbmtk base class template. This class handles keyword</span>
<span class="sd">    arguments, name registration and other common tasks</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="s2">&quot;__dict__&quot;</span>

    <span class="c1"># from typing import Dict</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">__global_defaults__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initial variables which should be present in every object</span>
<span class="sd">        Note that this is executed before we register the kwargs as instance</span>
<span class="sd">        variables</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lmo</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ldo</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;full_name&quot;</span><span class="p">,</span> <span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;groupname&quot;</span><span class="p">,</span> <span class="s2">&quot;ctype&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldo</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;set </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> self.kwargs[</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">] to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__validateandregister__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate the user provided input key-value pairs. For this we need</span>
<span class="sd">        kwargs = dictionary with the user provided key-value pairs</span>
<span class="sd">        self.lkk = dictionary with allowed keys and type</span>
<span class="sd">        self.lrk = list of mandatory keywords</span>
<span class="sd">        self.lod = dictionary of default values for keys</span>

<span class="sd">        and register the instance variables and the instance in the global name space</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># validate input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__validateinput__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># add global key-value pairs which should be present in each object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__global_defaults__</span><span class="p">()</span>

        <span class="c1"># register all key/value pairs as instance variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__registerkeys__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__register_name__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register object name in global name space, and test if</span>
<span class="sd">        name is unique</span>

<span class="sd">        There are two possible cases: This is a regular object, which will be registered</span>
<span class="sd">        in the global namespace (self.register is not set).</span>

<span class="sd">        Case B) This object should be registered in the local namespace of a group. In which case</span>
<span class="sd">        self.register should be set to the group object.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># we use this to suppress the echo during object creation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>

        <span class="c1"># if self register is set, it points to the group object which contains</span>
        <span class="c1"># this sub object.</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;self.register = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>  <span class="c1"># Register in global namespace</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Registering </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> in global namespace as type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>  <span class="c1"># Cannot register model with itself</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">builtins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lmo</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is a duplicate name. Please fix&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">builtins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lmo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dmo</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="p">})</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># register in group namespace</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="n">Element</span><span class="p">)):</span>  <span class="c1"># Model only exist in the global NS</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">builtins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># not a model, and part of group</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Registering </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> namespace&quot;</span>
                <span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">full_name</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                    <span class="n">fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span> <span class="o">=</span> <span class="n">fn</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">lmo</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> is a duplicate name. Please fix&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">lmo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>
                <span class="c1"># setattr(builtins, self.name, self)</span>
                <span class="c1"># self.mo.dmo.update({self.name: self})</span>

        <span class="c1"># add fullname to kwargs so it shows up in __repr__</span>
        <span class="c1"># its a dirty hack though</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provided_kwargs</span><span class="p">[</span><span class="s2">&quot;full_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__validateinput__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Validate the user provided input key-value pairs. For this we need</span>
<span class="sd">        kwargs = dictionary with the user provided key-value pairs</span>
<span class="sd">        self.lkk = dictionary with allowed keys and type</span>
<span class="sd">        self.lrk = list of mandatory keywords</span>
<span class="sd">        self.lod = dictionary of default values for keys</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>  <span class="c1"># store the kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provided_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># preserve a copy</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;lkk&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;lrk&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;lod&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;drn&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drn</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># check that mandatory keys are present</span>
        <span class="c1"># and that all keys are allowed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__checkkeys__</span><span class="p">()</span>

        <span class="c1"># initialize missing parameters</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__addmissingdefaults__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># check if key values are of correct type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__checktypes__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__checktypes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">av</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">],</span> <span class="n">pv</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;this method will use the the dict key in the user provided</span>
<span class="sd">        key value data (pv) to look up the allowed data type for this key in av</span>

<span class="sd">        av = dictinory with the allowed input keys and their type</span>
<span class="sd">        pv = dictionary with the user provided key-value data</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">k</span><span class="p">:</span> <span class="nb">any</span>
        <span class="n">v</span><span class="p">:</span> <span class="nb">any</span>

        <span class="c1"># provide more meaningful error messages</span>

        <span class="c1"># loop over provided keywords</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pv</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># check av if provided value v is of correct type</span>
            <span class="k">if</span> <span class="n">av</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">any</span><span class="p">:</span>
                <span class="c1"># print(f&quot;key = {k}, value  = {v}&quot;)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">av</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>

                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2"> is the wrong type for &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39;, should be &#39;</span><span class="si">{</span><span class="n">av</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__initerrormessages__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Init the list of known error messages&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bem</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Number&quot;</span><span class="p">:</span> <span class="s2">&quot;a number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Model&quot;</span><span class="p">:</span> <span class="s2">&quot;a model handle (i.e. the name without quotation marks)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Element&quot;</span><span class="p">:</span> <span class="s2">&quot;an element handle (i.e. the name without quotation marks)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Species&quot;</span><span class="p">:</span> <span class="s2">&quot;a species handle (i.e. the name without quotation marks)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Flux&quot;</span><span class="p">:</span> <span class="s2">&quot;a flux handle (i.e. the name without quotation marks)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Reservoir&quot;</span><span class="p">:</span> <span class="s2">&quot;a reservoir handle (i.e. the name without quotation marks)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Signal&quot;</span><span class="p">:</span> <span class="s2">&quot;a signal handle (i.e. the name without quotation marks)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Process&quot;</span><span class="p">:</span> <span class="s2">&quot;a process handle (i.e. the name without quotation marks)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Unit&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;File&quot;</span><span class="p">:</span> <span class="s2">&quot;a filename inb the local directory&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Legend&quot;</span><span class="p">:</span> <span class="s2">&quot; a string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Source&quot;</span><span class="p">:</span> <span class="s2">&quot; a string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Sink&quot;</span><span class="p">:</span> <span class="s2">&quot; a string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Ref&quot;</span><span class="p">:</span> <span class="s2">&quot; a Flux reference&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Alpha&quot;</span><span class="p">:</span> <span class="s2">&quot; a Number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Delta&quot;</span><span class="p">:</span> <span class="s2">&quot; a Number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Scale&quot;</span><span class="p">:</span> <span class="s2">&quot; a Number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Ratio&quot;</span><span class="p">:</span> <span class="s2">&quot; a Number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="s2">&quot;a number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;a model handle (i.e. the name without quotation marks)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;element&quot;</span><span class="p">:</span> <span class="s2">&quot;an element handle (i.e. the name without quotation marks)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="s2">&quot;a species handle (i.e. the name without quotation marks)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;flux&quot;</span><span class="p">:</span> <span class="s2">&quot;a flux handle (i.e. the name without quotation marks)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;reservoir&quot;</span><span class="p">:</span> <span class="s2">&quot;a reservoir handle (i.e. the name without quotation marks)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;signal&quot;</span><span class="p">:</span> <span class="s2">&quot;a signal handle (i.e. the name without quotation marks)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Process&quot;</span><span class="p">:</span> <span class="s2">&quot;a process handle (i.e. the name without quotation marks)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="s2">&quot;a filename inb the local directory&quot;</span><span class="p">,</span>
            <span class="s2">&quot;legend&quot;</span><span class="p">:</span> <span class="s2">&quot; a string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot; a string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sink&quot;</span><span class="p">:</span> <span class="s2">&quot; a string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ref&quot;</span><span class="p">:</span> <span class="s2">&quot; a Flux reference&quot;</span><span class="p">,</span>
            <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="s2">&quot; a Number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="s2">&quot; a Number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="s2">&quot;a Number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ratio&quot;</span><span class="p">:</span> <span class="s2">&quot;a Number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="s2">&quot;a Number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pl&quot;</span><span class="p">:</span> <span class="s2">&quot; a list with one or more process handles&quot;</span><span class="p">,</span>
            <span class="s2">&quot;react_with&quot;</span><span class="p">:</span> <span class="s2">&quot;a Flux handle&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;External Data Object&quot;</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="s2">&quot;esbmtk object&quot;</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">:</span> <span class="s2">&quot;a string with quotation marks&quot;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__registerkeys__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;register the kwargs key/value pairs as instance variables</span>
<span class="sd">        and complain about unknown keywords&quot;&quot;&quot;</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">any</span>  <span class="c1"># dict keys</span>
        <span class="n">v</span><span class="p">:</span> <span class="nb">any</span>  <span class="c1"># dict values</span>

        <span class="c1"># need list of replacement values</span>
        <span class="c1"># &quot;alpha&quot; : _alpha</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># check wheather the variable name needs to be replaced</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">drn</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drn</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__checkkeys__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; check if the mandatory keys are present&quot;&quot;&quot;</span>

        <span class="n">k</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">v</span><span class="p">:</span> <span class="nb">any</span>
        <span class="c1"># test if the required keywords are given</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span>  <span class="c1"># loop over required keywords</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  <span class="c1"># If keyword is a list</span>
                <span class="n">s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># loop over allowed substitutions</span>
                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>  <span class="c1"># test how many matches are in this list</span>
                    <span class="k">if</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># if more than one match</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;You need to specify exactly one from this list: </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c1"># keyword is not a list</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You need to specify a value for </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">tl</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># get a list of all known keywords</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">tl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="c1"># test if we know all keys</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> is not a valid keyword. </span><span class="se">\n</span><span class="s2"> Try any of </span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">tl</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__addmissingdefaults__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lod</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        test if the keys in lod exist in kwargs, otherwise add them with the default values</span>
<span class="sd">        in lod</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">lod</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                    <span class="n">new</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">})</span>

        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">kwargs</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Print the basic parameters for this class when called via the print method&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Q_</span>

        <span class="n">m</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># suppress output during object initialization</span>
        <span class="n">tdiff</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg_time</span>

        <span class="c1"># do not echo input unless explicitly requestted</span>

        <span class="n">m</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">provided_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">({</span><span class="n">k</span><span class="p">},</span> <span class="n">esbmtkBase</span><span class="p">):</span>
                <span class="c1"># check if this is not another esbmtk object</span>
                <span class="k">if</span> <span class="s2">&quot;esbmtk&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)):</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="c1"># if this is a string</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> = &#39;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&#39;,</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="c1"># if this is a quantity</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Q_</span><span class="p">):</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> = &#39;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&#39;,</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="c1"># if this is a list</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> = &#39;</span><span class="si">{</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;,</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="c1"># all other cases</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">,</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>

        <span class="k">if</span> <span class="n">log</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tdiff</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">return</span> <span class="n">m</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print the basic parameters for this class when called via the print method</span>
<span class="sd">        Optional arguments</span>

<span class="sd">        indent :int = 0 printing offset</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Q_</span>

        <span class="n">m</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">off</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>

        <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">ind</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="s2">&quot; &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ind</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">m</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">provided_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">({</span><span class="n">k</span><span class="p">},</span> <span class="n">esbmtkBase</span><span class="p">):</span>
                <span class="c1"># check if this is not another esbmtk object</span>
                <span class="k">if</span> <span class="s2">&quot;esbmtk&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)):</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;name&quot;</span><span class="p">):</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="n">off</span><span class="si">}{</span><span class="n">k</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Q_</span><span class="p">):</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="n">off</span><span class="si">}{</span><span class="n">k</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">elif</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="n">off</span><span class="si">}{</span><span class="n">k</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">m</span>

    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This is needed for sorting with sorted()&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">n</span>

    <span class="k">def</span> <span class="fm">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This is needed for sorting with sorted()&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">n</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show an overview of the object properties.</span>
<span class="sd">        Optional arguments are</span>

<span class="sd">        indent :int = 0 indentation</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>

        <span class="c1"># print basic data bout this object</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__aux_inits__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Aux initialization code. Not normally used&quot;&quot;&quot;</span>

        <span class="k">pass</span>
</pre></div>

        </details>

            <div class="docstring"><p>The esbmtk base class template. This class handles keyword
arguments, name registration and other common tasks</p>
</div>


                            <div id="esbmtkBase.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#esbmtkBase.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">esbmtkBase</span><span class="signature">()</span>
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="esbmtkBase.info" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#esbmtkBase.info">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">info</span><span class="signature">(self, **kwargs) -&gt; None</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show an overview of the object properties.</span>
<span class="sd">        Optional arguments are</span>

<span class="sd">        indent :int = 0 indentation</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>

        <span class="c1"># print basic data bout this object</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Show an overview of the object properties.
Optional arguments are</p>

<p>indent :int = 0 indentation</p>
</div>


                            </div>
                </section>
                <section id="Model">
                                <div class="attr class">
        <a class="headerlink" href="#Model">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Model</span>(<span class="base"><a href="#esbmtkBase">esbmtkBase</a></span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class is used to specify a new model</span>

<span class="sd">    Example:</span>

<span class="sd">          esbmtkModel(name   =  &quot;Test_Model&quot;,</span>
<span class="sd">                      start    = &quot;0 yrs&quot;,    # optional: start time</span>
<span class="sd">                      stop     = &quot;1000 yrs&quot;, # end time</span>
<span class="sd">                      timestep = &quot;2 yrs&quot;,    # as a string &quot;2 yrs&quot;</span>
<span class="sd">                      offset = &quot;0 yrs&quot;,    # optional: time offset for plot</span>
<span class="sd">                      mass_unit = &quot;mol/l&quot;,   #required</span>
<span class="sd">                      volume_unit = &quot;mol/l&quot;, #required</span>
<span class="sd">                      time_label = optional, defaults to &quot;Time&quot;</span>
<span class="sd">                      display_precision = optional, defaults to 0.01,</span>
<span class="sd">                      m_type = &quot;mass_only/both&quot;</span>
<span class="sd">                      plot_style = &#39;default&#39;, optional defaults to &#39;default&#39;</span>
<span class="sd">                      )</span>

<span class="sd">    ref_time:  will offset the time axis by the specified</span>
<span class="sd">                 amount, when plotting the data, .i.e., the model time runs from to</span>
<span class="sd">                 100, but you want to plot data as if where from 2000 to 2100, you would</span>
<span class="sd">                 specify a value of 2000. This is for display purposes only, and does not affect</span>
<span class="sd">                 the model. Care must be taken that any external data references the model</span>
<span class="sd">                 time domain, and not the display time.</span>

<span class="sd">    display precision: affects the on-screen display of data. It is</span>
<span class="sd">                       also cutoff for the graphicak output. I.e., the interval f the y-axis will not be</span>
<span class="sd">                       smaller than the display_precision.</span>

<span class="sd">    m_type: enables or disables isotope calculation for the entire model.</span>
<span class="sd">            The default value  is &quot;Not set&quot; in this case isotopes will only be calculated for</span>
<span class="sd">            reservoirs which set the isotope keyword. &#39;mass_only&#39; &#39;both&#39; will override</span>
<span class="sd">            the reservoir settings</span>


<span class="sd">    All of the above keyword values are available as variables with</span>
<span class="sd">    Model_Name.keyword</span>

<span class="sd">    The user facing methods of the model class are</span>
<span class="sd">       - Model_Name.info()</span>
<span class="sd">       - Model_Name.save_data()</span>
<span class="sd">       - Model_Name.plot_data()</span>
<span class="sd">       - Model_Name.plot_reservoirs() takes an optional filename as argument</span>
<span class="sd">       - Model_Name.plot([sb.DIC, sb.TA]) plot any object in the list</span>
<span class="sd">       - Model_Name.save_state() Save the model state</span>
<span class="sd">       - Model_name.read_state() Initialize with a previous model state</span>
<span class="sd">       - Model_Name.run(), there are 2 optional arguments here, solver=&quot;hybrid&quot;</span>
<span class="sd">         and solver = &quot;numba&quot;. Both involve a 3 to 5 second overhead. The hybrid</span>
<span class="sd">         solver is compatible with all connection types, and about 3 times faster</span>
<span class="sd">         than the  regular solver. The numba solver is about 10 faster, but currently</span>
<span class="sd">         only supports a limited set of connection types.</span>
<span class="sd">       - Model_Name.list_species()</span>
<span class="sd">       - Model_name.flux_summary()</span>
<span class="sd">       - Model_Name.connection_summary()</span>

<span class="sd">    User facing variable are Model_Name.time which contains the time</span>
<span class="sd">    axis.</span>

<span class="sd">    Optional, you can provide the element keyword which will setup a</span>
<span class="sd">    default set of Species for Carbon and Sulfur. In this case, there</span>
<span class="sd">    is no need to define elements or species. The argument to this</span>
<span class="sd">    keyword are either &quot;Carbon&quot;, or &quot;Sulfur&quot; or both as a list</span>
<span class="sd">    [&quot;Carbon&quot;, &quot;Sulfur&quot;].</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="s2">&quot;lor&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Init Sequence&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;stop&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;timestep&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;element&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span>
            <span class="s2">&quot;mass_unit&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;volume_unit&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;time_label&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="s2">&quot;m_type&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;plot_style&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;stop&quot;</span><span class="p">,</span> <span class="s2">&quot;timestep&quot;</span><span class="p">,</span> <span class="s2">&quot;mass_unit&quot;</span><span class="p">,</span> <span class="s2">&quot;volume_unit&quot;</span><span class="p">]</span>

        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="s2">&quot;0 years&quot;</span><span class="p">,</span>
            <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="s2">&quot;0 years&quot;</span><span class="p">,</span>
            <span class="s2">&quot;time_label&quot;</span><span class="p">:</span> <span class="s2">&quot;Time&quot;</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
            <span class="s2">&quot;m_type&quot;</span><span class="p">:</span> <span class="s2">&quot;Not Set&quot;</span><span class="p">,</span>
            <span class="s2">&quot;plot_style&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bem</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;timesetp&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;element&quot;</span><span class="p">:</span> <span class="s2">&quot;element name or list of names&quot;</span><span class="p">,</span>
                <span class="s2">&quot;mass_unit&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;volume_unit&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;time_label&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="s2">&quot;a number&quot;</span><span class="p">,</span>
                <span class="s2">&quot;m_type&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;plot_style&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># empty list which will hold all reservoir references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dmo</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dict of all model objects. useful for name lookups</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># empty list which will hold all connector references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># set with connection handles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lel</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list which will hold all element references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lsp</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list which will hold all species references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list flux processe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpc_f</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of external functions affecting fluxes</span>
        <span class="c1"># list of external functions affecting virtual reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpc_r</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of virtual reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># optional keywords for use in the connector class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">olkk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of objects which require a delayed initialize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lto</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of datafield objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ldf</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of signals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Parse the strings which contain unit information and convert</span>
        <span class="c1"># into model base units For this we setup 3 variables which define</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l_unit</span> <span class="o">=</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span>  <span class="c1"># the length unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># the time unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># display time units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_unit</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># the mass unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume_unit</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># the volume unit</span>
        <span class="c1"># the concentration unit (mass/volume)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_unit</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_unit</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span>  <span class="c1"># the flux unit (mass/time)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_unit</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span>  <span class="c1"># flux as volume/time</span>
        <span class="c1"># this is now defined in __init__.py</span>
        <span class="c1"># ureg.define(&#39;Sverdrup = 1e6 * meter **3 / second = Sv = Sverdrups&#39;)</span>

        <span class="c1"># legacy variable names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tu</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bu</span><span class="p">)</span>  <span class="c1"># needs to be a string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_style</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_style</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xl</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Time [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bu</span><span class="si">}</span><span class="s2">]&quot;</span>  <span class="c1"># time axis label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># initialize the hypsometry class</span>
        <span class="n">hypsometry</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;hyp&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># set_printoptions(precision=self.display_precision)</span>

        <span class="k">if</span> <span class="s2">&quot;element&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">element_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">element_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">]]</span>

            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">element_list</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">e</span> <span class="o">==</span> <span class="s2">&quot;Carbon&quot;</span><span class="p">:</span>
                    <span class="n">carbon</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">e</span> <span class="o">==</span> <span class="s2">&quot;Sulfur&quot;</span><span class="p">:</span>
                    <span class="n">sulfur</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">e</span> <span class="o">==</span> <span class="s2">&quot;Hydrogen&quot;</span><span class="p">:</span>
                    <span class="n">hydrogen</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">e</span> <span class="o">==</span> <span class="s2">&quot;Phosphor&quot;</span><span class="p">:</span>
                    <span class="n">phosphor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">e</span> <span class="o">==</span> <span class="s2">&quot;Oxygen&quot;</span><span class="p">:</span>
                    <span class="n">oxygen</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">e</span> <span class="o">==</span> <span class="s2">&quot;Nitrogen&quot;</span><span class="p">:</span>
                    <span class="n">nitrogen</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">e</span> <span class="o">==</span> <span class="s2">&quot;Boron&quot;</span><span class="p">:</span>
                    <span class="n">boron</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> not implemented yet&quot;</span><span class="p">)</span>

        <span class="n">warranty</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ESBMTK  Copyright (C) 2020  Ulrich G.Wortmann</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;This program comes with ABSOLUTELY NO WARRANTY</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;For details see the LICENSE file</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;This is free software, and you are welcome to redistribute it</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;under certain conditions; See the LICENSE file for details.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">warranty</span><span class="p">)</span>

        <span class="c1"># start a log file</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">handlers</span><span class="p">[:]:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

        <span class="n">fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.log&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">fn</span><span class="p">,</span> <span class="n">filemode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show an overview of the object properties.</span>
<span class="sd">        Optional arguments are</span>
<span class="sd">        index  :int = 0 this will show data at the given index</span>
<span class="sd">        indent :int = 0 indentation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">off</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>
        <span class="k">if</span> <span class="s2">&quot;index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>

        <span class="c1"># print basic data bout this object</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># list elements</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Currently defined elements and their species:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lel</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}</span><span class="s2"> Defined Species:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">lsp</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}{</span><span class="n">off</span><span class="si">}{</span><span class="n">ind</span><span class="si">}{</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Save model state. Similar to save data, but only saves the last 10</span>
<span class="sd">        time-steps</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
        <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">stride</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;state_&quot;</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__write_data__</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">stride</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Save the model results to a CSV file. Each reservoir will have</span>
<span class="sd">        their own CSV file</span>

<span class="sd">        Optional arguments:</span>
<span class="sd">        stride = int  # every nth element</span>
<span class="sd">        start = int   # start index</span>
<span class="sd">        stop = int    # end index</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> must be an integer number&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> must be an integer number&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;stride&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">stride</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;stride&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stride</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="s2">&quot;start&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="s2">&quot;stop&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;stop&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># Save reservoir and flux data</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__write_data__</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">stride</span><span class="p">)</span>

        <span class="c1"># save data fields</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldf</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__write_data__</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">stride</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This will initialize the model with the result of a previous model</span>
<span class="sd">        run.  For this to work, you will need issue a</span>
<span class="sd">        Model.save_state() command at then end of a model run. This</span>
<span class="sd">        will create the necessary data files to initialize a</span>
<span class="sd">        subsequent model run.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__read_state__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">plot_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loop over all reservoirs and either plot the data into a</span>
<span class="sd">        window, or save it to a pdf</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__plot__</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># create the plot windows</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot all objects specified in list)</span>

<span class="sd">        M.plot([sb.PO4, sb.DIC],fn=test.pdf)</span>

<span class="sd">        fn is optional</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;fn&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;fn&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">.pdf&quot;</span>

        <span class="n">noo</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="n">size</span><span class="p">,</span> <span class="n">geo</span> <span class="o">=</span> <span class="n">plot_geometry</span><span class="p">(</span><span class="n">noo</span><span class="p">)</span>  <span class="c1"># adjust layout</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_style</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Initialize a plot window</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> Reservoirs&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
            <span class="n">plot_object_data</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># create the plot windows</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.88</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_reservoirs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot only Reservoir data</span>

<span class="sd">        you can further specify a different name for the plot</span>
<span class="sd">        fn = &quot;foo.pdf&quot;</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># get number of plot objects</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># get number of signals</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">plot</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># get number of reservoirs</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">plot</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># get number of virtual reservoirs</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">plot</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">noo</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ldf</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span>
        <span class="n">size</span><span class="p">,</span> <span class="n">geo</span> <span class="o">=</span> <span class="n">plot_geometry</span><span class="p">(</span><span class="n">noo</span><span class="p">)</span>  <span class="c1"># adjust layout</span>

        <span class="k">if</span> <span class="s2">&quot;fn&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;fn&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">_Reservoirs.pdf&quot;</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_style</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Initialize a plot window</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> Reservoirs&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">:</span>  <span class="c1"># signals</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">plot</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
                <span class="n">plot_object_data</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>  <span class="c1"># reservoirs</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">plot</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
                <span class="n">plot_object_data</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span>  <span class="c1"># virtual reservoirs</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">plot</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
                <span class="n">plot_object_data</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldf</span><span class="p">:</span>  <span class="c1"># datafields</span>
            <span class="n">plot_object_data</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># create the plot windows</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.88</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Loop over the time vector, and for each time step, calculate the</span>
<span class="sd">        fluxes for each reservoir</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># this has nothing todo with self.time below!</span>
        <span class="n">wts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">process_time</span><span class="p">()</span>
        <span class="n">new</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">]</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

        <span class="c1"># put direction dictionary into a list</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>  <span class="c1"># loop over reservoirs</span>
            <span class="n">r</span><span class="o">.</span><span class="n">lodir</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>  <span class="c1"># loop over fluxes</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
                <span class="n">r</span><span class="o">.</span><span class="n">lodir</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="c1"># take care of objects which require a delayed init</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lto</span><span class="p">:</span>
            <span class="n">o</span><span class="o">.</span><span class="n">__delayed_init__</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;solver&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="s2">&quot;python&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s2">&quot;numba&quot;</span><span class="p">:</span>
            <span class="n">execute_e</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpc_f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpc_r</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">solver</span> <span class="o">==</span> <span class="s2">&quot;hybrid&quot;</span><span class="p">:</span>
            <span class="n">execute_h</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpc_f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpc_r</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">execute</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpc_f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpc_r</span><span class="p">)</span>
        <span class="c1"># self.execute(new, self.time, self.lor, self.lpc_f, self.lpc_r)</span>

        <span class="n">duration</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">process_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">wcd</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">wts</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Execution took </span><span class="si">{</span><span class="n">duration</span><span class="si">}</span><span class="s2"> cpu seconds, wt = </span><span class="si">{</span><span class="n">wcd</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># flag that the model has executed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">__step_process__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;For debugging. Provide reservoir and step number,&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span>  <span class="c1"># loop over reservoir processes</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>  <span class="c1"># update fluxes</span>

    <span class="k">def</span> <span class="nf">__step_update_reservoir__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;For debugging. Provide reservoir and step number,&quot;&quot;&quot;</span>
        <span class="n">flux_list</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span>
        <span class="c1"># new = sum_fluxes(flux_list,r,i) # integrate all fluxes in self.lof</span>

        <span class="n">ms</span> <span class="o">=</span> <span class="n">ls</span> <span class="o">=</span> <span class="n">hs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flux_list</span><span class="p">:</span>  <span class="c1"># do sum of fluxes in this reservoir</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
            <span class="n">ms</span> <span class="o">=</span> <span class="n">ms</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">direction</span>  <span class="c1"># current flux and direction</span>
            <span class="n">ls</span> <span class="o">=</span> <span class="n">ls</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">direction</span>  <span class="c1"># current flux and direction</span>
            <span class="n">hs</span> <span class="o">=</span> <span class="n">hs</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">direction</span>  <span class="c1"># current flux and direction</span>

        <span class="n">new</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">ms</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">hs</span><span class="p">])</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">new</span> <span class="o">*</span> <span class="n">r</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span>  <span class="c1"># get flux / timestep</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">new</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># add to data from last time step</span>
        <span class="c1"># new = new * (new &gt; 0)  # set negative values to zero</span>
        <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>  <span class="c1"># update reservoir data</span>

    <span class="k">def</span> <span class="nf">list_species</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List all  defined species.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lel</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">e</span><span class="o">.</span><span class="n">list_species</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">flux_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show a summary of all model fluxes</span>

<span class="sd">        Optional parameters:</span>

<span class="sd">        index :int = i &gt; 1 and i &lt; number of timesteps -1</span>
<span class="sd">        filter_by :str = filter on flux name or part of flux name</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;index&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span>

        <span class="k">if</span> <span class="s2">&quot;filter_by&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">fby</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;filter_by&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fby</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;filter&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;use filter_by instead of filter&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> --- Flux Summary -- filtered by </span><span class="si">{</span><span class="n">fby</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fby</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="p">:</span>  <span class="c1"># and f.m[i] &gt; 0:</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;    - </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">direction</span> <span class="o">*</span> <span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> d = </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    - </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">direction</span> <span class="o">*</span> <span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">connection_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show a summary of all connections</span>

<span class="sd">        Optional parameters:</span>

<span class="sd">        filter_by :str = filter on flux name or part of flux name</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;filter_by&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">fby</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;filter_by&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fby</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;filter&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;use filter_by instead of filter&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> --- Connection Summary -- filtered by </span><span class="si">{</span><span class="n">fby</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;       append info() to the connection name to see more details&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fby</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">full_name</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>This class is used to specify a new model</p>

<p>Example:</p>

<pre><code>  esbmtkModel(name   =  "Test_Model",
              start    = "0 yrs",    # optional: start time
              stop     = "1000 yrs", # end time
              timestep = "2 yrs",    # as a string "2 yrs"
              offset = "0 yrs",    # optional: time offset for plot
              mass_unit = "mol/l",   #required
              volume_unit = "mol/l", #required
              time_label = optional, defaults to "Time"
              display_precision = optional, defaults to 0.01,
              m_type = "mass_only/both"
              plot_style = 'default', optional defaults to 'default'
              )
</code></pre>

<p>ref_time:  will offset the time axis by the specified
             amount, when plotting the data, .i.e., the model time runs from to
             100, but you want to plot data as if where from 2000 to 2100, you would
             specify a value of 2000. This is for display purposes only, and does not affect
             the model. Care must be taken that any external data references the model
             time domain, and not the display time.</p>

<p>display precision: affects the on-screen display of data. It is
                   also cutoff for the graphicak output. I.e., the interval f the y-axis will not be
                   smaller than the display_precision.</p>

<p>m_type: enables or disables isotope calculation for the entire model.
        The default value  is "Not set" in this case isotopes will only be calculated for
        reservoirs which set the isotope keyword. 'mass_only' 'both' will override
        the reservoir settings</p>

<p>All of the above keyword values are available as variables with
Model_Name.keyword</p>

<p>The user facing methods of the model class are</p>

<ul>
<li>Model_Name.info()</li>
<li>Model_Name.save_data()</li>
<li>Model_Name.plot_data()</li>
<li>Model_Name.plot_reservoirs() takes an optional filename as argument</li>
<li>Model_Name.plot([sb.DIC, sb.TA]) plot any object in the list</li>
<li>Model_Name.save_state() Save the model state</li>
<li>Model_name.read_state() Initialize with a previous model state</li>
<li>Model_Name.run(), there are 2 optional arguments here, solver="hybrid"
 and solver = "numba". Both involve a 3 to 5 second overhead. The hybrid
 solver is compatible with all connection types, and about 3 times faster
 than the  regular solver. The numba solver is about 10 faster, but currently
 only supports a limited set of connection types.</li>
<li>Model_Name.list_species()</li>
<li>Model_name.flux_summary()</li>
<li>Model_Name.connection_summary()</li>
</ul>

<p>User facing variable are Model_Name.time which contains the time
axis.</p>

<p>Optional, you can provide the element keyword which will setup a
default set of Species for Carbon and Sulfur. In this case, there
is no need to define elements or species. The argument to this
keyword are either "Carbon", or "Sulfur" or both as a list
["Carbon", "Sulfur"].</p>
</div>


                            <div id="Model.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Model.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">Model</span><span class="signature">(**kwargs: Dict[&lt;built-in function any&gt;, &lt;built-in function any&gt;])</span>
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Init Sequence&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;stop&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;timestep&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;element&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span>
            <span class="s2">&quot;mass_unit&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;volume_unit&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;time_label&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="s2">&quot;m_type&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;plot_style&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;stop&quot;</span><span class="p">,</span> <span class="s2">&quot;timestep&quot;</span><span class="p">,</span> <span class="s2">&quot;mass_unit&quot;</span><span class="p">,</span> <span class="s2">&quot;volume_unit&quot;</span><span class="p">]</span>

        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="s2">&quot;0 years&quot;</span><span class="p">,</span>
            <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="s2">&quot;0 years&quot;</span><span class="p">,</span>
            <span class="s2">&quot;time_label&quot;</span><span class="p">:</span> <span class="s2">&quot;Time&quot;</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
            <span class="s2">&quot;m_type&quot;</span><span class="p">:</span> <span class="s2">&quot;Not Set&quot;</span><span class="p">,</span>
            <span class="s2">&quot;plot_style&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bem</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;timesetp&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;element&quot;</span><span class="p">:</span> <span class="s2">&quot;element name or list of names&quot;</span><span class="p">,</span>
                <span class="s2">&quot;mass_unit&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;volume_unit&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;time_label&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="s2">&quot;a number&quot;</span><span class="p">,</span>
                <span class="s2">&quot;m_type&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;plot_style&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># empty list which will hold all reservoir references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dmo</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dict of all model objects. useful for name lookups</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># empty list which will hold all connector references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># set with connection handles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lel</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list which will hold all element references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lsp</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list which will hold all species references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list flux processe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpc_f</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of external functions affecting fluxes</span>
        <span class="c1"># list of external functions affecting virtual reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpc_r</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of virtual reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># optional keywords for use in the connector class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">olkk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of objects which require a delayed initialize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lto</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of datafield objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ldf</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of signals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Parse the strings which contain unit information and convert</span>
        <span class="c1"># into model base units For this we setup 3 variables which define</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l_unit</span> <span class="o">=</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span>  <span class="c1"># the length unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># the time unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># display time units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_unit</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># the mass unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume_unit</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># the volume unit</span>
        <span class="c1"># the concentration unit (mass/volume)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_unit</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_unit</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span>  <span class="c1"># the flux unit (mass/time)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_unit</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span>  <span class="c1"># flux as volume/time</span>
        <span class="c1"># this is now defined in __init__.py</span>
        <span class="c1"># ureg.define(&#39;Sverdrup = 1e6 * meter **3 / second = Sv = Sverdrups&#39;)</span>

        <span class="c1"># legacy variable names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tu</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bu</span><span class="p">)</span>  <span class="c1"># needs to be a string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_style</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_style</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xl</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Time [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bu</span><span class="si">}</span><span class="s2">]&quot;</span>  <span class="c1"># time axis label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># initialize the hypsometry class</span>
        <span class="n">hypsometry</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;hyp&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># set_printoptions(precision=self.display_precision)</span>

        <span class="k">if</span> <span class="s2">&quot;element&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">element_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">element_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">]]</span>

            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">element_list</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">e</span> <span class="o">==</span> <span class="s2">&quot;Carbon&quot;</span><span class="p">:</span>
                    <span class="n">carbon</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">e</span> <span class="o">==</span> <span class="s2">&quot;Sulfur&quot;</span><span class="p">:</span>
                    <span class="n">sulfur</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">e</span> <span class="o">==</span> <span class="s2">&quot;Hydrogen&quot;</span><span class="p">:</span>
                    <span class="n">hydrogen</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">e</span> <span class="o">==</span> <span class="s2">&quot;Phosphor&quot;</span><span class="p">:</span>
                    <span class="n">phosphor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">e</span> <span class="o">==</span> <span class="s2">&quot;Oxygen&quot;</span><span class="p">:</span>
                    <span class="n">oxygen</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">e</span> <span class="o">==</span> <span class="s2">&quot;Nitrogen&quot;</span><span class="p">:</span>
                    <span class="n">nitrogen</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">e</span> <span class="o">==</span> <span class="s2">&quot;Boron&quot;</span><span class="p">:</span>
                    <span class="n">boron</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> not implemented yet&quot;</span><span class="p">)</span>

        <span class="n">warranty</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ESBMTK  Copyright (C) 2020  Ulrich G.Wortmann</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;This program comes with ABSOLUTELY NO WARRANTY</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;For details see the LICENSE file</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;This is free software, and you are welcome to redistribute it</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;under certain conditions; See the LICENSE file for details.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">warranty</span><span class="p">)</span>

        <span class="c1"># start a log file</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">handlers</span><span class="p">[:]:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

        <span class="n">fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.log&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">fn</span><span class="p">,</span> <span class="n">filemode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>Init Sequence</p>
</div>


                            </div>
                            <div id="Model.lkk" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Model.lkk">#&nbsp;&nbsp</a>

        <span class="name">lkk</span><span class="annotation">: Dict[str, &lt;built-in function any&gt;]</span>
    </div>

    

                            </div>
                            <div id="Model.lrk" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Model.lrk">#&nbsp;&nbsp</a>

        <span class="name">lrk</span><span class="annotation">: &#39;list[str]&#39;</span>
    </div>

    

                            </div>
                            <div id="Model.lod" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Model.lod">#&nbsp;&nbsp</a>

        <span class="name">lod</span><span class="annotation">: Dict[str, &lt;built-in function any&gt;]</span>
    </div>

    

                            </div>
                            <div id="Model.dmo" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Model.dmo">#&nbsp;&nbsp</a>

        <span class="name">dmo</span><span class="annotation">: dict</span>
    </div>

    

                            </div>
                            <div id="Model.lor" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Model.lor">#&nbsp;&nbsp</a>

        <span class="name">lor</span><span class="annotation">: list</span><span class="default_value"> = &lt;member &#39;lor&#39; of &#39;Model&#39; objects&gt;</span>
    </div>

    

                            </div>
                            <div id="Model.loc" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Model.loc">#&nbsp;&nbsp</a>

        <span class="name">loc</span><span class="annotation">: set</span>
    </div>

    

                            </div>
                            <div id="Model.lel" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Model.lel">#&nbsp;&nbsp</a>

        <span class="name">lel</span><span class="annotation">: list</span>
    </div>

    

                            </div>
                            <div id="Model.lsp" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Model.lsp">#&nbsp;&nbsp</a>

        <span class="name">lsp</span><span class="annotation">: list</span>
    </div>

    

                            </div>
                            <div id="Model.lop" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Model.lop">#&nbsp;&nbsp</a>

        <span class="name">lop</span><span class="annotation">: list</span>
    </div>

    

                            </div>
                            <div id="Model.lpc_f" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Model.lpc_f">#&nbsp;&nbsp</a>

        <span class="name">lpc_f</span><span class="annotation">: list</span>
    </div>

    

                            </div>
                            <div id="Model.lpc_r" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Model.lpc_r">#&nbsp;&nbsp</a>

        <span class="name">lpc_r</span><span class="annotation">: list</span>
    </div>

    

                            </div>
                            <div id="Model.lvr" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Model.lvr">#&nbsp;&nbsp</a>

        <span class="name">lvr</span><span class="annotation">: list</span>
    </div>

    

                            </div>
                            <div id="Model.olkk" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Model.olkk">#&nbsp;&nbsp</a>

        <span class="name">olkk</span><span class="annotation">: list</span>
    </div>

    

                            </div>
                            <div id="Model.lto" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Model.lto">#&nbsp;&nbsp</a>

        <span class="name">lto</span><span class="annotation">: list</span>
    </div>

    

                            </div>
                            <div id="Model.ldf" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Model.ldf">#&nbsp;&nbsp</a>

        <span class="name">ldf</span><span class="annotation">: list</span>
    </div>

    

                            </div>
                            <div id="Model.los" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Model.los">#&nbsp;&nbsp</a>

        <span class="name">los</span><span class="annotation">: list</span>
    </div>

    

                            </div>
                            <div id="Model.plot_style" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Model.plot_style">#&nbsp;&nbsp</a>

        <span class="name">plot_style</span><span class="annotation">: list</span>
    </div>

    

                            </div>
                            <div id="Model.info" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Model.info">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">info</span><span class="signature">(self, **kwargs) -&gt; None</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show an overview of the object properties.</span>
<span class="sd">        Optional arguments are</span>
<span class="sd">        index  :int = 0 this will show data at the given index</span>
<span class="sd">        indent :int = 0 indentation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">off</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>
        <span class="k">if</span> <span class="s2">&quot;index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>

        <span class="c1"># print basic data bout this object</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># list elements</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Currently defined elements and their species:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lel</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}</span><span class="s2"> Defined Species:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">lsp</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}{</span><span class="n">off</span><span class="si">}{</span><span class="n">ind</span><span class="si">}{</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Show an overview of the object properties.
Optional arguments are
index  :int = 0 this will show data at the given index
indent :int = 0 indentation</p>
</div>


                            </div>
                            <div id="Model.save_state" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Model.save_state">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">save_state</span><span class="signature">(self) -&gt; None</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">save_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Save model state. Similar to save data, but only saves the last 10</span>
<span class="sd">        time-steps</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
        <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">stride</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;state_&quot;</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__write_data__</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">stride</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Save model state. Similar to save data, but only saves the last 10
time-steps</p>
</div>


                            </div>
                            <div id="Model.save_data" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Model.save_data">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">save_data</span><span class="signature">(self, **kwargs) -&gt; None</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">save_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Save the model results to a CSV file. Each reservoir will have</span>
<span class="sd">        their own CSV file</span>

<span class="sd">        Optional arguments:</span>
<span class="sd">        stride = int  # every nth element</span>
<span class="sd">        start = int   # start index</span>
<span class="sd">        stop = int    # end index</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> must be an integer number&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> must be an integer number&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;stride&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">stride</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;stride&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stride</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="s2">&quot;start&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="s2">&quot;stop&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;stop&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># Save reservoir and flux data</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__write_data__</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">stride</span><span class="p">)</span>

        <span class="c1"># save data fields</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldf</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__write_data__</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">stride</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Save the model results to a CSV file. Each reservoir will have
their own CSV file</p>

<p>Optional arguments:
stride = int  # every nth element
start = int   # start index
stop = int    # end index</p>
</div>


                            </div>
                            <div id="Model.read_state" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Model.read_state">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">read_state</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">read_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This will initialize the model with the result of a previous model</span>
<span class="sd">        run.  For this to work, you will need issue a</span>
<span class="sd">        Model.save_state() command at then end of a model run. This</span>
<span class="sd">        will create the necessary data files to initialize a</span>
<span class="sd">        subsequent model run.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__read_state__</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>This will initialize the model with the result of a previous model
run.  For this to work, you will need issue a
<a href="#Model.save_state">Model.save_state()</a> command at then end of a model run. This
will create the necessary data files to initialize a
subsequent model run.</p>
</div>


                            </div>
                            <div id="Model.plot_data" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Model.plot_data">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">plot_data</span><span class="signature">(self, **kwargs: dict) -&gt; None</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">plot_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loop over all reservoirs and either plot the data into a</span>
<span class="sd">        window, or save it to a pdf</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__plot__</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># create the plot windows</span>
</pre></div>

        </details>

            <div class="docstring"><p>Loop over all reservoirs and either plot the data into a
window, or save it to a pdf</p>
</div>


                            </div>
                            <div id="Model.plot" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Model.plot">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">plot</span><span class="signature">(self, l: list = [], **kwargs) -&gt; None</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot all objects specified in list)</span>

<span class="sd">        M.plot([sb.PO4, sb.DIC],fn=test.pdf)</span>

<span class="sd">        fn is optional</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;fn&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;fn&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">.pdf&quot;</span>

        <span class="n">noo</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="n">size</span><span class="p">,</span> <span class="n">geo</span> <span class="o">=</span> <span class="n">plot_geometry</span><span class="p">(</span><span class="n">noo</span><span class="p">)</span>  <span class="c1"># adjust layout</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_style</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Initialize a plot window</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> Reservoirs&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
            <span class="n">plot_object_data</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># create the plot windows</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.88</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Plot all objects specified in list)</p>

<p>M.plot([sb.PO4, sb.DIC],fn=test.pdf)</p>

<p>fn is optional</p>
</div>


                            </div>
                            <div id="Model.plot_reservoirs" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Model.plot_reservoirs">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">plot_reservoirs</span><span class="signature">(self, **kwargs: dict) -&gt; None</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">plot_reservoirs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot only Reservoir data</span>

<span class="sd">        you can further specify a different name for the plot</span>
<span class="sd">        fn = &quot;foo.pdf&quot;</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># get number of plot objects</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># get number of signals</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">plot</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># get number of reservoirs</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">plot</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># get number of virtual reservoirs</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">plot</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">noo</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ldf</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span>
        <span class="n">size</span><span class="p">,</span> <span class="n">geo</span> <span class="o">=</span> <span class="n">plot_geometry</span><span class="p">(</span><span class="n">noo</span><span class="p">)</span>  <span class="c1"># adjust layout</span>

        <span class="k">if</span> <span class="s2">&quot;fn&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;fn&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">_Reservoirs.pdf&quot;</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_style</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Initialize a plot window</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> Reservoirs&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">:</span>  <span class="c1"># signals</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">plot</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
                <span class="n">plot_object_data</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>  <span class="c1"># reservoirs</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">plot</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
                <span class="n">plot_object_data</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span>  <span class="c1"># virtual reservoirs</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">plot</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
                <span class="n">plot_object_data</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldf</span><span class="p">:</span>  <span class="c1"># datafields</span>
            <span class="n">plot_object_data</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># create the plot windows</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.88</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Plot only Reservoir data</p>

<p>you can further specify a different name for the plot
fn = "foo.pdf"</p>
</div>


                            </div>
                            <div id="Model.run" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Model.run">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">run</span><span class="signature">(self, **kwargs) -&gt; None</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Loop over the time vector, and for each time step, calculate the</span>
<span class="sd">        fluxes for each reservoir</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># this has nothing todo with self.time below!</span>
        <span class="n">wts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">process_time</span><span class="p">()</span>
        <span class="n">new</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">]</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

        <span class="c1"># put direction dictionary into a list</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>  <span class="c1"># loop over reservoirs</span>
            <span class="n">r</span><span class="o">.</span><span class="n">lodir</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>  <span class="c1"># loop over fluxes</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
                <span class="n">r</span><span class="o">.</span><span class="n">lodir</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="c1"># take care of objects which require a delayed init</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lto</span><span class="p">:</span>
            <span class="n">o</span><span class="o">.</span><span class="n">__delayed_init__</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;solver&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="s2">&quot;python&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s2">&quot;numba&quot;</span><span class="p">:</span>
            <span class="n">execute_e</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpc_f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpc_r</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">solver</span> <span class="o">==</span> <span class="s2">&quot;hybrid&quot;</span><span class="p">:</span>
            <span class="n">execute_h</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpc_f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpc_r</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">execute</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpc_f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpc_r</span><span class="p">)</span>
        <span class="c1"># self.execute(new, self.time, self.lor, self.lpc_f, self.lpc_r)</span>

        <span class="n">duration</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">process_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">wcd</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">wts</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Execution took </span><span class="si">{</span><span class="n">duration</span><span class="si">}</span><span class="s2"> cpu seconds, wt = </span><span class="si">{</span><span class="n">wcd</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># flag that the model has executed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>

        </details>

            <div class="docstring"><p>Loop over the time vector, and for each time step, calculate the
fluxes for each reservoir</p>
</div>


                            </div>
                            <div id="Model.list_species" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Model.list_species">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">list_species</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">list_species</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List all  defined species.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lel</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">e</span><span class="o">.</span><span class="n">list_species</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>List all  defined species.</p>
</div>


                            </div>
                            <div id="Model.flux_summary" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Model.flux_summary">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">flux_summary</span><span class="signature">(self, **kwargs: dict) -&gt; None</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">flux_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show a summary of all model fluxes</span>

<span class="sd">        Optional parameters:</span>

<span class="sd">        index :int = i &gt; 1 and i &lt; number of timesteps -1</span>
<span class="sd">        filter_by :str = filter on flux name or part of flux name</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;index&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span>

        <span class="k">if</span> <span class="s2">&quot;filter_by&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">fby</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;filter_by&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fby</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;filter&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;use filter_by instead of filter&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> --- Flux Summary -- filtered by </span><span class="si">{</span><span class="n">fby</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fby</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="p">:</span>  <span class="c1"># and f.m[i] &gt; 0:</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;    - </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">direction</span> <span class="o">*</span> <span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> d = </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    - </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">direction</span> <span class="o">*</span> <span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Show a summary of all model fluxes</p>

<p>Optional parameters:</p>

<p>index :int = i &gt; 1 and i &lt; number of timesteps -1
filter_by :str = filter on flux name or part of flux name</p>
</div>


                            </div>
                            <div id="Model.connection_summary" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Model.connection_summary">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">connection_summary</span><span class="signature">(self, **kwargs: dict) -&gt; None</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">connection_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show a summary of all connections</span>

<span class="sd">        Optional parameters:</span>

<span class="sd">        filter_by :str = filter on flux name or part of flux name</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;filter_by&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">fby</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;filter_by&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fby</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;filter&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;use filter_by instead of filter&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> --- Connection Summary -- filtered by </span><span class="si">{</span><span class="n">fby</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;       append info() to the connection name to see more details&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fby</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">full_name</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Show a summary of all connections</p>

<p>Optional parameters:</p>

<p>filter_by :str = filter on flux name or part of flux name</p>
</div>


                            </div>
                </section>
                <section id="Element">
                                <div class="attr class">
        <a class="headerlink" href="#Element">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Element</span>(<span class="base"><a href="#esbmtkBase">esbmtkBase</a></span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Element</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Each model, can have one or more elements.  This class sets</span>
<span class="sd">    element specific properties</span>

<span class="sd">    Example::</span>

<span class="sd">            Element(name      = &quot;S &quot;           # the element name</span>
<span class="sd">                    model     = Test_model     # the model handle</span>
<span class="sd">                    mass_unit =  &quot;mol&quot;,        # base mass unit</span>
<span class="sd">                    li_label  =  &quot;$^{32$S&quot;,    # Label of light isotope</span>
<span class="sd">                    hi_label  =  &quot;$^{34}S&quot;,    # Label of heavy isotope</span>
<span class="sd">                    d_label   =  r&quot;$\delta^{34}$S&quot;,  # Label for delta value</span>
<span class="sd">                    d_scale   =  &quot;VCDT&quot;,       # Isotope scale</span>
<span class="sd">                    r         = 0.044162589,   # isotopic abundance ratio for element</span>
<span class="sd">                  )</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># set element properties</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Initialize all instance variables</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># provide a dict of known keywords and types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
            <span class="s2">&quot;mass_unit&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;li_label&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;hi_label&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;d_label&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;d_scale&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="n">Number</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;mass_unit&quot;</span><span class="p">]</span>
        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;li_label&#39;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s1">&#39;hi_label&#39;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s1">&#39;d_label&#39;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s1">&#39;d_scale&#39;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># legacy name aliases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># display name of species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>  <span class="c1"># model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_unit</span>  <span class="c1"># display name of mass unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ln</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">li_label</span>  <span class="c1"># display name of light isotope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hi_label</span>  <span class="c1"># display name of heavy isotope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_label</span>  <span class="c1"># display string for delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_scale</span>  <span class="c1"># display string for delta scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lsp</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of species for this element.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">list_species</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; List all species which are predefined for this element</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lsp</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Each model, can have one or more elements.  This class sets
element specific properties</p>

<p>Example::</p>

<pre><code>    Element(name      = "S "           # the element name
            model     = Test_model     # the model handle
            mass_unit =  "mol",        # base mass unit
            li_label  =  "$^{32$S",    # Label of light isotope
            hi_label  =  "$^{34}S",    # Label of heavy isotope
            d_label   =  r"$\delta^{34}$S",  # Label for delta value
            d_scale   =  "VCDT",       # Isotope scale
            r         = 0.044162589,   # isotopic abundance ratio for element
          )
</code></pre>
</div>


                            <div id="Element.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Element.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">Element</span><span class="signature">(**kwargs)</span>
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Initialize all instance variables</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># provide a dict of known keywords and types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
            <span class="s2">&quot;mass_unit&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;li_label&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;hi_label&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;d_label&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;d_scale&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="n">Number</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;mass_unit&quot;</span><span class="p">]</span>
        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;li_label&#39;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s1">&#39;hi_label&#39;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s1">&#39;d_label&#39;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s1">&#39;d_scale&#39;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># legacy name aliases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># display name of species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>  <span class="c1"># model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_unit</span>  <span class="c1"># display name of mass unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ln</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">li_label</span>  <span class="c1"># display name of light isotope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hi_label</span>  <span class="c1"># display name of heavy isotope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_label</span>  <span class="c1"># display string for delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_scale</span>  <span class="c1"># display string for delta scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lsp</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of species for this element.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>Initialize all instance variables</p>
</div>


                            </div>
                            <div id="Element.lrk" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Element.lrk">#&nbsp;&nbsp</a>

        <span class="name">lrk</span><span class="annotation">: list</span>
    </div>

    

                            </div>
                            <div id="Element.n" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Element.n">#&nbsp;&nbsp</a>

        <span class="name">n</span><span class="annotation">: str</span>
    </div>

    

                            </div>
                            <div id="Element.mo" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Element.mo">#&nbsp;&nbsp</a>

        <span class="name">mo</span><span class="annotation">: <a href="#Model">esbmtk.esbmtk.Model</a></span>
    </div>

    

                            </div>
                            <div id="Element.mu" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Element.mu">#&nbsp;&nbsp</a>

        <span class="name">mu</span><span class="annotation">: str</span>
    </div>

    

                            </div>
                            <div id="Element.ln" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Element.ln">#&nbsp;&nbsp</a>

        <span class="name">ln</span><span class="annotation">: str</span>
    </div>

    

                            </div>
                            <div id="Element.hn" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Element.hn">#&nbsp;&nbsp</a>

        <span class="name">hn</span><span class="annotation">: str</span>
    </div>

    

                            </div>
                            <div id="Element.dn" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Element.dn">#&nbsp;&nbsp</a>

        <span class="name">dn</span><span class="annotation">: str</span>
    </div>

    

                            </div>
                            <div id="Element.ds" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Element.ds">#&nbsp;&nbsp</a>

        <span class="name">ds</span><span class="annotation">: str</span>
    </div>

    

                            </div>
                            <div id="Element.lsp" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Element.lsp">#&nbsp;&nbsp</a>

        <span class="name">lsp</span><span class="annotation">: list</span>
    </div>

    

                            </div>
                            <div id="Element.list_species" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Element.list_species">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">list_species</span><span class="signature">(self) -&gt; None</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">list_species</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; List all species which are predefined for this element</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lsp</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>List all species which are predefined for this element</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#esbmtkBase">esbmtkBase</a></dt>
                                <dd id="Element.info" class="function"><a href="#esbmtkBase.info">info</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Species">
                                <div class="attr class">
        <a class="headerlink" href="#Species">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Species</span>(<span class="base"><a href="#esbmtkBase">esbmtkBase</a></span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Species</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Each model, can have one or more species.  This class sets species</span>
<span class="sd">specific properties</span>
<span class="sd">      </span>
<span class="sd">      Example::</span>
<span class="sd">        </span>
<span class="sd">            Species(name = &quot;SO4&quot;,</span>
<span class="sd">                    element = S,</span>
<span class="sd">)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

    <span class="c1"># set species properties</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Initialize all instance variables</span>
<span class="sd">            &quot;&quot;&quot;</span>

        <span class="c1"># provide a list of all known keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;element&quot;</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span>
            <span class="s1">&#39;display_as&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;m_weight&#39;</span><span class="p">:</span> <span class="n">Number</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;element&quot;</span><span class="p">]</span>

        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;display_as&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="s1">&#39;m_weight&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;display_as&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># legacy names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># display name of species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">mu</span>  <span class="c1"># display name of mass unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ln</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">ln</span>  <span class="c1"># display name of light isotope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">hn</span>  <span class="c1"># display name of heavy isotope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">dn</span>  <span class="c1"># display string for delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">ds</span>  <span class="c1"># display string for delta scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span>  <span class="c1"># ratio of isotope standard</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">n</span>  <span class="c1"># element name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span>  <span class="c1"># element handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dsa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span>  <span class="c1"># the display string.</span>

        <span class="c1">#self.mo.lsp.append(self)   # register self on the list of model objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">lsp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># register this species with the element</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>Each model, can have one or more species.  This class sets species
specific properties</p>

<pre><code>  Example::

        Species(name = "SO4",
                element = S,
</code></pre>

<p>)</p>
</div>


                            <div id="Species.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Species.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">Species</span><span class="signature">(**kwargs)</span>
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Initialize all instance variables</span>
<span class="sd">            &quot;&quot;&quot;</span>

        <span class="c1"># provide a list of all known keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;element&quot;</span><span class="p">:</span> <span class="n">Element</span><span class="p">,</span>
            <span class="s1">&#39;display_as&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;m_weight&#39;</span><span class="p">:</span> <span class="n">Number</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;element&quot;</span><span class="p">]</span>

        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;display_as&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="s1">&#39;m_weight&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;display_as&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># legacy names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># display name of species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">mu</span>  <span class="c1"># display name of mass unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ln</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">ln</span>  <span class="c1"># display name of light isotope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">hn</span>  <span class="c1"># display name of heavy isotope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">dn</span>  <span class="c1"># display string for delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">ds</span>  <span class="c1"># display string for delta scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span>  <span class="c1"># ratio of isotope standard</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">n</span>  <span class="c1"># element name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span>  <span class="c1"># element handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dsa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span>  <span class="c1"># the display string.</span>

        <span class="c1">#self.mo.lsp.append(self)   # register self on the list of model objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">lsp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># register this species with the element</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>Initialize all instance variables</p>
</div>


                            </div>
                            <div id="Species.lkk" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Species.lkk">#&nbsp;&nbsp</a>

        <span class="name">lkk</span><span class="annotation">: Dict[&lt;built-in function any&gt;, &lt;built-in function any&gt;]</span>
    </div>

    

                            </div>
                            <div id="Species.r" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Species.r">#&nbsp;&nbsp</a>

        <span class="name">r</span><span class="default_value"> = &lt;member &#39;r&#39; of &#39;Species&#39; objects&gt;</span>
    </div>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#esbmtkBase">esbmtkBase</a></dt>
                                <dd id="Species.info" class="function"><a href="#esbmtkBase.info">info</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Reservoir">
                                <div class="attr class">
        <a class="headerlink" href="#Reservoir">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Reservoir</span>(<span class="base"><a href="#esbmtkBase">esbmtkBase</a></span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Reservoir</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This object holds reservoir specific information.</span>

<span class="sd">          Example::</span>

<span class="sd">                  Reservoir(name = &quot;foo&quot;,      # Name of reservoir</span>
<span class="sd">                            species = S,          # Species handle</span>
<span class="sd">                            delta = 20,           # initial delta - optional (defaults  to 0)</span>
<span class="sd">                            mass/concentration = &quot;1 unit&quot;  # species concentration or mass</span>
<span class="sd">                            volume/geometry = &quot;1E5 l&quot;,      # reservoir volume (m^3)</span>
<span class="sd">                            plot = &quot;yes&quot;/&quot;no&quot;, defaults to yes</span>
<span class="sd">                            plot_transform_c = a function reference, optional (see below)</span>
<span class="sd">                            legend_left = str, optional, useful for plot transform</span>
<span class="sd">                            display_precision = number, optional, inherited from Model</span>
<span class="sd">                            register = optional, use to register with Reservoir Group</span>
<span class="sd">                            isotopes = True/False otherwise use Model.m_type</span>
<span class="sd">                            )</span>

<span class="sd">          You must either give mass or concentration.  The result will always be displayed</span>
<span class="sd">          as concentration though.</span>

<span class="sd">          You must provide either the volume or the geometry keyword. In the latter case</span>
<span class="sd">          provide a list where the first entry is the upper depth datum, the second entry is</span>
<span class="sd">          the lower depth datum, and the third entry is the area percentage. E.g., to specify</span>
<span class="sd">          the upper 200 meters of the entire ocean, you would write:</span>

<span class="sd">                 geometry=[0,-200,1]</span>

<span class="sd">          the corresponding ocean volume will then be calculated by the calc_volume method</span>
<span class="sd">          in this case the following instance variables will also be set:</span>

<span class="sd">                 self.volume in model units (usually liter)</span>
<span class="sd">                 self.are:a surface area in m^2 at the upper bounding surface</span>
<span class="sd">                 self.area_dz: area of seafloor which is intercepted by this box.</span>
<span class="sd">                 self.area_fraction: area of seafloor which is intercepted by this</span>
<span class="sd">                                    relative to the total ocean floor area</span>

<span class="sd">          Using a transform function</span>
<span class="sd">          ~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">          In some cases, it is useful to transform the reservoir</span>
<span class="sd">          concentration data before plotting it.  A good example is the H+</span>
<span class="sd">          concentration in water which is better displayed as pH.  We can</span>
<span class="sd">          do this by specifying a function to convert the reservoir</span>
<span class="sd">          concentration into pH units::</span>

<span class="sd">              def phc(c :float) -&gt; float:</span>
<span class="sd">                  # Calculate concentration as pH. c can be a number or numpy array</span>

<span class="sd">                  import numpy as np</span>

<span class="sd">                  pH :float = -np.log10(c)</span>
<span class="sd">                  return pH</span>

<span class="sd">          this function can then be added to a reservoir as::</span>

<span class="sd">          hplus.plot_transform_c = phc</span>

<span class="sd">          You can modify the left legend to suit the transform via the legend_left keyword</span>

<span class="sd">          Note, at present the plot_transform_c function will only take one</span>
<span class="sd">          argument, which always defaults to the reservoir</span>
<span class="sd">          concentration. The function must return a single argument which</span>
<span class="sd">          will be interpreted as the transformed reservoir concentration.</span>

<span class="sd">    Accesing Reservoir Data:</span>
<span class="sd">    ~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">    You can access the reservoir data as:</span>

<span class="sd">    - Name.m # mass</span>
<span class="sd">    - Name.d # delta</span>
<span class="sd">    - Name.c # concentration</span>

<span class="sd">    Useful methods include:</span>

<span class="sd">    - Name.write_data() # save data to file</span>
<span class="sd">    - Name.info()   # info Reservoir</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;lio&quot;</span><span class="p">,</span> <span class="s2">&quot;rvalue&quot;</span><span class="p">,</span> <span class="s2">&quot;lodir&quot;</span><span class="p">,</span> <span class="s2">&quot;lof&quot;</span><span class="p">,</span> <span class="s2">&quot;lpc&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize a reservoir.&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="n">Species</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Number</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">),</span>
            <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">),</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">),</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;plot_transform_c&quot;</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span>
            <span class="s2">&quot;legend_left&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;groupname&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="s2">&quot;a1&quot;</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span>
            <span class="s2">&quot;a2&quot;</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span>
            <span class="s2">&quot;a3&quot;</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span>
            <span class="s2">&quot;a4&quot;</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span>
            <span class="s2">&quot;a5&quot;</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span>
            <span class="s2">&quot;a6&quot;</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">,</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="s2">&quot;concentration&quot;</span><span class="p">],</span>
        <span class="p">]</span>

        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;plot_transform_c&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;legend_left&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;groupname&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Not Set&quot;</span><span class="p">,</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;a1&quot;</span><span class="p">:</span> <span class="n">numba</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">empty_list</span><span class="p">(</span><span class="n">nbt</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
            <span class="s2">&quot;a2&quot;</span><span class="p">:</span> <span class="n">numba</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">empty_list</span><span class="p">(</span><span class="n">nbt</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
            <span class="s2">&quot;a3&quot;</span><span class="p">:</span> <span class="n">numba</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">empty_list</span><span class="p">(</span><span class="n">nbt</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># validate and initialize instance variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bem</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="s2">&quot;a  string or quantity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="s2">&quot;a string or quantity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="s2">&quot;a string or quantity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;yes or no&quot;</span><span class="p">,</span>
                <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="s2">&quot;Group Object&quot;</span><span class="p">,</span>
                <span class="s2">&quot;legend_left&quot;</span><span class="p">:</span> <span class="s2">&quot;A string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="s2">&quot;A function&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># legacy names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># name of reservoir</span>
        <span class="c1"># if &quot;register&quot; in self.kwargs:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groupname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span>
        <span class="c1"># else:</span>
        <span class="c1">#   self.pt = self.name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">:</span> <span class="n">Species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>  <span class="c1"># species handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span>

        <span class="c1"># decide whether we use isotopes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_type</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_type</span> <span class="o">==</span> <span class="s2">&quot;mass_only&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">get_box_geometry_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            
        <span class="c1"># convert units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span> <span class="n">Number</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">v_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>  <span class="c1"># reservoir volume</span>
        <span class="c1"># This should probably be species specific?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">mass_unit</span>  <span class="c1"># massunit xxxx</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">units</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">:</span> <span class="n">Number</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">:</span> <span class="n">Number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>  <span class="c1"># caculate mass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span> <span class="o">=</span> <span class="s2">&quot;concentration&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_unit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">:</span> <span class="n">Number</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span> <span class="o">=</span> <span class="s2">&quot;mass&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You need to specify mass or concentration&quot;</span><span class="p">)</span>

        <span class="c1"># save the unit which was provided by the user for display purposes</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Flux</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># flux references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ExternalData</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># all external data references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lio</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># flux name:direction pairs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Process</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list holding all processe references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loe</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Element</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of elements in thiis reservoir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doe</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Species</span><span class="p">,</span> <span class="n">Flux</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># species flux pairs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># set of connection objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ldf</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">DataField</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of datafield objects</span>
        <span class="c1"># list of processes which calculate reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpc</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Process</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># initialize mass vector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># initialize concentration vector</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span>
            <span class="c1"># isotope mass</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_imass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
            <span class="c1"># delta of reservoir</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">get_delta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

        <span class="c1"># left y-axis label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">/l]&quot;</span>
        <span class="c1"># right y-axis label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ld</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">ds</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xl</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">xl</span>  <span class="c1"># set x-axis lable to model time</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dsa</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># leave as is</span>
            <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">ds</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># add this reservoir to the model</span>
        <span class="c1"># register instance name in global name space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>

        <span class="c1"># decide which setitem functions to use</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_with_isotopes__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_without_isotopes__</span>

        <span class="c1"># any auxilliary init - normally empty, but we use it here to extend the</span>
        <span class="c1"># reservoir class in virtual reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__aux_inits__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># setup a placeholder setitem function</span>
    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># what to do when called as a function ()</span>
        <span class="k">pass</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get flux data by index&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>

    <span class="k">def</span> <span class="nf">__set_with_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;write data by index&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="c1"># update concentration and delta next. This is computationally inefficient</span>
        <span class="c1"># but the next time step may depend on on both variables.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">get_delta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span>  <span class="c1"># update concentration</span>

    <span class="k">def</span> <span class="nf">__set_without_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;write data by index&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span>  <span class="c1"># update concentration</span>

    <span class="k">def</span> <span class="nf">__write_data__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stride</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;To be called by write_data and save_state&quot;&quot;&quot;</span>

        <span class="c1"># some short hands</span>
        <span class="n">sn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">n</span>  <span class="c1"># species name</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span>  <span class="c1"># species handle</span>
        <span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model handle</span>

        <span class="n">smu</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mo</span><span class="o">.</span><span class="n">m_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">mtu</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">fmu</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">cmu</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">sdn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">dn</span>  <span class="c1"># delta name</span>
        <span class="n">sds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">ds</span>  <span class="c1"># delta scale</span>
        <span class="n">rn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span>  <span class="c1"># reservoir name</span>
        <span class="n">mn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">n</span>  <span class="c1"># model name</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">mn</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2">.csv&quot;</span>  <span class="c1"># file name</span>

        <span class="c1"># build the dataframe</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>

        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2"> Time [</span><span class="si">{</span><span class="n">mtu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># time</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">smu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># mass</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sp</span><span class="o">.</span><span class="n">ln</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">smu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># light isotope</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sp</span><span class="o">.</span><span class="n">hn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">smu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># heavy isotope</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sdn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">sds</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># delta value</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">cmu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># concentration</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>  <span class="c1"># Assemble the headers and data for the reservoir fluxes</span>
            <span class="c1"># mass</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">fmu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>
            <span class="c1"># light isotope</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">sp</span><span class="o">.</span><span class="n">ln</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>
            <span class="c1"># heavy isotope</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">sp</span><span class="o">.</span><span class="n">hn</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>
            <span class="c1"># delta value</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sdn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">sds</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>

        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Write dataframe to file</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">__read_state__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;read data from csv-file into a dataframe</span>

<span class="sd">        The CSV file must have the following columns</span>

<span class="sd">        Model Time     t</span>
<span class="sd">        Reservoir_Name m</span>
<span class="sd">        Reservoir_Name l</span>
<span class="sd">        Reservoir_Name h</span>
<span class="sd">        Reservoir_Name d</span>
<span class="sd">        Reservoir_Name c</span>
<span class="sd">        Flux_name m</span>
<span class="sd">        Flux_name l etc etc.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.utility_functions</span> <span class="kn">import</span> <span class="n">is_name_in_list</span><span class="p">,</span> <span class="n">get_object_from_list</span>

        <span class="n">read</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">curr</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;state_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">.csv&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;reading state for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Flux </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2"> does not exist in Reservoir </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># get a set of all current fluxes</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
            <span class="n">curr</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Adding Flux </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> to list of fluxes to read&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span>

        <span class="c1"># the headers contain the object name for each data in the</span>
        <span class="c1"># reservoir or flux thus, we must reduce the list to unique</span>
        <span class="c1"># object names first. Note, we must preserve order</span>
        <span class="n">header_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header_list</span><span class="p">:</span>
                <span class="n">header_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="c1"># loop over all columns</span>
        <span class="n">col</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># we ignore the time column</span>
        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">header_list</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Looking for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># this finds the reservoir name</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;found reservoir data for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__assign__data__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="c1"># this loops over all fluxes in a reservoir</span>
            <span class="k">elif</span> <span class="n">is_name_in_list</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> is in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">.lof&quot;</span><span class="p">)</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">get_object_from_list</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;found object </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> adding flux data for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">read</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>
                <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__assign__data__</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to find Flux </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># test if we missed any fluxes</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">curr</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">read</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Warning: Did not find values for </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="se">\n</span><span class="s2"> in saved state&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__assign__data__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">res</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign the third last entry data to all values in flux or reservoir</span>

<span class="sd">        parameters: df = dataframe</span>
<span class="sd">                    col = column number</span>
<span class="sd">                    res = true if reservoir</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ovars</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">]</span>

        <span class="n">obj</span><span class="o">.</span><span class="n">m</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">l</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">h</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">d</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">4</span>

        <span class="k">if</span> <span class="n">res</span><span class="p">:</span>  <span class="c1"># if type is reservoir</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">c</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">col</span>

    <span class="k">def</span> <span class="nf">__plot__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot data from reservoirs and fluxes into a multiplot window&quot;&quot;&quot;</span>

        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span>
        <span class="n">species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="c1"># time = model.time + model.offset  # get the model time</span>
        <span class="c1"># xl = f&quot;Time [{model.bu}]&quot;</span>

        <span class="n">size</span><span class="p">,</span> <span class="n">geo</span> <span class="o">=</span> <span class="n">get_plot_layout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># adjust layout</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">.pdf&quot;</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># counter for the figure number</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">plot_style</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>  <span class="c1"># Initialize a plot window</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reservoir Name: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="c1"># plot reservoir data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
            <span class="n">plot_object_data</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

            <span class="c1"># plot the fluxes assoiated with this reservoir</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">):</span>  <span class="c1"># plot flux data</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">plot</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">plot_object_data</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ldf</span><span class="p">):</span>  <span class="c1"># plot data fields</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">plot_object_data</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">geo</span> <span class="o">!=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupname</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">, Reservoir: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># filename = f&quot;{self.groupname}_{self.n}.pdf&quot;</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Group: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">groupname</span><span class="si">}</span><span class="s2">, Reservoir: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span>
                    <span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.88</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving as </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__plot_reservoirs__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot only the  reservoirs data, and ignore the fluxes&quot;&quot;&quot;</span>

        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span>
        <span class="n">species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">time</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">offset</span>  <span class="c1"># get the model time</span>
        <span class="n">xl</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Time [</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">bu</span><span class="si">}</span><span class="s2">]&quot;</span>

        <span class="n">size</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">geo</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">.pdf&quot;</span>
        <span class="n">fn</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># counter for the figure number</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">plot_style</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>  <span class="c1"># Initialize a plot window</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="c1"># plt.legend()ot reservoir data</span>
        <span class="n">plot_object_data</span><span class="p">(</span><span class="n">geo</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="c1"># fig.subplots_adjust(top=0.88)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show an overview of the object properties.</span>
<span class="sd">        Optional arguments are</span>
<span class="sd">        index  :int = 0 this will show data at the given index</span>
<span class="sd">        indent :int = 0 indentation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">off</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>
        <span class="k">if</span> <span class="s2">&quot;index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>

        <span class="c1"># print basic data bout this reservoir</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Data sample:&quot;</span><span class="p">)</span>
        <span class="n">show_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Connnections:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}{</span><span class="n">ind</span><span class="si">}{</span><span class="n">p</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Use the info method on any of the above connections&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;to see information on fluxes and processes&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>This object holds reservoir specific information.</p>

<pre><code>  Example::

          Reservoir(name = "foo",      # Name of reservoir
                    species = S,          # Species handle
                    delta = 20,           # initial delta - optional (defaults  to 0)
                    mass/concentration = "1 unit"  # species concentration or mass
                    volume/geometry = "1E5 l",      # reservoir volume (m^3)
                    plot = "yes"/"no", defaults to yes
                    plot_transform_c = a function reference, optional (see below)
                    legend_left = str, optional, useful for plot transform
                    display_precision = number, optional, inherited from Model
                    register = optional, use to register with Reservoir Group
                    isotopes = True/False otherwise use Model.m_type
                    )

  You must either give mass or concentration.  The result will always be displayed
  as concentration though.

  You must provide either the volume or the geometry keyword. In the latter case
  provide a list where the first entry is the upper depth datum, the second entry is
  the lower depth datum, and the third entry is the area percentage. E.g., to specify
  the upper 200 meters of the entire ocean, you would write:

         geometry=[0,-200,1]

  the corresponding ocean volume will then be calculated by the calc_volume method
  in this case the following instance variables will also be set:

         self.volume in model units (usually liter)
         self.are:a surface area in m^2 at the upper bounding surface
         self.area_dz: area of seafloor which is intercepted by this box.
         self.area_fraction: area of seafloor which is intercepted by this
                            relative to the total ocean floor area

  Using a transform function
  ~~~~~~~~~~~~~~~~~~~~~~~~~~

  In some cases, it is useful to transform the reservoir
  concentration data before plotting it.  A good example is the H+
  concentration in water which is better displayed as pH.  We can
  do this by specifying a function to convert the reservoir
  concentration into pH units::

      def phc(c :float) -&gt; float:
          # Calculate concentration as pH. c can be a number or numpy array

          import numpy as np

          pH :float = -np.log10(c)
          return pH

  this function can then be added to a reservoir as::

  hplus.plot_transform_c = phc

  You can modify the left legend to suit the transform via the legend_left keyword

  Note, at present the plot_transform_c function will only take one
  argument, which always defaults to the reservoir
  concentration. The function must return a single argument which
  will be interpreted as the transformed reservoir concentration.
</code></pre>

<p>Accesing Reservoir Data:
<strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike>~~~~</p>

<p>You can access the reservoir data as:</p>

<ul>
<li>Name.m # mass</li>
<li>Name.d # delta</li>
<li>Name.c # concentration</li>
</ul>

<p>Useful methods include:</p>

<ul>
<li>Name.write_data() # save data to file</li>
<li>Name.info()   # info Reservoir</li>
</ul>
</div>


                            <div id="Reservoir.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Reservoir.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">Reservoir</span><span class="signature">(**kwargs)</span>
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize a reservoir.&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="n">Species</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Number</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">),</span>
            <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">),</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">),</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;plot_transform_c&quot;</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span>
            <span class="s2">&quot;legend_left&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;groupname&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="s2">&quot;a1&quot;</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span>
            <span class="s2">&quot;a2&quot;</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span>
            <span class="s2">&quot;a3&quot;</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span>
            <span class="s2">&quot;a4&quot;</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span>
            <span class="s2">&quot;a5&quot;</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span>
            <span class="s2">&quot;a6&quot;</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">,</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="s2">&quot;concentration&quot;</span><span class="p">],</span>
        <span class="p">]</span>

        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;plot_transform_c&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;legend_left&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;groupname&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Not Set&quot;</span><span class="p">,</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;a1&quot;</span><span class="p">:</span> <span class="n">numba</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">empty_list</span><span class="p">(</span><span class="n">nbt</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
            <span class="s2">&quot;a2&quot;</span><span class="p">:</span> <span class="n">numba</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">empty_list</span><span class="p">(</span><span class="n">nbt</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
            <span class="s2">&quot;a3&quot;</span><span class="p">:</span> <span class="n">numba</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">empty_list</span><span class="p">(</span><span class="n">nbt</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># validate and initialize instance variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bem</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="s2">&quot;a  string or quantity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="s2">&quot;a string or quantity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="s2">&quot;a string or quantity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;yes or no&quot;</span><span class="p">,</span>
                <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="s2">&quot;Group Object&quot;</span><span class="p">,</span>
                <span class="s2">&quot;legend_left&quot;</span><span class="p">:</span> <span class="s2">&quot;A string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="s2">&quot;A function&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># legacy names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># name of reservoir</span>
        <span class="c1"># if &quot;register&quot; in self.kwargs:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groupname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span>
        <span class="c1"># else:</span>
        <span class="c1">#   self.pt = self.name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">:</span> <span class="n">Species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>  <span class="c1"># species handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span>

        <span class="c1"># decide whether we use isotopes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_type</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_type</span> <span class="o">==</span> <span class="s2">&quot;mass_only&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">get_box_geometry_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            
        <span class="c1"># convert units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span> <span class="n">Number</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">v_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>  <span class="c1"># reservoir volume</span>
        <span class="c1"># This should probably be species specific?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">mass_unit</span>  <span class="c1"># massunit xxxx</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">units</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">:</span> <span class="n">Number</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">:</span> <span class="n">Number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>  <span class="c1"># caculate mass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span> <span class="o">=</span> <span class="s2">&quot;concentration&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_unit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">:</span> <span class="n">Number</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span> <span class="o">=</span> <span class="s2">&quot;mass&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You need to specify mass or concentration&quot;</span><span class="p">)</span>

        <span class="c1"># save the unit which was provided by the user for display purposes</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Flux</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># flux references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ExternalData</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># all external data references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lio</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># flux name:direction pairs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Process</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list holding all processe references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loe</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Element</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of elements in thiis reservoir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doe</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Species</span><span class="p">,</span> <span class="n">Flux</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># species flux pairs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># set of connection objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ldf</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">DataField</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of datafield objects</span>
        <span class="c1"># list of processes which calculate reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpc</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Process</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># initialize mass vector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># initialize concentration vector</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span>
            <span class="c1"># isotope mass</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_imass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
            <span class="c1"># delta of reservoir</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">get_delta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

        <span class="c1"># left y-axis label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">/l]&quot;</span>
        <span class="c1"># right y-axis label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ld</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">ds</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xl</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">xl</span>  <span class="c1"># set x-axis lable to model time</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dsa</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># leave as is</span>
            <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">ds</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># add this reservoir to the model</span>
        <span class="c1"># register instance name in global name space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>

        <span class="c1"># decide which setitem functions to use</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_with_isotopes__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_without_isotopes__</span>

        <span class="c1"># any auxilliary init - normally empty, but we use it here to extend the</span>
        <span class="c1"># reservoir class in virtual reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__aux_inits__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>

        </details>

            <div class="docstring"><p>Initialize a reservoir.</p>
</div>


                            </div>
                            <div id="Reservoir.lkk" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.lkk">#&nbsp;&nbsp</a>

        <span class="name">lkk</span><span class="annotation">: Dict[str, &lt;built-in function any&gt;]</span>
    </div>

    

                            </div>
                            <div id="Reservoir.lrk" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.lrk">#&nbsp;&nbsp</a>

        <span class="name">lrk</span><span class="annotation">: list</span>
    </div>

    

                            </div>
                            <div id="Reservoir.lod" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.lod">#&nbsp;&nbsp</a>

        <span class="name">lod</span><span class="annotation">: Dict[&lt;built-in function any&gt;, &lt;built-in function any&gt;]</span>
    </div>

    

                            </div>
                            <div id="Reservoir.n" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.n">#&nbsp;&nbsp</a>

        <span class="name">n</span><span class="annotation">: str</span>
    </div>

    

                            </div>
                            <div id="Reservoir.sp" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.sp">#&nbsp;&nbsp</a>

        <span class="name">sp</span><span class="annotation">: <a href="#Species">esbmtk.esbmtk.Species</a></span>
    </div>

    

                            </div>
                            <div id="Reservoir.mo" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.mo">#&nbsp;&nbsp</a>

        <span class="name">mo</span><span class="annotation">: <a href="#Model">esbmtk.esbmtk.Model</a></span>
    </div>

    

                            </div>
                            <div id="Reservoir.rvalue" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.rvalue">#&nbsp;&nbsp</a>

        <span class="name">rvalue</span><span class="default_value"> = &lt;member &#39;rvalue&#39; of &#39;Reservoir&#39; objects&gt;</span>
    </div>

    

                            </div>
                            <div id="Reservoir.volume" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.volume">#&nbsp;&nbsp</a>

        <span class="name">volume</span><span class="annotation">: nptyping.types._number.Number</span>
    </div>

    

                            </div>
                            <div id="Reservoir.v" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.v">#&nbsp;&nbsp</a>

        <span class="name">v</span><span class="annotation">: float</span>
    </div>

    

                            </div>
                            <div id="Reservoir.mu" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.mu">#&nbsp;&nbsp</a>

        <span class="name">mu</span><span class="annotation">: str</span>
    </div>

    

                            </div>
                            <div id="Reservoir.lof" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.lof">#&nbsp;&nbsp</a>

        <span class="name">lof</span><span class="annotation">: &#39;list[Flux]&#39;</span><span class="default_value"> = &lt;member &#39;lof&#39; of &#39;Reservoir&#39; objects&gt;</span>
    </div>

    

                            </div>
                            <div id="Reservoir.led" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.led">#&nbsp;&nbsp</a>

        <span class="name">led</span><span class="annotation">: &#39;list[ExternalData]&#39;</span>
    </div>

    

                            </div>
                            <div id="Reservoir.lio" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.lio">#&nbsp;&nbsp</a>

        <span class="name">lio</span><span class="annotation">: &#39;dict[(str, int)]&#39;</span><span class="default_value"> = &lt;member &#39;lio&#39; of &#39;Reservoir&#39; objects&gt;</span>
    </div>

    

                            </div>
                            <div id="Reservoir.lop" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.lop">#&nbsp;&nbsp</a>

        <span class="name">lop</span><span class="annotation">: &#39;list[Process]&#39;</span>
    </div>

    

                            </div>
                            <div id="Reservoir.loe" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.loe">#&nbsp;&nbsp</a>

        <span class="name">loe</span><span class="annotation">: &#39;list[Element]&#39;</span>
    </div>

    

                            </div>
                            <div id="Reservoir.doe" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.doe">#&nbsp;&nbsp</a>

        <span class="name">doe</span><span class="annotation">: Dict[<a href="#Species">esbmtk.esbmtk.Species</a>, <a href="#Flux">esbmtk.esbmtk.Flux</a>]</span>
    </div>

    

                            </div>
                            <div id="Reservoir.loc" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.loc">#&nbsp;&nbsp</a>

        <span class="name">loc</span><span class="annotation">: &#39;set[Connection]&#39;</span>
    </div>

    

                            </div>
                            <div id="Reservoir.ldf" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.ldf">#&nbsp;&nbsp</a>

        <span class="name">ldf</span><span class="annotation">: &#39;list[DataField]&#39;</span>
    </div>

    

                            </div>
                            <div id="Reservoir.lpc" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.lpc">#&nbsp;&nbsp</a>

        <span class="name">lpc</span><span class="annotation">: &#39;list[Process]&#39;</span><span class="default_value"> = &lt;member &#39;lpc&#39; of &#39;Reservoir&#39; objects&gt;</span>
    </div>

    

                            </div>
                            <div id="Reservoir.m" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.m">#&nbsp;&nbsp</a>

        <span class="name">m</span><span class="annotation">: &#39;[NDArray, Float[64]]&#39;</span><span class="default_value"> = &lt;member &#39;m&#39; of &#39;Reservoir&#39; objects&gt;</span>
    </div>

    

                            </div>
                            <div id="Reservoir.l" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.l">#&nbsp;&nbsp</a>

        <span class="name">l</span><span class="annotation">: &#39;[NDArray, Float[64]]&#39;</span><span class="default_value"> = &lt;member &#39;l&#39; of &#39;Reservoir&#39; objects&gt;</span>
    </div>

    

                            </div>
                            <div id="Reservoir.h" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.h">#&nbsp;&nbsp</a>

        <span class="name">h</span><span class="annotation">: &#39;[NDArray, Float[64]]&#39;</span><span class="default_value"> = &lt;member &#39;h&#39; of &#39;Reservoir&#39; objects&gt;</span>
    </div>

    

                            </div>
                            <div id="Reservoir.lm" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.lm">#&nbsp;&nbsp</a>

        <span class="name">lm</span><span class="annotation">: str</span>
    </div>

    

                            </div>
                            <div id="Reservoir.ld" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.ld">#&nbsp;&nbsp</a>

        <span class="name">ld</span><span class="annotation">: str</span>
    </div>

    

                            </div>
                            <div id="Reservoir.xl" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.xl">#&nbsp;&nbsp</a>

        <span class="name">xl</span><span class="annotation">: str</span>
    </div>

    

                            </div>
                            <div id="Reservoir.info" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Reservoir.info">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">info</span><span class="signature">(self, **kwargs) -&gt; None</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show an overview of the object properties.</span>
<span class="sd">        Optional arguments are</span>
<span class="sd">        index  :int = 0 this will show data at the given index</span>
<span class="sd">        indent :int = 0 indentation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">off</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>
        <span class="k">if</span> <span class="s2">&quot;index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>

        <span class="c1"># print basic data bout this reservoir</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Data sample:&quot;</span><span class="p">)</span>
        <span class="n">show_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Connnections:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}{</span><span class="n">ind</span><span class="si">}{</span><span class="n">p</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Use the info method on any of the above connections&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;to see information on fluxes and processes&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Show an overview of the object properties.
Optional arguments are
index  :int = 0 this will show data at the given index
indent :int = 0 indentation</p>
</div>


                            </div>
                            <div id="Reservoir.c" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.c">#&nbsp;&nbsp</a>

        <span class="name">c</span><span class="default_value"> = &lt;member &#39;c&#39; of &#39;Reservoir&#39; objects&gt;</span>
    </div>

    

                            </div>
                            <div id="Reservoir.d" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.d">#&nbsp;&nbsp</a>

        <span class="name">d</span><span class="default_value"> = &lt;member &#39;d&#39; of &#39;Reservoir&#39; objects&gt;</span>
    </div>

    

                            </div>
                            <div id="Reservoir.lodir" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.lodir">#&nbsp;&nbsp</a>

        <span class="name">lodir</span><span class="default_value"> = &lt;member &#39;lodir&#39; of &#39;Reservoir&#39; objects&gt;</span>
    </div>

    

                            </div>
                </section>
                <section id="ReservoirGroup">
                                <div class="attr class">
        <a class="headerlink" href="#ReservoirGroup">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">ReservoirGroup</span>(<span class="base"><a href="#esbmtkBase">esbmtkBase</a></span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">ReservoirGroup</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class allows the creation of a group of reservoirs which share</span>
<span class="sd">    a common volume, and potentially connections. E.g., if we have two</span>
<span class="sd">    reservoir groups with the same reservoirs, and we connect them</span>
<span class="sd">    with a flux, this flux will apply to all reservoirs in this group.</span>

<span class="sd">    A typical examples might be ocean water which comprises several</span>
<span class="sd">    species.  A reservoir group like ShallowOcean will then contain</span>
<span class="sd">    sub-reservoirs like DIC in the form of ShallowOcean.DIC</span>

<span class="sd">    Example::</span>

<span class="sd">        ReservoirGroup(name = &quot;ShallowOcean&quot;,         # Name of reservoir group</span>
<span class="sd">                    volume/geometry = &quot;1E5 l&quot;,                # reservoir volume (m^3)</span>
<span class="sd">                    delta   = {DIC:0, ALK:0, PO4:0]  # dict of delta values</span>
<span class="sd">                    mass/concentration = {DIC:&quot;1 unit&quot;, ALK: &quot;1 unit&quot;}</span>
<span class="sd">                    plot = {DIC:&quot;yes&quot;, ALK:&quot;yes&quot;}  defaults to yes</span>
<span class="sd">                    isotopes = {DIC: True/False} see Reservoir class for details</span>
<span class="sd">               )</span>

<span class="sd">    Notes: - The subreservoirs are derived from the keys in the concentration or mass</span>
<span class="sd">             dictionary. Toward this end, the keys must be valid species handles and</span>
<span class="sd">             -- not species names -- !</span>

<span class="sd">    Connecting two reservoir groups requires that the names in both</span>
<span class="sd">    group match, or that you specify a dictionary which delineates the</span>
<span class="sd">    matching.</span>

<span class="sd">    Most parameters are passed on to the Reservoir class. See the reservoir class</span>
<span class="sd">    documentation for details</span>

<span class="sd">    If the geometry parameter is supplied, the following instance variables will be</span>
<span class="sd">    computed</span>

<span class="sd">                 self.volume: in model units (usually liter)</span>
<span class="sd">                 self.are:a surface area in m^2 at the upper bounding surface</span>
<span class="sd">                 self.area_dz: area of seafloor which is intercepted by this box.</span>
<span class="sd">                 self.area_fraction: area of seafloor which is intercepted by this</span>
<span class="sd">                                    relative to the total ocean floor area</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize a new reservoir group&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>
        <span class="kn">from</span> <span class="nn">.sealevel</span> <span class="kn">import</span> <span class="n">get_box_geometry_parameters</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">),</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">],</span>
        <span class="p">]</span>

        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="s2">&quot;concentration&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;concentration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">elif</span> <span class="s2">&quot;mass&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must provide either mass or concentration&quot;</span><span class="p">)</span>

        <span class="c1"># validate and initialize instance variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bem</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="s2">&quot;a  string or quantity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="s2">&quot;a string or quantity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="s2">&quot;a string or quantity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;yes or no&quot;</span><span class="p">,</span>
                <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="s2">&quot;dict Species: True/False&quot;</span><span class="p">,</span>
                <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="s2">&quot;list&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># legacy variable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span>

        <span class="c1"># geoemtry information</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">volume</span><span class="si">}</span><span class="s2"> m**3&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">v_unit</span><span class="p">)</span>
            
        <span class="n">get_box_geometry_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># register this group object in the global namespace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>

        <span class="c1"># dict with all default values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span>
                <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># now we loop trough all keys for this reservoir and see</span>
            <span class="c1"># if we find a corresponding item in the kwargs</span>
            <span class="k">for</span> <span class="n">kcd</span><span class="p">,</span> <span class="n">vcd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># kcd  = delta, plot, etc</span>
                <span class="k">if</span> <span class="n">kcd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>  <span class="c1"># found entry delta</span>
                    <span class="c1"># test if delta relates to any species</span>
                    <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="n">kcd</span><span class="p">]:</span>  <span class="c1"># {SO4: xxx}</span>
                        <span class="c1"># update the entry with the value provided in kwargs</span>
                        <span class="c1"># self.cd[&#39;SO4_name&#39;][&#39;delta&#39;] = self.kwargs[&#39;delta&#39;][SO4]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">kcd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="n">kcd</span><span class="p">][</span><span class="n">s</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of reservoirs in this group.</span>
        <span class="c1"># loop over all entries in species and create the respective reservoirs</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Species</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> needs to be a valid species name&quot;</span><span class="p">)</span>

            <span class="c1"># create reservoir without registering it in the global name space</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">Reservoir</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">species</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                <span class="n">delta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;delta&quot;</span><span class="p">],</span>
                <span class="n">mass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;mass&quot;</span><span class="p">],</span>
                <span class="n">concentration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;concentration&quot;</span><span class="p">],</span>
                <span class="n">volume</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="p">,</span>
                <span class="n">geometry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span>
                <span class="n">plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;plot&quot;</span><span class="p">],</span>
                <span class="n">groupname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">isotopes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;isotopes&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="c1"># register as part of this group</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>This class allows the creation of a group of reservoirs which share
a common volume, and potentially connections. E.g., if we have two
reservoir groups with the same reservoirs, and we connect them
with a flux, this flux will apply to all reservoirs in this group.</p>

<p>A typical examples might be ocean water which comprises several
species.  A reservoir group like ShallowOcean will then contain
sub-reservoirs like DIC in the form of ShallowOcean.DIC</p>

<p>Example::</p>

<pre><code>ReservoirGroup(name = "ShallowOcean",         # Name of reservoir group
            volume/geometry = "1E5 l",                # reservoir volume (m^3)
            delta   = {DIC:0, ALK:0, PO4:0]  # dict of delta values
            mass/concentration = {DIC:"1 unit", ALK: "1 unit"}
            plot = {DIC:"yes", ALK:"yes"}  defaults to yes
            isotopes = {DIC: True/False} see Reservoir class for details
       )
</code></pre>

<p>Notes: - The subreservoirs are derived from the keys in the concentration or mass
         dictionary. Toward this end, the keys must be valid species handles and
         -- not species names -- !</p>

<p>Connecting two reservoir groups requires that the names in both
group match, or that you specify a dictionary which delineates the
matching.</p>

<p>Most parameters are passed on to the Reservoir class. See the reservoir class
documentation for details</p>

<p>If the geometry parameter is supplied, the following instance variables will be
computed</p>

<pre><code>         self.volume: in model units (usually liter)
         self.are:a surface area in m^2 at the upper bounding surface
         self.area_dz: area of seafloor which is intercepted by this box.
         self.area_fraction: area of seafloor which is intercepted by this
                            relative to the total ocean floor area
</code></pre>
</div>


                            <div id="ReservoirGroup.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ReservoirGroup.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">ReservoirGroup</span><span class="signature">(**kwargs)</span>
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize a new reservoir group&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>
        <span class="kn">from</span> <span class="nn">.sealevel</span> <span class="kn">import</span> <span class="n">get_box_geometry_parameters</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">),</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">],</span>
        <span class="p">]</span>

        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="s2">&quot;concentration&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;concentration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">elif</span> <span class="s2">&quot;mass&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must provide either mass or concentration&quot;</span><span class="p">)</span>

        <span class="c1"># validate and initialize instance variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bem</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="s2">&quot;a  string or quantity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="s2">&quot;a string or quantity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="s2">&quot;a string or quantity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;yes or no&quot;</span><span class="p">,</span>
                <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="s2">&quot;dict Species: True/False&quot;</span><span class="p">,</span>
                <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="s2">&quot;list&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># legacy variable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span>

        <span class="c1"># geoemtry information</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">volume</span><span class="si">}</span><span class="s2"> m**3&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">v_unit</span><span class="p">)</span>
            
        <span class="n">get_box_geometry_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># register this group object in the global namespace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>

        <span class="c1"># dict with all default values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span>
                <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># now we loop trough all keys for this reservoir and see</span>
            <span class="c1"># if we find a corresponding item in the kwargs</span>
            <span class="k">for</span> <span class="n">kcd</span><span class="p">,</span> <span class="n">vcd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># kcd  = delta, plot, etc</span>
                <span class="k">if</span> <span class="n">kcd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>  <span class="c1"># found entry delta</span>
                    <span class="c1"># test if delta relates to any species</span>
                    <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="n">kcd</span><span class="p">]:</span>  <span class="c1"># {SO4: xxx}</span>
                        <span class="c1"># update the entry with the value provided in kwargs</span>
                        <span class="c1"># self.cd[&#39;SO4_name&#39;][&#39;delta&#39;] = self.kwargs[&#39;delta&#39;][SO4]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">kcd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="n">kcd</span><span class="p">][</span><span class="n">s</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of reservoirs in this group.</span>
        <span class="c1"># loop over all entries in species and create the respective reservoirs</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Species</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> needs to be a valid species name&quot;</span><span class="p">)</span>

            <span class="c1"># create reservoir without registering it in the global name space</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">Reservoir</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">species</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                <span class="n">delta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;delta&quot;</span><span class="p">],</span>
                <span class="n">mass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;mass&quot;</span><span class="p">],</span>
                <span class="n">concentration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;concentration&quot;</span><span class="p">],</span>
                <span class="n">volume</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="p">,</span>
                <span class="n">geometry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span>
                <span class="n">plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;plot&quot;</span><span class="p">],</span>
                <span class="n">groupname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">isotopes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;isotopes&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="c1"># register as part of this group</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Initialize a new reservoir group</p>
</div>


                            </div>
                            <div id="ReservoirGroup.lkk" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#ReservoirGroup.lkk">#&nbsp;&nbsp</a>

        <span class="name">lkk</span><span class="annotation">: Dict[str, &lt;built-in function any&gt;]</span>
    </div>

    

                            </div>
                            <div id="ReservoirGroup.lrk" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#ReservoirGroup.lrk">#&nbsp;&nbsp</a>

        <span class="name">lrk</span><span class="annotation">: list</span>
    </div>

    

                            </div>
                            <div id="ReservoirGroup.lod" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#ReservoirGroup.lod">#&nbsp;&nbsp</a>

        <span class="name">lod</span><span class="annotation">: Dict[&lt;built-in function any&gt;, &lt;built-in function any&gt;]</span>
    </div>

    

                            </div>
                            <div id="ReservoirGroup.cd" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#ReservoirGroup.cd">#&nbsp;&nbsp</a>

        <span class="name">cd</span><span class="annotation">: dict</span>
    </div>

    

                            </div>
                            <div id="ReservoirGroup.lor" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#ReservoirGroup.lor">#&nbsp;&nbsp</a>

        <span class="name">lor</span><span class="annotation">: list</span>
    </div>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#esbmtkBase">esbmtkBase</a></dt>
                                <dd id="ReservoirGroup.info" class="function"><a href="#esbmtkBase.info">info</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Flux">
                                <div class="attr class">
        <a class="headerlink" href="#Flux">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Flux</span>(<span class="base"><a href="#esbmtkBase">esbmtkBase</a></span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Flux</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class which defines a flux object. Flux objects contain</span>
<span class="sd">    information which links them to an species, describe things like</span>
<span class="sd">    the mass and time unit, and store data of the total flux rate at</span>
<span class="sd">    any given time step. Similarly, they store the flux of the light</span>
<span class="sd">    and heavy isotope flux, as well as the delta of the flux. This</span>
<span class="sd">    is typically handled through the Connect object. If you set it up manually</span>

<span class="sd">    Flux = (name = &quot;Name&quot;</span>
<span class="sd">            species = species_handle,</span>
<span class="sd">            delta = any number,</span>
<span class="sd">            rate  = &quot;12 mol/s&quot; # must be a string</span>
<span class="sd">            display_precision = number, optional, inherited from Model</span>
<span class="sd">    )</span>

<span class="sd">     You can access the flux data as</span>
<span class="sd">    - Name.m # mass</span>
<span class="sd">    - Name.d # delta</span>
<span class="sd">    - Name.c # concentration</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;rvalue&quot;</span><span class="p">,</span> <span class="s2">&quot;lpc&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a flux. Arguments are the species name the flux rate</span>
<span class="sd">        (mol/year), the delta value and unit</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="n">Species</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">),</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;species&quot;</span><span class="p">,</span> <span class="s2">&quot;rate&quot;</span><span class="p">]</span>

        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># initialize instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bem</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span> <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># legacy names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># name of flux</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">:</span> <span class="n">Species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>  <span class="c1"># species name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="c1"># model units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">tu</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># and convert flux into model units</span>
        <span class="n">fluxrate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="n">fluxrate</span>
        <span class="p">)</span>  <span class="c1"># add the flux</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_imass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

        <span class="c1"># if self.delta == 0:</span>
        <span class="c1">#     self.d: [NDArray, Float[64]] = zeros(self.model.steps)</span>
        <span class="c1"># else:  # update delta</span>
        <span class="c1">#     self.d: [NDArray, Float[64]] = get_delta(self.l, self.h, self.sp.r)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">]&quot;</span>  <span class="c1"># left y-axis a label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ld</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">ds</span><span class="si">}</span><span class="s2">]&quot;</span>  <span class="c1"># right y-axis a label</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dsa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">ds</span><span class="si">}</span><span class="s2">]&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xl</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">xl</span>  <span class="c1"># se x-axis label equal to model time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Process</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of processes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpc</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of external functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ExternalData</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of ext data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Name of reservoir which acts as flux source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Name of reservoir which acts as flux sink</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>

        <span class="c1"># decide which setitem functions to use</span>
        <span class="c1"># decide whether we use isotopes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_type</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_type</span> <span class="o">==</span> <span class="s2">&quot;mass_only&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_with_isotopes__</span>
            <span class="c1"># self.__get_data__ = self.__get_with_isotopes__  </span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_without_isotopes__</span>
            <span class="c1">#self.__get_data__ = self.__get_without_isotopes__</span>

    <span class="c1"># setup a placeholder setitem function</span>
    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get data by index&quot;&quot;&quot;</span>
        <span class="c1">#return self.__get_data__(i)</span>
        <span class="k">return</span> <span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>

    <span class="c1"># def __get_with_isotopes__(self, i: int) -&gt; NDArray[np.float64]:</span>
    <span class="c1">#     &quot;&quot;&quot;Get data by index&quot;&quot;&quot;</span>

    <span class="c1">#     return array([self.m[i], self.l[i], self.h[i], self.d[i]])</span>

    <span class="c1"># def __get_without_isotopes__(self, i: int) -&gt; NDArray[np.float64]:</span>
    <span class="c1">#     &quot;&quot;&quot;Get data by index&quot;&quot;&quot;</span>

    <span class="c1">#     return array([self.m[i]])</span>

    <span class="k">def</span> <span class="nf">__set_with_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Write data by index&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="c1"># self.d[i] = get_delta(self.l[i], self.h[i], self.sp.r)  # update delta</span>

    <span class="k">def</span> <span class="nf">__set_without_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Write data by index&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># what to do when called as a function ()</span>
        <span class="k">pass</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;adding two fluxes works for the masses, but not for delta&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">l</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">h</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">get_delta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;adding two fluxes works for the masses, but not for delta&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">l</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">h</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">get_delta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show an overview of the object properties.</span>
<span class="sd">        Optional arguments are</span>
<span class="sd">        index  :int = 0 this will show data at the given index</span>
<span class="sd">        indent :int = 0 indentation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">off</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>
        <span class="k">if</span> <span class="s2">&quot;index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>

        <span class="c1"># print basic data bout this object</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Data sample:&quot;</span><span class="p">)</span>
        <span class="n">show_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Process(es) acting on this flux:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}{</span><span class="n">ind</span><span class="si">}{</span><span class="n">p</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Use help on the process name to get an explanation what this process does&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;e.g., help(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;e.g., help(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There are no processes for this flux&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot the flux data:&quot;&quot;&quot;</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># Set figure size in inches</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_dpi</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>  <span class="c1"># Set resolution in dots per inch</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">)</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>  <span class="c1"># get second y-axis</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">tu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>  <span class="c1">#</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">dn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">ds</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># remove unnecessary frame</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># remove unnecessary frame</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>A class which defines a flux object. Flux objects contain
information which links them to an species, describe things like
the mass and time unit, and store data of the total flux rate at
any given time step. Similarly, they store the flux of the light
and heavy isotope flux, as well as the delta of the flux. This
is typically handled through the Connect object. If you set it up manually</p>

<p>Flux = (name = "Name"
        species = species_handle,
        delta = any number,
        rate  = "12 mol/s" # must be a string
        display_precision = number, optional, inherited from Model
)</p>

<p>You can access the flux data as</p>

<ul>
<li>Name.m # mass</li>
<li>Name.d # delta</li>
<li>Name.c # concentration</li>
</ul>
</div>


                            <div id="Flux.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Flux.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">Flux</span><span class="signature">(**kwargs: Dict[str, &lt;built-in function any&gt;])</span>
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a flux. Arguments are the species name the flux rate</span>
<span class="sd">        (mol/year), the delta value and unit</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="n">Species</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">),</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;species&quot;</span><span class="p">,</span> <span class="s2">&quot;rate&quot;</span><span class="p">]</span>

        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># initialize instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bem</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span> <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># legacy names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># name of flux</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">:</span> <span class="n">Species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>  <span class="c1"># species name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="c1"># model units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">tu</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># and convert flux into model units</span>
        <span class="n">fluxrate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="n">fluxrate</span>
        <span class="p">)</span>  <span class="c1"># add the flux</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_imass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

        <span class="c1"># if self.delta == 0:</span>
        <span class="c1">#     self.d: [NDArray, Float[64]] = zeros(self.model.steps)</span>
        <span class="c1"># else:  # update delta</span>
        <span class="c1">#     self.d: [NDArray, Float[64]] = get_delta(self.l, self.h, self.sp.r)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">]&quot;</span>  <span class="c1"># left y-axis a label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ld</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">ds</span><span class="si">}</span><span class="s2">]&quot;</span>  <span class="c1"># right y-axis a label</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dsa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">ds</span><span class="si">}</span><span class="s2">]&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xl</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">xl</span>  <span class="c1"># se x-axis label equal to model time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Process</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of processes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpc</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of external functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ExternalData</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of ext data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Name of reservoir which acts as flux source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Name of reservoir which acts as flux sink</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>

        <span class="c1"># decide which setitem functions to use</span>
        <span class="c1"># decide whether we use isotopes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_type</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_type</span> <span class="o">==</span> <span class="s2">&quot;mass_only&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_with_isotopes__</span>
            <span class="c1"># self.__get_data__ = self.__get_with_isotopes__  </span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_without_isotopes__</span>
</pre></div>

        </details>

            <div class="docstring"><p>Initialize a flux. Arguments are the species name the flux rate
(mol/year), the delta value and unit</p>
</div>


                            </div>
                            <div id="Flux.lkk" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Flux.lkk">#&nbsp;&nbsp</a>

        <span class="name">lkk</span><span class="annotation">: Dict[str, &lt;built-in function any&gt;]</span>
    </div>

    

                            </div>
                            <div id="Flux.lrk" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Flux.lrk">#&nbsp;&nbsp</a>

        <span class="name">lrk</span><span class="annotation">: list</span>
    </div>

    

                            </div>
                            <div id="Flux.lod" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Flux.lod">#&nbsp;&nbsp</a>

        <span class="name">lod</span><span class="annotation">: Dict[&lt;built-in function any&gt;, &lt;built-in function any&gt;]</span>
    </div>

    

                            </div>
                            <div id="Flux.n" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Flux.n">#&nbsp;&nbsp</a>

        <span class="name">n</span><span class="annotation">: str</span>
    </div>

    

                            </div>
                            <div id="Flux.sp" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Flux.sp">#&nbsp;&nbsp</a>

        <span class="name">sp</span><span class="annotation">: <a href="#Species">esbmtk.esbmtk.Species</a></span>
    </div>

    

                            </div>
                            <div id="Flux.mo" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Flux.mo">#&nbsp;&nbsp</a>

        <span class="name">mo</span><span class="annotation">: <a href="#Model">esbmtk.esbmtk.Model</a></span>
    </div>

    

                            </div>
                            <div id="Flux.model" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Flux.model">#&nbsp;&nbsp</a>

        <span class="name">model</span><span class="annotation">: <a href="#Model">esbmtk.esbmtk.Model</a></span>
    </div>

    

                            </div>
                            <div id="Flux.rvalue" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Flux.rvalue">#&nbsp;&nbsp</a>

        <span class="name">rvalue</span><span class="default_value"> = &lt;member &#39;rvalue&#39; of &#39;Flux&#39; objects&gt;</span>
    </div>

    

                            </div>
                            <div id="Flux.mu" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Flux.mu">#&nbsp;&nbsp</a>

        <span class="name">mu</span><span class="annotation">: str</span>
    </div>

    

                            </div>
                            <div id="Flux.m" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Flux.m">#&nbsp;&nbsp</a>

        <span class="name">m</span><span class="annotation">: &#39;[NDArray, Float[64]]&#39;</span><span class="default_value"> = &lt;member &#39;m&#39; of &#39;Flux&#39; objects&gt;</span>
    </div>

    

                            </div>
                            <div id="Flux.l" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Flux.l">#&nbsp;&nbsp</a>

        <span class="name">l</span><span class="annotation">: &#39;[NDArray, Float[64]]&#39;</span><span class="default_value"> = &lt;member &#39;l&#39; of &#39;Flux&#39; objects&gt;</span>
    </div>

    

                            </div>
                            <div id="Flux.h" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Flux.h">#&nbsp;&nbsp</a>

        <span class="name">h</span><span class="annotation">: &#39;[NDArray, Float[64]]&#39;</span><span class="default_value"> = &lt;member &#39;h&#39; of &#39;Flux&#39; objects&gt;</span>
    </div>

    

                            </div>
                            <div id="Flux.d" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Flux.d">#&nbsp;&nbsp</a>

        <span class="name">d</span><span class="annotation">: &#39;[NDArray, Float[64]]&#39;</span><span class="default_value"> = &lt;member &#39;d&#39; of &#39;Flux&#39; objects&gt;</span>
    </div>

    

                            </div>
                            <div id="Flux.lm" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Flux.lm">#&nbsp;&nbsp</a>

        <span class="name">lm</span><span class="annotation">: str</span>
    </div>

    

                            </div>
                            <div id="Flux.ld" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Flux.ld">#&nbsp;&nbsp</a>

        <span class="name">ld</span><span class="annotation">: str</span>
    </div>

    

                            </div>
                            <div id="Flux.legend_left" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Flux.legend_left">#&nbsp;&nbsp</a>

        <span class="name">legend_left</span><span class="annotation">: str</span>
    </div>

    

                            </div>
                            <div id="Flux.legend_right" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Flux.legend_right">#&nbsp;&nbsp</a>

        <span class="name">legend_right</span><span class="annotation">: str</span>
    </div>

    

                            </div>
                            <div id="Flux.xl" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Flux.xl">#&nbsp;&nbsp</a>

        <span class="name">xl</span><span class="annotation">: str</span>
    </div>

    

                            </div>
                            <div id="Flux.lop" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Flux.lop">#&nbsp;&nbsp</a>

        <span class="name">lop</span><span class="annotation">: &#39;list[Process]&#39;</span>
    </div>

    

                            </div>
                            <div id="Flux.lpc" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Flux.lpc">#&nbsp;&nbsp</a>

        <span class="name">lpc</span><span class="annotation">: list</span><span class="default_value"> = &lt;member &#39;lpc&#39; of &#39;Flux&#39; objects&gt;</span>
    </div>

    

                            </div>
                            <div id="Flux.led" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Flux.led">#&nbsp;&nbsp</a>

        <span class="name">led</span><span class="annotation">: &#39;list[ExternalData]&#39;</span>
    </div>

    

                            </div>
                            <div id="Flux.source" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Flux.source">#&nbsp;&nbsp</a>

        <span class="name">source</span><span class="annotation">: str</span>
    </div>

    

                            </div>
                            <div id="Flux.sink" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Flux.sink">#&nbsp;&nbsp</a>

        <span class="name">sink</span><span class="annotation">: str</span>
    </div>

    

                            </div>
                            <div id="Flux.info" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Flux.info">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">info</span><span class="signature">(self, **kwargs) -&gt; None</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show an overview of the object properties.</span>
<span class="sd">        Optional arguments are</span>
<span class="sd">        index  :int = 0 this will show data at the given index</span>
<span class="sd">        indent :int = 0 indentation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">off</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>
        <span class="k">if</span> <span class="s2">&quot;index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>

        <span class="c1"># print basic data bout this object</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Data sample:&quot;</span><span class="p">)</span>
        <span class="n">show_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Process(es) acting on this flux:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}{</span><span class="n">ind</span><span class="si">}{</span><span class="n">p</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Use help on the process name to get an explanation what this process does&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;e.g., help(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;e.g., help(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There are no processes for this flux&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Show an overview of the object properties.
Optional arguments are
index  :int = 0 this will show data at the given index
indent :int = 0 indentation</p>
</div>


                            </div>
                            <div id="Flux.plot" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Flux.plot">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">plot</span><span class="signature">(self, **kwargs: dict) -&gt; None</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot the flux data:&quot;&quot;&quot;</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># Set figure size in inches</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_dpi</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>  <span class="c1"># Set resolution in dots per inch</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">)</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>  <span class="c1"># get second y-axis</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">tu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>  <span class="c1">#</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">dn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">ds</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># remove unnecessary frame</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># remove unnecessary frame</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Plot the flux data:</p>
</div>


                            </div>
                </section>
                <section id="SourceSink">
                                <div class="attr class">
        <a class="headerlink" href="#SourceSink">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">SourceSink</span>(<span class="base"><a href="#esbmtkBase">esbmtkBase</a></span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">SourceSink</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a meta class to setup a Source/Sink objects. These are not</span>
<span class="sd">    actual reservoirs, but we stil need to have them as objects</span>
<span class="sd">    Example::</span>

<span class="sd">           Sink(name = &quot;Pyrite&quot;,</span>
<span class="sd">               species = SO4,</span>
<span class="sd">               display_precision = number, optional, inherited from Model</span>
<span class="sd">               delta = number or str. optional defaults to &quot;None&quot;</span>
<span class="sd">           )</span>

<span class="sd">    where the first argument is a string, and the second is a reservoir handle</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="n">Species</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Number</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;species&quot;</span><span class="p">]</span>

        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># set of connection objects</span>

        <span class="c1"># legacy names</span>
        <span class="c1"># if self.register != &quot;None&quot;:</span>
        <span class="c1">#    self.full_name = f&quot;{self.name}.{self.register.name}&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mu</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">bu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lio</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groupname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>This is a meta class to setup a Source/Sink objects. These are not
actual reservoirs, but we stil need to have them as objects
Example::</p>

<pre><code>   Sink(name = "Pyrite",
       species = SO4,
       display_precision = number, optional, inherited from Model
       delta = number or str. optional defaults to "None"
   )
</code></pre>

<p>where the first argument is a string, and the second is a reservoir handle</p>
</div>


                            <div id="SourceSink.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SourceSink.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">SourceSink</span><span class="signature">(**kwargs)</span>
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="n">Species</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Number</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;species&quot;</span><span class="p">]</span>

        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># set of connection objects</span>

        <span class="c1"># legacy names</span>
        <span class="c1"># if self.register != &quot;None&quot;:</span>
        <span class="c1">#    self.full_name = f&quot;{self.name}.{self.register.name}&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mu</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">bu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lio</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groupname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="SourceSink.lkk" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#SourceSink.lkk">#&nbsp;&nbsp</a>

        <span class="name">lkk</span><span class="annotation">: Dict[str, &lt;built-in function any&gt;]</span>
    </div>

    

                            </div>
                            <div id="SourceSink.lrk" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#SourceSink.lrk">#&nbsp;&nbsp</a>

        <span class="name">lrk</span><span class="annotation">: &#39;list[str]&#39;</span>
    </div>

    

                            </div>
                            <div id="SourceSink.lod" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#SourceSink.lod">#&nbsp;&nbsp</a>

        <span class="name">lod</span><span class="annotation">: Dict[str, &lt;built-in function any&gt;]</span>
    </div>

    

                            </div>
                            <div id="SourceSink.loc" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#SourceSink.loc">#&nbsp;&nbsp</a>

        <span class="name">loc</span><span class="annotation">: &#39;set[Connection]&#39;</span>
    </div>

    

                            </div>
                            <div id="SourceSink.lio" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#SourceSink.lio">#&nbsp;&nbsp</a>

        <span class="name">lio</span><span class="annotation">: list</span>
    </div>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#esbmtkBase">esbmtkBase</a></dt>
                                <dd id="SourceSink.info" class="function"><a href="#esbmtkBase.info">info</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Sink">
                                <div class="attr class">
        <a class="headerlink" href="#Sink">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Sink</span>(<span class="base"><a href="#SourceSink">SourceSink</a></span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Sink</span><span class="p">(</span><span class="n">SourceSink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is just a wrapper to setup a Sink object</span>
<span class="sd">    Example::</span>

<span class="sd">           Sink(name = &quot;Pyrite&quot;,species =SO4)</span>

<span class="sd">    where the first argument is a string, and the second is a species handle</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>

        </details>

            <div class="docstring"><p>This is just a wrapper to setup a Sink object
Example::</p>

<pre><code>   Sink(name = "Pyrite",species =SO4)
</code></pre>

<p>where the first argument is a string, and the second is a species handle</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#SourceSink">SourceSink</a></dt>
                                <dd id="Sink.__init__" class="function"><a href="#SourceSink.__init__">SourceSink</a></dd>
                <dd id="Sink.lkk" class="variable"><a href="#SourceSink.lkk">lkk</a></dd>
                <dd id="Sink.lrk" class="variable"><a href="#SourceSink.lrk">lrk</a></dd>
                <dd id="Sink.lod" class="variable"><a href="#SourceSink.lod">lod</a></dd>
                <dd id="Sink.loc" class="variable"><a href="#SourceSink.loc">loc</a></dd>
                <dd id="Sink.lio" class="variable"><a href="#SourceSink.lio">lio</a></dd>

            </div>
            <div><dt><a href="#esbmtkBase">esbmtkBase</a></dt>
                                <dd id="Sink.info" class="function"><a href="#esbmtkBase.info">info</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Source">
                                <div class="attr class">
        <a class="headerlink" href="#Source">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Source</span>(<span class="base"><a href="#SourceSink">SourceSink</a></span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Source</span><span class="p">(</span><span class="n">SourceSink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is just a wrapper to setup a Source object</span>
<span class="sd">    Example::</span>

<span class="sd">           Source(name = &quot;SO4_diffusion&quot;, species =&quot;SO4&quot;)</span>

<span class="sd">    where the first argument is a string, and the second is a species handle</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>

        </details>

            <div class="docstring"><p>This is just a wrapper to setup a Source object
Example::</p>

<pre><code>   Source(name = "SO4_diffusion", species ="SO4")
</code></pre>

<p>where the first argument is a string, and the second is a species handle</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#SourceSink">SourceSink</a></dt>
                                <dd id="Source.__init__" class="function"><a href="#SourceSink.__init__">SourceSink</a></dd>
                <dd id="Source.lkk" class="variable"><a href="#SourceSink.lkk">lkk</a></dd>
                <dd id="Source.lrk" class="variable"><a href="#SourceSink.lrk">lrk</a></dd>
                <dd id="Source.lod" class="variable"><a href="#SourceSink.lod">lod</a></dd>
                <dd id="Source.loc" class="variable"><a href="#SourceSink.loc">loc</a></dd>
                <dd id="Source.lio" class="variable"><a href="#SourceSink.lio">lio</a></dd>

            </div>
            <div><dt><a href="#esbmtkBase">esbmtkBase</a></dt>
                                <dd id="Source.info" class="function"><a href="#esbmtkBase.info">info</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="SourceSinkGroup">
                                <div class="attr class">
        <a class="headerlink" href="#SourceSinkGroup">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">SourceSinkGroup</span>(<span class="base"><a href="#esbmtkBase">esbmtkBase</a></span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">SourceSinkGroup</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a meta class to setup  Source/Sink Groups. These are not</span>
<span class="sd">    actual reservoirs, but we stil need to have them as objects</span>
<span class="sd">    Example::</span>

<span class="sd">           Sink(name = &quot;Pyrite&quot;,</span>
<span class="sd">                species = [SO42, H2S],</span>
<span class="sd">                delta = {&quot;SO4&quot;: 10}</span>
<span class="sd">                )</span>

<span class="sd">    where the first argument is a string, and the second is a reservoir handle</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;species&quot;</span><span class="p">]</span>
        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">{}}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># legacy variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># set of connection objects</span>

        <span class="c1"># register this object in the global namespace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># get model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of sub reservoirs in this group</span>

        <span class="c1"># loop over species names and setup sub-objects</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Species</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> needs to be a valid species name&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">:</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>

            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;SourceGroup&quot;</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">Source</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">species</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                    <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;SinkGroup&quot;</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">Sink</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">species</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                    <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> is not a valid class type&quot;</span><span class="p">)</span>

            <span class="c1"># register in local namespace</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>This is a meta class to setup  Source/Sink Groups. These are not
actual reservoirs, but we stil need to have them as objects
Example::</p>

<pre><code>   Sink(name = "Pyrite",
        species = [SO42, H2S],
        delta = {"SO4": 10}
        )
</code></pre>

<p>where the first argument is a string, and the second is a reservoir handle</p>
</div>


                            <div id="SourceSinkGroup.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SourceSinkGroup.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">SourceSinkGroup</span><span class="signature">(**kwargs)</span>
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;species&quot;</span><span class="p">]</span>
        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">{}}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># legacy variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># set of connection objects</span>

        <span class="c1"># register this object in the global namespace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># get model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of sub reservoirs in this group</span>

        <span class="c1"># loop over species names and setup sub-objects</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Species</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> needs to be a valid species name&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">:</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>

            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;SourceGroup&quot;</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">Source</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">species</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                    <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;SinkGroup&quot;</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">Sink</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">species</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                    <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> is not a valid class type&quot;</span><span class="p">)</span>

            <span class="c1"># register in local namespace</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="SourceSinkGroup.lkk" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#SourceSinkGroup.lkk">#&nbsp;&nbsp</a>

        <span class="name">lkk</span><span class="annotation">: Dict[str, &lt;built-in function any&gt;]</span>
    </div>

    

                            </div>
                            <div id="SourceSinkGroup.lrk" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#SourceSinkGroup.lrk">#&nbsp;&nbsp</a>

        <span class="name">lrk</span><span class="annotation">: &#39;list[str]&#39;</span>
    </div>

    

                            </div>
                            <div id="SourceSinkGroup.lod" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#SourceSinkGroup.lod">#&nbsp;&nbsp</a>

        <span class="name">lod</span><span class="annotation">: Dict[&lt;built-in function any&gt;, &lt;built-in function any&gt;]</span>
    </div>

    

                            </div>
                            <div id="SourceSinkGroup.loc" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#SourceSinkGroup.loc">#&nbsp;&nbsp</a>

        <span class="name">loc</span><span class="annotation">: &#39;set[Connection]&#39;</span>
    </div>

    

                            </div>
                            <div id="SourceSinkGroup.lor" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#SourceSinkGroup.lor">#&nbsp;&nbsp</a>

        <span class="name">lor</span><span class="annotation">: list</span>
    </div>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#esbmtkBase">esbmtkBase</a></dt>
                                <dd id="SourceSinkGroup.info" class="function"><a href="#esbmtkBase.info">info</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="SinkGroup">
                                <div class="attr class">
        <a class="headerlink" href="#SinkGroup">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">SinkGroup</span>(<span class="base"><a href="#SourceSinkGroup">SourceSinkGroup</a></span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">SinkGroup</span><span class="p">(</span><span class="n">SourceSinkGroup</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is just a wrapper to setup a Sink object</span>
<span class="sd">    Example::</span>

<span class="sd">           Sink(name = &quot;Pyrite&quot;,species =SO4)</span>

<span class="sd">    where the first argument is a string, and the second is a species handle</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>

        </details>

            <div class="docstring"><p>This is just a wrapper to setup a Sink object
Example::</p>

<pre><code>   Sink(name = "Pyrite",species =SO4)
</code></pre>

<p>where the first argument is a string, and the second is a species handle</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#SourceSinkGroup">SourceSinkGroup</a></dt>
                                <dd id="SinkGroup.__init__" class="function"><a href="#SourceSinkGroup.__init__">SourceSinkGroup</a></dd>
                <dd id="SinkGroup.lkk" class="variable"><a href="#SourceSinkGroup.lkk">lkk</a></dd>
                <dd id="SinkGroup.lrk" class="variable"><a href="#SourceSinkGroup.lrk">lrk</a></dd>
                <dd id="SinkGroup.lod" class="variable"><a href="#SourceSinkGroup.lod">lod</a></dd>
                <dd id="SinkGroup.loc" class="variable"><a href="#SourceSinkGroup.loc">loc</a></dd>
                <dd id="SinkGroup.lor" class="variable"><a href="#SourceSinkGroup.lor">lor</a></dd>

            </div>
            <div><dt><a href="#esbmtkBase">esbmtkBase</a></dt>
                                <dd id="SinkGroup.info" class="function"><a href="#esbmtkBase.info">info</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="SourceGroup">
                                <div class="attr class">
        <a class="headerlink" href="#SourceGroup">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">SourceGroup</span>(<span class="base"><a href="#SourceSinkGroup">SourceSinkGroup</a></span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">SourceGroup</span><span class="p">(</span><span class="n">SourceSinkGroup</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is just a wrapper to setup a Source object</span>
<span class="sd">    Example::</span>

<span class="sd">           Sink(name = &quot;SO4_diffusion&quot;, species =&quot;SO4&quot;)</span>

<span class="sd">    where the first argument is a string, and the second is a species handle</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>

        </details>

            <div class="docstring"><p>This is just a wrapper to setup a Source object
Example::</p>

<pre><code>   Sink(name = "SO4_diffusion", species ="SO4")
</code></pre>

<p>where the first argument is a string, and the second is a species handle</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#SourceSinkGroup">SourceSinkGroup</a></dt>
                                <dd id="SourceGroup.__init__" class="function"><a href="#SourceSinkGroup.__init__">SourceSinkGroup</a></dd>
                <dd id="SourceGroup.lkk" class="variable"><a href="#SourceSinkGroup.lkk">lkk</a></dd>
                <dd id="SourceGroup.lrk" class="variable"><a href="#SourceSinkGroup.lrk">lrk</a></dd>
                <dd id="SourceGroup.lod" class="variable"><a href="#SourceSinkGroup.lod">lod</a></dd>
                <dd id="SourceGroup.loc" class="variable"><a href="#SourceSinkGroup.loc">loc</a></dd>
                <dd id="SourceGroup.lor" class="variable"><a href="#SourceSinkGroup.lor">lor</a></dd>

            </div>
            <div><dt><a href="#esbmtkBase">esbmtkBase</a></dt>
                                <dd id="SourceGroup.info" class="function"><a href="#esbmtkBase.info">info</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Signal">
                                <div class="attr class">
        <a class="headerlink" href="#Signal">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Signal</span>(<span class="base"><a href="#esbmtkBase">esbmtkBase</a></span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Signal</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;We use a simple generator which will create a signal which is</span>
<span class="sd">    described by its startime (relative to the model time), it&#39;s</span>
<span class="sd">    size (as mass) and duration, or as duration and</span>
<span class="sd">    magnitude. Furthermore, we can presribe the signal shape</span>
<span class="sd">    (square, pyramid) and whether the signal will repeat. You</span>
<span class="sd">    can also specify whether the event will affect the delta value.</span>

<span class="sd">    The data in the signal class will simply be added to the data in</span>
<span class="sd">    a given flux. So this class cannot be used for scaling (can we</span>
<span class="sd">    add this functionality?)</span>

<span class="sd">    Example::</span>

<span class="sd">          Signal(name = &quot;Name&quot;,</span>
<span class="sd">                 species = Species handle,</span>
<span class="sd">                 start = &quot;0 yrs&quot;,     # optional</span>
<span class="sd">                 duration = &quot;0 yrs&quot;,  #</span>
<span class="sd">                 delta = 0,           # optional</span>
<span class="sd">                 stype = &quot;addition&quot;   # optional, currently the only type</span>
<span class="sd">                 shape = &quot;square&quot;     # square, pyramid</span>
<span class="sd">                 mass/magnitude/filename  # give one</span>
<span class="sd">                 offset = &#39;0 yrs&#39;,     #</span>
<span class="sd">                 scale = 1, optional,  #</span>
<span class="sd">                 reservoir = r-handle # optional, see below</span>
<span class="sd">                 source = s-handle optional, see below</span>
<span class="sd">                 display_precision = number, optional, inherited from Model</span>
<span class="sd">                )</span>

<span class="sd">    Signals are cumulative, i.e., complex signals ar created by</span>
<span class="sd">    adding one signal to another (i.e., Snew = S1 + S2)</span>

<span class="sd">    The optional scaling argument will only affect the y-column data of</span>
<span class="sd">    external data files</span>

<span class="sd">    Signals are registered with a flux during flux creation,</span>
<span class="sd">    i.e., they are passed on the process list when calling the</span>
<span class="sd">    connector object.</span>

<span class="sd">    if the filename argument is used, you can provide a filename which</span>
<span class="sd">    contains the data to be used in csv format. The data will be</span>
<span class="sd">    interpolated to the model domain, and added to the already existing data.</span>
<span class="sd">    The external data need to be in the following format</span>

<span class="sd">      Time, Rate, delta value</span>
<span class="sd">      0,     10,   12</span>

<span class="sd">      i.e., the first row needs to be a header line</span>

<span class="sd">    All time data in the csv file will be treated as realative time</span>
<span class="sd">    (i.e., the start time will be mapped to zero). Use the offset</span>
<span class="sd">    keyword to shift the external signal data in the time domain.</span>

<span class="sd">    Last but not least, you can provide an optional reservoir name. In</span>
<span class="sd">    this case, the signal will create a source as (signal_name_source)</span>
<span class="sd">    and the connection to the specified reservoir. If you build a</span>
<span class="sd">    complex signal do this as the last step. If you additionally</span>
<span class="sd">    provide a source name the connection will be made between the</span>
<span class="sd">    provided source (this can be useful if you use source groups).</span>


<span class="sd">    This class has the following methods</span>

<span class="sd">      Signal.repeat()</span>
<span class="sd">      Signal.plot()</span>
<span class="sd">      Signal.info()</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Parse and initialize variables&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>

        <span class="c1"># provide a list of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="n">Species</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;stype&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;magnitude&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;reservoir&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Reservoir</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Source</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;magnitude&quot;</span><span class="p">,</span> <span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">],</span>
        <span class="p">]</span>

        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="s2">&quot;0 yrs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;stype&quot;</span><span class="p">:</span> <span class="s2">&quot;addition&quot;</span><span class="p">,</span>
            <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="s2">&quot;external_data&quot;</span><span class="p">,</span>
            <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="s2">&quot;0 yrs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="s2">&quot;0 yrs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;reservoir&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bem</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;magnitude&quot;</span><span class="p">:</span> <span class="s2">&quot;Number&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="s2">&quot;Number&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># list of signals we are based on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Signal</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># convert units to model units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">st</span><span class="p">:</span> <span class="n">Number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="p">)</span>  <span class="c1"># start time</span>

        <span class="k">if</span> <span class="s2">&quot;mass&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="k">elif</span> <span class="s2">&quot;magnitude&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">magnitude</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="k">if</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="c1"># legacy name definitions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># the name of the this signal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">:</span> <span class="n">Species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>  <span class="c1"># the species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># the model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ty</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stype</span>  <span class="c1"># type of signal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sh</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># shape the event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span>  <span class="c1"># delta value offset during the event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwd</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span>  <span class="c1"># list of keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="c1"># initialize signal data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__init_signal_data__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_data&quot;</span>  <span class="c1"># update the name of the signal data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">legend_left</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">legend_right</span>
        <span class="c1"># update isotope values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">li</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">hi</span> <span class="o">=</span> <span class="n">get_imass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">los</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># register with model</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__apply_signal__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__apply_signal__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a source, and connect signal, source and reservoir&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Connect</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">Source</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_Source&quot;</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">)</span>

        <span class="n">Connect</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>  <span class="c1"># source of flux</span>
            <span class="n">sink</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="p">,</span>  <span class="c1"># target of flux</span>
            <span class="n">rate</span><span class="o">=</span><span class="s2">&quot;0 mol/yr&quot;</span><span class="p">,</span>  <span class="c1"># flux rate</span>
            <span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>  <span class="c1"># list of processes</span>
            <span class="n">plot</span><span class="o">=</span><span class="s2">&quot;no&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init_signal_data__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create an empty flux and apply the shape&quot;&quot;&quot;</span>
        <span class="c1"># create a dummy flux we can act up</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">:</span> <span class="n">Flux</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="s2">&quot;_data&quot;</span><span class="p">,</span>
            <span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">,</span>
            <span class="n">rate</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;0 </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">delta</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># since the flux is zero, the delta value will be undefined. So we set it explicitly</span>
        <span class="c1"># this will avoid having additions with Nan values.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">:]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># find nearest index for start, and end point</span>
        <span class="c1"># print(f&quot;Model time units = {self.species.mo.t_unit}&quot;)</span>
        <span class="c1"># print(f&quot;start_time = {self.st}, dt = {self.mo.dt}&quot;)</span>
        <span class="c1"># print(f&quot;duration = {self.duration}&quot;)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">si</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">st</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">))</span>  <span class="c1"># starting index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ei</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">si</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">))</span>  <span class="c1"># end index</span>
        <span class="c1"># print(f&quot;start index = {self.si}&quot;)</span>
        <span class="c1"># print(f&quot;end index = {self.ei}&quot;)</span>

        <span class="c1"># create slice of flux vector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">si</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ei</span><span class="p">])</span>
        <span class="c1"># create slice of delta vector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">si</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ei</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sh</span> <span class="o">==</span> <span class="s2">&quot;square&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__square__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">si</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ei</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sh</span> <span class="o">==</span> <span class="s2">&quot;pyramid&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__pyramid__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">si</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ei</span><span class="p">)</span>

        <span class="k">elif</span> <span class="s2">&quot;filename&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>  <span class="c1"># use an external data set</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__int_ext_data__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">si</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ei</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;argument needs to be either square/pyramid, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;or an ExternalData object. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;shape = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sh</span><span class="si">}</span><span class="s2"> is not a valid Value&quot;</span>
            <span class="p">)</span>

        <span class="c1"># now add the signal into the flux slice</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">si</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ei</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">si</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ei</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span>

    <span class="k">def</span> <span class="nf">__square__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create Square Signal&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;mass&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span>  <span class="c1"># get the height of the square</span>

        <span class="k">elif</span> <span class="s2">&quot;magnitude&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must specify mass or magnitude of the signal&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">h</span>  <span class="c1"># add this to the section</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>  <span class="c1"># add the delta offset</span>

    <span class="k">def</span> <span class="nf">__pyramid__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create pyramid type Signal</span>

<span class="sd">        s = start index</span>
<span class="sd">        e = end index</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;mass&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span>  <span class="c1"># get the height of the pyramid</span>

        <span class="k">elif</span> <span class="s2">&quot;magnitude&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must specify mass or magnitude of the signal&quot;</span><span class="p">)</span>

        <span class="c1"># create pyramid</span>
        <span class="n">c</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">e</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># get the center index for the peak</span>
        <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">e</span> <span class="o">-</span> <span class="n">s</span><span class="p">])</span>  <span class="c1"># setup the x coordinates</span>
        <span class="n">y</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>  <span class="c1"># setup the y coordinates</span>
        <span class="n">d</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>  <span class="c1"># setup the d coordinates</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">e</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span>  <span class="c1"># setup the points at which to interpolate</span>
        <span class="n">h</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>  <span class="c1"># interpolate flux</span>
        <span class="n">dy</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>  <span class="c1"># interpolate delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span> <span class="o">+</span> <span class="n">h</span>  <span class="c1"># add this to the section</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span> <span class="o">+</span> <span class="n">dy</span>  <span class="c1"># ditto for delta</span>

    <span class="k">def</span> <span class="nf">__int_ext_data__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Interpolate External data as a signal. Unlike the other signals,</span>
<span class="sd">        thiw will replace the values in the flux with those read from the</span>
<span class="sd">        external data source. The external data need to be in the following format</span>

<span class="sd">        Time [units], Rate [units], delta value [units]</span>
<span class="sd">        0,     10,   12</span>

<span class="sd">        i.e., the first row needs to be a header line</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>  <span class="c1"># check if the file is actually there</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># read external dataset</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

        <span class="c1"># get unit information from each header</span>
        <span class="n">xh</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">yh</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># zh = df.iloc[0,2].split(&quot;[&quot;)[1].split(&quot;]&quot;)[0]</span>

        <span class="c1"># create the associated quantities</span>
        <span class="n">xq</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">xh</span><span class="p">)</span>
        <span class="n">yq</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">yh</span><span class="p">)</span>
        <span class="c1"># zq = Q_(zh)</span>

        <span class="c1"># add these to the data we are are reading</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">*</span> <span class="n">xq</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">*</span> <span class="n">yq</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="c1"># map into model units, and strip unit information</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

        <span class="c1"># the data can contain 1 to n data points (i.e., index</span>
        <span class="c1"># values[0,1,n]) each index value contains a time</span>
        <span class="c1"># coordinate. So the duration is x[-1] - X[0]. Duration/dt</span>
        <span class="c1"># gives us the steps, so we can setup a vector for</span>
        <span class="c1"># interpolation. Insertion off this vector depends on the time</span>
        <span class="c1"># offset defined by offset keyword which defines the</span>
        <span class="c1"># insertion indexes self.si self.ei</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">st</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># start time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">et</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># end times</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">et</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">st</span><span class="p">))</span>

        <span class="c1"># map the original time coordinate into model space</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># since everything has been mapped to dt, time equals index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">si</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>  <span class="c1"># starting index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ei</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">duration</span>  <span class="c1"># end index</span>

        <span class="c1"># create slice of flux vector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">si</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ei</span><span class="p">])</span>

        <span class="c1"># create slice of delta vector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">si</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ei</span><span class="p">])</span>

        <span class="c1"># setup the points at which to interpolate</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">duration</span><span class="p">)</span>

        <span class="n">h</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>  <span class="c1"># interpolate flux</span>
        <span class="n">dy</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>  <span class="c1"># interpolate delta</span>

        <span class="c1"># add this to the corresponding section off the flux</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span> <span class="o">+</span> <span class="n">h</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span> <span class="o">+</span> <span class="n">dy</span>  <span class="c1"># ditto for delta</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; allow the addition of two signals and return a new signal&quot;&quot;&quot;</span>

        <span class="n">ns</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># add the data of both fluxes</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">h</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span>

        <span class="p">[</span><span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_imass</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

        <span class="n">ns</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="s2">&quot;_and_&quot;</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">n</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;adding </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">, returning </span><span class="si">{</span><span class="n">ns</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="s2">&quot;_and_&quot;</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="s2">&quot;_data&quot;</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">st</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">st</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">st</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">l</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">sh</span> <span class="o">=</span> <span class="s2">&quot;compound&quot;</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">los</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">los</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ns</span>

    <span class="k">def</span> <span class="nf">repeat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This method creates a new signal by repeating an existing signal.</span>
<span class="sd">        Example::</span>

<span class="sd">        new_signal = signal.repeat(start,   # start time of signal slice to be repeated</span>
<span class="sd">                                   stop,    # end time of signal slice to be repeated</span>
<span class="sd">                                   offset,  # offset between repetitions</span>
<span class="sd">                                   times,   # number of time to repeat the slice</span>
<span class="sd">                              )</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ns</span><span class="p">:</span> <span class="n">Signal</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_repeated_</span><span class="si">{</span><span class="n">times</span><span class="si">}</span><span class="s2">_times&quot;</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_repeated_</span><span class="si">{</span><span class="n">times</span><span class="si">}</span><span class="s2">_times_data&quot;</span>
        <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>  <span class="c1"># convert from time to index</span>
        <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">stop</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">offset</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">start</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">stop</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">stop</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">offset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span> <span class="o">+</span> <span class="n">offset</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">times</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">times</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">ms</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">[</span>
            <span class="n">start</span><span class="p">:</span><span class="n">stop</span>
        <span class="p">]</span>  <span class="c1"># get the data slice we are using</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">ds</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>

        <span class="n">diff</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
            <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">ns</span><span class="o">.</span><span class="n">offset</span>
            <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">+</span> <span class="n">ns</span><span class="o">.</span><span class="n">offset</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">stop</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">):</span>  <span class="c1"># end index larger than data size</span>
                <span class="n">diff</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>  <span class="c1"># difference</span>
                <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">diff</span>  <span class="c1"># new end index</span>
                <span class="n">lds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">ds</span><span class="p">)</span> <span class="o">-</span> <span class="n">diff</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">ds</span><span class="p">)</span>

            <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span> <span class="o">+</span> <span class="n">ns</span><span class="o">.</span><span class="n">ms</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">lds</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span> <span class="o">+</span> <span class="n">ns</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">lds</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># and recalculate li and hi</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">h</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span>
        <span class="p">[</span><span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_imass</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ns</span>

    <span class="k">def</span> <span class="nf">__register_with_flux__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flux</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Register this signal with a flux. This should probably be done</span>
<span class="sd">        through a process!</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fo</span><span class="p">:</span> <span class="n">Flux</span> <span class="o">=</span> <span class="n">flux</span>  <span class="c1"># the flux handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">:</span> <span class="n">Species</span> <span class="o">=</span> <span class="n">flux</span><span class="o">.</span><span class="n">sp</span>  <span class="c1"># the species handle</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="n">flux</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># the model handle add this process to the</span>
        <span class="c1"># list of processes</span>
        <span class="n">flux</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;what to do when called as a function ()&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fo</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fo</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fo</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fo</span><span class="o">.</span><span class="n">d</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">fo</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">          Example::</span>

<span class="sd">              Signal.plot()</span>

<span class="sd">        Plot the signal</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>We use a simple generator which will create a signal which is
described by its startime (relative to the model time), it's
size (as mass) and duration, or as duration and
magnitude. Furthermore, we can presribe the signal shape
(square, pyramid) and whether the signal will repeat. You
can also specify whether the event will affect the delta value.</p>

<p>The data in the signal class will simply be added to the data in
a given flux. So this class cannot be used for scaling (can we
add this functionality?)</p>

<p>Example::</p>

<pre><code>  Signal(name = "Name",
         species = Species handle,
         start = "0 yrs",     # optional
         duration = "0 yrs",  #
         delta = 0,           # optional
         stype = "addition"   # optional, currently the only type
         shape = "square"     # square, pyramid
         mass/magnitude/filename  # give one
         offset = '0 yrs',     #
         scale = 1, optional,  #
         reservoir = r-handle # optional, see below
         source = s-handle optional, see below
         display_precision = number, optional, inherited from Model
        )
</code></pre>

<p>Signals are cumulative, i.e., complex signals ar created by
adding one signal to another (i.e., Snew = S1 + S2)</p>

<p>The optional scaling argument will only affect the y-column data of
external data files</p>

<p>Signals are registered with a flux during flux creation,
i.e., they are passed on the process list when calling the
connector object.</p>

<p>if the filename argument is used, you can provide a filename which
contains the data to be used in csv format. The data will be
interpolated to the model domain, and added to the already existing data.
The external data need to be in the following format</p>

<p>Time, Rate, delta value
  0,     10,   12</p>

<p>i.e., the first row needs to be a header line</p>

<p>All time data in the csv file will be treated as realative time
(i.e., the start time will be mapped to zero). Use the offset
keyword to shift the external signal data in the time domain.</p>

<p>Last but not least, you can provide an optional reservoir name. In
this case, the signal will create a source as (signal_name_source)
and the connection to the specified reservoir. If you build a
complex signal do this as the last step. If you additionally
provide a source name the connection will be made between the
provided source (this can be useful if you use source groups).</p>

<p>This class has the following methods</p>

<p><a href="#Signal.repeat">Signal.repeat()</a>
  <a href="#Signal.plot">Signal.plot()</a>
  <a href="#Signal.info">Signal.info()</a></p>
</div>


                            <div id="Signal.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Signal.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">Signal</span><span class="signature">(**kwargs)</span>
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Parse and initialize variables&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>

        <span class="c1"># provide a list of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="n">Species</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;stype&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;magnitude&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;reservoir&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Reservoir</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Source</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;magnitude&quot;</span><span class="p">,</span> <span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">],</span>
        <span class="p">]</span>

        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="s2">&quot;0 yrs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;stype&quot;</span><span class="p">:</span> <span class="s2">&quot;addition&quot;</span><span class="p">,</span>
            <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="s2">&quot;external_data&quot;</span><span class="p">,</span>
            <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="s2">&quot;0 yrs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="s2">&quot;0 yrs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;reservoir&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bem</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;magnitude&quot;</span><span class="p">:</span> <span class="s2">&quot;Number&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="s2">&quot;Number&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># list of signals we are based on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Signal</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># convert units to model units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">st</span><span class="p">:</span> <span class="n">Number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="p">)</span>  <span class="c1"># start time</span>

        <span class="k">if</span> <span class="s2">&quot;mass&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="k">elif</span> <span class="s2">&quot;magnitude&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">magnitude</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="k">if</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="c1"># legacy name definitions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># the name of the this signal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">:</span> <span class="n">Species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>  <span class="c1"># the species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># the model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ty</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stype</span>  <span class="c1"># type of signal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sh</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># shape the event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span>  <span class="c1"># delta value offset during the event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwd</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span>  <span class="c1"># list of keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="c1"># initialize signal data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__init_signal_data__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_data&quot;</span>  <span class="c1"># update the name of the signal data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">legend_left</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">legend_right</span>
        <span class="c1"># update isotope values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">li</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">hi</span> <span class="o">=</span> <span class="n">get_imass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">los</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># register with model</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__apply_signal__</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>Parse and initialize variables</p>
</div>


                            </div>
                            <div id="Signal.lkk" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Signal.lkk">#&nbsp;&nbsp</a>

        <span class="name">lkk</span><span class="annotation">: Dict[str, &lt;built-in function any&gt;]</span>
    </div>

    

                            </div>
                            <div id="Signal.lrk" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Signal.lrk">#&nbsp;&nbsp</a>

        <span class="name">lrk</span><span class="annotation">: numba.typed.typedlist.List[str]</span>
    </div>

    

                            </div>
                            <div id="Signal.lod" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Signal.lod">#&nbsp;&nbsp</a>

        <span class="name">lod</span><span class="annotation">: Dict[str, &lt;built-in function any&gt;]</span>
    </div>

    

                            </div>
                            <div id="Signal.los" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Signal.los">#&nbsp;&nbsp</a>

        <span class="name">los</span><span class="annotation">: numba.typed.typedlist.List[<a href="#Signal">esbmtk.esbmtk.Signal</a>]</span>
    </div>

    

                            </div>
                            <div id="Signal.st" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Signal.st">#&nbsp;&nbsp</a>

        <span class="name">st</span><span class="annotation">: nptyping.types._number.Number</span>
    </div>

    

                            </div>
                            <div id="Signal.l" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Signal.l">#&nbsp;&nbsp</a>

        <span class="name">l</span><span class="annotation">: int</span>
    </div>

    

                            </div>
                            <div id="Signal.n" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Signal.n">#&nbsp;&nbsp</a>

        <span class="name">n</span><span class="annotation">: str</span>
    </div>

    

                            </div>
                            <div id="Signal.sp" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Signal.sp">#&nbsp;&nbsp</a>

        <span class="name">sp</span><span class="annotation">: <a href="#Species">esbmtk.esbmtk.Species</a></span>
    </div>

    

                            </div>
                            <div id="Signal.mo" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Signal.mo">#&nbsp;&nbsp</a>

        <span class="name">mo</span><span class="annotation">: <a href="#Model">esbmtk.esbmtk.Model</a></span>
    </div>

    

                            </div>
                            <div id="Signal.ty" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Signal.ty">#&nbsp;&nbsp</a>

        <span class="name">ty</span><span class="annotation">: str</span>
    </div>

    

                            </div>
                            <div id="Signal.sh" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Signal.sh">#&nbsp;&nbsp</a>

        <span class="name">sh</span><span class="annotation">: str</span>
    </div>

    

                            </div>
                            <div id="Signal.d" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Signal.d">#&nbsp;&nbsp</a>

        <span class="name">d</span><span class="annotation">: float</span>
    </div>

    

                            </div>
                            <div id="Signal.kwd" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Signal.kwd">#&nbsp;&nbsp</a>

        <span class="name">kwd</span><span class="annotation">: Dict[str, &lt;built-in function any&gt;]</span>
    </div>

    

                            </div>
                            <div id="Signal.led" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Signal.led">#&nbsp;&nbsp</a>

        <span class="name">led</span><span class="annotation">: list</span>
    </div>

    

                            </div>
                            <div id="Signal.repeat" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Signal.repeat">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">repeat</span><span class="signature">(self, start, stop, offset, times) -&gt; None</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">repeat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This method creates a new signal by repeating an existing signal.</span>
<span class="sd">        Example::</span>

<span class="sd">        new_signal = signal.repeat(start,   # start time of signal slice to be repeated</span>
<span class="sd">                                   stop,    # end time of signal slice to be repeated</span>
<span class="sd">                                   offset,  # offset between repetitions</span>
<span class="sd">                                   times,   # number of time to repeat the slice</span>
<span class="sd">                              )</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ns</span><span class="p">:</span> <span class="n">Signal</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_repeated_</span><span class="si">{</span><span class="n">times</span><span class="si">}</span><span class="s2">_times&quot;</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_repeated_</span><span class="si">{</span><span class="n">times</span><span class="si">}</span><span class="s2">_times_data&quot;</span>
        <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>  <span class="c1"># convert from time to index</span>
        <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">stop</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">offset</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">start</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">stop</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">stop</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">offset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span> <span class="o">+</span> <span class="n">offset</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">times</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">times</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">ms</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">[</span>
            <span class="n">start</span><span class="p">:</span><span class="n">stop</span>
        <span class="p">]</span>  <span class="c1"># get the data slice we are using</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">ds</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>

        <span class="n">diff</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
            <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">ns</span><span class="o">.</span><span class="n">offset</span>
            <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">+</span> <span class="n">ns</span><span class="o">.</span><span class="n">offset</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">stop</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">):</span>  <span class="c1"># end index larger than data size</span>
                <span class="n">diff</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>  <span class="c1"># difference</span>
                <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">diff</span>  <span class="c1"># new end index</span>
                <span class="n">lds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">ds</span><span class="p">)</span> <span class="o">-</span> <span class="n">diff</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">ds</span><span class="p">)</span>

            <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span> <span class="o">+</span> <span class="n">ns</span><span class="o">.</span><span class="n">ms</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">lds</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span> <span class="o">+</span> <span class="n">ns</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">lds</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># and recalculate li and hi</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">h</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">Float</span><span class="p">[</span><span class="mi">64</span><span class="p">]]</span>
        <span class="p">[</span><span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_imass</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ns</span>
</pre></div>

        </details>

            <div class="docstring"><p>This method creates a new signal by repeating an existing signal.
Example::</p>

<p>new_signal = signal.repeat(start,   # start time of signal slice to be repeated
                           stop,    # end time of signal slice to be repeated
                           offset,  # offset between repetitions
                           times,   # number of time to repeat the slice
                      )</p>
</div>


                            </div>
                            <div id="Signal.plot" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Signal.plot">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">plot</span><span class="signature">(self) -&gt; None</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">          Example::</span>

<span class="sd">              Signal.plot()</span>

<span class="sd">        Plot the signal</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>Example::</p>

<pre><code>  <a href="#Signal.plot">Signal.plot()</a>
</code></pre>

<p>Plot the signal</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#esbmtkBase">esbmtkBase</a></dt>
                                <dd id="Signal.info" class="function"><a href="#esbmtkBase.info">info</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="DataField">
                                <div class="attr class">
        <a class="headerlink" href="#DataField">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">DataField</span>(<span class="base"><a href="#esbmtkBase">esbmtkBase</a></span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">DataField</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DataField: Datafields can be used to plot data which is computed after</span>
<span class="sd">    the model finishes in the overview plot windows. Therefore, datafields will</span>
<span class="sd">    plot in the same window as the reservoir they are associated with.</span>
<span class="sd">    Datafields must share the same x-axis is the model, and can have up to two</span>
<span class="sd">    y axis.</span>

<span class="sd">    Example::</span>
<span class="sd">    </span>
<span class="sd">             DataField(name = &quot;Name&quot;</span>
<span class="sd">                       associated_with = reservoir_handle</span>
<span class="sd">                       y1_data = np.Ndarray</span>
<span class="sd">                       y1_label = Y-Axis label</span>
<span class="sd">                       y1_legend = Data legend</span>
<span class="sd">                       y2_data = np.Ndarray    # optional</span>
<span class="sd">                       y2_label = Y-Axis label # optional</span>
<span class="sd">                       y2_legend = Data legend # optional</span>
<span class="sd">                       common_y_scale = &quot;no&quot;,  #optional, default &quot;no&quot;</span>
<span class="sd">                       display_precision = number, optional, inherited from Model</span>
<span class="sd">                       )</span>

<span class="sd">    Note that Datafield data is not mapped to model units. Care must be taken</span>
<span class="sd">    that the data units match the model units.</span>

<span class="sd">    The instance provides the following data</span>

<span class="sd">    Name.x    = X-axis = model X-axis</span>
<span class="sd">    Name.y1_data</span>
<span class="sd">    Name.y1_label</span>
<span class="sd">    Name.y1_legend</span>

<span class="sd">    Similarly for y2</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Initialize this instance &quot;&quot;&quot;</span>

        <span class="c1"># dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;associated_with&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Reservoir</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">),</span>
            <span class="s2">&quot;y1_data&quot;</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
            <span class="s2">&quot;y1_label&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;y1_legend&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;y2_data&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">[</span><span class="nb">float</span><span class="p">]),</span>
            <span class="s2">&quot;y2_label&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;y2_legend&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;common_y_scale&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;associated_with&quot;</span><span class="p">,</span> <span class="s2">&quot;y1_data&quot;</span><span class="p">]</span>

        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;y1_label&quot;</span><span class="p">:</span> <span class="s2">&quot;Not Provided&quot;</span><span class="p">,</span>
            <span class="s2">&quot;y1_legend&quot;</span><span class="p">:</span> <span class="s2">&quot;Not Provided&quot;</span><span class="p">,</span>
            <span class="s2">&quot;y2_label&quot;</span><span class="p">:</span> <span class="s2">&quot;Not Provided&quot;</span><span class="p">,</span>
            <span class="s2">&quot;y2_legend&quot;</span><span class="p">:</span> <span class="s2">&quot;Not Provided&quot;</span><span class="p">,</span>
            <span class="s2">&quot;y2_data&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;common_y_scale&quot;</span><span class="p">:</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># provide a dictionary entry for a keyword specific error message</span>
        <span class="c1"># see esbmtkBase.__initerrormessages__()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bem</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;associated_with&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;y1_data&quot;</span><span class="p">:</span> <span class="s2">&quot;a numpy array&quot;</span><span class="p">,</span>
                <span class="s2">&quot;y1_label&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;y1_legend&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;y2_data&quot;</span><span class="p">:</span> <span class="s2">&quot;a numpy array&quot;</span><span class="p">,</span>
                <span class="s2">&quot;y2_label&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;y2_legend&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;common_y_scale&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># set legacy variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1_legend</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">associated_with</span><span class="o">.</span><span class="n">mo</span>
        <span class="k">if</span> <span class="s2">&quot;self.y2_data&quot;</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_legend</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ld</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_label</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># register with reservoir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">associated_with</span><span class="o">.</span><span class="n">ldf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># register with model. needed for print_reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">ldf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;---------------------------------------------------------------------------</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Warning, you are initializing a datafield before the model results are known</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;---------------------------------------------------------------------------&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__write_data__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stride</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;To be called by write_data and save_state&quot;&quot;&quot;</span>

        <span class="c1"># some short hands</span>
        <span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model handle</span>

        <span class="n">smu</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mo</span><span class="o">.</span><span class="n">m_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">mtu</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">fmu</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">cmu</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">rn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>  <span class="c1"># reservoir name</span>
        <span class="n">mn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">n</span>  <span class="c1"># model name</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">mn</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2">.csv&quot;</span>  <span class="c1"># file name</span>

        <span class="c1"># build the dataframe</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>

        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> Time [</span><span class="si">{</span><span class="n">mtu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># time</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1_data</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># y1 data</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># y2_data</span>

        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Write dataframe to file</span>
        <span class="k">return</span> <span class="n">df</span>
</pre></div>

        </details>

            <div class="docstring"><p>DataField: Datafields can be used to plot data which is computed after
the model finishes in the overview plot windows. Therefore, datafields will
plot in the same window as the reservoir they are associated with.
Datafields must share the same x-axis is the model, and can have up to two
y axis.</p>

<p>Example::</p>

<pre><code>     DataField(name = "Name"
               associated_with = reservoir_handle
               y1_data = np.Ndarray
               y1_label = Y-Axis label
               y1_legend = Data legend
               y2_data = np.Ndarray    # optional
               y2_label = Y-Axis label # optional
               y2_legend = Data legend # optional
               common_y_scale = "no",  #optional, default "no"
               display_precision = number, optional, inherited from Model
               )
</code></pre>

<p>Note that Datafield data is not mapped to model units. Care must be taken
that the data units match the model units.</p>

<p>The instance provides the following data</p>

<p>Name.x    = X-axis = model X-axis
Name.y1_data
Name.y1_label
Name.y1_legend</p>

<p>Similarly for y2</p>
</div>


                            <div id="DataField.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#DataField.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">DataField</span><span class="signature">(**kwargs: Dict[str, &lt;built-in function any&gt;])</span>
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Initialize this instance &quot;&quot;&quot;</span>

        <span class="c1"># dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;associated_with&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Reservoir</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">),</span>
            <span class="s2">&quot;y1_data&quot;</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
            <span class="s2">&quot;y1_label&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;y1_legend&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;y2_data&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">[</span><span class="nb">float</span><span class="p">]),</span>
            <span class="s2">&quot;y2_label&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;y2_legend&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;common_y_scale&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;associated_with&quot;</span><span class="p">,</span> <span class="s2">&quot;y1_data&quot;</span><span class="p">]</span>

        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;y1_label&quot;</span><span class="p">:</span> <span class="s2">&quot;Not Provided&quot;</span><span class="p">,</span>
            <span class="s2">&quot;y1_legend&quot;</span><span class="p">:</span> <span class="s2">&quot;Not Provided&quot;</span><span class="p">,</span>
            <span class="s2">&quot;y2_label&quot;</span><span class="p">:</span> <span class="s2">&quot;Not Provided&quot;</span><span class="p">,</span>
            <span class="s2">&quot;y2_legend&quot;</span><span class="p">:</span> <span class="s2">&quot;Not Provided&quot;</span><span class="p">,</span>
            <span class="s2">&quot;y2_data&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;common_y_scale&quot;</span><span class="p">:</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># provide a dictionary entry for a keyword specific error message</span>
        <span class="c1"># see esbmtkBase.__initerrormessages__()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bem</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;associated_with&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;y1_data&quot;</span><span class="p">:</span> <span class="s2">&quot;a numpy array&quot;</span><span class="p">,</span>
                <span class="s2">&quot;y1_label&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;y1_legend&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;y2_data&quot;</span><span class="p">:</span> <span class="s2">&quot;a numpy array&quot;</span><span class="p">,</span>
                <span class="s2">&quot;y2_label&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;y2_legend&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;common_y_scale&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># set legacy variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1_legend</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">associated_with</span><span class="o">.</span><span class="n">mo</span>
        <span class="k">if</span> <span class="s2">&quot;self.y2_data&quot;</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_legend</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ld</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_label</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># register with reservoir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">associated_with</span><span class="o">.</span><span class="n">ldf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># register with model. needed for print_reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">ldf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;---------------------------------------------------------------------------</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Warning, you are initializing a datafield before the model results are known</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;---------------------------------------------------------------------------&quot;</span>
            <span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Initialize this instance</p>
</div>


                            </div>
                            <div id="DataField.lkk" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#DataField.lkk">#&nbsp;&nbsp</a>

        <span class="name">lkk</span><span class="annotation">: Dict[str, &lt;built-in function any&gt;]</span>
    </div>

    

                            </div>
                            <div id="DataField.lrk" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#DataField.lrk">#&nbsp;&nbsp</a>

        <span class="name">lrk</span><span class="annotation">: list</span>
    </div>

    

                            </div>
                            <div id="DataField.lod" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#DataField.lod">#&nbsp;&nbsp</a>

        <span class="name">lod</span><span class="annotation">: Dict[str, &lt;built-in function any&gt;]</span>
    </div>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#esbmtkBase">esbmtkBase</a></dt>
                                <dd id="DataField.info" class="function"><a href="#esbmtkBase.info">info</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="VirtualReservoir">
                                <div class="attr class">
        <a class="headerlink" href="#VirtualReservoir">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">VirtualReservoir</span>(<span class="base"><a href="#Reservoir">Reservoir</a></span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">VirtualReservoir</span><span class="p">(</span><span class="n">Reservoir</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;A virtual reservoir. Unlike regular reservoirs, the mass of a</span>
<span class="sd">   virtual reservoir depends entirely on the return value of a function.</span>

<span class="sd">   Example::</span>

<span class="sd">   VirtualReservoir(name=&quot;foo&quot;,</span>
<span class="sd">                   volume=&quot;10 liter&quot;,</span>
<span class="sd">                   concentration=&quot;1 mmol&quot;,</span>
<span class="sd">                   species=  ,</span>
<span class="sd">                   function=bar,</span>
<span class="sd">                   a1 to a3 =  to 3optional function arguments,</span>
<span class="sd">                   display_precision = number, optional, inherited from Model,</span>
<span class="sd">                   )</span>

<span class="sd">   the concentration argument will be used to initialize the reservoir and</span>
<span class="sd">   to determine the display units.</span>

<span class="sd">   The function definition follows the GenericFunction class.</span>
<span class="sd">   which takes a generic function and up to 6 optional</span>
<span class="sd">   function arguments, and will replace the mass value(s) of the</span>
<span class="sd">   given reservoirs with whatever the function calculates. This is</span>
<span class="sd">   particularly useful e.g., to calculate the pH of a given reservoir</span>
<span class="sd">   as function of e.g., Alkalinity and DIC.</span>
<span class="sd">   Parameters:</span>
<span class="sd">    - name = name of process,</span>
<span class="sd">    - act_on = name of a reservoir this process will act upon</span>
<span class="sd">    - function  = a function reference</span>
<span class="sd">    - a1 to a3 function arguments</span>

<span class="sd">   In order to be compatible with the numba solver, a1 and a2 must be</span>
<span class="sd">   an array of 1-D numpy.arrays i.e., [m, l, h, c]. The array can have</span>
<span class="sd">   any number of arrays though. a3 must be single array (or list)</span>
<span class="sd">   containing an arbitrary number if entries. All numbers in a1 to a3</span>
<span class="sd">   _must_ be of type float64.</span>

<span class="sd">   The function must return a list of numbers which correspond to the</span>
<span class="sd">   data which describe a reservoir i.e., mass, light isotope, heavy</span>
<span class="sd">   isotope, delta, and concentration</span>

<span class="sd">   In order to use this function we need first declare a function we plan to</span>
<span class="sd">   use with the generic function process. This function needs to follow this</span>
<span class="sd">   template::</span>

<span class="sd">       def my_func(i, a1, a2, a3) -&gt; tuple:</span>
<span class="sd">           #</span>
<span class="sd">           # i = index of the current timestep</span>
<span class="sd">           # a1 to a2 =  optional function parameter. These must be present,</span>
<span class="sd">           # even if your function will not use it</span>

<span class="sd">           # calc some stuff and return it as</span>

<span class="sd">           return [m, l, h, d, c] # where m= mass, and l &amp; h are the respective</span>
<span class="sd">                                  # isotopes. d denotes the delta value and</span>
<span class="sd">                                  # c the concentration</span>
<span class="sd">                                  # Use dummy value as necessary.</span>

<span class="sd">   This class provides an update method to resolve cases where e.g., two virtual</span>
<span class="sd">   reservoirs have a circular reference. See the documentation of update().</span>

<span class="sd">   &quot;&quot;&quot;</span>

   <span class="k">def</span> <span class="nf">__aux_inits__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
       <span class="sd">&quot;&quot;&quot;We us the regular init methods of the Reservoir Class, and extend it in this method&quot;&quot;&quot;</span>

       <span class="kn">from</span> <span class="nn">.processes</span> <span class="kn">import</span> <span class="n">GenericFunction</span>

       <span class="c1"># if self.register != &quot;None&quot;:</span>
       <span class="c1">#    self.full_name = f&quot;{self.full_name}.{self.name}&quot;</span>
       <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">_generic_function&quot;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
       <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;creating </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

       <span class="bp">self</span><span class="o">.</span><span class="n">gfh</span> <span class="o">=</span> <span class="n">GenericFunction</span><span class="p">(</span>
           <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
           <span class="n">function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">,</span>
           <span class="n">a1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="p">,</span>
           <span class="n">a2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a2</span><span class="p">,</span>
           <span class="n">a3</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a3</span><span class="p">,</span>
           <span class="n">act_on</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
       <span class="p">)</span>

       <span class="c1"># we only depend on the above function. so no need</span>
       <span class="c1"># to be in the reservoir list</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
       <span class="c1"># but lets keep track of  virtual reservoir in lvr.</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lvr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>



   <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
       <span class="sd">&quot;&quot;&quot;This method allows to update GenericFunction parameters after the</span>
<span class="sd">       VirtualReservoir has been initialized. This is most useful</span>
<span class="sd">       when parameters have to reference other virtual reservoirs</span>
<span class="sd">       which do not yet exist, e.g., when two virtual reservoirs have</span>
<span class="sd">       a circular reference.</span>

<span class="sd">       Example::</span>

<span class="sd">       VR.update(a1=new_parameter, a2=new_parameter)</span>

<span class="sd">       &quot;&quot;&quot;</span>

       <span class="n">allowed_keys</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;a1&quot;</span><span class="p">,</span> <span class="s2">&quot;a2&quot;</span><span class="p">,</span> <span class="s2">&quot;a3&quot;</span><span class="p">,</span> <span class="s2">&quot;a4&quot;</span><span class="p">,</span> <span class="s2">&quot;a5&quot;</span><span class="p">,</span> <span class="s2">&quot;a6&quot;</span><span class="p">,</span> <span class="s2">&quot;volume&quot;</span><span class="p">]</span>
       <span class="c1"># loop over provided kwargs</span>
       <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
           <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_keys</span><span class="p">:</span>
               <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;you can only change a1 to a6&quot;</span><span class="p">)</span>
           <span class="k">else</span><span class="p">:</span>
               <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="c1"># update self</span>
               <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gfh</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="c1"># update function</span>
</pre></div>

        </details>

            <div class="docstring"><p>A virtual reservoir. Unlike regular reservoirs, the mass of a
virtual reservoir depends entirely on the return value of a function.</p>

<p>Example::</p>

<p>VirtualReservoir(name="foo",
                volume="10 liter",
                concentration="1 mmol",
                species=  ,
                function=bar,
                a1 to a3 =  to 3optional function arguments,
                display_precision = number, optional, inherited from Model,
                )</p>

<p>the concentration argument will be used to initialize the reservoir and
to determine the display units.</p>

<p>The function definition follows the GenericFunction class.
which takes a generic function and up to 6 optional
function arguments, and will replace the mass value(s) of the
given reservoirs with whatever the function calculates. This is
particularly useful e.g., to calculate the pH of a given reservoir
as function of e.g., Alkalinity and DIC.
Parameters:</p>

<ul>
<li>name = name of process,</li>
<li>act_on = name of a reservoir this process will act upon</li>
<li>function  = a function reference</li>
<li>a1 to a3 function arguments</li>
</ul>

<p>In order to be compatible with the numba solver, a1 and a2 must be
an array of 1-D numpy.arrays i.e., [m, l, h, c]. The array can have
any number of arrays though. a3 must be single array (or list)
containing an arbitrary number if entries. All numbers in a1 to a3
_must_ be of type float64.</p>

<p>The function must return a list of numbers which correspond to the
data which describe a reservoir i.e., mass, light isotope, heavy
isotope, delta, and concentration</p>

<p>In order to use this function we need first declare a function we plan to
use with the generic function process. This function needs to follow this
template::</p>

<pre><code>def my_func(i, a1, a2, a3) -&gt; tuple:
    #
    # i = index of the current timestep
    # a1 to a2 =  optional function parameter. These must be present,
    # even if your function will not use it

    # calc some stuff and return it as

    return [m, l, h, d, c] # where m= mass, and l &amp; h are the respective
                           # isotopes. d denotes the delta value and
                           # c the concentration
                           # Use dummy value as necessary.
</code></pre>

<p>This class provides an update method to resolve cases where e.g., two virtual
reservoirs have a circular reference. See the documentation of update().</p>
</div>


                            <div id="VirtualReservoir.update" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#VirtualReservoir.update">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">update</span><span class="signature">(self, **kwargs) -&gt; None</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>   <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
       <span class="sd">&quot;&quot;&quot;This method allows to update GenericFunction parameters after the</span>
<span class="sd">       VirtualReservoir has been initialized. This is most useful</span>
<span class="sd">       when parameters have to reference other virtual reservoirs</span>
<span class="sd">       which do not yet exist, e.g., when two virtual reservoirs have</span>
<span class="sd">       a circular reference.</span>

<span class="sd">       Example::</span>

<span class="sd">       VR.update(a1=new_parameter, a2=new_parameter)</span>

<span class="sd">       &quot;&quot;&quot;</span>

       <span class="n">allowed_keys</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;a1&quot;</span><span class="p">,</span> <span class="s2">&quot;a2&quot;</span><span class="p">,</span> <span class="s2">&quot;a3&quot;</span><span class="p">,</span> <span class="s2">&quot;a4&quot;</span><span class="p">,</span> <span class="s2">&quot;a5&quot;</span><span class="p">,</span> <span class="s2">&quot;a6&quot;</span><span class="p">,</span> <span class="s2">&quot;volume&quot;</span><span class="p">]</span>
       <span class="c1"># loop over provided kwargs</span>
       <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
           <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_keys</span><span class="p">:</span>
               <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;you can only change a1 to a6&quot;</span><span class="p">)</span>
           <span class="k">else</span><span class="p">:</span>
               <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="c1"># update self</span>
               <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gfh</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="c1"># update function</span>
</pre></div>

        </details>

            <div class="docstring"><p>This method allows to update GenericFunction parameters after the
VirtualReservoir has been initialized. This is most useful
when parameters have to reference other virtual reservoirs
which do not yet exist, e.g., when two virtual reservoirs have
a circular reference.</p>

<p>Example::</p>

<p>VR.update(a1=new_parameter, a2=new_parameter)</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Reservoir">Reservoir</a></dt>
                                <dd id="VirtualReservoir.__init__" class="function"><a href="#Reservoir.__init__">Reservoir</a></dd>
                <dd id="VirtualReservoir.lkk" class="variable"><a href="#Reservoir.lkk">lkk</a></dd>
                <dd id="VirtualReservoir.lrk" class="variable"><a href="#Reservoir.lrk">lrk</a></dd>
                <dd id="VirtualReservoir.lod" class="variable"><a href="#Reservoir.lod">lod</a></dd>
                <dd id="VirtualReservoir.n" class="variable"><a href="#Reservoir.n">n</a></dd>
                <dd id="VirtualReservoir.sp" class="variable"><a href="#Reservoir.sp">sp</a></dd>
                <dd id="VirtualReservoir.mo" class="variable"><a href="#Reservoir.mo">mo</a></dd>
                <dd id="VirtualReservoir.rvalue" class="variable"><a href="#Reservoir.rvalue">rvalue</a></dd>
                <dd id="VirtualReservoir.volume" class="variable"><a href="#Reservoir.volume">volume</a></dd>
                <dd id="VirtualReservoir.v" class="variable"><a href="#Reservoir.v">v</a></dd>
                <dd id="VirtualReservoir.mu" class="variable"><a href="#Reservoir.mu">mu</a></dd>
                <dd id="VirtualReservoir.lof" class="variable"><a href="#Reservoir.lof">lof</a></dd>
                <dd id="VirtualReservoir.led" class="variable"><a href="#Reservoir.led">led</a></dd>
                <dd id="VirtualReservoir.lio" class="variable"><a href="#Reservoir.lio">lio</a></dd>
                <dd id="VirtualReservoir.lop" class="variable"><a href="#Reservoir.lop">lop</a></dd>
                <dd id="VirtualReservoir.loe" class="variable"><a href="#Reservoir.loe">loe</a></dd>
                <dd id="VirtualReservoir.doe" class="variable"><a href="#Reservoir.doe">doe</a></dd>
                <dd id="VirtualReservoir.loc" class="variable"><a href="#Reservoir.loc">loc</a></dd>
                <dd id="VirtualReservoir.ldf" class="variable"><a href="#Reservoir.ldf">ldf</a></dd>
                <dd id="VirtualReservoir.lpc" class="variable"><a href="#Reservoir.lpc">lpc</a></dd>
                <dd id="VirtualReservoir.m" class="variable"><a href="#Reservoir.m">m</a></dd>
                <dd id="VirtualReservoir.l" class="variable"><a href="#Reservoir.l">l</a></dd>
                <dd id="VirtualReservoir.h" class="variable"><a href="#Reservoir.h">h</a></dd>
                <dd id="VirtualReservoir.lm" class="variable"><a href="#Reservoir.lm">lm</a></dd>
                <dd id="VirtualReservoir.ld" class="variable"><a href="#Reservoir.ld">ld</a></dd>
                <dd id="VirtualReservoir.xl" class="variable"><a href="#Reservoir.xl">xl</a></dd>
                <dd id="VirtualReservoir.info" class="function"><a href="#Reservoir.info">info</a></dd>
                <dd id="VirtualReservoir.c" class="variable"><a href="#Reservoir.c">c</a></dd>
                <dd id="VirtualReservoir.d" class="variable"><a href="#Reservoir.d">d</a></dd>
                <dd id="VirtualReservoir.lodir" class="variable"><a href="#Reservoir.lodir">lodir</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ExternalData">
                                <div class="attr class">
        <a class="headerlink" href="#ExternalData">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">ExternalData</span>(<span class="base"><a href="#esbmtkBase">esbmtkBase</a></span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">ExternalData</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Instances of this class hold external X/Y data which can be associated with</span>
<span class="sd">    a reservoir.</span>

<span class="sd">    Example::</span>

<span class="sd">           ExternalData(name       = &quot;Name&quot;</span>
<span class="sd">                        filename   = &quot;filename&quot;,</span>
<span class="sd">                        legend     = &quot;label&quot;,</span>
<span class="sd">                        offset     = &quot;0 yrs&quot;,</span>
<span class="sd">                        reservoir  = reservoir_handle,</span>
<span class="sd">                        scale      = scaling factor, optional</span>
<span class="sd">                        display_precision = number, optional, inherited from Model</span>
<span class="sd">                       )</span>

<span class="sd">    The data must exist as CSV file, where the first column contains</span>
<span class="sd">    the X-values, and the second column contains the Y-values.</span>

<span class="sd">    The x-values must be time and specify the time units in the header between square brackets</span>
<span class="sd">    They will be mapped into the model time units.</span>

<span class="sd">    The y-values can be any data, but the user must take care that they match the model units</span>
<span class="sd">    defined in the model instance. So your data file mujst look like this</span>

<span class="sd">    Time [years], Data [units], Data [units]</span>
<span class="sd">    1, 12</span>
<span class="sd">    2, 13</span>

<span class="sd">    By convention, the secon column should contaain the same type of</span>
<span class="sd">    data as the reservoir (i.e., a concentration), whereas the third</span>
<span class="sd">    column contain isotope delta values. Columns with no data should</span>
<span class="sd">    be left empty (and have no header!) The optional scale argumenty, will</span>
<span class="sd">    only affect the Y-col data, not the isotope data</span>

<span class="sd">    The column headers are only used for the time or concentration</span>
<span class="sd">    data conversion, and are ignored by the default plotting</span>
<span class="sd">    methods, but they are available as self.xh,yh</span>

<span class="sd">    The file must exist in the local working directory.</span>

<span class="sd">    Methods:</span>
<span class="sd">      - name.plot()</span>

<span class="sd">    Data:</span>
<span class="sd">      - name.x</span>
<span class="sd">      - name.y</span>
<span class="sd">      - name.df = dataframe as read from csv file</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>

        <span class="c1"># dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;legend&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;reservoir&quot;</span><span class="p">:</span> <span class="n">Reservoir</span><span class="p">,</span>
            <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="s2">&quot;legend&quot;</span><span class="p">,</span> <span class="s2">&quot;reservoir&quot;</span><span class="p">]</span>
        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="s2">&quot;0 yrs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># validate input and initialize instance variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># legacy names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># string =  name of this instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>  <span class="c1"># string = filename of data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">):</span>  <span class="c1"># check if the file is actually there</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">)</span>  <span class="c1"># read file</span>

        <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># test of we have 3 columns</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;CSV file must have 3 columns&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="n">xh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># get unit information from each header</span>
        <span class="n">xh</span> <span class="o">=</span> <span class="n">get_string_between_brackets</span><span class="p">(</span><span class="n">xh</span><span class="p">)</span>

        <span class="n">xq</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">xh</span><span class="p">)</span>
        <span class="c1"># add these to the data we are are reading</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">*</span> <span class="n">xq</span>
        <span class="c1"># map into model units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="c1"># map into model space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>

        <span class="c1"># check if y-data is present</span>
        <span class="n">yh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;Unnamed&quot;</span> <span class="ow">in</span> <span class="n">yh</span><span class="p">:</span>
            <span class="n">yh</span> <span class="o">=</span> <span class="n">get_string_between_brackets</span><span class="p">(</span><span class="n">yh</span><span class="p">)</span>
            <span class="n">yq</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">yh</span><span class="p">)</span>
            <span class="c1"># add these to the data we are are reading</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">*</span> <span class="n">yq</span>
            <span class="c1"># map into model units</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

        <span class="c1"># check if z-data is present</span>
        <span class="k">if</span> <span class="n">ncols</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">zh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="c1"># register with reservoir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__register__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register this dataset with a flux or reservoir. This will have the</span>
<span class="sd">        effect that the data will be printed together with the model</span>
<span class="sd">        results for this reservoir</span>

<span class="sd">        Example::</span>

<span class="sd">        ExternalData.register(Reservoir)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span>  <span class="c1"># reser handle we associate with</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">led</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__interpolate__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Interpolate the input data with a resolution of dt across the model</span>
<span class="sd">        domain The first and last data point must coincide with the</span>
<span class="sd">        model start and end time. In other words, this method will not</span>
<span class="sd">        patch data at the end points.</span>

<span class="sd">        This will replace the original values of name.x and name.y. However</span>
<span class="sd">        the original data remains accessible as name.df</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">xi</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">time</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">xi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">xi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Interpolation requires that the time domain&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;is equal or greater than the model domain&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;data t(0) = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, tmax = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;model t(0) = </span><span class="si">{</span><span class="n">xi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, tmax = </span><span class="si">{</span><span class="n">xi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">xi</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot the data and save a pdf</span>

<span class="sd">        Example::</span>

<span class="sd">                ExternalData.plot()</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>  <span class="c1">#</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">legend</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xh</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yh</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Instances of this class hold external X/Y data which can be associated with
a reservoir.</p>

<p>Example::</p>

<pre><code>   ExternalData(name       = "Name"
                filename   = "filename",
                legend     = "label",
                offset     = "0 yrs",
                reservoir  = reservoir_handle,
                scale      = scaling factor, optional
                display_precision = number, optional, inherited from Model
               )
</code></pre>

<p>The data must exist as CSV file, where the first column contains
the X-values, and the second column contains the Y-values.</p>

<p>The x-values must be time and specify the time units in the header between square brackets
They will be mapped into the model time units.</p>

<p>The y-values can be any data, but the user must take care that they match the model units
defined in the model instance. So your data file mujst look like this</p>

<p>Time [years], Data [units], Data [units]
1, 12
2, 13</p>

<p>By convention, the secon column should contaain the same type of
data as the reservoir (i.e., a concentration), whereas the third
column contain isotope delta values. Columns with no data should
be left empty (and have no header!) The optional scale argumenty, will
only affect the Y-col data, not the isotope data</p>

<p>The column headers are only used for the time or concentration
data conversion, and are ignored by the default plotting
methods, but they are available as self.xh,yh</p>

<p>The file must exist in the local working directory.</p>

<p>Methods:</p>

<ul>
<li>name.plot()</li>
</ul>

<p>Data:</p>

<ul>
<li>name.x</li>
<li>name.y</li>
<li>name.df = dataframe as read from csv file</li>
</ul>
</div>


                            <div id="ExternalData.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ExternalData.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">ExternalData</span><span class="signature">(**kwargs: Dict[str, str])</span>
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>

        <span class="c1"># dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;legend&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;reservoir&quot;</span><span class="p">:</span> <span class="n">Reservoir</span><span class="p">,</span>
            <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="s2">&quot;legend&quot;</span><span class="p">,</span> <span class="s2">&quot;reservoir&quot;</span><span class="p">]</span>
        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="s2">&quot;0 yrs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># validate input and initialize instance variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># initialize keyword values</span>

        <span class="c1"># legacy names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># string =  name of this instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>  <span class="c1"># string = filename of data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">):</span>  <span class="c1"># check if the file is actually there</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">)</span>  <span class="c1"># read file</span>

        <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># test of we have 3 columns</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;CSV file must have 3 columns&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="n">xh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># get unit information from each header</span>
        <span class="n">xh</span> <span class="o">=</span> <span class="n">get_string_between_brackets</span><span class="p">(</span><span class="n">xh</span><span class="p">)</span>

        <span class="n">xq</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">xh</span><span class="p">)</span>
        <span class="c1"># add these to the data we are are reading</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">*</span> <span class="n">xq</span>
        <span class="c1"># map into model units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="c1"># map into model space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>

        <span class="c1"># check if y-data is present</span>
        <span class="n">yh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;Unnamed&quot;</span> <span class="ow">in</span> <span class="n">yh</span><span class="p">:</span>
            <span class="n">yh</span> <span class="o">=</span> <span class="n">get_string_between_brackets</span><span class="p">(</span><span class="n">yh</span><span class="p">)</span>
            <span class="n">yq</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">yh</span><span class="p">)</span>
            <span class="c1"># add these to the data we are are reading</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">:</span> <span class="p">[</span><span class="n">NDArray</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">*</span> <span class="n">yq</span>
            <span class="c1"># map into model units</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

        <span class="c1"># check if z-data is present</span>
        <span class="k">if</span> <span class="n">ncols</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">zh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="c1"># register with reservoir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="ExternalData.lkk" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#ExternalData.lkk">#&nbsp;&nbsp</a>

        <span class="name">lkk</span><span class="annotation">: Dict[str, &lt;built-in function any&gt;]</span>
    </div>

    

                            </div>
                            <div id="ExternalData.lrk" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#ExternalData.lrk">#&nbsp;&nbsp</a>

        <span class="name">lrk</span><span class="annotation">: list</span>
    </div>

    

                            </div>
                            <div id="ExternalData.lod" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#ExternalData.lod">#&nbsp;&nbsp</a>

        <span class="name">lod</span><span class="annotation">: Dict[str, &lt;built-in function any&gt;]</span>
    </div>

    

                            </div>
                            <div id="ExternalData.n" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#ExternalData.n">#&nbsp;&nbsp</a>

        <span class="name">n</span><span class="annotation">: str</span>
    </div>

    

                            </div>
                            <div id="ExternalData.fn" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#ExternalData.fn">#&nbsp;&nbsp</a>

        <span class="name">fn</span><span class="annotation">: str</span>
    </div>

    

                            </div>
                            <div id="ExternalData.mo" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#ExternalData.mo">#&nbsp;&nbsp</a>

        <span class="name">mo</span><span class="annotation">: <a href="#Model">esbmtk.esbmtk.Model</a></span>
    </div>

    

                            </div>
                            <div id="ExternalData.df" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#ExternalData.df">#&nbsp;&nbsp</a>

        <span class="name">df</span><span class="annotation">: pandas.core.frame.DataFrame</span>
    </div>

    

                            </div>
                            <div id="ExternalData.x" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#ExternalData.x">#&nbsp;&nbsp</a>

        <span class="name">x</span><span class="annotation">: &#39;[NDArray]&#39;</span>
    </div>

    

                            </div>
                            <div id="ExternalData.plot" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ExternalData.plot">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">plot</span><span class="signature">(self) -&gt; None</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot the data and save a pdf</span>

<span class="sd">        Example::</span>

<span class="sd">                ExternalData.plot()</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>  <span class="c1">#</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">legend</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xh</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yh</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Plot the data and save a pdf</p>

<p>Example::</p>

<pre><code>    <a href="#ExternalData.plot">ExternalData.plot()</a>
</code></pre>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#esbmtkBase">esbmtkBase</a></dt>
                                <dd id="ExternalData.info" class="function"><a href="#esbmtkBase.info">info</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
</body>
</html>